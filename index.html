<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tools For Work</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Alexandria:wght@400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;600&display=swap');
        
        /* Base Dark Mode Styles */
        body {
            font-family: 'Alexandria', sans-serif;
            background-color: #111827;
            color: #e5e7eb;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        h1, h2 {
            font-family: 'Poppins', sans-serif;
        }
        .container-bg {
            background-color: #0d1117;
            background-image: radial-gradient(at 0% 0%, hsla(215,90%,55%,0.15) 0, transparent 50%),
                                 radial-gradient(at 100% 100%, hsla(280,90%,70%,0.15) 0, transparent 50%);
        }
        .link-card, .card-style, .form-container, .floating-card, .main-card, .sidebar, .modal-content {
            background-color: rgba(22, 27, 34, 0.8);
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
        }
        .link-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .link-title {
            background-image: linear-gradient(to right, #80e8ff, #62b3ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .pulse-effect:hover {
            animation: pulse-border 1s infinite;
        }
        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(100, 160, 255, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(100, 160, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(100, 160, 255, 0);
            }
        }


			@keyframes unlock-animation {
			    0% {
			        transform: scale(0.9);
			        opacity: 0.8;
			    }
			    50% {
			        transform: scale(1.1);
			        opacity: 1;
			        filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.7)); /* A golden glow */
			    }
			    100% {
			        transform: scale(1);
			        opacity: 1;
			        filter: none;
			    }
			}
			
			.newly-unlocked {
			    animation: unlock-animation 0.7s ease-out forwards;
			}
		
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1-px rgba(0, 0, 0, 0.1), 0 2px 4px -1-px rgba(0, 0, 0, 0.06);
            color: white;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .message-box.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

/* Add these styles for the level-up modal */
#level-up-modal .modal-content {
    position: relative; /* This is the key change to allow flexbox centering */
    background: radial-gradient(ellipse at top, #3b82f6, #1e3a8a);
    border: 2px solid #60a5fa;
    animation: level-up-pop-in 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
}

@keyframes level-up-pop-in {
    0% {
        transform: scale(0.5); /* We remove the translate property */
        opacity: 0;
    }
    100% {
        transform: scale(1); /* Flexbox now handles the centering */
        opacity: 1;
    }
}

.scrollbar-hide::-webkit-scrollbar {
    display: none;
}
.scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
}
.achievement-card-redesign {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 1rem;
    transition: all 0.2s ease-in-out;
    border: 1px solid transparent;
}
.achievement-card-redesign:hover {
    transform: translateY(-4px);
    background-color: rgba(31, 41, 55, 0.7);
    border-color: #4b5563;
}
.achievement-card-redesign .achievement-icon-wrapper {
    margin-bottom: 0.75rem;
    flex-shrink: 0; /* Prevents icon from shrinking */
}
.achievement-card-redesign p {
    margin-top: 0.25rem;
    font-size: 0.875rem;
}
/* Ensure icons don't get squished */
.level-badge-wrapper, .achievement-icon-wrapper {
    flex-shrink: 0;
}		

.challenge-progress-container {
    background-color: #374151; /* A darker gray for the bar background */
    border-radius: 9999px;
    height: 0.75rem; /* 12px */
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
    overflow: hidden;
}
.challenge-progress-bar {
    background-color: #34d399; /* A nice green for progress */
    height: 100%;
    border-radius: 9999px;
    transition: width 0.5s ease-in-out;
}

/* --- Leveling System Styles --- */
.xp-bar-container {
    background-color: #374151; /* A darker gray for the bar background */
    border-radius: 9999px;
    height: 1rem;
    margin-top: 1rem;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
}
.xp-bar {
    background-color: #3b82f6; /* Blue for the progress fill */
    height: 1rem;
    border-radius: 9999px;
    transition: width 0.5s ease-in-out;
}
.level-up-animation {
    animation: level-up-glow 1.5s ease-out;
}
@keyframes level-up-glow {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); }
    50% { transform: scale(1.2); box-shadow: 0 0 20px 10px rgba(251, 191, 36, 0.5); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); }
}		

/* --- Leveling System Icon Styles --- */
.level-badge-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    box-shadow:
        inset 0 2px 4px rgba(255, 255, 255, 0.4),
        inset 0 -2px 4px rgba(0, 0, 0, 0.3),
        0 4px 8px rgba(0, 0, 0, 0.5);
    overflow: hidden;
    transition: transform 0.3s ease-in-out, filter 0.3s ease, box-shadow 0.5s ease-in-out;
    border: 2px solid;
    cursor: pointer;
    background-size: 200% 200%;
    background-position: 50% 50%;
}

.level-badge-wrapper:hover {
    transform: scale(1.08);
    filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.3));
}

/* --- Rank Colors & Base Icons --- */
.level-badge-newbie { background: linear-gradient(145deg, #a3b18a, #588157); border-color: #3a5a40; }
.level-badge-apprentice { background: linear-gradient(145deg, #d7a98c, #a05d2d); border-color: #8c582c; }
.level-badge-journeyman { background: linear-gradient(145deg, #afb7c5, #7d8491); border-color: #555c63; }
.level-badge-artisan { background: linear-gradient(145deg, #93c5fd, #3b82f6); border-color: #2563eb; }
.level-badge-expert { background: linear-gradient(145deg, #a5b4fc, #6366f1); border-color: #4f46e5; }

/* --- Higher Tier Colors & Glow Variables --- */
.level-badge-master { background: linear-gradient(145deg, #ffd700, #ffb800); border-color: #e6a700; --glow-color: #ffd700; --gem-color: #ffd700;}
.level-badge-grandmaster { background: linear-gradient(145deg, #d8b4fe, #a855f7); border-color: #9333ea; --glow-color: #a855f7; --gem-color: #d8b4fe;}
.level-badge-legend { background: linear-gradient(145deg, #fb923c, #ef4444, #b91c1c); border-color: #991b1b; --glow-color: #ef4444; --gem-color: #fca5a5; }
.level-badge-demigod { background: linear-gradient(145deg, #7dd3fc, #0284c7); border-color: #0369a1; --glow-color: #38bdf8; --gem-color: #7dd3fc;}
.level-badge-deity { background: radial-gradient(ellipse at center, #f1f5f9 0%, #94a3b8 50%, #020617 100%); border-color: #cbd5e1; --glow-color: #f8fafc; --gem-color: #ffffff; }

/* --- Font Awesome Icon Styling (Gradient Fill) --- */
.level-badge-wrapper i {
    color: transparent;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-size: 2.5rem;
    position: relative;
    z-index: 20;
}

/* First 5 icons set to solid white */
.level-badge-newbie i,
.level-badge-apprentice i,
.level-badge-journeyman i,
.level-badge-artisan i,
.level-badge-expert i { 
    background-image: none;
    -webkit-text-stroke: 0;
    color: white;
    -webkit-text-fill-color: white;
}

.level-badge-master i { background-image: linear-gradient(to bottom, #fcebb8, #ffd700); -webkit-text-stroke: 1px #e6a700; }
.level-badge-grandmaster i { background-image: linear-gradient(to bottom, #e7c8ff, #d8b4fe); -webkit-text-stroke: 1px #a855f7; }
.level-badge-legend i { background-image: linear-gradient(to bottom, #fdd2d2, #fca5a5); -webkit-text-stroke: 1px #ef4444; }
.level-badge-demigod i { background-image: linear-gradient(to bottom, #bae6fd, #7dd3fc); -webkit-text-stroke: 1px #0ea5e9; }

/* --- Decorative Elements & Layers --- */
.beveled-edge::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 50%;
    box-shadow: inset 0 3px 6px rgba(255, 255, 255, 0.4), inset 0 -3px 6px rgba(0, 0, 0, 0.4);
    z-index: 10;
}

.inner-ring::before {
    content: '';
    position: absolute;
    inset: 5px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
    z-index: 1;
}

.emblem-ring-gem::before {
    content: '';
    position: absolute;
    top: -2px; left: 50%;
    transform: translateX(-50%);
    width: 8px; height: 8px;
    border-radius: 50%;
    background: radial-gradient(circle at center, white 0%, var(--gem-color) 80%);
    box-shadow: 0 0 5px 2px var(--gem-color);
    z-index: 20;
}

.layered-emblem::after {
    content: '\f005'; /* Font Awesome star */
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    position: absolute;
    font-size: 2rem;
    color: rgba(255, 255, 255, 0.1);
    z-index: 5;
    text-shadow: none;
}

/* --- Animation & Effects --- */
.master-shine-effect::before {
    content: '';
    position: absolute;
    inset: -2px;
    border-radius: 50%;
    background: conic-gradient(from 0deg, transparent 0%, rgba(255, 255, 255, 0.4) 10%, transparent 25%);
    animation: rotate-shine 4s linear infinite;
    z-index: 6;
}
@keyframes rotate-shine {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
.master-shine-effect i {
    animation: master-pulse 2s ease-in-out infinite;
}
@keyframes master-pulse {
    0%, 100% { transform: scale(1); filter: drop-shadow(0 0 2px #fff); }
    50% { transform: scale(1.05); filter: drop-shadow(0 0 5px #fff); }
}

.grandmaster-crystal-pulse {
    animation: grandmaster-bg-pulse 3s ease-in-out infinite;
}
@keyframes grandmaster-bg-pulse {
    0%, 100% {
        box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), inset 0 -2px 4px rgba(0, 0, 0, 0.3), 0 4px 8px rgba(0, 0, 0, 0.5), 0 0 15px var(--glow-color);
    }
    50% {
        box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), inset 0 -2px 4px rgba(0, 0, 0, 0.3), 0 4px 8px rgba(0, 0, 0, 0.5), 0 0 25px var(--glow-color), 0 0 10px #fff;
    }
}
.grandmaster-crystal-pulse::after { /* Targets the layered-emblem star */
    animation: star-flare 3s ease-in-out infinite;
}
@keyframes star-flare {
    0%, 100% { opacity: 0.5; transform: scale(1) rotate(0deg); color: rgba(255, 255, 255, 0.1); }
    50% { opacity: 0.8; transform: scale(1.1) rotate(10deg); color: rgba(255, 255, 255, 0.4); }
}
.grandmaster-crystal-pulse i {
    animation: crown-pulse 3s ease-in-out infinite;
}
@keyframes crown-pulse {
    0%, 100% { transform: scale(1); filter: drop-shadow(0 0 3px #fff); }
    50% { transform: scale(1.1); filter: drop-shadow(0 0 8px #fff); }
}

.legend-molten-core {
    background-size: 300% 300%;
    animation: molten-flow 4s ease-in-out infinite;
    overflow: visible;
}
@keyframes molten-flow {
    0% { background-position: 50% 0%; box-shadow: 0 0 15px var(--glow-color), 0 0 20px #dc2626, inset 0 0 10px rgba(255, 255, 255, 0.2); }
    50% { background-position: 50% 100%; box-shadow: 0 0 25px var(--glow-color), 0 0 35px #dc2626, inset 0 0 10px rgba(255, 255, 255, 0.2); }
    100% { background-position: 50% 0%; box-shadow: 0 0 15px var(--glow-color), 0 0 20px #dc2626, inset 0 0 10px rgba(255, 255, 255, 0.2); }
}
.legend-molten-core i {
    animation: dragon-heat 2s infinite ease-in-out;
}
@keyframes dragon-heat {
    0%, 100% { filter: drop-shadow(0 0 2px #fef08a); }
    50% { filter: drop-shadow(0 0 6px #fef08a); }
}

.flame { position: absolute; top: 50%; left: 50%; width: 6px; height: 6px; border-radius: 50%; background: radial-gradient(circle, #fef08a 0%, #fb923c 50%, transparent 70%); box-shadow: 0 0 5px #ef4444; opacity: 0; pointer-events: none; }
.flame.f1 { animation: erupt-1 2.2s ease-out infinite; animation-delay: 0s; }
.flame.f2 { width: 5px; height: 5px; animation: erupt-2 2.5s ease-out infinite; animation-delay: 0.6s; }
.flame.f3 { width: 7px; height: 7px; animation: erupt-3 2s ease-out infinite; animation-delay: 1.3s; }
@keyframes erupt-1 { 0% { transform: translate(-50%, -50%) scale(0.6); opacity: 1; } 100% { transform: translate(-90px, -70px) scale(0); opacity: 0; } }
@keyframes erupt-2 { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(80px, 100px) scale(0); opacity: 0; } }
@keyframes erupt-3 { 0% { transform: translate(-50%, -50%) scale(0.7); opacity: 1; } 100% { transform: translate(30px, -110px) scale(0); opacity: 0; } }

.demigod-power-surge { overflow: visible; }
.demigod-power-surge::before,
.demigod-power-surge::after { content: ''; position: absolute; inset: -2px; border-radius: 50%; z-index: 0; animation: power-surge-flicker 1.2s infinite linear; }
.demigod-power-surge::after { animation-delay: -0.6s; }
@keyframes power-surge-flicker {
    0% { box-shadow: 0 0 6px 2px var(--glow-color), 0 0 8px 4px #7dd3fc, 0 0 10px 6px #fff; opacity: 1; }
    50% { box-shadow: 0 0 10px 4px var(--glow-color), 0 0 14px 8px #7dd3fc, 0 0 18px 10px #fff; opacity: 0.7; }
    100% { box-shadow: 0 0 6px 2px var(--glow-color), 0 0 8px 4px #7dd3fc, 0 0 10px 6px #fff; opacity: 1; }
}
.demigod-power-surge i { animation: bolt-pulse 1.2s infinite ease-in-out; }
@keyframes bolt-pulse {
    0%, 100% { transform: scale(1); filter: drop-shadow(0 0 3px #fff); }
    50% { transform: scale(1.1); filter: drop-shadow(0 0 8px #fff); }
}

.divine-radiance { position: absolute; inset: 0; border-radius: 50%; pointer-events: none; }
.divine-radiance::before,
.divine-radiance::after { content: ''; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); border-radius: 50%; }
.divine-radiance::before { width: 100%; height: 100%; box-shadow: 0 0 10px 2px #f8fafc, 0 0 20px 8px rgba(203, 213, 225, 0.5); animation: breathing-aura 4s ease-in-out infinite; z-index: -1; }
@keyframes breathing-aura {
    0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
    50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
}
.divine-radiance::after { width: 100%; height: 100%; box-shadow: 0 0 0 0px #ffffff; animation: energy-burst 5s ease-out infinite; z-index: -2; animation-delay: 1s; }
@keyframes energy-burst {
    0% { transform: translate(-50%, -50%) scale(0.8); box-shadow: 0 0 5px 2px #ffffff; opacity: 1; }
    15% { transform: translate(-50%, -50%) scale(1.8); box-shadow: 0 0 20px 10px #ffffff; opacity: 0; }
    100% { transform: translate(-50%, -50%) scale(1.8); opacity: 0; }
}
.deity-particles { overflow: visible; }
.particle { position: absolute; background: var(--glow-color); border-radius: 50%; animation: orbit 6s linear infinite; }
.p1 { width: 3px; height: 3px; animation-delay: -1s; }
.p2 { width: 2px; height: 2px; animation-delay: -2s; }
.p3 { width: 4px; height: 4px; animation-delay: -3.5s; }
@keyframes orbit {
    0% { transform: rotate(0deg) translateX(55px) rotate(0deg) scale(1); opacity: 1;}
    50% { opacity: 0.8; }
    100% { transform: rotate(360deg) translateX(55px) rotate(-360deg) scale(0.8); opacity: 1;}
}

.gleam-container { position: absolute; inset: 0; border-radius: 50%; overflow: hidden; z-index: 15; }
.gleam-container::after { content: ''; position: absolute; top: -10%; left: -150%; width: 50%; height: 120%; background: linear-gradient(to right, transparent 0%, rgba(255, 255, 255, 0.4) 50%, transparent 100%); transform: rotate(-35deg); animation: celestial-gleam 5s ease-in-out infinite; animation-delay: 1.5s; }
@keyframes celestial-gleam { 0% { left: -150%; } 25% { left: 150%; } 100% { left: 150%; } }

.deity-glyph { width: 3.8rem; height: 3.8rem; position: relative; z-index: 20; animation: glyph-rotate 20s linear infinite; }
@keyframes glyph-rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

/* Kept your rank up glow for the level-up event */
.rank-up-glow {
    animation: rank-up-animation 1.5s ease-out;
}
@keyframes rank-up-animation {
    0% { transform: scale(0.9); opacity: 0.8; }
    50% { transform: scale(1.1); opacity: 1; filter: drop-shadow(0 0 15px rgba(251, 191, 36, 0.8)); }
    100% { transform: scale(1); opacity: 1; filter: none; }
}	

/* Add these styles to your <style> block */
.leaderboard-entry {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    background-color: rgba(31, 41, 55, 0.5); /* bg-gray-700 with opacity */
    border-radius: 0.75rem;
    transition: all 0.2s ease-in-out;
}
.leaderboard-entry:hover {
    transform: scale(1.02);
    background-color: rgba(55, 65, 81, 0.7); /* bg-gray-600 with opacity */
}
.leaderboard-rank {
    font-size: 1.125rem;
    font-weight: bold;
    width: 2.5rem;
    text-align: center;
    color: #9ca3af; /* text-gray-400 */
}
.leaderboard-rank.top-1 { color: #fBBF24; } /* A golden color */
.leaderboard-rank.top-2 { color: #d1d5db; } /* A silver color */
.leaderboard-rank.top-3 { color: #d97706; } /* A bronze color */

.leaderboard-details {
    margin-left: 1rem;
    flex-grow: 1;
}
.leaderboard-xp {
    font-weight: bold;
    color: #34d399; /* A nice green color */
}

/* --- Shiny 3D Achievement Icon Styles --- */
.achievement-icon-wrapper {
  /* This wrapper holds the icon and its styles */
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 48px;  /* 3rem */
  height: 48px; /* 3rem */
  border-radius: 50%;
  box-shadow: 
    inset 0 2px 4px rgba(255, 255, 255, 0.4), /* Inner top highlight */
    inset 0 -2px 4px rgba(0, 0, 0, 0.3),    /* Inner bottom shadow */
    0 4px 8px rgba(0, 0, 0, 0.5);          /* Drop shadow */
  overflow: hidden; /* This is crucial for the glare effect */
  border: 2px solid;
  transition: transform 0.2s ease-in-out;
}

.achievement-icon-wrapper i {
  /* Styles the Font Awesome icon inside */
  font-size: 1.5rem; /* 24px */
  color: rgba(0, 0, 0, 0.6);
  text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.2);
}

/* The Glare Effect */
.achievement-icon-wrapper::after {
  content: '';
  position: absolute;
  top: -10px;
  left: -20px;
  width: 25px;
  height: 70px;
  background: linear-gradient(to bottom, 
    rgba(255, 255, 255, 0.6) 0%, 
    rgba(255, 255, 255, 0.2) 50%, 
    rgba(255, 255, 255, 0) 100%
  );
  transform: rotate(25deg);
}

/* Tier Colors */
.achievement-icon-gold {
  background: linear-gradient(145deg, #fceabb, #f8b500);
  border-color: #e6a700;
}
.achievement-icon-silver {
  background: linear-gradient(145deg, #e0e0e0, #b0b0b0);
  border-color: #a0a0a0;
}
.achievement-icon-bronze {
  background: linear-gradient(145deg, #d7a98c, #a05d2d);
  border-color: #8c582c;
}
.achievement-icon-default {
  background: linear-gradient(145deg, #a7c5eb, #6495ed);
  border-color: #5a88d6;
}
.achievement-icon-locked {
  background: linear-gradient(145deg, #555, #333);
  border-color: #222;
}
.achievement-icon-locked i {
  color: rgba(0, 0, 0, 0.4);
}
/* Additional Tier Colors */
.achievement-icon-blue {
  background: linear-gradient(145deg, #93c5fd, #3b82f6);
  border-color: #2563eb;
}
.achievement-icon-green {
  background: linear-gradient(145deg, #86efac, #22c55e);
  border-color: #16a34a;
}
.achievement-icon-teal {
  background: linear-gradient(145deg, #5eead4, #14b8a6);
  border-color: #0d9488;
}
.achievement-icon-indigo {
  background: linear-gradient(145deg, #a5b4fc, #6366f1);
  border-color: #4f46e5;
}
.achievement-icon-white {
  background: linear-gradient(145deg, #ffffff, #e5e5e5);
  border-color: #d4d4d4;
}
.achievement-icon-pink {
  background: linear-gradient(145deg, #f9a8d4, #ec4899);
  border-color: #db2777;
}
.achievement-icon-orange {
  background: linear-gradient(145deg, #fdba74, #f97316);
  border-color: #ea580c;
}
.achievement-icon-sky {
  background: linear-gradient(145deg, #7dd3fc, #0ea5e9);
  border-color: #0284c7;
}
.achievement-icon-lime {
  background: linear-gradient(145deg, #bef264, #84cc16);
  border-color: #65a30d;
}
.achievement-icon-cyan {
  background: linear-gradient(145deg, #67e8f9, #06b6d4);
  border-color: #0891b2;
}
.achievement-icon-purple {
  background: linear-gradient(145deg, #d8b4fe, #a855f7);
  border-color: #9333ea;
}
.achievement-icon-violet {
    background: linear-gradient(145deg, #c4b5fd, #8b5cf6);
    border-color: #7c3aed;
}
.achievement-icon-red {
    background: linear-gradient(145deg, #fca5a5, #ef4444);
    border-color: #dc2626;
}		

.update-indicator-pulse {
    animation: pulse-red 2s infinite;
}

@keyframes pulse-red {
    0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
    }
    70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
    }
    100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
    }
}		
        
/* Update the main modal container to be a full-screen overlay */
/* Refined modal container for full-screen overlay */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.25);
    z-index: 1001;
    display: flex; /* We want it to be a flex container when it's visible */
    justify-content: center;
    align-items: center;
}

/* This rule ensures that adding the 'hidden' class hides the modal completely */
.modal.hidden {
    display: none;
}

/* Base modal content styling, without positioning */
.modal-content {
    background-color: #1f2937;
    color: #e5e7eb;
    padding: 2.5rem;
    border-radius: 1rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
    width: 90%;
    max-width: 450px;
    position: absolute;
    transition: all 0.5s ease-in-out;
}

/* Tutorial Pop-up specific positioning */
/* Tutorial Pop-up specific positioning - REFACTORED FOR RESPONSIVENESS */
#tutorial-modal .modal-content {
    opacity: 0;
    transform: scale(0.95);
    /* Make sure transition is here for smooth animations */
    transition: all 0.5s ease-in-out; 
}

/* This is your default centered modal, it's perfect */
#tutorial-modal.show-modal .modal-content {
    opacity: 1;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(1);
}

/* Positioned near the top-right of the screen */
#tutorial-modal.top-right .modal-content {
    opacity: 1;
    top: 15%;
    left: 40%; /* Unset left */
    right: 10%; /* Anchor to the right */
    transform: translate(0, 0) scale(1);
    max-width: 400px;
}
		
/* Positioned near the top-left of the screen */
#tutorial-modal.top-left .modal-content {
    opacity: 1;
    top: 20%;
    left: 10%; /* Anchor to the left */
    right: auto; /* Unset right */
    transform: translate(-20%, -20%) scale(1);
    max-width: 400px;
}		

/* Positioned near the bottom-left of the screen */
#tutorial-modal.bottom-left .modal-content {
    opacity: 1;
    top: auto; /* Unset top */
    bottom: 25%; /* Anchor to the bottom */
    left: 40%;   /* Anchor to the left */
    right: auto; /* Unset right */
    transform: translate(0, 0) scale(1);
    max-width: 400px;
}

/* Positioned on the right, vertically centered (for highlighting a response) */
#tutorial-modal.on-response .modal-content {
    opacity: 1;
    top: 40%;
    left: auto;
    right: 30%;
    /* This vertically centers the popup next to the highlighted element */
    transform: translateY(-50%) scale(1); 
    max-width: 400px;
}

#tutorial-modal.pin-response .modal-content {
    opacity: 1;
    top: 30%;
    left: auto;
    right: 25%;
    /* This vertically centers the popup next to the highlighted element */
    transform: translateY(-50%) scale(1); 
    max-width: 400px;
}		

/* Position for the FedEx tracker page */
#tutorial-modal.on-tracker-page .modal-content {
    opacity: 1;
    top: 10%;
    left: 70%;
    right: 10%;
    transform: translate(-0, 0) scale(1);
    max-width: 400px;
}		
		
/* Positioned in the upper-right area of the screen */
#tutorial-modal.upper-right .modal-content {
    opacity: 1;
    top: 10%;
    left: auto;
    right: 15%;
    transform: translate(0, 0) scale(1);
    max-width: 400px;
}

/* Positioned on the left, vertically centered */
#tutorial-modal.left-response .modal-content {
    opacity: 1;
    top: 50%;
    left: 65%;
    right: 50%;
    /* This vertically centers the popup */
    transform: translate(-200%, -50%) scale(1); 
    max-width: 500px;
}	 	


        /* Add these rules to ensure proper z-indexing for highlighting */
#add-response-section,
#category-bar {
    position: relative;
}


@keyframes pulse-highlight {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(100, 160, 255, 0.4); }
    50% { transform: scale(1.01); box-shadow: 0 0 0 10px rgba(100, 160, 255, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(100, 160, 255, 0.4); }
}
		
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background-color: #1f2937;
            padding: 2.5rem 1.5rem;
            box-shadow: 4px 0 15px rgba(0,0,0,0.5);
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2000;
        }
        .sidebar.open {
            left: 0;
        }
        .pb-extra {
            padding-bottom: 2rem;
        }
        .scrollable-box {
            max-height: 250px;
            overflow-y: auto;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            background-color: #1f2937;
            box-shadow: 0 10px 15px -3-px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.5);
        }
        .tracking-numbers-container {
            background-color: #111827;
            border-color: #4a5568;
        }
        .tracking-tab {
            background-color: #2d3748;
            border-color: #4a5568;
        }
        .text-placeholder::placeholder {
            color: #a0aec0;
        }
        .main-card {
            background-color: rgba(22, 27, 34, 0.8);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            padding: 2rem;
            transition: all 0.3s ease;
        }
        .main-card:hover {
            transform: translateY(-5px);
        }
        .floating-card {
            background-color: rgba(22, 27, 34, 0.8);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .highlight {
            background-color: rgba(255, 255, 0, 0.3);
            color: #000;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .highlight-placeholder {
            color: #80e8ff; /* A color that stands out from the prose */
            font-weight: 700;
            background-color: rgba(128, 232, 255, 0.1);
            padding: 2px 4px;
            border-radius: 4px;
        }

        .highlight-target {
            position: relative; /* This is crucial for z-index to work */
            z-index: 1000;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            border-radius: 1rem; /* Adjust this to match your modal's border radius */
            animation: pulse-highlight 1.5s infinite;

            /* ADD THIS LINE to give the element a permanent, bright glow */
            border: 3px solid white; /* Adds a solid, white border for more visibility */
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.8)); /* Adds a soft glow effect */		
        }

		/* Light Mode Highlighting Effect */
body.light-mode .highlight-target {
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.2);
    border: 3px solid #1f2937;
    filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.8));
    animation: pulse-highlight-light 1.5s infinite;
}

@keyframes pulse-highlight-light {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(100, 160, 255, 0.4); }
    50% { transform: scale(1.01); box-shadow: 0 0 0 10px rgba(100, 160, 255, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(100, 160, 255, 0.4); }
}

        /* Light Mode Styles */
        body.light-mode {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .light-mode .container-bg {
            background-color: #f9fafb;
            background-image: radial-gradient(at 0% 0%, hsla(215,90%,55%,0.15) 0, transparent 50%),
                                 radial-gradient(at 100% 100%, hsla(280,90%,70%,0.15) 0, transparent 50%);
        }
        .light-mode .link-card, .light-mode .card-style, .light-mode .form-container, .light-mode .floating-card, .light-mode .main-card, .light-mode .sidebar, .light-mode .modal-content {
            background-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .light-mode .link-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .light-mode h1, .light-mode h2, .light-mode h3 {
            color: #1f2937;
        }
        .light-mode .link-title {
            background-image: none;
            -webkit-background-clip: unset;
            -webkit-text-fill-color: inherit;
            color: #1f2937;
        }
        .light-mode .text-placeholder::placeholder {
            color: #6b7280;
        }
        .light-mode #auth-status, .light-mode .text-gray-400 {
            color: #4b5563;
        }
        .light-mode .bg-gray-800 { background-color: #e5e7eb; }
        .light-mode .bg-gray-700 { background-color: #d1d5db; }
        .light-mode .bg-gray-600 { background-color: #9ca3af; }
        .light-mode .text-gray-100 { color: #1f2937; }
        .light-mode .text-gray-200 { color: #374151; }
        .light-mode .border-gray-600 { border-color: #9ca3af; }
        .light-mode .hover\:bg-gray-700:hover { background-color: #d1d5db; }
        .light-mode .hover\:text-white:hover { color: #1f2937; }
        .light-mode .tracking-numbers-container { background-color: #f3f4f6; }
        .light-mode .tracking-tab { background-color: #e5e7eb; }
		
        .kebab-button.active svg {
            transform: rotate(90deg);
            transition: transform 0.2s ease-in-out;
        }

        .kebab-button svg {
            transition: transform 0.2s ease-in-out;
        }

        /* Login Modal and Popup Styles */
        #login-popup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        #login-popup-modal.show {
            display: flex;
        }

        .login-popup {
            background-color: #1f2937;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            padding: 1.5rem;
            width: 90%;
            max-width: 350px;
            animation: fadeInModal 0.3s ease-in-out;
            z-index: 3001;
        }

        .light-mode .login-popup {
            background-color: rgba(255, 255, 255, 0.9);
            color: #111827;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        @keyframes fadeInModal {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

		/* Light Mode Styles for Tutorial Modal */
body.light-mode #tutorial-modal .modal-content {
    background-color: rgba(243, 244, 246, 0.9); /* Lighter background */
    color: #111827; /* Dark text */
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

body.light-mode #tutorial-modal h3,
body.light-mode #tutorial-modal h4 {
    color: #3b82f6; /* A contrasting blue for headings */
}

body.light-mode #tutorial-modal p,
body.light-mode #tutorial-modal ul {
    color: #4b5563; /* Darker text for readability */
}

body.light-mode #tutorial-modal .bg-gray-800 {
    background-color: #e5e7eb; /* Adjusting the info box color */
    border-color: #d1d5db;
}
/* Inside your style block */
/* Buttons in dark mode (default) */
#tutorial-back-btn { background-color: #4b5563; color: #e5e7eb; }
#tutorial-next-btn { background-color: #2563eb; color: #ffffff; }
#tutorial-finish-btn { background-color: #16a34a; color: #ffffff; }

/* Buttons in light mode */
body.light-mode #tutorial-back-btn { background-color: #d1d5db; color: #1f2937; }
body.light-mode #tutorial-next-btn { background-color: #3b82f6; color: #ffffff; }
body.light-mode #tutorial-finish-btn { background-color: #22c55e; color: #ffffff; }

/* Button hover effects */
#tutorial-back-btn:hover { background-color: #6b7280; }
body.light-mode #tutorial-back-btn:hover { background-color: #9ca3af; }
#tutorial-next-btn:hover { background-color: #3b82f6; }
body.light-mode #tutorial-next-btn:hover { background-color: #3b82f6; }
#tutorial-finish-btn:hover { background-color: #22c55e; }
body.light-mode #tutorial-finish-btn:hover { background-color: #4ade80; }

    </style>
		
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">

    <link rel="shortcut icon" href="favicon.ico">

    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">

    <link rel="manifest" href="site.webmanifest">
</head>
<body class="flex flex-col min-h-screen bg-gray-900 relative">

	<div id="full-page-loader" class="fixed inset-0 bg-gray-900 flex justify-center items-center z-[9999]">
        <svg class="animate-spin h-12 w-12 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <audio id="level-up-sound" src="level-up.mp3" preload="auto"></audio> 
	<audio id="achievement-sound" src="achievement.mp3" preload="auto"></audio>

    <div id="tutorial-overlay" class="fixed inset-0 bg-black bg-opacity-75 hidden z-[999]"></div>

    <div id="sidebar" class="sidebar flex flex-col">
        <h2 class="text-3xl font-extrabold text-gray-100 mb-8">Tools </h2>
        <nav class="flex flex-col space-y-3">
            <button id="nav-canned-responses" class="w-full text-left px-5 py-3 rounded-xl hover:bg-gray-700 transition duration-300 text-gray-200 font-semibold text-lg">
                <i class="fas fa-comment-dots mr-3"></i> Canned Responses
            </button>
            <button id="nav-fedex-tracker" class="w-full text-left px-5 py-3 rounded-xl hover:bg-gray-700 transition duration-300 text-gray-200 font-semibold text-lg">
                <i class="fas fa-box-open mr-3"></i> FedEx Tracker
            </button>
            <button id="nav-helpful-links" class="w-full text-left px-5 py-3 rounded-xl hover:bg-gray-700 transition duration-300 text-gray-200 font-semibold text-lg">
                <i class="fas fa-link mr-3"></i> Helpful Links
            </button>
			
		    <button id="nav-my-stats" class="w-full text-left px-5 py-3 rounded-xl hover:bg-gray-700 transition duration-300 text-gray-200 font-semibold text-lg">
		        <i class="fas fa-chart-line mr-3"></i> My Stats
		    </button>
			
            <button id="nav-settings" class="w-full text-left px-5 py-3 rounded-xl hover:bg-gray-700 transition duration-300 text-gray-200 font-semibold text-lg">
                <i class="fas fa-cog mr-3"></i> Settings
				<span id="settings-update-indicator" class="hidden absolute top-3 right-3 h-3 w-3 rounded-full bg-red-500"></span>
            </button>
        </nav>
        <button id="close-sidebar-btn" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-700 transition duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>

    <div id="main-content" class="flex-1 p-6 sm:p-10 flex flex-col items-center transition-all duration-300 ease-in-out">
        <header class="w-full mb-8">
            <div class="flex items-center justify-between relative">
                <button id="hamburger-menu-btn" class="p-2 rounded-full hover:bg-gray-700 transition duration-300 relative z-1000" aria-label="Open Menu">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <div class="flex items-center space-x-4">
                    <h1 id="main-title" class="text-3xl sm:text-5xl font-extrabold text-gray-100 transition-colors duration-300">Canned Responses</h1>
                    <div id="category-menu-container" class="relative">
                        <button id="category-actions-btn" class="kebab-button p-2 rounded-full hover:bg-gray-700 transition duration-300 relative hidden" aria-expanded="true" aria-haspopup="true">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                            </svg>
                        </button>
                        <div id="category-actions-menu" class="hidden absolute top-full right-0 mt-3 w-56 bg-gray-700 rounded-xl shadow-2xl z-50 transform scale-95 opacity-0 transition-all duration-300 origin-top-right">
                            <button id="rename-category-btn" class="w-full text-left px-5 py-3 hover:bg-gray-600 rounded-t-xl transition duration-200"><i class="fas fa-pencil-alt mr-2"></i>Rename Category</button>
                            <button id="delete-category-btn" class="w-full text-left px-5 py-3 hover:bg-gray-600 text-red-400 transition duration-200"><i class="fas fa-trash-alt mr-2"></i>Delete Category</button>
                            <button id="change-color-btn" class="w-full text-left px-5 py-3 hover:bg-gray-600 rounded-b-xl transition duration-200"><i class="fas fa-palette mr-2"></i>Change Color</button>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="import-export-btn-placeholder" class="p-2 text-gray-400 hover:text-blue-400 transition duration-300 hidden" aria-label="Import/Export Data">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div id="category-bar" class="mt-6 p-4 bg-gray-800 shadow-2xl flex items-center justify-between rounded-2xl">
                <div class="flex-grow overflow-x-auto whitespace-nowrap scrollbar-hide">
                    <div id="category-list" class="flex gap-4">
                        </div>
                </div>
                <button id="add-category-btn" class="flex-shrink-0 ml-4 bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-blue-700 transition duration-300">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </header>

        <div id="message-box" class="message-box"></div>

        <div id="canned-responses-app" class="w-full container-bg rounded-2xl p-6 sm:p-10 text-gray-100 min-h-screen flex items-start justify-center py-12 hidden">
            <div class="w-full max-w-7xl mx-auto flex flex-col md:flex-row gap-8">
                <div class="w-full md:w-1/3 flex flex-col">
                    <div id="search-bar-container" class="floating-card mb-8 relative p-6 sm:p-8">
                        <div class="absolute inset-y-0 left-0 pl-11 flex items-center pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input
                            type="text"
                            id="search-input"
                            class="w-full border-2 border-gray-600 rounded-xl p-4 pl-12 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg text-placeholder"
                            placeholder="Search responses..."
                        />
                    </div>
                    
                    <div id="add-response-section" class="floating-card mb-8 p-6 sm:p-8 flex justify-center items-start">
                        <button id="open-add-response-modal-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-blue-700 transition duration-300">
                            <i class="fas fa-plus mr-2"></i> Add New Response
                        </button>
                    </div>
                </div>

                <div class="w-full md:w-2/3">
                    <div id="responses-container" class="w-full floating-card p-6 sm:p-8">
                        <h2 id="responses-heading" class="text-3xl font-bold text-gray-200 mb-6 hidden"></h2>
                        
                        <div id="responses-list" class="space-y-6">
                            </div>
                        <div id="empty-state" class="text-center text-gray-400 mt-8 hidden">
                            <p class="text-lg">No canned responses in this category. Add one above!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="fedex-tracker-app" class="w-full container-bg rounded-2xl p-6 sm:p-10 text-gray-100 min-h-screen flex items-center justify-center py-12 hidden">
            <div class="main-card p-8 w-full max-w-2xl mx-auto">
                <h1 class="text-4xl font-bold text-center text-gray-100 mb-4">FedEx Tracking</h1>
                <p class="text-center text-gray-400 mb-8 text-lg">Extract and manage your FedEx tracking numbers easily.</p>
		
                <div class="mb-6">
                    <label for="input-text" class="block text-sm font-medium text-gray-300 mb-2">Paste or type your text here:</label>
                    <textarea id="input-text-fedex" rows="8" class="text-placeholder w-full p-4 border-2 border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-800 text-gray-100 transition duration-300 text-lg" placeholder="e.g., 'Your package with tracking number 794829370821 has been shipped.'"></textarea>
                </div>
		
                <div class="mb-6">
                    <h2 class="text-2xl font-semibold text-gray-200 mb-4">Extracted Tracking Numbers</h2>
                    <div id="tracking-numbers-container" class="tracking-numbers-container border-2 border-dashed border-gray-700 rounded-xl p-4 scrollable-box shadow-inner">
                        <p id="no-numbers-message" class="text-center text-gray-500 text-base">No tracking numbers found yet.</p>
                        <div id="loading-indicator" class="hidden flex justify-center items-center">
                            <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-base text-gray-400">Processing...</span>
                        </div>
                    </div>
                </div>
		
                <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <button id="clear-button-fedex" class="w-full sm:w-auto bg-gray-700 text-gray-200 font-semibold py-3 px-8 rounded-xl shadow-md hover:bg-gray-600 transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-400 disabled:opacity-50">
                        Clear
                    </button>
                    <button id="copy-button-fedex" class="w-full sm:w-auto bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 disabled:bg-indigo-300">
                        <svg class="h-5 w-5 inline-block -mt-1 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2H6z" />
                        </svg>
                        Copy All & Open FedEx
                    </button>
                </div>
            </div>
        </div>

<div id="helpful-links-app" class="w-full hidden container-bg rounded-2xl p-6 sm:p-10 text-gray-100 min-h-screen flex items-center justify-center py-12">
    <div class="container mx-auto px-4">
        <div id="links-search-bar-container" class="floating-card mb-8 relative p-6 sm:p-8">
            <div class="absolute inset-y-0 left-0 pl-11 flex items-center pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            <input
                type="text"
                id="links-search-input"
                class="w-full border-2 border-gray-600 rounded-xl p-4 pl-12 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg text-placeholder"
                placeholder="Search helpful links..."
            />
        </div>
        <header class="text-center mb-16 animate-fade-in">
                </header>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    
                    <section class="col-span-1 md:col-span-2 lg:col-span-3">
                        <h2 class="text-3xl font-bold text-center mb-8 link-title">
                            Static Resources
                        </h2>
                        <div id="static-links-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <p class="text-center text-gray-400 col-span-full">Loading static links...</p>
                        </div>
                    </section>
                    
                    <section id="user-links-section" class="col-span-1 md:col-span-2 lg:col-span-3 mt-12">
                        <h2 class="text-3xl font-bold text-center mb-8 link-title">
                            Your Links
                        </h2>
                        <div id="user-links-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <p class="text-center text-gray-400 col-span-full">No links added yet. Add one above!</p>
                        </div>
                    </section>

                    <section id="add-link-section" class="col-span-1 md:col-span-2 lg:col-span-3 flex justify-center">
                        <div class="floating-card rounded-2xl p-8 max-w-lg w-full">
                            <h2 id="form-title" class="text-2xl font-bold text-blue-400 mb-4">Add a New Link</h2>
                            <form id="add-link-form" class="space-y-4">
                                <div>
                                    <label for="link-title" class="block text-sm font-medium text-gray-400">Title</label>
                                    <input type="text" id="link-title" required class="mt-1 block w-full bg-gray-700 text-white border-2 border-gray-600 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg p-3 transition duration-300">
                                </div>
                                <div>
                                    <label for="link-url" class="block text-sm font-medium text-gray-400">URL</label>
                                    <input type="url" id="link-url" required class="mt-1 block w-full bg-gray-700 text-white border-2 border-gray-600 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg p-3 transition duration-300">
                                </div>
                                <div>
                                    <label for="link-description" class="block text-sm font-medium text-gray-400">Description (Optional)</label>
                                    <input type="text" id="link-description" class="mt-1 block w-full bg-gray-700 text-white border-2 border-gray-600 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg p-3 transition duration-300">
                                </div>
                                <div class="flex space-x-4">
                                    <button type="submit" id="submit-button" class="w-full inline-flex justify-center py-3 px-6 border border-transparent shadow-lg text-lg font-bold rounded-xl text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">
                                        Add Link
                                    </button>
                                    <button type="button" id="cancel-button" class="w-full inline-flex justify-center py-3 px-6 border border-gray-600 shadow-md text-lg font-bold rounded-xl text-gray-300 bg-gray-700 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-300 hidden">
                                        Cancel
                                    </button>
                                </div>
                                <div id="status-message" class="text-center mt-2 text-sm text-gray-400"></div>
                            </form>
                        </div>
                    </section>
                </div>
            </div>
        </div>
		
        <div id="settings-page" class="w-full container-bg rounded-2xl p-6 sm:p-10 text-gray-100 min-h-screen flex items-start justify-center py-12 hidden">
            <div class="w-full max-w-7xl mx-auto space-y-8 md:flex md:flex-wrap md:gap-8">
                
                <div class="floating-card p-6 sm:p-8 flex flex-col items-center flex-1 md:w-1/2 min-h-full">
                    <h2 class="text-2xl font-bold text-gray-200 mb-4 flex items-center">
                        <i class="fas fa-user-circle mr-3 text-3xl text-blue-400"></i> Account
                    </h2>
                    <div id="auth-status-settings" class="text-center text-gray-400 font-medium mb-4">Not signed in.</div>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 w-full justify-center">
                        <button id="sign-in-btn-settings" class="w-full sm:w-auto text-center px-5 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 transition duration-300 shadow-lg hidden">
                            <i class="fas fa-sign-in-alt mr-2"></i> Sign In with Google
                        </button>
                        <button id="sign-out-btn-settings" class="w-full sm:w-auto text-center px-5 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 transition duration-300 shadow-lg hidden">
                            <i class="fas fa-sign-out-alt mr-2"></i> Sign Out
                        </button>
                    </div>
                </div>

                <div class="floating-card p-6 sm:p-8 flex-1 md:w-1/2 min-h-full space-y-6">
                    <h2 class="text-2xl font-bold text-gray-200 mb-4 flex items-center">
                        <i class="fas fa-paint-brush mr-3 text-3xl text-purple-400"></i> Appearance
                    </h2>
                    <div class="flex items-center justify-between border-t border-gray-600 pt-6">
                        <span class="text-lg text-gray-300">Dark / Light Mode</span>
                        <button id="theme-toggle-btn-settings" class="px-5 py-3 rounded-xl bg-gray-700 text-white font-bold hover:bg-gray-600 transition duration-300 shadow-lg">
                            <i id="theme-icon-settings" class="fas fa-moon mr-2"></i> Toggle Theme
                        </button>
                    </div>
                    <div class="flex items-center justify-between border-t border-gray-600 pt-6">
                        <span class="text-lg text-gray-300">Check for New Content</span>
                        <button id="check-updates-btn-settings" class="px-5 py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition duration-300 shadow-lg">
                            <i class="fas fa-sync-alt mr-2"></i> Check for Updates
							<span id="check-updates-indicator" class="hidden absolute -top-1 -right-1 h-3 w-3 rounded-full bg-red-500 border-2 border-gray-800"></span>
                        </button>
                    </div>
                </div>

                <div class="floating-card p-6 sm:p-8 flex flex-col items-center md:w-full">
                    <h2 class="text-2xl font-bold text-gray-200 mb-4 flex items-center">
                        <i class="fas fa-database mr-3 text-3xl text-green-400"></i> Data Management
                    </h2>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 w-full justify-center">
                        <button id="import-export-btn-settings" class="w-full sm:w-auto text-center px-5 py-3 rounded-xl bg-gray-700 text-white font-bold hover:bg-gray-600 transition duration-300 shadow-lg">
                            <i class="fas fa-exchange-alt mr-2"></i> Import / Export
                        </button>
                    </div>
                    <div id="tutorial-reset-section" class="flex items-center justify-between border-t border-gray-600 pt-6 mt-6 w-full hidden">
                        <span class="text-lg text-gray-300">Tutorial</span>
                        <button id="show-tutorial-btn" class="px-5 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 transition duration-300 shadow-lg">
                            <i class="fas fa-book mr-2"></i> Show Me Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div id="my-stats-page" class="w-full container-bg rounded-2xl p-6 sm:p-10 text-gray-100">
    <div id="stats-loader" class="flex justify-center items-center h-full pt-24">
        <svg class="animate-spin h-10 w-10 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <div id="stats-content" class="w-full max-w-7xl mx-auto space-y-8 hidden">
        <div id="leveling-section" class="floating-card p-6 sm:p-8 flex flex-col md:flex-row items-center gap-6">
            <div id="rank-icon-container" class="text-6xl md:text-8xl w-24 h-24 flex-shrink-0 flex items-center justify-center text-gray-400">
                <i class="fas fa-seedling"></i>
            </div>
            <div class="flex-grow w-full text-center md:text-left">
                <div class="flex items-center justify-center md:justify-start gap-4">
                    <h3 id="rank-name" class="text-3xl font-bold text-gray-100">Newbie</h3>
                    <span id="level-display" class="px-3 py-1 bg-blue-600 text-white text-lg font-bold rounded-full">Level 1</span>
                </div>
                <div class="xp-bar-container">
                    <div id="xp-bar" class="xp-bar" style="width: 0%;"></div>
                </div>
                <p id="xp-progress-text" class="text-gray-400 mt-2 text-sm">0 / 100 XP</p>
            </div>
        </div>

        <div id="achievements-module" class="floating-card p-6 sm:p-8">
            <div class="flex flex-col sm:flex-row items-center justify-between mb-4 gap-4">
				 <h2 class="text-2xl font-bold text-gray-200 mb-4 flex items-center">
				    🏆 Achievements
				</h2>
                <div class="flex items-center gap-4">
                    <div id="achievement-tabs" class="flex gap-2 text-sm">
                        <button class="achievement-tab px-4 py-2 rounded-lg font-semibold bg-blue-600 text-white" data-filter="all">All</button>
                        <button class="achievement-tab px-4 py-2 rounded-lg font-semibold text-gray-300 hover:bg-gray-700 transition" data-filter="unlocked">Unlocked</button>
                    </div>
                    <div class="text-right">
                        <p id="ach-progress-text" class="text-lg font-semibold text-gray-300">0 / 0 Unlocked</p>
                        <div class="w-24 h-2 bg-gray-700 rounded-full mt-1">
                            <div id="ach-progress-bar" class="h-full bg-indigo-500 rounded-full transition-all duration-500" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="achievements-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4 overflow-y-auto max-h-[340px] p-2 scrollbar-hide">
                </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="floating-card p-6 sm:p-8 lg:col-span-1">
                <h2 class="text-2xl font-bold text-gray-200 mb-4 flex items-center">
				    ⚡️ Activity Snapshot
				</h2>
                <div id="metric-badges-container" class="grid grid-cols-2 gap-4">
                    </div>
            </div>
            <div class="floating-card p-6 sm:p-8 lg:col-span-1">
				<h2 class="text-2xl font-bold text-gray-200 mb-4 flex items-center">
				    🏃 Active Challenges
				</h2>
                <div id="challenges-container" class="space-y-4">
                    </div>
            </div>
            <div class="floating-card p-6 sm:p-8 lg:col-span-1">
				<h2 class="text-2xl font-bold text-gray-200 mb-4 flex items-center">
				    ⭐ Leaderboard
				</h2>
                <div id="leaderboard-container" class="space-y-2">
                    </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="floating-card p-6 sm:p-8">
                <h2 class="text-2xl font-bold text-gray-200 mb-4 flex items-center">
                    <i class="fas fa-chart-bar mr-3 text-3xl text-teal-400"></i> Top 5 Responses
                </h2>
                <div id="stats-container" class="w-full relative h-64 sm:h-80">
                    <canvas id="stats-chart"></canvas>
                </div>
            </div>
            <div class="floating-card p-6 sm:p-8">
                <h2 class="text-2xl font-bold text-gray-200 mb-4 flex items-center">
                    <i class="fas fa-pie-chart mr-3 text-3xl text-indigo-400"></i> Category Breakdown
                </h2>
                <div id="category-chart-container" class="relative h-64 sm:h-80">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <div class="floating-card p-6 sm:p-8">
            <h2 class="text-2xl font-bold text-gray-200 mb-4 flex items-center">
                <i class="fas fa-chart-line mr-3 text-3xl text-green-400"></i> Activity Over Time
            </h2>
            <div id="activity-chart-container" class="relative h-64 sm:h-80">
                <canvas id="activityChart"></canvas>
            </div>
        </div>
    </div>
</div>

    <div id="placeholder-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Customize Response</h3>
            <p class="text-gray-400 text-base mb-4">Please fill in the details for the placeholders below.</p>
            <div id="placeholder-inputs" class="space-y-4">
                </div>
            <div class="flex justify-end mt-6 space-x-4">
                <button id="cancel-placeholder-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="confirm-placeholder-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Copy Response
                </button>
            </div>
        </div>
    </div>

    <div id="edit-response-modal" class="modal hidden">
        <div class="modal-content w-full max-w-3xl" data-original-category="">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Edit Response</h3>
            <p class="text-gray-400 text-base mb-4">Modify the response, its label, or category below.</p>
            <div id="edit-form" class="space-y-4">
                <div>
                    <label for="edit-response-label" class="block text-sm font-medium text-gray-400">Label</label>
                    <input type="text" id="edit-response-label" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg" />
                </div>
                <div>
                    <label for="edit-response-text" class="block text-sm font-medium text-gray-400">Response Text</label>
                    <textarea id="edit-response-text" rows="15" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg"></textarea>
                </div>
                <div>
                    <label for="edit-category-select" class="block text-sm font-medium text-gray-400">Category</label>
                    <select id="edit-category-select" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg"></select>
                </div>
            </div>
            <div class="flex justify-end mt-6 space-x-4">
                <button id="cancel-edit-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="save-edit-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Save Changes
                </button>
            </div>
        </div>
    </div>


    <div id="import-export-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Import or Export Data</h3>
            <div class="flex flex-col space-y-4">
                <div>
                    <h4 class="font-semibold text-gray-400 text-lg">Export All Data</h4>
                    <p class="text-gray-400 text-base mb-2">Download a JSON file containing all your categories and responses.</p>
                    <button id="export-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition duration-300 shadow-lg">
                        <i class="fas fa-download mr-2"></i> Export to File
                    </button>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-400 text-lg">Import Data</h4>
                    <p class="text-gray-400 text-base mb-2">Upload a JSON file to restore your categories and responses. This will overwrite your current data.</p>
                    <input type="file" id="import-file-input" accept="application/json" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 transition duration-300">
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button id="close-import-export-modal-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Close
                </button>
            </div>
        </div>
    </div>

    <div id="new-response-modal" class="modal hidden">
        <div class="modal-content w-full max-w-3xl">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Create New Response</h3>
            <div id="add-response-form" class="space-y-4">
                <div>
                    <label for="new-response-label" class="block text-sm font-medium text-gray-400">Label (Optional)</label>
                    <input type="text" id="new-response-label" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg" placeholder="Enter a label (e.g., 'Customer Support')" />
                </div>
                <div>
                    <label for="new-response-text" class="block text-sm font-medium text-gray-400">Response Text</label>
                    <textarea id="new-response-text" rows="15" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg" placeholder="Type your new canned response here..."></textarea>
                </div>
                <div>
                    <label for="new-response-category" class="block text-sm font-medium text-gray-400">Category</label>
                    <select id="new-response-category" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg"></select>
                </div>
            </div>
            <div class="flex justify-end mt-6 space-x-4">
                <button id="cancel-new-response-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="save-new-response-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Save Response
                </button>
            </div>
        </div>
    </div>


    <div id="add-category-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Add a New Category</h3>
            <p class="text-gray-400 text-base mb-4">Give your new category a name.</p>
            <input
                type="text"
                id="add-category-input"
                class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 mb-4 text-lg"
                placeholder="Enter category name (e.g., 'Customer Support')"
            />
            <div class="flex justify-end space-x-4">
                <button id="cancel-add-category-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="confirm-add-category-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Create Category
                </button>
            </div>
        </div>
    </div>

    <div id="edit-category-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Edit Category</h3>
            <p class="text-gray-400 text-base mb-4">Enter a new name for the category.</p>
            <input
                type="text"
                id="edit-category-input"
                class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 mb-4 text-lg"
                placeholder="Enter new name"
            />
            <div class="flex justify-end space-x-4">
                <button id="cancel-edit-category-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="confirm-edit-category-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Save Name
                </button>
            </div>
        </div>
    </div>

    <div id="delete-category-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Confirm Category Deletion</h3>
            <p class="text-gray-400 text-base mb-4">Are you sure you want to delete this category? All responses inside it will be permanently deleted.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-category-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="confirm-delete-category-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-red-700 transition duration-300 shadow-md">
                    Yes, Delete
                </button>
            </div>
        </div>
    </div>

    <div id="color-picker-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Change Category Color</h3>
            <p class="text-gray-400 text-base mb-4">Select a new color for the active category.</p>
            <div class="flex justify-center mb-4">
                <input type="color" id="color-input" class="w-16 h-16 rounded-lg cursor-pointer border-2 border-gray-600">
            </div>
            <div class="flex justify-end mt-6 space-x-4">
                <button id="close-color-picker-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Close
                </button>
                <button id="save-color-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Save
                </button>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Confirm Deletion</h3>
            <p class="text-gray-400 text-base mb-4">Are you sure you want to delete this response?</p>
            <div class="flex justify-end space-x-4">
                <button id="delete-cancel-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="delete-confirm-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-red-700 transition duration-300 shadow-md">
                    Yes, Delete
                </button>
            </div>
        </div>
    </div>

    <div id="update-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="update-modal-title" class="text-2xl font-bold text-gray-200 mb-4">Checking for Updates...</h3>
            <p id="update-modal-message" class="text-gray-400 text-base mb-4">Please wait while we check for new content.</p>
            <div id="update-modal-buttons" class="flex justify-end space-x-4 hidden">
                <button id="close-update-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Close
                </button>
            </div>
        </div>
    </div>
		
    <div id="login-popup-modal" class="modal hidden">
        <div class="login-popup flex flex-col space-y-3">
            <div class="flex items-center justify-between">
                <span class="text-sm font-semibold text-gray-200">Sign In for more!</span>
                <button id="close-login-popup-btn" class="p-1 rounded-full hover:bg-gray-600 transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <p class="text-xs text-gray-400">Sign in to save your canned responses and helpful links across all your devices.</p>
            <button id="login-popup-btn" class="w-full text-center px-4 py-2 rounded-xl bg-blue-600 text-white text-sm font-bold hover:bg-blue-700 transition duration-300">
                Sign In with Google
            </button>
        </div>
    </div>

    <div id="tutorial-modal" class="modal hidden">
        <div class="modal-content w-full max-w-lg">
            <div id="tutorial-step-1" class="tutorial-step space-y-6">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Welcome! 👋</h3>
                <p class="text-lg text-gray-300 text-center">Thanks for signing in! Here's a quick tour to show you how to get the most out of this site.</p>
            </div>

            <div id="tutorial-step-2" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Add New Responses</h3>
                <p class="text-lg text-gray-300">This button is where you can create new canned responses. You can give it a label and assign it to a category.</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-plus-circle text-purple-400 mr-3"></i> Tips
                    </h4>
                    <p class="text-gray-400">Add responses for your most common requests to save time!</p>
                </div>
            </div>
            <div id="tutorial-step-3" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Search Your Responses</h3>
                <p class="text-lg text-gray-300">Quickly find any response by using the search box at the top of the left column.</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-search text-yellow-400 mr-3"></i> How it Works
                    </h4>
                    <p class="text-gray-400">Type any keyword into the search bar, and the list below will instantly filter to show you matching responses.</p>
                </div>
            </div>

            <div id="tutorial-step-4" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Categories</h3>
                <p class="text-lg text-gray-300">Organize your responses with custom categories. You can create new categories with the **<i class="fas fa-plus"></i>** button.</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-ellipsis-v text-pink-400 mr-3"></i> Manage Categories
                    </h4>
                    <p class="text-gray-400">Click the vertical ellipsis (<i class="fas fa-ellipsis-v"></i>) next to a category to edit your categories. </p>
                </div>
            </div>
            
            <div id="tutorial-step-5" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Manage Categories</h3>
                <p class="text-lg text-gray-300">Once you have a category selected, click on the (<i class="fas fa-ellipsis-v"></i>) **menu button** to edit, rename, or delete it.</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-lightbulb text-yellow-400 mr-3"></i> Tip
                    </h4>
                    <p class="text-gray-400">You can also change a category's color here to make it stand out!</p>
                </div>
            </div>
            
            <div id="tutorial-step-6" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Manage Responses</h3>
                <p class="text-lg text-gray-300">Use the Copy, Edit, and Delete buttons to manage your canned responses.!</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-copy text-green-400 mr-3"></i> Quick Actions
                    </h4>
                    <p class="text-gray-400">The **Copy** button instantly copies the text. The other buttons allow you to easily edit or delete the entry from your list.</p>
                </div>
            </div>

            <div id="tutorial-step-7" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Pin Your Favorites</h3>
                <p class="text-lg text-gray-300">The  <i class="fas fa-thumbtack text-white mr-3"></i> allows you to pin your most-used responses to the top of the list for quick access.</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-thumbtack text-white mr-3"></i> Pinning Tips
                    </h4>
                    <p class="text-gray-400">Click the pin icon again to unpin a response, and it will return to its alphabetical position.</p>
                </div>
            </div>
            
            <div id="tutorial-step-8" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Dynamic Placeholders</h3>
                <p class="text-lg text-gray-300">Some responses use special placeholders like [TrackingNumber], [Customer's Name], [Asset Number], that you can quickly fill in. You can also edit or add your own placeholders by simply adding brackets [] arround phrases!</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-magic text-purple-400 mr-3"></i> Try it out!
                    </h4>
                    <p class="text-gray-400 mt-2">Notice the highlighted response on the right. Click the button below to see how to fill in its placeholders!</p>
                </div>
                <div class="flex justify-center mt-6">
                    <button id="show-placeholder-example-btn" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-purple-700 transition duration-300">
                        Fill it Out
                    </button>
                </div>
            </div>

            <div id="tutorial-step-9" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">You're All Set to Paste! 🎉</h3>
                <p class="text-lg text-gray-300">You've successfully copied a response with placeholders filled in. Now you can paste it anywhere you need!</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-paste text-green-400 mr-3"></i> Try it out
                    </h4>
                    <p class="text-gray-400">Paste the text into a document or email to see the final result. All your responses are now ready to be used with a single click.</p>
                </div>
            </div>

			<div id="tutorial-step-10" class="tutorial-step space-y-6 hidden">
   				 <h3 class="text-3xl font-extrabold text-blue-400 text-center">Navigate to Other Pages 🗺️</h3>
   				 <p class="text-lg text-gray-300">
       				 You can access other tools, like the **FedEx Tracker**, **Helpful Links**, & **My Stats** by opening the main menu.
   				 </p>
   				 <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
       				 <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
            			<i class="fas fa-bars text-gray-400 mr-3"></i> How it Works
        				</h4>
       				 <p class="text-gray-400">
           			 Click the hamburger icon on the top left to reveal the sidebar menu and switch between pages.
        			</p>
    			</div>
			</div>

            <div id="tutorial-step-11" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">FedEx Tracker Page 📦</h3>
                <p class="text-lg text-gray-300">This page allows you to quickly extract FedEx tracking numbers from any block of text you paste in.</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-clipboard-check text-green-400 mr-3"></i> Try it out!
                    </h4>
                    <p class="text-gray-400">Paste up to 30 FedEx tracking numbers into the box on the left.</p>
                </div>
            </div>	

            <div id="tutorial-step-12" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Copy & Open FedEx 🔗</h3>
                <p class="text-lg text-gray-300">After the numbers are extracted, this button copies all of them and automatically opens a new FedEx tracking tab for you.</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-truck text-red-400 mr-3"></i> Why it's useful
                    </h4>
                    <p class="text-gray-400">This saves you from copying each number one by one and pasting them into the FedEx website, streamlining your workflow.</p>
                </div>
            </div>

			<div id="tutorial-step-13" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Helpful Links Page 🔗</h3>
                <p class="text-lg text-gray-300">This page is a curated collection of useful links. You can search through the default links and add your own personal links for quick access.</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-search-plus text-teal-400 mr-3"></i> Quick Tip
                    </h4>
                    <p class="text-gray-400">Use the search bar at the top to instantly filter both the default and your personal links.</p>
                </div>
            </div>

            <div id="tutorial-step-14" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">My Stats Page 📊</h3>
                <p class="text-lg text-gray-300">Track your productivity here! This page visualizes your usage, showing your most copied responses, category breakdowns, and achievements you've unlocked.</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-trophy text-yellow-400 mr-3"></i> Gamify Your Work
                    </h4>
                    <p class="text-gray-400">Unlock achievements by using different features of the application. See how many you can collect!</p>
                </div>
            </div>

            <div id="copy-success-modal" class="modal hidden">
                <div class="modal-content">
                    <h3 class="text-2xl font-bold text-gray-200 mb-4">Text Copied! ✅</h3>
                    <p class="text-gray-400 text-base mb-2">Here is the final response you just copied:</p>
                    <div class="bg-gray-700 p-4 rounded-xl border border-gray-600 mb-4 overflow-auto max-h-60">
                        <pre id="copied-text-display" class="whitespace-pre-wrap text-gray-200"></pre>
                    </div>
                    <p class="text-sm text-gray-500 mb-4">Feel free to paste this into your application.</p>
                    <div class="flex justify-end">
                        <button id="close-copy-success-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300">
                            Got it!
                        </button>
                    </div>
                </div>
            </div>

			<div class="flex justify-between items-center mt-8">
   				 <button id="tutorial-back-btn" class="py-3 px-6 rounded-xl shadow-md hidden 
       			 dark:bg-gray-600 dark:text-white dark:hover:bg-gray-700
        			light-mode:bg-gray-300 light-mode:text-gray-800 light-mode:hover:bg-gray-400
        			transition duration-300">
       			 <i class="fas fa-arrow-left mr-2"></i> Back
   			 </button>
   			 <button id="tutorial-next-btn" class="py-3 px-6 rounded-xl shadow-lg
        			dark:bg-blue-600 dark:text-white dark:hover:bg-blue-700
        			light-mode:bg-blue-600 light-mode:text-white light-mode:hover:bg-blue-700
        			transition duration-300">
        			Next <i class="fas fa-arrow-right ml-2"></i>
   			 </button>
    			<button id="tutorial-finish-btn" class="py-3 px-6 rounded-xl shadow-lg hidden
       			 dark:bg-green-600 dark:text-white dark:hover:bg-green-700
       			 light-mode:bg-green-600 light-mode:text-white light-mode:hover:bg-green-700
       			 transition duration-300">
       			 Finish <i class="fas fa-check ml-2"></i>
    			</button>
			</div>
        </div>
    </div>

		</div> <div id="achievement-toast" class="fixed bottom-5 right-5 flex items-center w-full max-w-xs p-4 space-x-4 rtl:space-x-reverse text-gray-200 bg-gray-700 divide-x rtl:divide-x-reverse divide-gray-600 rounded-lg shadow-lg space-x opacity-0 translate-y-5 transition-all duration-500 ease-out z-[5000]">
		    <div id="toast-icon" class="text-2xl text-yellow-400">🏆</div>
		    <div class="ps-4 text-sm font-normal">
		        <div class="font-bold">Achievement Unlocked!</div>
		        <div id="toast-message"></div>
		    </div>
		</div>

		<div id="achievement-details-modal" class="modal hidden">
		    <div class="modal-content text-center">
		        <div id="modal-achievement-icon" class="text-6xl mb-4"></div>
		        
		        <h3 id="modal-achievement-title" class="text-3xl font-bold text-gray-100 mb-2"></h3>
		        
		        <p id="modal-achievement-desc" class="text-gray-400 text-lg mb-6"></p>
		        
		        <p id="modal-achievement-date" class="text-sm text-gray-500 mb-6"></p>
		        
		        <button id="close-achievement-modal-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
		            Close
		        </button>
		    </div>
		</div>

		<div id="level-up-modal" class="modal hidden">
		    <div class="modal-content text-center">
		        <div id="modal-level-up-icon" class="text-8xl mb-4"></div>
		        <h3 class="text-4xl font-extrabold text-yellow-300 mb-2">LEVEL UP!</h3>
		        <p id="modal-level-up-message" class="text-gray-300 text-xl mb-6"></p>
		        <button id="close-level-up-modal-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-blue-700 transition duration-300 shadow-lg">
		            Awesome!
		        </button>
		    </div>
		</div>
	
		
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, query, deleteDoc, updateDoc, setLogLevel, getDocs, serverTimestamp, orderBy, limit, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Initialization and Auth ---
        const firebaseConfig = {
          apiKey: "AIzaSyCCsU4YY_Rwqo-F9KJjeOOSD4NpUGLNq8s",
          authDomain: "tools-a180f.firebaseapp.com",
          projectId: "tools-a180f",
          storageBucket: "tools-a180f.firebasestorage.app",
          messagingSenderId: "195275159442",
          appId: "1:195275159442:web:20031fd5ccf0428162334b",
          measurementId: "G-TP0VKGV0EE"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-tools-app';
        const safeAppId = appId.replace(/[:\/]/g, '-');

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug');
        
        // --- Global State Variables ---
let currentTutorialStep = 0;
let categories = {};
let activeCategory = '';
let userId = null;
let isAnonymous = true;
let responseToDeleteId = null;
let categoryToEdit = null;
let currentPage = 'canned-responses';
let userName = '';
let currentTextToCopy = '';
let currentEditingId = null;
let openCategoryMenu = null;
let editingLinkDocId = null;
let openMenuId = null;
let defaultLinks = [];
let cannedResponsesUnsubscribe = null;
let helpfulLinksUnsubscribe = null;
let userLinks = [];
let renderedStaticLinks = false;
let isSubmittingLink = false;
let isTutorialActive = false;	
let currentResponseToCopyId = null; 
let currentResponseToCopyCategory = null; 
let statsChart = null; 	
let shownAchievements = new Set();	
let categoryChartInstance = null;
let activityChartInstance = null;
let firstSignIn = null; 		
let audioUnlocked = false;
let userLevelData = { level: 0, xp: 0 };
let masterBlueprintVersion = 1;
let lastCopyTimestamps = {};
let activeAchievementFilter = 'all';		
		

// --- NEW: Leveling System Configuration ---		
const XP_VALUES = {
    COPY_RESPONSE: 25,
    CREATE_RESPONSE: 50,
    CREATE_CATEGORY: 100,
    UNLOCK_ACHIEVEMENT: 1000,
	FEDEX_TRACKING: 50,
};

const BASE_XP = 100; // XP needed for level 1
const XP_INCREASE_FACTOR = 1.2; // Every other level needs 20% more XP

const LEVEL_RANKS = [
    { level: 0, name: "Newbie", icon: "fa-seedling" },
    { level: 20, name: "Apprentice", icon: "fa-book-reader" },
    { level: 30, name: "Journeyman", icon: "fa-pencil-ruler" },
    { level: 40, name: "Artisan", icon: "fa-hammer" },
    { level: 50, name: "Expert", icon: "fa-star" },
    { level: 60, name: "Master", icon: "fa-trophy" },
    { level: 70, name: "Grandmaster", icon: "fa-crown" },
    { level: 80, name: "Legend", icon: "fa-dragon" },
    { level: 90, name: "Demigod", icon: "fa-bolt" },
    { level: 100, name: "Deity", icon: "fa-sun" } 
];

// Add this new function to your helper functions section
const updateLeaderboardData = async (uid, levelInfo) => {
    if (!uid || isAnonymous) return; // Don't run for anonymous users

    const leaderboardDocRef = doc(db, "leaderboard", uid);
    try {
        const user = auth.currentUser;
        if (!user) return;

        const dataToSet = {
            displayName: user.displayName || 'Anonymous User',
            xp: levelInfo.totalXp,
            level: levelInfo.level,
            rankName: levelInfo.rankName,
            rankIcon: levelInfo.rankIcon,
            memberSince: user.metadata.creationTime ? new Date(user.metadata.creationTime) : serverTimestamp()
        };

        await setDoc(leaderboardDocRef, dataToSet, { merge: true });
    } catch (error) {
        console.error("Error updating leaderboard:", error);
    }
};
		
const savedPage = localStorage.getItem('lastVisitedPage');
if (savedPage) {
    currentPage = savedPage;
}		

const storedTheme = localStorage.getItem('theme');
if (storedTheme === 'light') {
    document.body.classList.add('light-mode');
}

// Function to darken a color for light mode backgrounds
function lightenColor(hexColor) {
    // Remove the '#' if it exists
    const hex = hexColor.replace('#', '');
    
    // Convert hex to R, G, B
    const r = parseInt(hex.substring(0, 2), 16);
    const g = parseInt(hex.substring(2, 4), 16);
    const b = parseInt(hex.substring(4, 6), 16);
    
    // Find the max and min RGB values
    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    
    // Convert RGB to HSL
    let h, s, l = (max + min) / 255 / 2;
    
    if (max === min) {
        h = s = 0; // Achromatic
    } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        
        switch(max) {
            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
            case g: h = (b - r) / d + 2; break;
            case b: h = (r - g) / d + 4; break;
        }
        
        h /= 6;
    }
    
    // Increase lightness for light mode (e.g., to 90% or 95%)
    let newL = Math.min(l + 0.5, 0.95); // Ensure it's not too light
    
    // Convert back to RGB
    let newR, newG, newB;
    if (s === 0) {
        newR = newG = newB = newL; // Achromatic
    } else {
        const hue2rgb = (p, q, t) => {
            if (t < 0) t += 1;
            if (t > 1) t -= 1;
            if (t < 1/6) return p + (q - p) * 6 * t;
            if (t < 1/2) return q;
            if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
            return p;
        };
        const q = newL < 0.5 ? newL * (1 + s) : newL + s - newL * s;
        const p = 2 * newL - q;
        newR = hue2rgb(p, q, h + 1/3);
        newG = hue2rgb(p, q, h);
        newB = hue2rgb(p, q, h - 1/3);
    }
    
    // Convert RGB back to hex
    const toHex = (c) => {
        const hex = Math.round(c * 255).toString(16);
        return hex.length === 1 ? '0' + hex : hex;
    };
    
    return `#${toHex(newR)}${toHex(newG)}${toHex(newB)}`;
}


const tutorialSteps = [
    document.getElementById('tutorial-step-1'),
    document.getElementById('tutorial-step-2'),
    document.getElementById('tutorial-step-3'),
    document.getElementById('tutorial-step-4'),
    document.getElementById('tutorial-step-5'), 
    document.getElementById('tutorial-step-6'), 
    document.getElementById('tutorial-step-7'),
    document.getElementById('tutorial-step-8'),
    document.getElementById('tutorial-step-9'),
    document.getElementById('tutorial-step-10'),
    document.getElementById('tutorial-step-11'),
    document.getElementById('tutorial-step-12'),
	document.getElementById('tutorial-step-13'),
	document.getElementById('tutorial-step-14'),
];

const highlightedElements = [
    null, // Step 1
    document.getElementById('add-response-section'), // Step 2: Add New Response
    document.getElementById('search-bar-container'), // Step 3: Search Bar
    document.getElementById('category-bar'), // Step 4: Categories
    document.getElementById('category-menu-container'), // Step 5: Kebab menu
    null, // Step 6: Copy, Edit, Delete buttons (highlighting handled dynamically)
    null, // Step 7: Pin button (highlighting handled dynamically)
    null, // Step 8: Dynamic Placeholders
    null, // Step 9:This will be handled dynamically inside the function
	document.getElementById('hamburger-menu-btn'), // New Step 10: Highlights the hamburger icon
    document.getElementById('input-text-fedex'), // Step 11
    document.getElementById('copy-button-fedex'), // Step 12: New highlight
	null,
	null,
];
 
const tutorialPages = [
    'canned-responses', // Step 1: Welcome screen
    'canned-responses', // Step 2: Add a response
    'canned-responses', // Step 3: Search
    'canned-responses', // Step 4: Categories
    'canned-responses', // Step 5: Manage Categories
    'canned-responses', // Step 6: Manage Responses (new)
    'canned-responses', // Step 7: Pinning (new)
    'canned-responses', // Step 8: Dynamic placeholders
    'canned-responses', //step 9
	'canned-responses', //step 10
    'fedex-tracker', // Step 11: Change page to FedEx tracker
    'fedex-tracker', // Step 12: Change page to FedEx tracker
	'helpful-links',    //  Step 13
    'my-stats',         //  Step 14
];

// An array to map each step to the modal's target position
const modalPositions = [
    'show-modal', // Step 1: Centered modal
    'top-right',  // Step 2: Position for add response section
    'top-right',  // Step 3: Position for the search bar
    'bottom-left', // Step 4: Position for category bar
    'upper-right', //Step 5: Position for Kebab menu
    'on-response', // Step 6: Response buttons (new)
    'on-response',  // Step 7: Pin button (new)
    'left-response', // Step 8: Dynamic placeholders
    'show-modal', //Step 9
	'top-left',
    'left-response', // Step 10: New position
    'on-tracker-page', // Step 11: Position on the tracker page
	'show-modal',
	'show-modal',
];

// --- Master Blueprint Data for Initialization ---
const defaultCannedResponsesBlueprint = {
    'BRONCO': {
        color: '#32789C',
        responses: [
            { id: 'bronco-1', label: 'NON ACTIONABLE ORDER', text: 'Hello [Customer\'s Name],\n\nI am writing to inform you that the item you ordered, [Device Model], is currently out of stock. We expect to have it back in stock within 2-4 weeks. I apologize for the inconvenience.\n\nOnce it is back in stock, we will deliver it to you as soon as possible. We appreciate your patience and understanding during this time.\n\nIf you have any other questions or concerns, please do not hesitate to contact me.\n\nSincerely,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1},
            { id: 'bronco-2', label: 'ACTIONABLE ITEM RESPONSE', text: 'Hello [Customer\'s Name],\n\nThank you for your order!\n\nOur target is to have them either shipped or delivered to you in 1-3 business days time. We will let you know when your order is on its way.\n\nThank you\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
            { id: 'bronco-3', label: 'OUT FOR DELIVERY RESPONSE', text: 'Hello [Customer\'s Name],\n\nYour order will ship today or the next business day, depending on FedEx\'s pickup schedule. You can track your shipment with FedEx Tracking [TrackingNumber].\n\nPlease make sure to check your local Mail room once this order is marked delivered.\n\nPlease note that once the order is delivered, we are unable to see and respond to updates in the order.\n\nIf you need further help, please submit a request through go/stuff by selecting “Have questions about your order?”, or by opening a ticket at go/emt-request.\n\nThank you,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1},
            { id: 'bronco-4', label: 'ITEM DELIVERED', text: 'Hello [Customer\'s Name],\n\nI have delivered the [Device Model] to your desk location [Desk Location], as noted on MOMA, today [Date].\n\nPlease note that once the order is delivered, we are unable to see and respond to updates in the order.\n\nIf you need further help, please submit a request through go/stuff by selecting “Have questions about your order?”, or by opening a ticket at go/emt-request.\n\nThank you,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
            { id: 'bronco-5', label: 'SECURITY KEY DELIVERED', text: 'Hello [Customer\'s Name],\n\nYour security key order has been delivered to your desk location [Desk Location], as noted on MOMA, today [Date]. Please be sure to follow the Techstop security key setup instructions at go/setup-sk.\n\nPlease note that once the order is delivered, we are unable to see and respond to updates in the order.\n\nIf you need further help, please submit a request through go/stuff by selecting “Have questions about your order?”, or by opening a ticket at go/emt-request.\n\nThank you,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
            { id: 'bronco-6', label: 'PIKTIME', text: 'Hello [Customer\'s Name],\n\nThank you for your request.\n\nWe\'ve prepared your order and it will be ready for you to pick up at your confirmed appointment time.\n\nPick-up Location: https://floorscope.googleplex.com/US-LAX-BIN2-1#US-LAX-BIN2-1-100 (Please knock on our door when you arrive to pick up your order.)\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
            { id: 'bronco-7', label: 'PIKTIME DELIVERED', text: 'Hello [Customer\'s Name],\n\nYour order for a [Device Model] was successfully picked up on [Date]. Thanks for stopping by!\n\nWe will now mark this order delivered.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
            { id: 'bronco-8', label: 'PIKTIME CANCELLED', text: 'Hello [Customer\'s Name],\n\nThis is to inform you that your order has been canceled. This is due to the failure to pick up the order at the confirmed date and time of your appointment.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
			{ id: 'bronco-9', label: 'Remote Security Key Delivery', text: 'Hello [Customer\'s Name],\n\nYour Security Key order has shipped. When the order arrives, please be sure to follow the Techstop Security Key setup instructions at go/setup-sk and Enroll: go/sl-enroll\n\nYou can track your shipment with the following FedEx tracking Number: [TrackingNumber]\n\nPlease view this tracking number for updates about your delivery, and expect an update once the package has been delivered.\n\nPlease note that once the order is delivered, we are unable to see and respond to updates in the order. If you need further help, please submit a request through go/stuff by selecting “Have questions about your order?”, or by opening a ticket at go/emt-request.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 }
        ]
    },
    'PAR': {
        color: '#242020',
        responses: [
            { id: 'par-1', label: 'PAR REMOTE ORDER', text: 'Hello [Customer\'s Name],\n\nYour shipping materials have been sent for your return order\n\nFedEx Tracking: [TrackingNumber]\nReturn Tracking: [ReturnTrackingNumber]\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
            { id: 'par-2', label: 'PAR SHIPPING MATERIALS DELIVERED', text: 'Hello [Customer\'s Name],\n\nAccording to the FedEx tracking number, the shipping Materials were delivered on [Date].\n\nScreenshot:\n\nAs a reminder, per Google’s device return policy, you have 10 business days to complete your return. If you still have your device after the return window, this device will lose corporate access and your cost center will be charged back after 40 days.\n\nBest regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
            { id: 'par-3', label: 'PAR STUFF LOCKER', text: 'Hello [Customer\'s Name],\n\nThank you for submitting your return request.\n\nWe\'ll retrieve your asset from the Stuff Station return locker as soon as it\'s dropped off.\n\nJust a friendly reminder: you have 10 business days from the creation date of this order to place your asset in the return locker. If it\'s not dropped off within this time frame, your return order will be automatically canceled.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
            { id: 'par-4', label: 'CANCEL RETURN LOCKER ORDER', text: 'Hello [Customer\'s Name],\n\nPlease be advised that this return order will be canceled. This is due to the failure to pick up the item from the designated return lockers.', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 }
        ]
    },
    'GUTS': {
        color: '#014B34',
        responses: [
            { id: 'guts-1', label: 'GNG LOCKERS PROACTIVE TICKET', text: 'The GNG lockers contain [Number] loaners and [Number2] empty slots.\n\nScreenshot:\n\nThis ticket will be marked resolved.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
            { id: 'guts-2', label: 'GUTS STUFF STATION VENDING', text: 'The stuff station vending machine has been replenished .\n\nScreenshot:\n\nThis ticket will now be resolved.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
            { id: 'guts-3', label: 'Remote Return Shipment Information', text: 'Your request has been prepped and ready to ship. Feel free to reach out to us if you need more assistance. (1 Box Sent)\n\nFedEx Tracking:[TrackingNumber]\nReturn Tracking:[ReturnTrackingNumber]\n\nAs a reminder, per Google’s device return policy, you have 14 days (10 business days) to complete your return. If you still have your device after the return window, this device will lose corporate access and your cost center will be charged.\n\nWe will send a reminder in 3 business days if we haven\'t received your return by then.\n\nI’ll set this ticket to Pending Hardware Return while we wait for delivery.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
            { id: 'guts-4', label: 'Resolution For Lost Device', text: 'After conducting a search for [Asset Number] - [Device Model], I have concluded that this device is lost and I updated our records to reflect this.\n\nThe following actions were taken to search for this device:\n1:\n2:\n3:\n\nSince no further actions are needed, I will resolve this ticket now. Please feel free to reach out if you have any further questions regarding this request.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
            { id: 'guts-5', label: 'Exit Onsite Collection Information', text: 'Thank you for confirming that your [Asset Number] - [Device Model] is ready for pickup on [Date].\n\nI will set this ticket to Pending Date of Event until the collection date, and I will update the ticket again when the collection is in progress.\n\nIn the meantime, please let me know if you have any further questions regarding this request.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
            { id: 'guts-6', label: 'Onsite Collection That Was Not Found/Not Ready for Pick Up', text: 'I just want to follow up because we visited [Desk Location] and your [Device Model] Asset Number [Asset Number] was not ready for collection.\n\nCan you please confirm a new collection date and the correct pick up location site code?\n\nAs a reminder, you have [Number] business days remaining to complete your return. If you do not complete your return in [Number] business days this request will be closed, and your device will lose corporate access.\n\nIn the meantime, I’ll set this ticket back to Pending Customer Action while we wait for your reply.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
            { id: 'guts-7', label: 'Remote Return Shipment That Has Not Been Received', text: 'I just want to follow up because we have not received your return.\n\nAs a reminder, you have 5 business days remaining to complete your return.\n\nIf you do not complete your return in 5 business days this request will be closed, and your device will lose corporate access.\n\nIn the meantime, I’ll set this ticket back to Pending Hardware Return while we wait for your return to be delivered.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
            { id: 'guts-8', label: 'Successful Return', text: 'The following devices have been returned to inventory, so I’ll resolve this ticket now:\n\n [Asset Number] - [Device Model]\n\nPlease feel free to reach out if you have any further questions regarding this return.\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
			{ id: 'guts-9', label: 'Approvals Needed', text: 'This ticket was generated because go/stuff was unable to determine your eligibility to receive the equipment you selected.\n\nBecause this equipment is an upgrade from your current equipment, we need to obtain approval from your director before the order can proceed.\n\nBecause this is not self explanatory, I want to let you know that I am going to deny the approval of this request. This will trigger the approval chain to be activated so all necessary approvals are recorded.\n\nOnce all approvals are complete, the order will be released through the inventory system to a fulfillment team.  You will be able to track the progress of the approvals in this ticket, and the order status through your open orders on go/stuff.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
			{ id: 'guts-10', label: 'Approvals Complete', text: 'All approvals have been completed at this time and your order has been released to a fulfillment team.\n\nAt this point, the purpose for this ticket is complete and you can track further progress on your order from your open orders page through go/stuff.\n\nThank you for your patience.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
			{ id: 'guts-11', label: 'No Approvals Needed', text: 'This ticket was generated because go/stuff was unable to determine your eligibility to receive the equipment you selected.\n\nI have reviewed your asset records and verified your request falls within Google’s Distribution policy.\n\nWhen I approve this request, the ticket\'s purpose will be completed and resolved.\n\nYou can track the progress of your request though the go/stuff open orders page.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
			{ id: 'guts-12', label: 'DSS Scheduling Appointment', text: 'We are happy to assist you with &lt;issue description&gt; and would like to set an appointment for us to complete this service.\n\nWould [Date] at [Time] be a convenient time for this service appointment?\n\nIf not, please feel free to suggest a time that works best for you.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
			{ id: 'guts-13', label: 'DSS Confirming Appointment', text: 'Thank you for confirming your service appointment on [Date] at [Time].\n\nI will set this ticket to “Pending Date of Event” until the date of your appointment.In the meantime, feel free to reach out with any further questions regarding this request.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
			{ id: 'guts-14', label: 'DSS Documentation and Resolution', text: 'This service appointment is complete and below are our findings. Please let us know if you have any further issues.\n\nKind regards,\n\n[Name]\n\n**Tech Report**\n\nSymptom(s) experienced by the Requester: \n\nWere you able to replicate the symptom(s) reported (Yes or No)?\n\nTroubleshooting steps from issue confirmation until resolution:\n\n1)\n\n2)\n\n3)\n\nRoot cause of the issue: \n\nAction that resolved the issue: ', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
			{ id: 'guts-15', label: 'Out of Scope Request', text: 'Thank you for reaching out regarding &lt;Requested Service&gt;.\n\nUnfortunately this request is out of scope for our team, so we will route this ticket to the &lt;Team GUTS Group&gt; Team so that they can assist you with this request.\n\nHello &lt;GUTS Group&gt; Team,\n\nWould you please assist &lt;Requester Name&gt; with &lt;Requested Service&gt;?\n\n&lt;Provide all available information that will help the team successfully complete the request.&gt;\n\nThank you!\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
			{ id: 'guts-16', label: 'Ricoh Service Call Request was Submitted', text: 'I have submitted a request for a Ricoh service visit and I expect to receive call from a Ricoh service representative to schedule the appointment within the next 2 business days.\n\nI will set this ticket to Pending 3rd Party Action while we wait for the call from Ricoh, and I will update the ticket again to confirm the appointment date and time.\n\nIn the meantime, please feel free to reach out if you have any questions regarding this request.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
			{ id: 'guts-17', label: 'Ricoh Service Call Appointment', text: 'I have scheduled a Ricoh service call appointment for [Date] at [Time] AM/PM.\n\nI will set this ticket to Pending Date of Event until the appointment date.\n\nIn the meantime, please feel free to reach out if you have any questions regarding this request.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
			{ id: 'guts-18', label:	'Ricoh Replacement Part Order', text: '[Part Name] has been ordered for this service, and the order details are listed below.\n\nOrder GUTS Ticket number: [TicketNumber]\n\nETA: [Date]\n\nI will set this ticket to Pending Hardware while we wait for this part to be delivered, and I will update this ticket again to confirm when we receive the part and the service can be completed.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 },
			{ id: 'guts-19', label: 'AV Break/Fix Resolution Response', text: 'We concluded our investigation and below are our findings. Please let us know if you have any further issues.\n\nKind regards,\n\n[Name]\n\n**Tech Report**\n\nSymptom(s) experienced by the Requester: \n\nWere you able to replicate the symptom(s) reported (Yes or No)?\n\nTroubleshooting steps from issue confirmation until resolution:\n\n1)\n\n2)\n\n3)\n\nRoot cause of the issue: \n\nAction that resolved the issue: ', isPinned: false, createdAt: new Date().toISOString(), isDefault: true, version: 1 }
        ]
    }
};

const defaultHelpfulLinksBlueprint = [
    { id: 'admin-device-portal', title: 'Admin Device Portal (Armada)', description: 'The Armada portal for device administration.', url: 'https://admin-device-portal.corp.google.com/' },
    { id: 'astreya-audits', title: 'Astreya Audits', description: 'Review and manage Astreya audit reports.', url: 'https://ui-web-dot-emt-inspecto-dev.uc.r.appspot.com/app/' },
    { id: 'astreya-kb', title: 'Astreya KB', description: 'Access the Astreya knowledge base for support.', url: 'https://supportcenter.corp.google.com/corpengkb/category/bltc1355050242a3f3d?e=ServicedeskCommonGuidedSupport::Launch' },
    { id: 'bronco-plant-codes', title: 'Bronco Plant Codes', description: 'A spreadsheet of plant codes for the Bronco project.', url: 'https://docs.google.com/spreadsheets/d/1urmopWJvKXdXqAsPf1TBW2W97h5wbkFkNs9CKcBdwsE/edit?gid=0#gid=0' },
    { id: 'bronco-support', title: 'Bronco Support', description: 'Resources for Bronco project support.', url: 'https://sites.google.com/corp/google.com/gobronco-support/home' },
    { id: 'buganizer', title: 'Buganizer', description: 'A bug and issue tracking tool.', url: 'https://b.corp.google.com/issues?q=assignee:gasparl@google.com%20status:open' },
    { id: 'clipper', title: 'Clipper', description: 'A search tool for BIOS passwords.', url: 'https://clipper.googleplex.com/ui/#/search' },
    { id: 'emt-signage', title: 'EMT Signage', description: 'A folder of EMT signage and templates.', url: 'https://drive.google.com/corp/drive/folders/1uhrfZjH6Jz_9Mnftjl021nhduaRVdAtv?resourcekey=0-904bGgjllpWnTujOP-M5-w' },
    { id: 'find-net-blocks', title: 'Find Net blocks', description: 'Search for network blocks and IP information.', url: 'https://ipdb.corp.google.com/ipdb/corp-list/?ip_address=&netmask=&description=&vlan=&address_type=all&region_name=&country_name=&city_name=&building_name=&network_name=&tag=ACL-CORP-MNP' },
    { id: 'gallop', title: 'Gallop', description: 'The Gallop platform for asset and equipment management.', url: 'https://dasinfra-sap-fiori-prod5.gcpnode.com/sap/bc/ui5_ui5/ui2/ushell/shells/abap/FioriLaunchpad.html#ZEQUIPMGMTSEMOBJ-display' },
    { id: 'ganpati', title: 'Ganpati', description: 'Project management and group information.', url: 'https://ganpati2.corp.google.com/group/eng.corp?tab=descendants' },
    { id: 'gng-audit-legacy', title: 'GNG Audit (Legacy)', description: 'Access to the legacy loaner audit system.', url: 'https://loaner-2.googleplex.com/authorization' },
    { id: 'guts', title: 'GUTS', description: 'The GUTS ticket management system.', url: 'https://gutsv3.corp.google.com/#search/default/Assigned%20To%20Me/0' },
    { id: 'guts-cti', title: 'GUTS CTI', description: 'Check the GUTS CTI spreadsheet for contact info.', url: 'https://docs.google.com/spreadsheets/d/1zYSxHSdwIwrEvWAcpVyhbx6b5R2raWq322pM3EGexy0/edit?resourcekey=0-ghk2iWDZcH3sFEZ_NA-uyQ&gid=421127237#gid=421127237' },
    { id: 'guts-ticket-checklist', title: 'GUTS Ticket Checklist', description: 'A checklist for resolving GUTS tickets.', url: 'https://docs.google.com/spreadsheets/d/1VeKBxej95gIGqB2RhER9cRu-8DvD4kNcbL2PDIPMtp0/edit?gid=0#gid=0' },
    { id: 'hardware-part-numbers', title: 'Hardware Part Numbers', description: 'A dashboard for looking up hardware part numbers.', url: 'https://lookerstudio.google.com/c/u/0/reporting/36d77f1b-9303-44f9-8cf2-7b63ec333308/page/JRgzB' },
    { id: 'host-admin', title: 'Host Admin', description: 'A portal for host and asset management.', url: 'https://hostadmin.corp.google.com/#' },
    { id: 'install-glinux', title: 'Install gLinux', description: 'Instructions for installing gLinux.', url: 'https://supportcenter.corp.google.com/techstop/article/00000185-7924-d5bd-a3c5-fff7c03b0000/interactive?visit_id=638917657833593233-968085255&hl=en&rd=3' },
    { id: 'install-windows', title: 'Install Windows', description: 'Instructions for installing Windows on a corporate device.', url: 'https://supportcenter.corp.google.com/techstop/article/blt584aae127d944eb1?visit_id=638917657536484308-3551301642&hl=en&rd=2' },
    { id: 'litigation-hold', title: 'Litigation Hold', description: 'Manage litigation holds for devices.', url: 'https://amionhold.googleplex.com/lookup' },
    { id: 'mac-setup', title: 'Mac Setup', description: 'Instructions for setting up a new Mac.', url: 'https://drive.google.com/file/d/1TevV8ZdDYHOJFbpgXyaNAzyWUnLsyb3d/view?resourcekey=0-5eszItugO833_pRzoCePCw' },
    { id: 'noogley', title: 'Noogley', description: 'Internal resources for Nooglers (new Googlers).', url: 'https://noogley.googleplex.com/' },
    { id: 'office-move-stats', title: 'Office Move Stats', description: 'Statistics for office moves and logistics.', url: 'https://movestats.googleplex.com/' },
    { id: 'people-view', title: 'People View', description: 'Internal employee information and directory (check for Director or VP).', url: 'https://data.corp.google.com/sites/persons/home/' },
    { id: 'piktime', title: 'Piktime', description: 'The Piktime appointment and scheduling platform.', url: 'https://piktime.corp.google.com/' },
    { id: 'print-central', title: 'Print Central', description: 'Manage and monitor corporate printers.', url: 'https://printcentral.googleplex.com/#/printers/active' },
    { id: 'project-codes', title: 'Project Codes', description: 'A spreadsheet containing various project codes.', url: 'https://docs.google.com/spreadsheets/d/1li6NkMulPByZwcJrvQlK9Qrx64JWahwRg2xMSWEI6Dc/edit?gid=0#gid=0' },
    { id: 'purser', title: 'Purser', description: 'An internal tool to destroy Host ID.', url: 'https://purser.corp.google.com/#/home' },
    { id: 'recyclable-report', title: 'Recyclable Report', description: 'A report for tracking recyclable items.', url: 'https://lookerstudio.google.com/c/u/0/reporting/482b6544-e45b-4db3-ace7-2251d99b4e04/page/qPdtB?s=pF0bgEtUbIw' },
    { id: 'recycling-helper', title: 'Recycling Helper', description: 'A tool to assist with recycling processes.', url: 'https://script.google.com/a/macros/google.com/s/AKfycbzuJiDm7OqFxA6fIRq4Huiu2bUJLbQjqaTtZ69D2r5w0A2sjVca/exec' },
    { id: 'starting-gate', title: 'Starting Gate', description: 'Onboarding and new hire resources.', url: 'https://startinggate.corp.google.com/' },
    { id: 'techstop', title: 'Techstop', description: 'The main Techstop support center.', url: 'https://supportcenter.corp.google.com/techstop/site' },
    { id: 'technician-workload-management', title: 'Technician Workload Management', description: 'View and manage technician workload.', url: 'https://lookerstudio.google.com/c/u/0/reporting/462c770f-51f7-42e4-811d-b3fb3daf09eb/page/p_6a7jcz4nsd' },
    { id: 'wistek', title: 'Wistek / Iron Mountain', description: 'The Wistek and Iron Mountain return portal.', url: 'https://www.returntek.com/' }
];

// --- Helper Functions ---

// Add this new function to your helper functions section
const migrateExistingUsersToLeaderboard = async () => {
    console.log("Starting leaderboard data migration...");
    try {
        // Get all user documents. This requires a query on the top-level 'users' collection.
        const usersCollectionRef = collection(db, 'artifacts', safeAppId, 'users');
        const userQuerySnapshot = await getDocs(usersCollectionRef);

        if (userQuerySnapshot.empty) {
            console.log("No user data found to migrate.");
            return;
        }

        const batch = writeBatch(db);
        let migratedCount = 0;

        for (const userDoc of userQuerySnapshot.docs) {
            const userData = userDoc.data();
            const userId = userDoc.id;

            // Check if the user is an anonymous user
            if (userData.isAnonymous || userId.startsWith('anonymous')) {
                continue;
            }

            // Skip if this user has already been migrated
            if (userData.migratedToLeaderboard) {
                continue;
            }

            // Get the latest level info
            const levelInfo = calculateLevelInfo(userData.xp || 0);

            // Get user's display name from their auth data (if available)
            const userAuth = await getAuth().getUser(userId);
            const displayName = userAuth.displayName || userData.displayName || 'Unknown User';

            // Prepare the data for the leaderboard document
            const leaderboardData = {
                displayName: displayName,
                xp: levelInfo.totalXp,
                level: levelInfo.level,
                rankName: levelInfo.rankName,
                rankIcon: levelInfo.rankIcon,
                memberSince: userData.firstSignIn
            };
            
            // Add the new leaderboard document to the batch
            const leaderboardDocRef = doc(db, "leaderboard", userId);
            batch.set(leaderboardDocRef, leaderboardData, { merge: true });

            // Mark the user as migrated in their original document to prevent future runs
            batch.update(userDoc.ref, { migratedToLeaderboard: true });
            migratedCount++;
        }

        if (migratedCount > 0) {
            await batch.commit();
            console.log(`Successfully migrated ${migratedCount} users to the leaderboard.`);
            showMessage(`Migrated ${migratedCount} users to the leaderboard!`, 'success');
        } else {
            console.log("All existing users are already on the leaderboard.");
        }

    } catch (error) {
        console.error("Error during leaderboard migration:", error);
        showMessage("Failed to migrate some users to the leaderboard.", 'error');
    }
};		

// --- Renders achievements based on the active filter ---
const renderFilteredAchievements = (events, userData) => {
    const userAchievements = userData.achievementsData || {};
    const firstSignIn = userData.firstSignIn ? userData.firstSignIn.toDate() : null;
    const darkModeUsage = userData.darkModeUsage || { streak: 0 };
    const totalCopies = events.filter(e => e.type === 'copy').length;
    const totalCategories = Object.keys(categories).length;
    const hasArchitectAchievement = Object.values(categories).some(cat => cat.responses && cat.responses.length >= 5);
    const visitedPages = new Set(events.filter(e => e.type === 'visit_page').map(e => e.page));
    const daysSinceSignIn = firstSignIn ? Math.floor((new Date() - firstSignIn) / (1000 * 60 * 60 * 24)) : 0;

    const dailyActivity = events.reduce((acc, event) => {
        if (!event.timestamp) return acc;
        const date = event.timestamp.toDate().toISOString().split('T')[0];
        if (!acc[date]) acc[date] = { copies: 0, tracking: 0, links: 0 };
        if (event.type === 'copy') acc[date].copies++;
        if (event.type === 'extract_tracking') acc[date].tracking += (event.count || 0);
        if (event.type === 'add_link') acc[date].links++;
        return acc;
    }, {});

    const hasPerfectDay = Object.values(dailyActivity).some(day => day.copies >= 10 && day.tracking >= 3 && day.links >= 1);
    const hasCreatedCategory = events.some(e => e.type === 'create_category');
    const hasCreatedResponseWithPlaceholder = events.some(e => e.type === 'create_response' && /\[([^\]]+)\]/g.test(e.text || ''));
    const hasPinnedResponse = events.some(e => e.type === 'pin_response');
    const hasLivingLibrary = hasCreatedCategory && hasCreatedResponseWithPlaceholder && hasPinnedResponse;
    const recentCopyEvents = events.filter(e => e.type === 'copy' && e.timestamp?.toDate() > new Date(Date.now() - 30 * 60 * 1000));
    const uniqueCategoriesIn30Min = new Set(recentCopyEvents.map(e => e.categoryName)).size;
    const hasTheScribe = uniqueCategoriesIn30Min >= 5;
    const hasHistorian = daysSinceSignIn >= 365;
    const isBusinessDay = (date) => { const day = date.getDay(); return day > 0 && day < 6; };
    const usageDates = [...new Set(events.filter(e => e.timestamp).map(e => e.timestamp.toDate().toISOString().split('T')[0]))].sort();
    let maxStreak = 0;
    if (usageDates.length > 0) {
        let currentStreak = 1;
        for (let i = 1; i < usageDates.length; i++) {
            const prevDate = new Date(usageDates[i - 1]);
            const currentDate = new Date(usageDates[i]);
            if (!isBusinessDay(currentDate)) continue;
            const diffTime = currentDate - prevDate;
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays === 1 || (prevDate.getDay() === 5 && diffDays === 3)) {
                currentStreak++;
            } else {
                maxStreak = Math.max(maxStreak, currentStreak);
                currentStreak = 1;
            }
        }
        maxStreak = Math.max(maxStreak, currentStreak);
    }
    const hasStreakBreaker = maxStreak >= 90;
    const deletedInLast5Mins = events.filter(e => e.type === 'delete_response_single' && e.timestamp?.toDate() > new Date(Date.now() - 5 * 60 * 1000)).length;
    const hasCleanSlate = deletedInLast5Mins >= 5;

    const copyTiers = getTier(totalCopies, [
        { name: "Copycat", goal: 10, icon: "fa-clipboard", color: "text-amber-500" },
        { name: "Wordsmith", goal: 50, icon: "fa-clipboard", color: "text-slate-400" },
        { name: "Master of Efficiency", goal: 100, icon: "fa-clipboard", color: "text-yellow-400" }
    ]);
    const librarianTiers = getTier(totalCategories, [
        { name: "The Librarian", goal: 5, icon: "fa-book-open", color: "text-amber-500" },
        { name: "Head Archivist", goal: 10, icon: "fa-book-open", color: "text-slate-400" },
        { name: "Chief Organizer", goal: 25, icon: "fa-book-open", color: "text-yellow-400" }
    ]);

    const allAchievements = [
        { id: 'first_responder', name: "First Responder", desc: "Copied your first response.", icon: "fa-rocket", color: "text-blue-400", unlocked: totalCopies > 0 },
        { id: 'copy_tiers', name: copyTiers.name, desc: `Copied ${totalCopies} / ${copyTiers.goal} responses.`, icon: copyTiers.icon, color: copyTiers.color, unlocked: copyTiers.unlocked },
        { id: 'the_creator', name: "The Creator", desc: "Created your first response.", icon: "fa-plus-circle", color: "text-green-400", unlocked: events.some(e => e.type === 'create_response') },
        { id: 'librarian_tiers', name: librarianTiers.name, desc: `Created ${totalCategories} / ${librarianTiers.goal} categories.`, icon: librarianTiers.icon, color: librarianTiers.color, unlocked: librarianTiers.unlocked },
        { id: 'the_architect', name: "The Architect", desc: "Create a category with 5+ responses.", icon: "fa-drafting-compass", color: "text-teal-400", unlocked: hasArchitectAchievement },
        { id: 'the_editor', name: "The Editor", desc: "Edited a response.", icon: "fa-pencil-alt", color: "text-indigo-400", unlocked: events.some(e => e.type === 'edit_response') },
        { id: 'the_curator', name: "The Curator", desc: "Pinned a response.", icon: "fa-thumbtack", color: "text-white", unlocked: hasPinnedResponse },
        { id: 'the_color_coder', name: "The Color Coder", desc: "Changed a category's color.", icon: "fa-palette", color: "text-pink-400", unlocked: events.some(e => e.type === 'change_color') },
        { id: 'the_explorer', name: "The Explorer", desc: "Visited all main pages.", icon: "fa-compass", color: "text-orange-400", unlocked: visitedPages.has('canned-responses') && visitedPages.has('fedex-tracker') && visitedPages.has('helpful-links') },
        { id: 'the_data_hoarder', name: "The Data Hoarder", desc: "Imported a data file.", icon: "fa-cloud-download-alt", color: "text-sky-400", unlocked: events.some(e => e.type === 'import_data') },
        { id: 'the_personalizer', name: "The Personalizer", desc: "Added a new helpful link.", icon: "fa-link", color: "text-lime-400", unlocked: events.some(e => e.type === 'add_link') },
        { id: 'the_globetrotter', name: "The Globetrotter", desc: "Used responses from 2+ categories in one session.", icon: "fa-globe-americas", color: "text-cyan-400", unlocked: events.some(e => e.type === 'globetrotter_milestone') },
        { id: 'the_night_owl', name: "The Night Owl", desc: `Use dark mode for 5 consecutive days. (${darkModeUsage.streak}/5)`, icon: "fa-moon", color: "text-purple-400", unlocked: darkModeUsage.streak >= 5 },
        { id: 'endless_scroll', name: "The Endless Scroll", desc: `Copy 1,000 responses. (${totalCopies}/1000)`, icon: "fa-infinity", color: "text-violet-500", unlocked: totalCopies >= 1000 },
        { id: 'perfect_day', name: "The Perfect Day", desc: "Copy 10+ responses, extract 3+ tracking numbers, and add a link in one day.", icon: "fa-sun", color: "text-yellow-300", unlocked: hasPerfectDay },
        { id: 'living_library', name: "The Living Library", desc: "Create a category, add a response with a placeholder, and pin it.", icon: "fa-book-dead", color: "text-green-600", unlocked: hasLivingLibrary },
        { id: 'the_scribe', name: "The Scribe", desc: "Use a response from 5 different categories in 30 minutes.", icon: "fa-feather-alt", color: "text-gray-300", unlocked: hasTheScribe },
        { id: 'the_historian', name: "The Historian", desc: `Be a member for 365 days. (${daysSinceSignIn}/365)`, icon: "fa-calendar-alt", color: "text-red-400", unlocked: hasHistorian },
        { id: 'streak_breaker', name: "The Streak Breaker", desc: `Maintain a 90 business-day usage streak. (${maxStreak}/90)`, icon: "fa-fire", color: "text-red-500", unlocked: hasStreakBreaker },
        { id: 'meticulous_mover', name: "The Meticulous Mover", desc: "Edit a response and move it to a different category.", icon: "fa-truck-moving", color: "text-blue-500", unlocked: events.some(e => e.type === 'move_response') },
        { id: 'clean_slate', name: "The Clean Slate", desc: "Delete at least 5 responses in a single session.", icon: "fa-broom", color: "text-amber-600", unlocked: hasCleanSlate },
        { id: 'the_purist', name: "The Purist", desc: "Copy a response that has no placeholders.", icon: "fa-file-alt", color: "text-slate-300", unlocked: events.some(e => e.type === 'copy_purist') },
        { id: 'the_improviser', name: "The Improviser", desc: "Add a placeholder to a response that didn't have one.", icon: "fa-cogs", color: "text-cyan-500", unlocked: events.some(e => e.type === 'add_placeholder') },
    ];

    const allOtherAchievementsUnlocked = allAchievements.every(ach => ach.unlocked);
    const grandMasterAchievement = { id: 'grand_master', name: "The Grand Master", desc: "Unlock all other achievements.", icon: "fa-trophy", color: "text-yellow-400", unlocked: allOtherAchievementsUnlocked };
    
    const achievementsToRender = [...allAchievements, grandMasterAchievement];
	
    const unlockedCount = allAchievements.filter(a => a.unlocked).length;
    const totalCount = allAchievements.length;
    const progress = totalCount > 0 ? (unlockedCount / totalCount) * 100 : 0;
    
    document.getElementById('ach-progress-text').textContent = `${unlockedCount} / ${totalCount} Unlocked`;
    document.getElementById('ach-progress-bar').style.width = `${progress}%`;
    
    const container = document.getElementById('achievements-container');
    let filtered = activeAchievementFilter === 'unlocked' ? allAchievements.filter(a => a.unlocked) : allAchievements;

    if (filtered.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-400 col-span-full py-8">No achievements here yet!</p>';
        return;
    }
    
    container.innerHTML = filtered.map(ach => {
        const badgeClass = ach.unlocked ? getAchievementClassFromColor(ach.color) : 'achievement-icon-locked';
        const textColor = ach.unlocked ? 'text-gray-100' : 'text-gray-500';
        const sanitizedDesc = ach.desc.replace(/"/g, '&quot;');
        const unlockedDate = ach.unlocked ? (userAchievements[ach.id]?.date || new Date().toISOString()) : '';
        
        return `
            <div class="achievement-card-redesign floating-card ${ach.unlocked ? 'cursor-pointer' : 'cursor-default'}"
                 data-id="${ach.id}" data-name="${ach.name}" data-desc="${sanitizedDesc}"
                 data-icon="${ach.icon}" data-color="${ach.color || 'text-yellow-400'}"
                 data-unlocked="${ach.unlocked}" data-unlocked-date="${unlockedDate}">
                <div class="achievement-icon-wrapper ${badgeClass}">
                    <i class="fas ${ach.icon}"></i>
                </div>
                <div>
                    <p class="font-bold ${textColor}">${ach.name}</p>
                </div>
            </div>
        `;
    }).join('');
};

// --- Sets up the click listeners for the achievement filter tabs ---
const setupAchievementFiltering = () => {
    const achievementTabs = document.getElementById('achievement-tabs');
    if (achievementTabs) {
        achievementTabs.addEventListener('click', (e) => {
            const button = e.target.closest('.achievement-tab');
            if (button && button.dataset.filter !== activeAchievementFilter) {
                activeAchievementFilter = button.dataset.filter;
                document.querySelectorAll('.achievement-tab').forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('text-gray-300', 'hover:bg-gray-700');
                });
                button.classList.add('bg-blue-600', 'text-white');
                button.classList.remove('text-gray-300', 'hover:bg-gray-700');
                // Re-render the stats to apply the filter
                renderAdvancedStats();
            }
        });
    }
};		

// --- NEW: Challenge System Configuration ---
const CHALLENGES_CONFIG = {
    dailyCopies: {
        id: 'daily_copies',
        title: 'Daily Clicks',
        description: 'Copy 10 responses in a single day.',
        goal: 10,
        xp: 100,
        type: 'daily',
        icon: 'fa-sun',
        // This function calculates the user's current progress for this challenge
        getProgress: async (events) => {
            const todayStr = new Date().toISOString().split('T')[0];
            const todayStart = new Date(todayStr);
            const todaysCopies = events.filter(e => e.type === 'copy' && e.timestamp && e.timestamp.toDate() >= todayStart).length;
            return { current: todaysCopies };
        }
    },
    weeklyCopies: {
        id: 'weekly_copies',
        title: 'Weekly Warrior',
        description: 'Copy 50 responses in a single week.',
        goal: 50,
        xp: 500,
        type: 'weekly',
        icon: 'fa-calendar-week',
        getProgress: async (events) => {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday...
            const daysSinceMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - daysSinceMonday);
            startOfWeek.setHours(0, 0, 0, 0);

            const weeklyCopies = events.filter(e => e.type === 'copy' && e.timestamp && e.timestamp.toDate() >= startOfWeek).length;
            return { current: weeklyCopies };
        }
    }
};
		
const getCurrentDateString = () => {
    return new Date().toISOString().split('T')[0];
};

// NEW: Gets a unique ID for the current week (e.g., '2024-36')
const getCurrentWeekId = () => {
    const now = new Date();
    // Create a copy to avoid modifying the original date
    const date = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
    // Set to the nearest Thursday: current date + 4 - current day number
    // Make Sunday's day number 7
    date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7));
    // Get first day of year
    const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
    // Calculate full weeks to nearest Thursday
    const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    // Return year and week number
    return `${date.getUTCFullYear()}-${weekNo}`;
};	

const checkAndAwardChallengeXP = async (userId) => {
    if (!userId || isAnonymous) return;

    try {
        const todayStr = getCurrentDateString();
        const weekId = getCurrentWeekId();

        const userDocRef = getUserRootDocRef(userId);
        const userDoc = await getDoc(userDocRef);
        const userData = userDoc.exists() ? userDoc.data() : {};

        const eventsCollectionRef = getUserEventsCollectionRef(userId);

        // --- 1. Daily Challenge Check ---
        const lastDailyCompletion = userData.lastDailyChallengeDate || '';
        if (lastDailyCompletion !== todayStr) {
            const todayStart = new Date(todayStr);
            const querySnapshot = await getDocs(query(eventsCollectionRef));
            const events = querySnapshot.docs.map(doc => doc.data());
            const todaysCopies = events.filter(e => e.type === 'copy' && e.timestamp && e.timestamp.toDate() >= todayStart).length;

            if (todaysCopies >= 10) {
                await awardXP(100);
                await setDoc(userDocRef, { lastDailyChallengeDate: todayStr }, { merge: true });
                showMessage("Daily Challenge Complete! +100 XP", "success");
            }
        }

        // --- 2. Weekly Challenge Check ---
        const lastWeeklyCompletion = userData.lastWeeklyChallengeWeek || '';
        if (lastWeeklyCompletion !== weekId) {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const daysSinceMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - daysSinceMonday);
            startOfWeek.setHours(0, 0, 0, 0);

            const querySnapshot = await getDocs(query(eventsCollectionRef));
            const events = querySnapshot.docs.map(doc => doc.data());
            const weeklyCopies = events.filter(e => e.type === 'copy' && e.timestamp && e.timestamp.toDate() >= startOfWeek).length;

            if (weeklyCopies >= 50) {
                await awardXP(500);
                await setDoc(userDocRef, { lastWeeklyChallengeWeek: weekId }, { merge: true });
                showMessage("Weekly Challenge Complete! +500 XP", "success");
            }
        }
    } catch (error) {
        console.error("Error checking for challenge XP:", error);
    }
};		

const showLevelUpNotification = (level, rankName, rankIcon) => {
    const modal = document.getElementById('level-up-modal');
    const iconContainer = document.getElementById('modal-level-up-icon');
    const messageEl = document.getElementById('modal-level-up-message');

    if (!modal || !iconContainer || !messageEl) return;

    // Dynamically create the icon with the correct classes and styles for the modal
    const rankClass = `level-badge-${rankName.toLowerCase().replace(' ', '-')}`;
    iconContainer.innerHTML = `
        <div class="level-badge-wrapper ${rankClass}" style="width: 100px; height: 100px; margin: 0 auto; font-size: 3rem;">
            <i class="fas ${rankIcon}"></i>
        </div>
    `;
    // Update the message with the new level and rank
    messageEl.innerHTML = `You have reached <span class="font-bold text-white">Level ${level}</span> and achieved the rank of <span class="font-bold text-white">${rankName}</span>!`;

    // Show the modal
    modal.classList.remove('hidden');
};

const getAppControlDocRef = () => { return doc(db, 'artifacts', safeAppId, 'app_control', 'version_info'); };		
		
const showMessage = (text, type = 'success') => {
    const messageBox = document.getElementById('message-box');
    messageBox.textContent = text;
    messageBox.className = 'message-box show';
    if (type === 'success') {
        messageBox.style.backgroundColor = '#10B981';
    } else if (type === 'error') {
        messageBox.style.backgroundColor = '#EF4444';
    }
    setTimeout(() => {
        messageBox.className = 'message-box';
    }, 3000);
};

const getAchievementClassFromColor = (colorClass) => {
    switch (colorClass) {
        // Gold Tier
        case 'text-yellow-400':
        case 'text-yellow-300':
            return 'achievement-icon-gold';
        // Silver Tier
        case 'text-slate-400':
        case 'text-slate-300':
        case 'text-gray-300':
            return 'achievement-icon-silver';
        // Bronze Tier
        case 'text-amber-500':
        case 'text-amber-600':
            return 'achievement-icon-bronze';
        // Unique Colors
        case 'text-blue-400':
        case 'text-blue-500':
            return 'achievement-icon-blue';
        case 'text-green-400':
        case 'text-green-600':
            return 'achievement-icon-green';
        case 'text-teal-400':
            return 'achievement-icon-teal';
        case 'text-indigo-400':
            return 'achievement-icon-indigo';
        case 'text-white':
            return 'achievement-icon-white';
        case 'text-pink-400':
            return 'achievement-icon-pink';
        case 'text-orange-400':
            return 'achievement-icon-orange';
        case 'text-sky-400':
            return 'achievement-icon-sky';
        case 'text-lime-400':
            return 'achievement-icon-lime';
        case 'text-cyan-400':
        case 'text-cyan-500':
            return 'achievement-icon-cyan';
        case 'text-purple-400':
            return 'achievement-icon-purple';
        case 'text-violet-500':
            return 'achievement-icon-violet';
        case 'text-red-400':
        case 'text-red-500':
            return 'achievement-icon-red';
        // Fallback
        default:
            return 'achievement-icon-default';
    }
};	

const triggerCelebration = () => {
    // A fun confetti burst from both sides of the screen for 3 seconds
    const duration = 3 * 1000;
    const animationEnd = Date.now() + duration;
    const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

    function randomInRange(min, max) {
        return Math.random() * (max - min) + min;
    }

    const interval = setInterval(function() {
        const timeLeft = animationEnd - Date.now();
        if (timeLeft <= 0) {
            return clearInterval(interval);
        }
        const particleCount = 50 * (timeLeft / duration);
        // Launch from the left
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
        // Launch from the right
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
    }, 250);
};

// --- NEW: Leveling System Functions ---
const calculateXpForLevel = (level) => {
    if (level <= 1) return BASE_XP;
    // Apply the increase factor for every 2 levels
    const effectiveLevel = Math.floor((level - 1) / 2);
    return Math.floor(BASE_XP * Math.pow(XP_INCREASE_FACTOR, effectiveLevel));
};

const calculateLevelInfo = (totalXp) => {
    let level = 1;
    let xpForNextLevel = calculateXpForLevel(level);
    let xpTowardsNextLevel = totalXp;

    while (xpTowardsNextLevel >= xpForNextLevel) {
        xpTowardsNextLevel -= xpForNextLevel;
        level++;
        xpForNextLevel = calculateXpForLevel(level);
    }

    const rank = LEVEL_RANKS.slice().reverse().find(r => level >= r.level) || LEVEL_RANKS[0];

    return {
        level: level,
        rankName: rank.name,
        rankIcon: rank.icon,
        xpForNextLevel: xpForNextLevel,
        xpProgress: xpTowardsNextLevel,
        totalXp: totalXp
    };
};


const awardXP = async (amount) => {
    if (!userId || isAnonymous) return;

    const userDocRef = getUserRootDocRef(userId);
    try {
        const userDoc = await getDoc(userDocRef);
        const userData = userDoc.exists() ? userDoc.data() : { xp: 0 };
        const oldXp = userData.xp || 0;
        const newXp = oldXp + amount;

        const oldLevelInfo = calculateLevelInfo(oldXp);
        const newLevelInfo = calculateLevelInfo(newXp);

        await setDoc(userDocRef, { xp: newXp }, { merge: true });
		await updateLeaderboardData(userId, newLevelInfo);

        // Check for a LEVEL up
        if (newLevelInfo.level > oldLevelInfo.level) {
            showLevelUpNotification(newLevelInfo.level, newLevelInfo.rankName, newLevelInfo.rankIcon);

            triggerCelebration(); // Trigger confetti on every level up!
            const sound = document.getElementById('level-up-sound');
            if (sound) {
                sound.currentTime = 0; // Rewind to start
                sound.play().catch(e => console.error("Level up audio play failed:", e));
            }

            const levelDisplay = document.getElementById('level-display');
            if (levelDisplay) {
                levelDisplay.classList.add('level-up-animation');
                setTimeout(() => levelDisplay.classList.remove('level-up-animation'), 1500);
            }
        }
        
        // Check for a RANK up to trigger the icon animation
        if (newLevelInfo.rankName !== oldLevelInfo.rankName) {
            const iconWrapper = document.querySelector('.level-badge-wrapper');
            if (iconWrapper) {
                iconWrapper.classList.add('rank-up-glow');
                setTimeout(() => iconWrapper.classList.remove('rank-up-glow'), 1500);
            }
        }

    } catch (error) {
        console.error("Error awarding XP:", error);
    }
};

		
const showAchievementNotification = (achievement) => {
    const toast = document.getElementById('achievement-toast');
    const toastMessage = document.getElementById('toast-message');
    const toastIcon = document.getElementById('toast-icon');
    const sound = document.getElementById('achievement-sound');

    if (!toast || !toastMessage || !toastIcon || !sound) return;

    // Update content
    toastIcon.innerHTML = `<i class="fas ${achievement.icon}"></i>`;
	toastIcon.className = `text-2xl ${achievement.color || 'text-yellow-400'}`;
    toastMessage.textContent = achievement.name;

    // Play sound
    sound.currentTime = 0; // Rewind to start
    sound.play().catch(e => console.error("Audio play failed:", e));

    // Show toast
    toast.classList.remove('opacity-0', 'translate-y-5');

    // Hide after 5 seconds
    setTimeout(() => {
        toast.classList.add('opacity-0', 'translate-y-5');
    }, 5000);
    setTimeout(() => {
        const badgeOnPage = document.querySelector(`.achievement-badge[data-id="${achievement.id}"]`);
        if (badgeOnPage) {
            badgeOnPage.classList.add('newly-unlocked');
            // Remove the class after the animation finishes so it doesn't replay
            setTimeout(() => {
                badgeOnPage.classList.remove('newly-unlocked');
            }, 700); // Must match the animation duration in CSS
        }
    }, 100);
};
		

   const clearTutorialHighlights = () => {
    document.querySelectorAll('.highlight-target').forEach(el => {
        el.classList.remove('highlight-target');
    });
};		

// Add this new function to your helper functions section
const renderLinks = (searchQuery = '') => {
    const staticLinksList = document.getElementById('static-links-list');
    const userLinksList = document.getElementById('user-links-list');
    const userLinksSection = document.getElementById('user-links-section');

    const query = searchQuery.toLowerCase();
    const regex = new RegExp(`(${query})`, 'gi'); // Create a case-insensitive regex for highlighting

    // Filter static links based on the search query
    const filteredStaticLinks = defaultLinks.filter(link => 
        link.title.toLowerCase().includes(query) ||
        (link.description && link.description.toLowerCase().includes(query))
    );
    
    // Filter user links if they exist
    let filteredUserLinks = [];
    if (userLinks && userLinks.length > 0) {
        filteredUserLinks = userLinks.filter(link =>
            link.title.toLowerCase().includes(query) ||
            (link.description && link.description.toLowerCase().includes(query))
        );
    }
    
    // Render static links
    staticLinksList.innerHTML = '';
    if (filteredStaticLinks.length > 0) {
        filteredStaticLinks.forEach(link => {
            const card = document.createElement('div');
            card.className = 'link-card rounded-xl p-6 shadow-2xl pulse-effect';
            
            // Apply highlighting to title and description
            const highlightedTitle = query ? link.title.replace(regex, `<span class="highlight">$&</span>`) : link.title;
            const highlightedDescription = query && link.description ? link.description.replace(regex, `<span class="highlight">$&</span>`) : (link.description || 'No description available.');

            card.innerHTML = `
                <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="block">
                    <h3 class="font-bold text-xl text-white hover:text-sky-300 transition-colors mb-2">${highlightedTitle}</h3>
                    <p class="text-sm text-gray-400">${highlightedDescription}</p>
                </a>
            `;
            staticLinksList.appendChild(card);
        });
    } else {
        staticLinksList.innerHTML = '<p class="text-center text-gray-400 col-span-full">No static links found.</p>';
    }
    
    // Render user links
    userLinksList.innerHTML = '';
    if (!isAnonymous && filteredUserLinks.length > 0) {
        userLinksSection.classList.remove('hidden'); // Ensure the section is visible if there are links
        filteredUserLinks.forEach(link => {
            const card = document.createElement('div');
            card.className = 'link-card rounded-xl p-6 shadow-2xl pulse-effect flex items-center justify-between relative';
            
            // Apply highlighting to title and description
            const highlightedTitle = query ? link.title.replace(regex, `<span class="highlight">$&</span>`) : link.title;
            const highlightedDescription = query && link.description ? link.description.replace(regex, `<span class="highlight">$&</span>`) : (link.description || 'No description available.');
            
            card.innerHTML = `
                <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="flex-grow">
                    <h3 class="font-bold text-xl text-white hover:text-sky-300 transition-colors mb-2">${highlightedTitle}</h3>
                    <p class="text-sm text-gray-400">${highlightedDescription}</p>
                </a>
                <div class="relative inline-block text-left" data-doc-id="${link.id}" data-title="${link.title}" data-url="${link.url}" data-description="${link.description || ''}">
                    <button type="button" class="meatballs-button p-2 text-gray-400 hover:text-white transition-colors" aria-expanded="true" aria-haspopup="true">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 pointer-events-none">
                            <path d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM11.5 15a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z" />
                        </svg>
                    </button>
                    <div class="meatballs-menu hidden absolute right-0 mt-2 w-48 origin-top-right rounded-md bg-gray-700 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-10">
                        <div class="py-1">
                            <button class="edit-link-btn text-gray-200 block w-full text-left px-4 py-2 text-sm hover:bg-gray-600">Edit</button>
                            <button class="delete-link-btn text-red-400 block w-full text-left px-4 py-2 text-sm hover:bg-gray-600">Delete</button>
                        </div>
                    </div>
                </div>
            `;
            userLinksList.appendChild(card);
        });
    } else if (!isAnonymous) {
        userLinksList.innerHTML = '<p class="text-center text-gray-400 col-span-full">No user links found.</p>';
    }
    
    // Hide or show the user links section based on the filtered results
    if (isAnonymous) {
      userLinksSection.classList.add('hidden');
    } else {
      userLinksSection.classList.remove('hidden');
    }
};

		

// This is the new, combined function that handles all tutorial logic
const showTutorialStep = async (stepIndex) => {
	    isTutorialActive = true;
    // Define the elements and their positions for each step
    const highlightedElements = [
        null, // Step 0 (Welcome)
        document.getElementById('add-response-section'), // Step 1: Add New Response
        document.getElementById('search-bar-container'), // Step 2: Search Bar
        document.getElementById('category-bar'), // Step 3: Categories
        document.getElementById('category-menu-container'), // Step 4: Kebab menu
        null, // Step 5: Will find dynamically below
        null, // Step 6: Will find dynamically below
        null, // Step 7: Dynamic Placeholders
        null, // Step 8: Placeholder Demo
		document.getElementById('hamburger-menu-btn'), // New Step 10: Highlights the hamburger icon
        document.getElementById('input-text-fedex'), // Step 11: FedEx Tracker
        document.getElementById('copy-button-fedex'), // Step 12: New highlight
		null,
		null,
    ];
    
    const positionClasses = [
        'show-modal', // Step 0: Centered modal
        'top-right',  // Step 1: Add response section
        'top-right',  // Step 2: Search bar
        'bottom-left', // Step 3: Category bar
        'upper-right', // Step 4: Kebab menu
        'on-response', // Step 5: Manage Responses (new)
        'on-response', // Step 6: Pin button (new)
        'left-response', // Step 7: Dynamic placeholders
        'show-modal', // Step 8: Placeholder demo
		'top-left',
        'on-tracker-page', // Step 10: New position
        'on-tracker-page', // Step 11: Position on the tracker page
		'show-modal',
		'show-modal',
		
    ];

    const tutorialModal = document.getElementById('tutorial-modal');
    const tutorialOverlay = document.getElementById('tutorial-overlay');

    tutorialSteps.forEach((step, index) => {
        if (index !== stepIndex) {
            step.classList.add('hidden');
        } else {
            step.classList.remove('hidden');
        }
    });
    // Determine the target page based on the tutorial step
    const targetPage = tutorialPages[stepIndex];

    // Check if a page change is required
    if (currentPage !== targetPage) {
        currentPage = targetPage;
        
        // Use a promise to wait for the page to render.
        // This is the crucial change to fix the race condition.
        await new Promise(resolve => {
            renderContent();
            requestAnimationFrame(() => {
                requestAnimationFrame(resolve);
            });
        });
    }
	
    // We now clear the highlights and hide the modal AFTER the page content is rendered.
    clearTutorialHighlights();
    tutorialModal.classList.remove(...positionClasses);

    const currentStepElement = tutorialSteps[stepIndex];
    if (currentStepElement) {
        currentStepElement.classList.remove('hidden');

        // Dynamically set highlights based on stepIndex
        if (stepIndex === 5) {
            const firstResponse = document.querySelector('.response-item');
            if (firstResponse) {
                const buttons = firstResponse.querySelectorAll('.copy-btn, .edit-btn, .delete-btn');
                buttons.forEach(button => button.classList.add('highlight-target'));
            }
        } else if (stepIndex === 6) {
            const firstResponse = document.querySelector('.response-item');
            if (firstResponse) {
                const pinButton = firstResponse.querySelector('.pin-btn');
                if (pinButton) pinButton.classList.add('highlight-target');
            }
        } else if (stepIndex === 7) {
            const responsesWithPlaceholders = [];
            if (categories[activeCategory]) {
                categories[activeCategory].responses.forEach(response => {
                    if (response.text.match(/\[([^\]]+)\]/g)) {
                        responsesWithPlaceholders.push(document.querySelector(`.response-item[data-id="${response.id}"]`));
                    }
                });
            }
            if (responsesWithPlaceholders.length === 0) {
                for (const category in categories) {
                    categories[category].responses.forEach(response => {
                        if (response.text.match(/\[([^\]]+)\]/g)) {
                            const foundResponse = document.querySelector(`.response-item[data-id="${response.id}"]`);
                            if (foundResponse) {
                                responsesWithPlaceholders.push(foundResponse);
                            }
                        }
                    });
                }
            }
            const responseToHighlight = responsesWithPlaceholders[0];
            if (responseToHighlight) {
                responseToHighlight.classList.add('highlight-target');
                if (responseToHighlight.dataset.category !== activeCategory) {
                    activeCategory = responseToHighlight.dataset.category;
                    renderCategories();
                    const newHighlight = document.querySelector(`.response-item[data-id="${responseToHighlight.dataset.id}"]`);
                    if (newHighlight) {
                        newHighlight.classList.add('highlight-target');
                        newHighlight.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                } else {
                    responseToHighlight.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            } else {
                console.warn("No canned response with dynamic placeholders found for the tutorial.");
            }
		} else if (stepIndex === 9) { // New logic for the hamburger icon
		const hamburgerBtn = document.getElementById('hamburger-menu-btn');
        hamburgerBtn.classList.add('highlight-target', 'bg-gray-700');	
			hamburgerBtn.scrollIntoView({
            		behavior: 'smooth',
            		block: 'start' // This positions the element at the top of the viewport
        });
        } else if (stepIndex === 10) {
            document.getElementById('input-text-fedex').classList.add('highlight-target');
            document.getElementById('input-text-fedex').scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        } else if (stepIndex === 11) {
            document.getElementById('copy-button-fedex').classList.add('highlight-target');
            document.getElementById('copy-button-fedex').scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        } else {
            const targetElement = highlightedElements[stepIndex];
            if (targetElement) {
                if (Array.isArray(targetElement)) {
                    targetElement.forEach(el => {
                        el.classList.add('highlight-target');
                    });
                } else {
                    targetElement.classList.add('highlight-target');
                }
            }
        }
    }

    // Now, show the modal with the correct positioning
    tutorialModal.classList.remove('hidden');
    tutorialOverlay.classList.remove('hidden');
    tutorialModal.classList.add('modal', positionClasses[stepIndex]);

    // Update button visibility
    const tutorialBackBtn = document.getElementById('tutorial-back-btn');
    const tutorialNextBtn = document.getElementById('tutorial-next-btn');
    const tutorialFinishBtn = document.getElementById('tutorial-finish-btn');
    tutorialBackBtn.classList.toggle('hidden', stepIndex === 0);
    tutorialNextBtn.classList.toggle('hidden', stepIndex === tutorialSteps.length - 1);
    tutorialFinishBtn.classList.toggle('hidden', stepIndex !== tutorialSteps.length - 1);

    currentTutorialStep = stepIndex;
};
		

const logUserEvent = async (eventType, eventData = {}) => {
    if (!userId || isAnonymous) return; // Don't log for anonymous users
    try {
        const eventsCollectionRef = getUserEventsCollectionRef(userId);
	    const cleanedEventData = {};
	    for (const key in eventData) {
	        if (eventData[key] !== undefined) {
	            cleanedEventData[key] = eventData[key];
	        }
        }	
        await addDoc(eventsCollectionRef, {
            type: eventType,
            timestamp: serverTimestamp(),
            ...eventData
        });

        // --- Add Globetrotter Logic ---
        if (eventType === 'copy' && eventData.categoryName) {
            let categoriesUsed = JSON.parse(sessionStorage.getItem('categoriesUsedInSession') || '[]');
            if (!categoriesUsed.includes(eventData.categoryName)) {
                categoriesUsed.push(eventData.categoryName);
                sessionStorage.setItem('categoriesUsedInSession', JSON.stringify(categoriesUsed));
                // If this is the second unique category, log the milestone
                if (categoriesUsed.length >= 2) {
                    // Log a specific event for this so we only unlock it once
                    const events = await getDocs(query(eventsCollectionRef));
                    const hasMilestone = events.docs.some(doc => doc.data().type === 'globetrotter_milestone');
                    if (!hasMilestone) {
                         await addDoc(eventsCollectionRef, { type: 'globetrotter_milestone', timestamp: serverTimestamp() });
                    }
                }
            }
        }
    } catch (error) {
        console.error("Error logging user event:", error);
        // We don't show a message to the user for this, as it's a background task.
    }
};

const updateDarkModeStreak = async () => {
    if (isAnonymous || !userId || document.body.classList.contains('light-mode')) {
        return; // Only run for signed-in users when in dark mode
    }

    const userDocRef = getUserRootDocRef(userId);
    const userDoc = await getDoc(userDocRef);
    const today = new Date().toISOString().split('T')[0];
    
    const data = userDoc.exists() ? userDoc.data() : {};
    const darkModeUsage = data.darkModeUsage || { lastUsed: null, streak: 0 };

    if (darkModeUsage.lastUsed === today) {
        return; // Already counted for today
    }
    
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = yesterday.toISOString().split('T')[0];

    if (darkModeUsage.lastUsed === yesterdayStr) {
        darkModeUsage.streak++; // It's a consecutive day, increment!
    } else {
        darkModeUsage.streak = 1; // Not consecutive, reset to 1
    }
    darkModeUsage.lastUsed = today;
    
    await setDoc(userDocRef, { darkModeUsage }, { merge: true });
    logUserEvent('used_dark_mode'); // Log this to trigger the achievement check
};

const getTier = (count, tiers) => {
    // Start with the default "locked" state
    let currentTier = {
        name: tiers[0].name,
        desc: `Reach the first tier at ${tiers[0].goal}!`,
        icon: 'fa-lock', // A locked icon by default
        color: 'text-gray-600',
        unlocked: false,
        progress: count,
        goal: tiers[0].goal
    };

    // Loop backward through the tiers to find the highest one the user has achieved
    for (let i = tiers.length - 1; i >= 0; i--) {
        if (count >= tiers[i].goal) {
            const nextGoal = (i + 1 < tiers.length) ? tiers[i+1].goal : tiers[i].goal;
            currentTier = { ...tiers[i], unlocked: true, progress: count, goal: nextGoal };

            // Update the description based on progress to the next tier
            if (count >= nextGoal && i === tiers.length - 1) {
                currentTier.desc = "Max tier reached!";
            } else {
                currentTier.desc = `Reach the next tier at ${nextGoal}!`;
            }
            break; // Found the correct tier, no need to check lower ones
        }
    }
    return currentTier;
};		

const checkAndNotifyAchievements = async (firstSignIn) => {
    if (!userId || isAnonymous) return;
	
    const milestoneAchievements = [
        'copy_tiers',        // For unlocking any "Wordsmith" or "Master" tier
        'librarian_tiers',   // For unlocking any "Head Archivist" or "Chief" tier
        'endless_scroll',    // A very big milestone!
        'the_historian',     // A long-term achievement
        'streak_breaker',    // Rewarding consistency
        'grand_master'       // The ultimate achievement!
    ];
    // Get the latest events and user data
    const eventsCollectionRef = getUserEventsCollectionRef(userId);
    const snapshot = await getDocs(query(eventsCollectionRef));
    const events = snapshot.docs.map(doc => doc.data());
    
    const userDocRef = getUserRootDocRef(userId);
    const userDoc = await getDoc(userDocRef);
	const userData = userDoc.exists() ? userDoc.data() : {};
	const userAchievements = userData.achievementsData || {};
	const darkModeUsage = userData.darkModeUsage || { streak: 0 };
	const daysSinceSignIn = firstSignIn ? Math.floor((new Date() - firstSignIn) / (1000 * 60 * 60 * 24)) : 0;

    const totalCopies = events.filter(e => e.type === 'copy').length;
    const totalCategories = Object.keys(categories).length;
    const hasArchitectAchievement = Object.values(categories).some(cat => cat.responses && cat.responses.length >= 5);
    const visitedPages = new Set(events.filter(e => e.type === 'visit_page').map(e => e.page));

	const copyEvents = events.filter(e => e.type === 'copy');
    const categoriesUsedInSession = new Set();
    const sessionStartTime = new Date(Date.now() - 30 * 60 * 1000); // last 30 minutes
    copyEvents.forEach(event => {
        if (event.timestamp?.toDate() > sessionStartTime && event.categoryName) {
            categoriesUsedInSession.add(event.categoryName);
        }
    });
    const hasGlobetrotter = categoriesUsedInSession.size >= 2;

	const dailyActivity = events.reduce((acc, event) => {
	    if (!event.timestamp) return acc;
	    const date = event.timestamp.toDate().toISOString().split('T')[0];
	    if (!acc[date]) acc[date] = { copies: 0, tracking: 0, links: 0 };
	    if (event.type === 'copy') acc[date].copies++;
	    if (event.type === 'extract_tracking') acc[date].tracking += (event.count || 0);
	    if (event.type === 'add_link') acc[date].links++;
	    return acc;
	}, {});
	const hasPerfectDay = Object.values(dailyActivity).some(day => day.copies >= 10 && day.tracking >= 3 && day.links >= 1);
	const hasCreatedCategory = events.some(e => e.type === 'create_category');
	const hasCreatedResponseWithPlaceholder = events.some(e => e.type === 'create_response' && /\[([^\]]+)\]/g.test(e.text || ''));
	const hasPinnedResponse = events.some(e => e.type === 'pin_response');
	const hasLivingLibrary = hasCreatedCategory && hasCreatedResponseWithPlaceholder && hasPinnedResponse;
	const recentCopyEvents = events.filter(e => e.type === 'copy' && e.timestamp?.toDate() > new Date(Date.now() - 30 * 60 * 1000));
	const uniqueCategoriesIn30Min = new Set(recentCopyEvents.map(e => e.categoryName)).size;
	const hasTheScribe = uniqueCategoriesIn30Min >= 5;
	const hasHistorian = daysSinceSignIn >= 365;
	const isBusinessDay = (date) => { const day = date.getDay(); return day > 0 && day < 6; };
	const usageDates = [...new Set(events.filter(e => e.timestamp).map(e => e.timestamp.toDate().toISOString().split('T')[0]))].sort();
	let maxStreak = 0;
	if (usageDates.length > 0) {
	    let currentStreak = 1;
	    for (let i = 1; i < usageDates.length; i++) {
	        const prevDate = new Date(usageDates[i - 1]);
	        const currentDate = new Date(usageDates[i]);
	        if (!isBusinessDay(currentDate)) continue;
	        const diffTime = currentDate - prevDate;
	        const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
	        if (diffDays === 1 || (prevDate.getDay() === 5 && diffDays === 3)) {
	            currentStreak++;
	        } else {
	            maxStreak = Math.max(maxStreak, currentStreak);
	            currentStreak = 1;
	        }
	    }
	    maxStreak = Math.max(maxStreak, currentStreak);
	}
	const hasStreakBreaker = maxStreak >= 90;
	const deletedInLast5Mins = events.filter(e => e.type === 'delete_response_single' && e.timestamp?.toDate() > new Date(Date.now() - 5 * 60 * 1000)).length;
	const hasCleanSlate = deletedInLast5Mins >= 5;	


	const copyTiers = getTier(totalCopies, [
        { name: "Copycat", goal: 10, icon: "fa-clipboard", color: "text-amber-500" },
        { name: "Wordsmith", goal: 50, icon: "fa-clipboard", color: "text-slate-400" },
        { name: "Master of Efficiency", goal: 100, icon: "fa-clipboard", color: "text-yellow-400" }
    ]);
    
    const librarianTiers = getTier(totalCategories, [
        { name: "The Librarian", goal: 5, icon: "fa-book-open", color: "text-amber-500" },
        { name: "Head Archivist", goal: 10, icon: "fa-book-open", color: "text-slate-400" },
        { name: "Chief Organizer", goal: 25, icon: "fa-book-open", color: "text-yellow-400" }
    ]);
    
const achievements = [
    // Core Actions
    { id: 'first_responder', name: "First Responder", desc: "Copied your first response.", icon: "fa-rocket", color: "text-blue-400", unlocked: totalCopies > 0 },
    { id: 'copy_tiers', name: copyTiers.name, desc: `Copied ${totalCopies} / ${copyTiers.goal} responses.`, icon: copyTiers.icon, color: copyTiers.color, unlocked: copyTiers.unlocked },
    { id: 'the_creator', name: "The Creator", desc: "Created your first response.", icon: "fa-plus-circle", color: "text-green-400", unlocked: events.some(e => e.type === 'create_response') },
    
    // Organization & Management
    { id: 'librarian_tiers', name: librarianTiers.name, desc: `Created ${totalCategories} / ${librarianTiers.goal} categories.`, icon: librarianTiers.icon, color: librarianTiers.color, unlocked: librarianTiers.unlocked },
    { id: 'the_architect', name: "The Architect", desc: "Create a category with 5+ responses.", icon: "fa-drafting-compass", color: "text-teal-400", unlocked: hasArchitectAchievement },
    { id: 'the_editor', name: "The Editor", desc: "Edited a response.", icon: "fa-pencil-alt", color: "text-indigo-400", unlocked: events.some(e => e.type === 'edit_response') },
    { id: 'the_curator', name: "The Curator", desc: "Pinned a response.", icon: "fa-thumbtack", color: "text-white", unlocked: hasPinnedResponse },
    { id: 'the_color_coder', name: "The Color Coder", desc: "Changed a category's color.", icon: "fa-palette", color: "text-pink-400", unlocked: events.some(e => e.type === 'change_color') },

    // Exploration & Discovery
    { id: 'the_explorer', name: "The Explorer", desc: "Visited all main pages.", icon: "fa-compass", color: "text-orange-400", unlocked: visitedPages.has('canned-responses') && visitedPages.has('fedex-tracker') && visitedPages.has('helpful-links') },
    { id: 'the_data_hoarder', name: "The Data Hoarder", desc: "Imported a data file.", icon: "fa-cloud-download-alt", color: "text-sky-400", unlocked: events.some(e => e.type === 'import_data') },
    { id: 'the_personalizer', name: "The Personalizer", desc: "Added a new helpful link.", icon: "fa-link", color: "text-lime-400", unlocked: events.some(e => e.type === 'add_link') },
    { id: 'the_globetrotter', name: "The Globetrotter", desc: "Used responses from 2+ categories in one session.", icon: "fa-globe-americas", color: "text-cyan-400", unlocked: events.some(e => e.type === 'globetrotter_milestone') },
    { id: 'the_night_owl', name: "The Night Owl", desc: `Use dark mode for 5 consecutive days. (${darkModeUsage.streak}/5)`, icon: "fa-moon", color: "text-purple-400", unlocked: darkModeUsage.streak >= 5 },
    
    // --- YOUR NEW ADVANCED ACHIEVEMENTS (Now with colors!) ---
    { id: 'endless_scroll', name: "The Endless Scroll", desc: `Copy 1,000 responses. (${totalCopies}/1000)`, icon: "fa-infinity", color: "text-violet-500", unlocked: totalCopies >= 1000 },
    { id: 'perfect_day', name: "The Perfect Day", desc: "Copy 10+ responses, extract 3+ tracking numbers, and add a link in one day.", icon: "fa-sun", color: "text-yellow-300", unlocked: hasPerfectDay },
    { id: 'living_library', name: "The Living Library", desc: "Create a category, add a response with a placeholder, and pin it.", icon: "fa-book-dead", color: "text-green-600", unlocked: hasLivingLibrary },
    { id: 'the_scribe', name: "The Scribe", desc: "Use a response from 5 different categories in 30 minutes.", icon: "fa-feather-alt", color: "text-gray-300", unlocked: hasTheScribe },
    { id: 'the_historian', name: "The Historian", desc: `Be a member for 365 days. (${daysSinceSignIn}/365)`, icon: "fa-calendar-alt", color: "text-red-400", unlocked: hasHistorian },
    { id: 'streak_breaker', name: "The Streak Breaker", desc: `Maintain a 90 business-day usage streak. (${maxStreak}/90)`, icon: "fa-fire", color: "text-red-500", unlocked: hasStreakBreaker },
    { id: 'meticulous_mover', name: "The Meticulous Mover", desc: "Edit a response and move it to a different category.", icon: "fa-truck-moving", color: "text-blue-500", unlocked: events.some(e => e.type === 'move_response') },
    { id: 'clean_slate', name: "The Clean Slate", desc: "Delete at least 5 responses in a single session.", icon: "fa-broom", color: "text-amber-600", unlocked: hasCleanSlate },
    { id: 'the_purist', name: "The Purist", desc: "Copy a response that has no placeholders.", icon: "fa-file-alt", color: "text-slate-300", unlocked: events.some(e => e.type === 'copy_purist') },
    { id: 'the_improviser', name: "The Improviser", desc: "Add a placeholder to a response that didn't have one.", icon: "fa-cogs", color: "text-cyan-500", unlocked: events.some(e => e.type === 'add_placeholder') },
];

    const newAchievementsToSave = {};

    achievements.forEach(ach => {
        if (ach.unlocked && !userAchievements[ach.id]) {
            showAchievementNotification(ach);
            newAchievementsToSave[ach.id] = { date: new Date().toISOString() };
			awardXP(XP_VALUES.UNLOCK_ACHIEVEMENT);
			
			if (milestoneAchievements.includes(ach.id)) {
                triggerCelebration();
            }

        }
    });

    // If we have new achievements to notify, update Firestore
    if (Object.keys(newAchievementsToSave).length > 0) {
        await setDoc(userDocRef, { achievementsData: newAchievementsToSave }, { merge: true });
    }
};	
		
const getCannedResponsesBlueprint = async () => { return defaultCannedResponsesBlueprint; };
const getHelpfulLinksBlueprint = async () => { return defaultHelpfulLinksBlueprint; };
const getUserCannedResponsesDocRef = (uid) => { return doc(db, 'artifacts', safeAppId, 'users', uid, 'canned_responses_data', 'app_data'); };
const getUserHelpfulLinksCollectionRef = (uid) => { return collection(db, 'artifacts', safeAppId, 'users', uid, 'helpful_links_data'); };
const getUserRootDocRef = (uid) => { return doc(db, 'artifacts', safeAppId, 'users', uid); }
const getUserEventsCollectionRef = (uid) => { return collection(db, 'artifacts', safeAppId, 'users', uid, 'user_events'); };		

const saveToFirestore = async (dataToSave) => {
    if (!userId || isAnonymous) {
        console.error("User not authenticated or is anonymous. Cannot save data.");
        showMessage("Please sign in to save your data.", 'error');
        return;
    }
    const userDocRef = getUserCannedResponsesDocRef(userId);
    try {
        const cleanedData = JSON.parse(JSON.stringify(dataToSave));
        for (const key in cleanedData) {
            if (!cleanedData[key].responses) {
                cleanedData[key].responses = [];
            }
        }
        await setDoc(userDocRef, { categories: cleanedData });
    } catch (error) {
        console.error("Error saving to Firestore:", error);
        showMessage("Error saving data. Check your permissions.", 'error');
    }
};

const showUpdateNotification = (shouldShow) => {
    const settingsIndicator = document.getElementById('settings-update-indicator');
    const checkUpdatesIndicator = document.getElementById('check-updates-indicator');
    if (settingsIndicator && checkUpdatesIndicator) {
        if (shouldShow) {
            settingsIndicator.classList.remove('hidden');
            settingsIndicator.classList.add('update-indicator-pulse');
            checkUpdatesIndicator.classList.remove('hidden');
            checkUpdatesIndicator.classList.add('update-indicator-pulse');
        } else {
            settingsIndicator.classList.add('hidden');
            settingsIndicator.classList.remove('update-indicator-pulse');
            checkUpdatesIndicator.classList.add('hidden');
            checkUpdatesIndicator.classList.remove('update-indicator-pulse');
        }
    }
};

const checkForUpdatesOnLoad = async () => {
    if (!userId || isAnonymous) {
        showUpdateNotification(false);
        return;
    }

    try {
        // Get master version from Firestore
        const appControlDocRef = getAppControlDocRef();
        const appControlDoc = await getDoc(appControlDocRef);
        if (appControlDoc.exists()) {
            masterBlueprintVersion = appControlDoc.data().blueprintVersion || 1;
        }

        // Get user's last synced version
        const userDocRef = getUserRootDocRef(userId);
        const userDoc = await getDoc(userDocRef);
        const userData = userDoc.exists() ? userDoc.data() : {};
        const userSyncedVersion = userData.syncedBlueprintVersion || 0; // Default to 0 if not present

        // Compare and show notification if master version is newer
        if (masterBlueprintVersion > userSyncedVersion) {
            showUpdateNotification(true);
        } else {
            showUpdateNotification(false);
        }
    } catch (error) {
        console.error("Error checking for updates on load:", error);
        showUpdateNotification(false); // Hide on error
    }
};		

// --- Rendering Functions ---
const renderContent = () => {
    const cannedResponsesApp = document.getElementById('canned-responses-app');
    const fedexTrackerApp = document.getElementById('fedex-tracker-app');
    const helpfulLinksApp = document.getElementById('helpful-links-app');
	const myStatsPage = document.getElementById('my-stats-page');
    const settingsPage = document.getElementById('settings-page');
    const categoryBar = document.getElementById('category-bar');
    const mainTitle = document.getElementById('main-title');
    const categoryActionsBtn = document.getElementById('category-actions-btn');
    const categoryActionsMenu = document.getElementById('category-actions-menu');
    const addCategoryBtn = document.getElementById('add-category-btn');
    const addResponseSection = document.getElementById('add-response-section');
    const userLinksSection = document.getElementById('user-links-section');
    const addLinkSection = document.getElementById('add-link-section');
    const importExportBtnSettings = document.getElementById('import-export-btn-settings');
    const checkUpdatesBtnSettings = document.getElementById('check-updates-btn-settings');

    categoryActionsBtn.classList.add('hidden');
    categoryActionsMenu.classList.add('hidden');

    if (cannedResponsesApp) cannedResponsesApp.classList.add('hidden');
    if (fedexTrackerApp) fedexTrackerApp.classList.add('hidden');
    if (helpfulLinksApp) helpfulLinksApp.classList.add('hidden');
	if (myStatsPage) myStatsPage.classList.add('hidden');
    if (settingsPage) settingsPage.classList.add('hidden');
    if (categoryBar) categoryBar.classList.add('hidden');

    if (currentPage === 'canned-responses') {
        cannedResponsesApp.classList.remove('hidden');
        categoryBar.classList.remove('hidden');
        mainTitle.textContent = 'Canned Responses';
        renderCategories();

        if (!isAnonymous) {
            addCategoryBtn.classList.remove('hidden');
            addResponseSection.classList.remove('hidden');
            if (Object.keys(categories).length > 0) {
                categoryActionsBtn.classList.remove('hidden');
            }
        } else {
            addCategoryBtn.classList.add('hidden');
            addResponseSection.classList.add('hidden');
            categoryActionsBtn.classList.add('hidden');
        }
    } else if (currentPage === 'fedex-tracker') {
        fedexTrackerApp.classList.remove('hidden');
        mainTitle.textContent = 'FedEx Tracker';
        extractAndDisplayNumbers();
    } else if (currentPage === 'helpful-links') {
        helpfulLinksApp.classList.remove('hidden');
        mainTitle.textContent = 'Helpful Links';
		renderLinks();

        if (isAnonymous) {
            userLinksSection.classList.add('hidden');
            addLinkSection.classList.add('hidden');
        } else {
            userLinksSection.classList.remove('hidden');
            addLinkSection.classList.remove('hidden');
        }
	} else if (currentPage === 'my-stats') {
    myStatsPage.classList.remove('hidden');
    mainTitle.textContent = 'My Stats';
    renderAdvancedStats();
		
    } else if (currentPage === 'settings') {
        settingsPage.classList.remove('hidden');
        mainTitle.textContent = 'Settings';
        renderSettingsPage();
        if (isAnonymous) {
            importExportBtnSettings.classList.add('hidden');
            checkUpdatesBtnSettings.classList.add('hidden');
        } else {
            importExportBtnSettings.classList.remove('hidden');
            checkUpdatesBtnSettings.classList.remove('hidden');
        }
    }
};

// Add this new rendering function
const renderLeaderboard = async () => {
    const container = document.getElementById('leaderboard-container');
    if (!container) return;

    container.innerHTML = '<p class="text-gray-400">Loading leaderboard...</p>';

    try {
        const leaderboardColRef = collection(db, "leaderboard");
        // Query the top 10 users, ordered by XP
        const q = query(leaderboardColRef, orderBy("xp", "desc"), limit(10));
        
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
            container.innerHTML = '<p class="text-gray-400">The leaderboard is empty. Start copying to get on the board!</p>';
            return;
        }

        let leaderboardHTML = '';
        let rank = 1;

        querySnapshot.forEach(doc => {
            const userData = doc.data();
            const rankClass = rank <= 3 ? `top-${rank}` : '';
            
            leaderboardHTML += `
                <div class="leaderboard-entry">
                    <span class="leaderboard-rank ${rankClass}">${rank}</span>
                    <div class="level-badge-wrapper ${'level-badge-' + userData.rankName.toLowerCase()}" style="width: 40px; height: 40px; margin-left: 0.5rem;">
                        <i class="fas ${userData.rankIcon}" style="font-size: 1.25rem;"></i>
                    </div>
                    <div class="leaderboard-details">
                        <p class="font-semibold text-gray-100">${userData.displayName}</p>
                        <p class="text-sm text-gray-400">Level ${userData.level} - ${userData.rankName}</p>
                    </div>
                    <span class="leaderboard-xp">${userData.xp.toLocaleString()} XP</span>
                </div>
            `;
            rank++;
        });

        container.innerHTML = leaderboardHTML;

    } catch (error) {
        console.error("Error rendering leaderboard:", error);
        container.innerHTML = '<p class="text-red-400">Could not load leaderboard data.</p>';
    }
};		

const renderCategories = () => {
    const categoryList = document.getElementById('category-list');
    const addResponseSection = document.getElementById('add-response-section');
    const searchBarContainer = document.getElementById('search-bar-container');
    const categoryActionsBtn = document.getElementById('category-actions-btn');
    const categoryActionsMenu = document.getElementById('category-actions-menu');

    categoryList.innerHTML = '';
    const categoryNames = Object.keys(categories).sort();
    
    if (!isAnonymous && categoryNames.length > 0) {
        if (categoryActionsBtn) categoryActionsBtn.classList.remove('hidden');
    } else {
        if (categoryActionsBtn) {
            categoryActionsBtn.classList.add('hidden');
            categoryActionsMenu.classList.add('hidden');
        }
    }

    if (!isAnonymous) {
        addResponseSection.classList.remove('hidden');
        searchBarContainer.classList.remove('hidden');
    }
    
    categoryNames.forEach(name => {
        const button = document.createElement('button');
        
        // Determine the text color based on the theme
        const textColorClass = document.body.classList.contains('light-mode') ? 'text-gray-900' : 'text-white';
        
        // Determine the border color based on the theme
        const activeClass = name === activeCategory ?
            (document.body.classList.contains('light-mode') ? 'border-2 border-gray-900' : 'border-2 border-white') :
            '';

        button.className = `category-item font-bold py-2 px-4 rounded-lg shadow-md ${textColorClass} transition-colors
            ${activeClass}
            hover:scale-105 active:scale-95 transition-all duration-300`;
            
        let categoryColor = categories[name].color || '#60a5fa';

        if (document.body.classList.contains('light-mode')) {
            categoryColor = lightenColor(categoryColor);
        }

        button.style.backgroundColor = categoryColor;

        if (name === activeCategory) {
            button.style.borderColor = document.body.classList.contains('light-mode') ? '#111827' : '#FFFFFF';
        } else {
            button.style.borderColor = categoryColor;
        }

        const responseCount = categories[name]?.responses?.length || 0;
        button.textContent = `${name} (${responseCount})`;
        button.dataset.category = name;
        categoryList.appendChild(button);
    });
    
    if (!categories[activeCategory]) {
        activeCategory = categoryNames[0];
    }
    renderResponses();
};

const renderChallenges = async (events) => {
    const container = document.getElementById('challenges-container');
    if (!container) return;
    container.innerHTML = ''; // Clear previous content

    for (const challenge of Object.values(CHALLENGES_CONFIG)) {
        const progressData = await challenge.getProgress(events);
        const progressPercent = Math.min((progressData.current / challenge.goal) * 100, 100);
        const isComplete = progressData.current >= challenge.goal;

        const challengeCardHTML = `
            <div class="floating-card p-6 flex flex-col justify-between ${isComplete ? 'border-2 border-green-400' : ''}">
                <div>
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="text-xl font-bold text-gray-100">${challenge.title}</h4>
                            <p class="text-sm text-gray-400 mt-1">${challenge.description}</p>
                        </div>
                        <div class="text-2xl ${isComplete ? 'text-green-400' : 'text-gray-500'}">
                            <i class="fas ${isComplete ? 'fa-check-circle' : challenge.icon}"></i>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between items-center text-sm mb-1">
                        <span class="font-semibold ${isComplete ? 'text-green-400' : 'text-gray-300'}">
                            ${progressData.current.toLocaleString()} / ${challenge.goal.toLocaleString()}
                        </span>
                        <span class="font-bold text-yellow-400">+${challenge.xp} XP</span>
                    </div>
                    <div class="challenge-progress-container">
                        <div class="challenge-progress-bar" style="width: ${progressPercent}%;"></div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += challengeCardHTML;
    }
};
		
const renderResponses = (searchQuery = '') => {
    const responsesList = document.getElementById('responses-list');
    const emptyState = document.getElementById('empty-state');
    const responsesHeading = document.getElementById('responses-heading');

    responsesList.innerHTML = '';
    
    let responsesToRender = [];
    let headingText = '';
    const query = searchQuery.toLowerCase();

    if (query) {
        let allResponses = [];
        for (const categoryName in categories) {
            allResponses = allResponses.concat(categories[categoryName].responses.map(r => ({...r, category: categoryName})));
        }
        
        let labelMatches = [];
        let textMatches = [];

        allResponses.forEach(r => {
            const labelMatch = r.label && r.label.toLowerCase().includes(query);
            const textMatch = r.text && r.text.toLowerCase().includes(query);
            
            if (labelMatch) {
                labelMatches.push(r);
            } else if (textMatch) {
                textMatches.push(r);
            }
        });
        
        responsesToRender = [...new Set([...labelMatches, ...textMatches])];
		const count = responsesToRender.length;
		headingText = `Search Results <span class="ml-3 inline-block bg-gray-600 text-gray-200 text-sm font-bold px-3 py-1 rounded-full">${count}</span>`;    } else {
        if (categories[activeCategory]) {
            const allResponses = categories[activeCategory].responses.map(r => ({...r, category: activeCategory}));
            const pinnedResponses = allResponses.filter(r => r.isPinned);
            const unpinnedResponses = allResponses.filter(r => !r.isPinned);
            
            unpinnedResponses.sort((a, b) => (a.label || '').localeCompare(b.label || ''));
            responsesToRender = [...pinnedResponses, ...unpinnedResponses];
			           
			const count = responsesToRender.length;
			headingText = `Responses in: ${activeCategory} <span class="ml-3 inline-block bg-gray-600 text-gray-200 text-sm font-bold px-3 py-1 rounded-full">${count} Saved</span>`;
        } else {
            responsesToRender = [];
            headingText = 'No Active Category';
        }
    }
	
    if (responsesToRender.length > 0 || query) {
        const count = responsesToRender.length;
        const label = query ? 'Results Found' : 'Saved Replies';
        headingText = `${query ? 'Search Results' : activeCategory} <span class="ml-4 text-xl font-normal text-gray-400">(${count} ${label})</span>`;
    }	
    
    document.title = (query ? 'Search Results' : `${activeCategory} - Canned Responses`);
    document.getElementById('main-title').textContent = (query ? 'Search Results' : 'Canned Responses');

    responsesHeading.innerHTML = headingText;
    responsesHeading.classList.remove('hidden');
    
    if (responsesToRender.length > 0) {
        emptyState.classList.add('hidden');
        const groupedResponses = responsesToRender.reduce((acc, response) => {
            const label = response.label || 'Unlabeled';
            if (!acc[label]) {
                acc[label] = [];
            }
            acc[label].push(response);
            return acc;
        }, {});

        for (const label in groupedResponses) {
            const labelSection = document.createElement('div');
            labelSection.className = 'mb-6';
            let highlightedLabel = label;
            if(query) {
                const regex = new RegExp(query, 'gi');
                highlightedLabel = label.replace(regex, `<span class="highlight">$&</span>`);
            }

            labelSection.innerHTML = `
                <h3 class="text-xl font-bold text-gray-400 mb-2">${highlightedLabel}</h3>
                <div class="space-y-4"></div>
            `;
            const responsesInSection = labelSection.querySelector('div');


			groupedResponses[label].forEach(response => {
   				 let displayText = response.text;
   				 if (query) {
       				 const regex = new RegExp(query, 'gi');
       				 displayText = displayText.replace(regex, `<span class="highlight">$&</span>`);
  				  }

   					 const responseEl = document.createElement('div');
   					 let categoryColor = categories[response.category].color || '#60a5fa';

   					 if (document.body.classList.contains('light-mode')) {
      					  categoryColor = lightenColor(categoryColor);
				    }
    
  					  const timesCopied = response.timesCopied || 0; // Get the count

    				responseEl.className = 'response-item flex flex-col p-4 rounded-lg border relative';
  					responseEl.style.backgroundColor = categoryColor;
   					 responseEl.style.borderColor = categoryColor;
 				   	responseEl.dataset.id = response.id;
					responseEl.dataset.category = response.category;
   					 responseEl.innerHTML = `
			        <div class="absolute top-3 left-3 flex items-center text-xs text-gray-300 bg-gray-900 bg-opacity-60 px-2 py-1 rounded-full z-10" title="${timesCopied} times copied">
			            <i class="fas fa-copy mr-2"></i>
			            <span>${timesCopied}</span>
			        </div>
			        
			        <button class="pin-btn absolute top-3 right-3 p-2 rounded-full hover:bg-gray-600 transition-colors duration-200" title="Pin/Unpin" ${isAnonymous ? 'hidden' : ''}>
			            <i class="fas fa-thumbtack ${response.isPinned ? 'text-white' : 'text-gray-400'}"></i>
			        </button>
			        <div class="flex-grow display-mode space-y-2 w-full pt-8 sm:pt-8">
			            <p class="response-text-display text-gray-200 whitespace-pre-wrap">${displayText}</p>
			        </div>
			        <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-600">
			            <button class="copy-btn bg-green-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-700 hover:scale-105 hover:shadow-md active:scale-95 transition-all duration-300">
			                <i class="fas fa-copy"></i> Copy
			            </button>
			            <div class="flex space-x-2 ${isAnonymous ? 'hidden' : ''}">
			                <button class="edit-btn bg-yellow-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-yellow-600 hover:scale-105 hover:shadow-md active:scale-95 transition-all duration-300" data-id="${response.id}">
			                    <i class="fas fa-pencil-alt"></i> Edit
			                </button>
			                <button class="delete-btn bg-red-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-700 hover:scale-105 hover:shadow-md active:scale-95 transition-all duration-300">
			                    <i class="fas fa-trash"></i> Delete
			                </button>
			            </div>
			        </div>
			    `;
			    responsesInSection.appendChild(responseEl);
			});
            responsesList.appendChild(labelSection);
        }
        if (currentTutorialStep === 5 || currentTutorialStep === 6) {
            const firstResponse = document.querySelector('.response-item');
            if (firstResponse) {
                if (currentTutorialStep === 5) {
                    // Highlight the copy, edit, and delete buttons
                    const buttons = firstResponse.querySelectorAll('.copy-btn, .edit-btn, .delete-btn');
                    buttons.forEach(button => button.classList.add('highlight-target'));
                } else if (currentTutorialStep === 6) {
                    // Highlight the pin button
                    const pinButton = firstResponse.querySelector('.pin-btn');
                    if (pinButton) pinButton.classList.add('highlight-target');
                }
            }
        }		
    } else {
        emptyState.classList.add('hidden');
    }
};

const addResponse = async (text, label, category) => {
    if (isAnonymous) {
        showMessage("Please sign in to add responses.", 'error');
        return;
    }
    const newId = Date.now().toString();
    const newResponse = { id: newId, text: text, label: label || '', isPinned: false, createdAt: new Date().toISOString() };
    const updatedCategories = JSON.parse(JSON.stringify(categories));
    if (!updatedCategories[category]) {
        updatedCategories[category] = { color: categories[category]?.color || '#60a5fa', responses: [] };
    }
    if (!updatedCategories[category].responses) {
        updatedCategories[category].responses = [];
    }
    updatedCategories[category].responses.push(newResponse);
    saveToFirestore(updatedCategories);
    showMessage("Response added successfully!");
};
const updateResponse = (id, newText, newLabel, newCategory, oldCategory) => {
    if (isAnonymous) {
        showMessage("Please sign in to edit responses.", 'error');
        return;
    }
    const updatedCategories = JSON.parse(JSON.stringify(categories));
    const oldResponsesList = updatedCategories[oldCategory]?.responses || [];
    const responseToUpdate = oldResponsesList.find(r => r.id === id);
	const originalText = categories[oldCategory]?.responses.find(r => r.id === id)?.text || '';
	
    if (!responseToUpdate) {
        showMessage("Error: The response no longer exists in its original category.", 'error');
        return;
    }
    if (newCategory && newCategory !== oldCategory) {
		logUserEvent('move_response', {}, firstSignIn);
        const index = oldResponsesList.findIndex(r => r.id === id);
        if (index > -1) {
            oldResponsesList.splice(index, 1);
        }
        if (!updatedCategories[newCategory]) {
            updatedCategories[newCategory] = { color: updatedCategories[newCategory]?.color || '#60a5fa', responses: [] };
        }
        if (!updatedCategories[newCategory].responses) {
            updatedCategories[newCategory].responses = [];
        }
        responseToUpdate.text = newText;
        responseToUpdate.label = newLabel || '';
        updatedCategories[newCategory].responses.push(responseToUpdate);
        activeCategory = newCategory;
    } else {
        responseToUpdate.text = newText;
        responseToUpdate.label = newLabel || '';
    }

    const placeholderRegex = /\[([^\]]+)\]/g;
    const hadPlaceholder = placeholderRegex.test(originalText);
    const hasPlaceholderNow = placeholderRegex.test(newText);
    if (!hadPlaceholder && hasPlaceholderNow) {
        logUserEvent('add_placeholder', {}, firstSignIn);
    }
	
    saveToFirestore(updatedCategories);
    showMessage("Response updated successfully!");
};
const deleteResponse = (id, categoryName) => {
    if (isAnonymous) {
        showMessage("Please sign in to delete responses.", 'error');
        return;
    }
    if (!categoryName || !categories[categoryName] || !categories[categoryName].responses) return;
    const updatedCategories = JSON.parse(JSON.stringify(categories));
    updatedCategories[categoryName].responses = updatedCategories[categoryName].responses.filter(r => r.id !== id);
	logUserEvent('delete_response_single');
    saveToFirestore(updatedCategories);
    showMessage("Response deleted successfully!");
};

const copyToClipboard = async (text, responseId = null, categoryName = null) => {
    // This part always runs, so the user can always copy the text
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    showMessage("Copied to clipboard!");

    if (responseId && categoryName) {
        const now = Date.now();
        const lastCopyTime = lastCopyTimestamps[responseId] || 0; 
        const COOLDOWN_PERIOD = 5000; 

        if (now - lastCopyTime > COOLDOWN_PERIOD) {
            lastCopyTimestamps[responseId] = now; 

            const placeholderRegex = /\[([^\]]+)\]/g;
            if (!placeholderRegex.test(text)) {
                logUserEvent('copy_purist');
            }
            await awardXP(XP_VALUES.COPY_RESPONSE);
            logUserEvent('copy', { responseId, categoryName, text });

            if (userId && !isAnonymous) {
                try {
                    const category = categories[categoryName];
                    if (category && category.responses) {
                        const response = category.responses.find(r => r.id === responseId);
                        if (response) {
                            response.timesCopied = (response.timesCopied || 0) + 1;
                            saveToFirestore(categories);
                        }
                    }
                } catch (error) {
                    console.error("Error updating copy count:", error);
                }
            }
            await checkAndAwardChallengeXP(userId);
        }
    }
};
		
const exportData = () => {
    if (isAnonymous) {
        showMessage("Please sign in to export data.", 'error');
        return;
    }
    const dataStr = JSON.stringify(categories, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'canned_responses.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showMessage("Data exported successfully!");
};
const importData = (file) => {
    if (isAnonymous) {
        showMessage("Please sign in to import data.", 'error');
        return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const importedData = JSON.parse(e.target.result);
            if (typeof importedData === 'object' && importedData !== null) {
                categories = importedData;
                const categoryNames = Object.keys(categories);
                if (categoryNames.length > 0) {
                    activeCategory = categoryNames[0];
                } else {
                    activeCategory = '';
                }
                saveToFirestore(categories);
                showMessage("Data imported successfully!");
                importExportModal.classList.add('hidden');
				logUserEvent('import_data', {}, firstSignIn);
            } else {
                throw new Error('Invalid JSON format.');
            }
        } catch (error) {
            showMessage(`Error importing file: ${error.message}`, 'error');
        }
    };
    reader.readAsText(file);
};
const placeholderRegex = /\[([^\]]+)\]/g;
const processAndCopy = (text, responseId, categoryName) => {
    const placeholderInputsContainer = document.getElementById('placeholder-inputs');
    const placeholderModal = document.getElementById('placeholder-modal');
    currentTextToCopy = text;

    // Store the ID and category for later use
    currentResponseToCopyId = responseId;
    currentResponseToCopyCategory = categoryName;

    const matches = text.match(placeholderRegex);
    const placeholders = matches ? [...new Set(matches.map(m => m.slice(1, -1)))] : [];
    if (placeholders.length > 0 && !(placeholders.length === 1 && placeholders[0] === 'Name')) {
        placeholderInputsContainer.innerHTML = '';
        const today = new Date().toISOString().split('T')[0];
        placeholders.forEach(placeholder => {
            if (placeholder !== 'Name') {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'flex flex-col';
                const label = document.createElement('label');
                label.className = 'block text-sm font-medium text-gray-400 mb-1';
                label.textContent = placeholder;
                let input;
                if (placeholder.toLowerCase().includes('date')) {
                    input = document.createElement('input');
                    input.type = 'date';
                    input.value = today;
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                }
                input.dataset.placeholder = placeholder;
                input.id = `placeholder-${placeholder.replace(/\s/g, '-')}`;
                input.className = 'w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg';
                inputGroup.appendChild(label);
                inputGroup.appendChild(input);
                placeholderInputsContainer.appendChild(inputGroup);
            }
        });
        placeholderModal.classList.remove('hidden');
        document.querySelector('#placeholder-inputs input')?.focus();
    } else {
        const finalContent = replacePlaceholders(currentTextToCopy, {});
        // Pass the ID and category along
        copyToClipboard(finalContent, responseId, categoryName);
    }
};
const replacePlaceholders = (text, userValues) => {
    let result = text;
    result = result.replace(/\[Name\]/g, userName);
    for (const key in userValues) {
        const regex = new RegExp(`\\[${key}\\]`, 'g');
        result = result.replace(regex, userValues[key]);
    }
    return result;
};
const renderStaticLinks = () => {
    const staticLinksList = document.getElementById('static-links-list');
    if (renderedStaticLinks) return;
    staticLinksList.innerHTML = '';
    if (defaultLinks.length > 0) {
        defaultLinks.forEach(link => {
            const card = document.createElement('div');
            card.className = 'link-card rounded-xl p-6 shadow-2xl pulse-effect';
            const descriptionText = link.description || 'No description available.';
            card.innerHTML = `
                <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="block">
                    <h3 class="font-bold text-xl text-white hover:text-sky-300 transition-colors mb-2">${link.title}</h3>
                    <p class="text-sm text-gray-400">${descriptionText}</p>
                </a>
            `;
            staticLinksList.appendChild(card);
        });
    } else {
        staticLinksList.innerHTML = '<p class="text-center text-gray-400 col-span-full">No static links found.</p>';
    }
    renderedStaticLinks = true;
}
const renderUserLinks = () => {
    const userLinksList = document.getElementById('user-links-list');
    userLinksList.innerHTML = '';
    if (userLinks && userLinks.length > 0) {
        userLinks.forEach(link => {
            const card = document.createElement('div');
            card.className = 'link-card rounded-xl p-6 shadow-2xl pulse-effect flex items-center justify-between relative';
            card.innerHTML = `
                <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="flex-grow">
                    <h3 class="font-bold text-xl text-white hover:text-sky-300 transition-colors mb-2">${link.title}</h3>
                    <p class="text-sm text-gray-400">${link.description || 'No description available.'}</p>
                </a>
                <div class="relative inline-block text-left" data-doc-id="${link.id}" data-title="${link.title}" data-url="${link.url}" data-description="${link.description || ''}">
                    <button type="button" class="meatballs-button p-2 text-gray-400 hover:text-white transition-colors" aria-expanded="true" aria-haspopup="true">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 pointer-events-none">
                            <path d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM11.5 15a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z" />
                        </svg>
                    </button>
                    <div class="meatballs-menu hidden absolute right-0 mt-2 w-48 origin-top-right rounded-md bg-gray-700 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-10">
                        <div class="py-1">
                            <button class="edit-link-btn text-gray-200 block w-full text-left px-4 py-2 text-sm hover:bg-gray-600">Edit</button>
                            <button class="delete-link-btn text-red-400 block w-full text-left px-4 py-2 text-sm hover:bg-gray-600">Delete</button>
                        </div>
                    </div>
                </div>
            `;
            userLinksList.appendChild(card);
        });
    } else {
        userLinksList.innerHTML = '<p class="text-center text-gray-400 col-span-full">No links added yet. Add one above!</p>';
    }

	    if (filteredUserLinks.length === 0 && isAnonymous) {
      userLinksSection.classList.add('hidden');
    } else {
      userLinksSection.classList.remove('hidden');
    }
};
const renderHelpfulLinks = () => {
    const userLinksSection = document.getElementById('user-links-section');
    const addLinkSection = document.getElementById('add-link-section');
    
    // Call the unified rendering function with no search query
    renderLinks(); 

    if (isAnonymous) {
        userLinksSection.classList.add('hidden');
        addLinkSection.classList.add('hidden');
    } else {
        userLinksSection.classList.remove('hidden');
        addLinkSection.classList.remove('hidden');
    }
};
const showLinksStatus = (message, colorClass) => {
    const linksStatusMessage = document.getElementById('status-message');
    linksStatusMessage.textContent = message;
    linksStatusMessage.className = `text-center mt-2 text-sm font-semibold ${colorClass}`;
    setTimeout(() => {
        linksStatusMessage.textContent = '';
        linksStatusMessage.className = 'text-center mt-2 text-sm text-gray-400';
    }, 3000);
};

// Add this helper function somewhere in your script block
const closeSidebar = () => {
    const sidebar = document.getElementById('sidebar');
    if (sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
    }
};

const resetLinksForm = () => {
    const linksFormTitle = document.getElementById('form-title');
    const linkTitleInput = document.getElementById('link-title');
    const linkUrlInput = document.getElementById('link-url');
    const linkDescriptionInput = document.getElementById('link-description');
    const linksSubmitButton = document.getElementById('submit-button');
    const linksCancelButton = document.getElementById('cancel-button');
    linksFormTitle.textContent = "Add a New Link";
    linkTitleInput.value = '';
    linkUrlInput.value = '';
    linkDescriptionInput.value = '';
    linksSubmitButton.textContent = 'Add Link';
    linksCancelButton.classList.add('hidden');
    editingLinkDocId = null;
};
const editLink = (docId, title, url, description) => {
    const linksFormTitle = document.getElementById('form-title');
    const linkTitleInput = document.getElementById('link-title');
    const linkUrlInput = document.getElementById('link-url');
    const linkDescriptionInput = document.getElementById('link-description');
    const linksSubmitButton = document.getElementById('submit-button');
    const linksCancelButton = document.getElementById('cancel-button');
    const addLinkSection = document.getElementById('add-link-section');
    linksFormTitle.textContent = "Edit Link";
    linkTitleInput.value = title;
    linkUrlInput.value = url;
    linkDescriptionInput.value = description;
    linksSubmitButton.textContent = 'Save Changes';
    linksCancelButton.classList.remove('hidden');
    editingLinkDocId = docId;
    addLinkSection.scrollIntoView({ behavior: 'smooth' });
};
const deleteLink = async (docId) => {
    if (!db || !userId || isAnonymous) {
        showLinksStatus('Please sign in to delete links.', 'text-red-400');
        return;
    }
    const docRef = doc(db, 'artifacts', safeAppId, 'users', userId, 'helpful_links_data', docId);
    try {
        await deleteDoc(docRef);
        showLinksStatus('Link deleted successfully!', 'text-green-400');
    } catch (error) {
        console.error("Error deleting link:", error);
        showLinksStatus(`Failed to delete link: ${error.message}`, 'text-red-400');
    }
};
const extractAndDisplayNumbers = () => {
    const fedexRegex = /(?:78\d{10}|79\d{10}|80\d{10}|81\d{10}|82\d{10}|(?:96\d{20}|96\d{32}|\d{15}|\d{12}))/g;
    const inputTextareaFedex = document.getElementById('input-text-fedex');
    const trackingNumbersContainer = document.getElementById('tracking-numbers-container');
    const noNumbersMessage = document.getElementById('no-numbers-message');

    // Exit if any critical elements aren't found
    if (!inputTextareaFedex || !trackingNumbersContainer || !noNumbersMessage) {
        return;
    }

    const text = inputTextareaFedex.value;
    const matches = text.match(fedexRegex) || [];
    const uniqueMatches = [...new Set(matches)];

    // **THE FIX:** Remove only the previously added tracking tabs.
    const existingTabs = trackingNumbersContainer.querySelectorAll('.tracking-tab');
    existingTabs.forEach(tab => tab.remove());

    if (uniqueMatches.length > 0) {
        // Hide the "no numbers" message because we found results.
        noNumbersMessage.classList.add('hidden');
        
        // Add the new tracking number divs.
        uniqueMatches.forEach(num => {
            const div = document.createElement('div');
            div.className = 'tracking-tab flex items-center justify-between p-3 rounded-lg shadow-md mb-2';
            div.innerHTML = `
                <span class="text-sm font-semibold">${num}</span>
                <button class="copy-tracking-btn bg-indigo-500 text-white text-xs px-2 py-1 rounded-full hover:bg-indigo-400 transition-colors">
                    Copy
                </button>
            `;
            trackingNumbersContainer.appendChild(div);
        });
    } else {
        // If no numbers were found, make sure the message is visible.
        noNumbersMessage.classList.remove('hidden');
    }

    // Re-attach event listeners to any new copy buttons that were created.
    document.querySelectorAll('.copy-tracking-btn').forEach(button => {
        button.addEventListener('click', () => {
            const number = button.previousElementSibling.textContent;
            copyToClipboard(number);
        });
    });
};
const renderSettingsPage = () => {
    const themeIconSettings = document.getElementById('theme-icon-settings');
    const authStatusSettings = document.getElementById('auth-status-settings');
    const signInBtn = document.getElementById('sign-in-btn-settings');
    const signOutBtn = document.getElementById('sign-out-btn-settings');
    const tutorialResetSection = document.getElementById('tutorial-reset-section');
    const importExportBtnSettings = document.getElementById('import-export-btn-settings');
    const checkUpdatesBtnSettings = document.getElementById('check-updates-btn-settings');

    if (document.body.classList.contains('light-mode')) {
        themeIconSettings.className = 'fas fa-sun mr-2';
    } else {
        themeIconSettings.className = 'fas fa-moon mr-2';
    }
    if (auth.currentUser) {
        const displayName = auth.currentUser.displayName || auth.currentUser.email || 'User';
        authStatusSettings.textContent = `Signed in as: ${displayName}`;
        authStatusSettings.title = auth.currentUser.email;
        if (isAnonymous) {
            signInBtn.classList.remove('hidden');
            signOutBtn.classList.add('hidden');
            tutorialResetSection.classList.add('hidden');
        } else {
            signInBtn.classList.add('hidden');
            signOutBtn.classList.remove('hidden');
            tutorialResetSection.classList.remove('hidden');
        }
    } else {
        authStatusSettings.textContent = 'Not signed in.';
        signInBtn.classList.remove('hidden');
        signOutBtn.classList.add('hidden');
        tutorialResetSection.classList.add('hidden');
    }
    if (isAnonymous) {
        importExportBtnSettings.classList.add('hidden');
        checkUpdatesBtnSettings.classList.add('hidden');
    } else {
        importExportBtnSettings.classList.remove('hidden');
        checkUpdatesBtnSettings.classList.remove('hidden');
    }
};

const renderCategoryChart = (events) => {
    const container = document.getElementById('category-chart-container');
    if (!container) return;

    // Clear previous chart and messages
    container.innerHTML = '<canvas id="categoryChart"></canvas>';
    const ctx = document.getElementById('categoryChart').getContext('2d');

    if (categoryChartInstance) {
        categoryChartInstance.destroy();
    }

    const copyEvents = events.filter(e => e.type === 'copy' && e.categoryName);
    if (copyEvents.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-400 mt-12">Copy some responses to see your category breakdown!</p>';
        return;
    }

    const categoryCounts = copyEvents.reduce((acc, event) => {
        acc[event.categoryName] = (acc[event.categoryName] || 0) + 1;
        return acc;
    }, {});

    const labels = Object.keys(categoryCounts);
    const data = Object.values(categoryCounts);
    
    // Use your existing category colors for the chart
    const backgroundColors = labels.map(label => categories[label]?.color || '#888888');

    const isLightMode = document.body.classList.contains('light-mode');
    const textColor = isLightMode ? '#1f2937' : '#e5e7eb';

    categoryChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                label: 'Copies per Category',
                data: data,
                backgroundColor: backgroundColors,
                borderColor: isLightMode ? '#f3f4f6' : '#111827',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: textColor,
                        padding: 20,
                        font: { size: 14 }
                    }
                }
            }
        }
    });
};

const renderActivityChart = (events) => {
    const container = document.getElementById('activity-chart-container');
    if (!container) return;

    // Clear previous chart and messages
    container.innerHTML = '<canvas id="activityChart"></canvas>';
    const ctx = document.getElementById('activityChart').getContext('2d');
    
    if (activityChartInstance) {
        activityChartInstance.destroy();
    }

    const copyEvents = events.filter(e => e.type === 'copy' && e.timestamp);
    if (copyEvents.length < 2) { // Need at least 2 data points for a line chart
        container.innerHTML = '<p class="text-center text-gray-400 mt-12">Not enough copy activity to show a trend.</p>';
        return;
    }

    // Group copy events by day
    const activityByDay = copyEvents.reduce((acc, event) => {
        const date = event.timestamp.toDate().toISOString().split('T')[0];
        acc[date] = (acc[date] || 0) + 1;
        return acc;
    }, {});

    const sortedDates = Object.keys(activityByDay).sort();
    const labels = sortedDates;
    const data = sortedDates.map(date => activityByDay[date]);
    
    const isLightMode = document.body.classList.contains('light-mode');
    const gridColor = isLightMode ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
    const textColor = isLightMode ? '#1f2937' : '#e5e7eb';

    activityChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Copies per Day',
                data: data,
                fill: true,
                backgroundColor: 'rgba(74, 222, 128, 0.2)',
                borderColor: 'rgba(74, 222, 128, 1)',
                pointBackgroundColor: 'rgba(74, 222, 128, 1)',
                tension: 0.2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { color: textColor, precision: 0 }, grid: { color: gridColor } },
                x: { ticks: { color: textColor }, grid: { color: gridColor } }
            },
            plugins: { legend: { display: false } }
        }
    });
};

const renderLevelingSystem = (userData) => {
    const totalXp = userData.xp || 0;
    const levelInfo = calculateLevelInfo(totalXp);
    const rankName = levelInfo.rankName;
    const rankClass = `level-badge-${rankName.toLowerCase().replace(' ', '-')}`;
    const rankIconContainer = document.getElementById('rank-icon-container');

    // Base classes for all wrappers
    let wrapperClasses = `level-badge-wrapper ${rankClass}`;
    let innerHTML = '';

    // Add classes and inner HTML based on the rank
    switch(rankName) {
        case "Newbie":
        case "Apprentice":
            wrapperClasses += ' beveled-edge';
            innerHTML = `<i class="fas ${levelInfo.rankIcon}"></i>`;
            break;
        case "Journeyman":
        case "Artisan":
        case "Expert":
            wrapperClasses += ' inner-ring beveled-edge';
            innerHTML = `<i class="fas ${levelInfo.rankIcon}"></i>`;
            break;
        case "Master":
            wrapperClasses += ' inner-ring glowing-effect beveled-edge master-shine-effect';
            innerHTML = `<i class="fas ${levelInfo.rankIcon}"></i>`;
            break;
        case "Grandmaster":
            wrapperClasses += ' inner-ring beveled-edge emblem-ring-gem layered-emblem grandmaster-crystal-pulse';
            innerHTML = `<i class="fas ${levelInfo.rankIcon}"></i>`;
            break;
        case "Legend":
            wrapperClasses += ' inner-ring beveled-edge emblem-ring-gem layered-emblem legend-molten-core';
            innerHTML = `
                <div class="flame f1"></div>
                <div class="flame f2"></div>
                <div class="flame f3"></div>
                <i class="fas ${levelInfo.rankIcon}"></i>
            `;
            break;
        case "Demigod":
            wrapperClasses += ' inner-ring glowing-effect demigod-power-surge beveled-edge emblem-ring-gem layered-emblem';
            innerHTML = `<i class="fas ${levelInfo.rankIcon}"></i>`;
            break;
        case "Deity":
            wrapperClasses += ' inner-ring beveled-edge emblem-ring-gem deity-particles';
            innerHTML = `
                <div class="divine-radiance"></div>
                <div class="gleam-container"></div>
                <div class="particle p1"></div>
                <div class="particle p2"></div>
                <div class="particle p3"></div>
                <svg class="deity-glyph" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="deity-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ffffff;" />
                            <stop offset="100%" style="stop-color:#e2e8f0;" />
                        </linearGradient>
                        <filter id="deity-glow-filter" x="-50%" y="-50%" width="200%" height="200%">
                            <feGaussianBlur in="SourceGraphic" stdDeviation="2" result="blur">
                                <animate attributeName="stdDeviation" values="2; 4; 2" dur="4s" repeatCount="indefinite" />
                            </feGaussianBlur>
                            <feMerge>
                                <feMergeNode in="blur" />
                                <feMergeNode in="SourceGraphic" />
                            </feMerge>
                        </filter>
                    </defs>
                    <g filter="url(#deity-glow-filter)">
                        <circle cx="50" cy="50" r="40" fill="none" stroke="#f8fafc" stroke-width="1.5" opacity="0.8"/>
                        <circle cx="50" cy="50" r="32" fill="none" stroke="#cbd5e1" stroke-width="1" opacity="0.6"/>
                        <path d="M50 15 V 38 M85 50 H 62 M50 85 V 62 M15 50 H 38" stroke="#94a3b8" stroke-width="1.5" />
                        <path d="M29.29 29.29 L44.85 44.85 M70.71 29.29 L55.15 44.85 M70.71 70.71 L55.15 55.15 M29.29 70.71 L44.85 55.15" stroke="#94a3b8" stroke-width="1.5" />
                        <path d="M50 42 L58 50 L50 58 L42 50 Z" fill="url(#deity-gradient)"/>
                    </g>
                </svg>
            `;
            break;
        default:
            innerHTML = `<i class="fas ${levelInfo.rankIcon}"></i>`;
            break;
    }

    rankIconContainer.innerHTML = `<div class="${wrapperClasses}">${innerHTML}</div>`;

    document.getElementById('rank-name').textContent = levelInfo.rankName;
    document.getElementById('level-display').textContent = `Level ${levelInfo.level}`;

    const progressPercent = (levelInfo.xpProgress / levelInfo.xpForNextLevel) * 100;
    document.getElementById('xp-bar').style.width = `${progressPercent}%`;
    document.getElementById('xp-progress-text').textContent = `${levelInfo.xpProgress.toLocaleString()} / ${levelInfo.xpForNextLevel.toLocaleString()} XP`;
};	

// --- Renders all stats and achievement data for the page ---
const renderAdvancedStats = async () => {
    const statsContent = document.getElementById('stats-content');
    const statsLoader = document.getElementById('stats-loader');
    const metricBadgesContainer = document.getElementById('metric-badges-container');
    const achievementsContainer = document.getElementById('achievements-container');
    const chartContainer = document.getElementById('stats-container');

    if (statsLoader) statsLoader.classList.remove('hidden');
    if (statsContent) statsContent.classList.add('hidden');

    if (!statsContent || isAnonymous) {
        if (statsContent) statsContent.innerHTML = '<p class="text-gray-400 text-center py-16">Sign in to track your achievements and usage stats.</p>';
        if (statsLoader) statsLoader.classList.add('hidden');
        if (statsContent) statsContent.classList.remove('hidden');
        return;
    }

    try {
        const userDocRef = getUserRootDocRef(userId);
        const userDoc = await getDoc(userDocRef);
        const userData = userDoc.exists() ? userDoc.data() : {};
        renderLevelingSystem(userData);

        const eventsCollectionRef = getUserEventsCollectionRef(userId);
        const snapshot = await getDocs(query(eventsCollectionRef));
        const events = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));

        // Render all components
        renderChallenges(events);
        renderCategoryChart(events);
        renderActivityChart(events);
        renderLeaderboard();

        // --- Metric Badges ---
        const now = new Date();
        const startOfWeek = new Date(now);
        startOfWeek.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));
        startOfWeek.setHours(0, 0, 0, 0);
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

        const copiesThisWeek = events.filter(e => e.type === 'copy' && e.timestamp?.toDate() >= startOfWeek).length;
        const editsThisMonth = events.filter(e => e.type === 'edit_response' && e.timestamp?.toDate() > startOfMonth).length;
        const totalResponsesCreated = events.filter(e => e.type === 'create_response').length;
        const totalCategories = Object.keys(categories).length;

        metricBadgesContainer.innerHTML = `
            <div class="bg-gray-800 p-4 rounded-xl text-center"><p class="text-2xl font-bold text-blue-400">${copiesThisWeek}</p><p class="text-sm text-gray-400">Copies This Week</p></div>
            <div class="bg-gray-800 p-4 rounded-xl text-center"><p class="text-2xl font-bold text-green-400">${editsThisMonth}</p><p class="text-sm text-gray-400">Edits This Month</p></div>
            <div class="bg-gray-800 p-4 rounded-xl text-center"><p class="text-2xl font-bold text-purple-400">${totalResponsesCreated}</p><p class="text-sm text-gray-400">Responses Made</p></div>
            <div class="bg-gray-800 p-4 rounded-xl text-center"><p class="text-2xl font-bold text-yellow-400">${totalCategories}</p><p class="text-sm text-gray-400">Total Categories</p></div>
        `;

        // --- Achievements Rendering (Redesigned) ---
        renderFilteredAchievements(events, userData);

        // --- Top 5 Chart ---
        let allResponses = [];
        for (const categoryName in categories) {
            if (categories[categoryName].responses) {
                allResponses.push(...categories[categoryName].responses);
            }
        }
        const sortedResponses = allResponses.filter(r => r.timesCopied > 0).sort((a, b) => b.timesCopied - a.timesCopied);

        if (sortedResponses.length > 0) {
            chartContainer.innerHTML = '<canvas id="stats-chart"></canvas>';
            const topResponses = sortedResponses.slice(0, 5);
            const chartLabels = topResponses.map(r => r.label || 'Unlabeled');
            const chartData = topResponses.map(r => r.timesCopied);

            if (statsChart) statsChart.destroy();
            const ctx = document.getElementById('stats-chart').getContext('2d');
            const isLightMode = document.body.classList.contains('light-mode');
            const textColor = isLightMode ? '#1f2937' : '#e5e7eb';
            const gridColor = isLightMode ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
            statsChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: chartLabels, datasets: [{ label: 'Times Copied', data: chartData, backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { color: textColor, precision: 0 }, grid: { color: gridColor } }, y: { ticks: { color: textColor }, grid: { display: false } } }, plugins: { legend: { display: false }, title: { display: false } } }
            });
        } else {
            chartContainer.innerHTML = '<p class="text-gray-400 text-center flex items-center justify-center h-full">Copy responses to see your top 5 here!</p>';
        }

    } catch (error) {
        console.error("Error rendering stats:", error);
        if (statsContent) statsContent.innerHTML = `<p class="text-red-400 text-center py-16">Error loading stats: ${error.message}</p>`;
    } finally {
        if (statsLoader) statsLoader.classList.add('hidden');
        if (statsContent) statsContent.classList.remove('hidden');
    }
};

const showPlaceholderDemo = () => {
    const tutorialModal = document.getElementById('tutorial-modal');
    const tutorialOverlay = document.getElementById('tutorial-overlay');

    // Get the element that is highlighted for the tutorial
    const highlightedResponse = document.querySelector('.response-item.highlight-target');

    // Check if the highlighted element exists and has the necessary text
    if (highlightedResponse) {
        const textToCopy = highlightedResponse.querySelector('.response-text-display').textContent;
        processAndCopy(textToCopy);
    } else {
        // Fallback or error handling if the highlighted item isn't found
        console.error("No highlighted response found for the tutorial demo.");
        const fallbackText = "Hello [Customer's Name], this is a default message. There was an issue loading the dynamic placeholder example.";
        processAndCopy(fallbackText);
    }

    // Hide the tutorial modal and overlay so the placeholder modal is the main focus
    tutorialModal.classList.add('hidden');
    tutorialOverlay.classList.add('hidden');
};


// PASTE THIS ENTIRE BLOCK
// --- All Event Listeners (Correctly placed to be attached only once) ---
function attachEventListeners() {
	
    const unlockAudio = () => {
        if (!audioUnlocked) {
            const sound = document.getElementById('achievement-sound');
            if (sound) {
                sound.play().catch(() => {});
                sound.pause();
                audioUnlocked = true;
                document.body.removeEventListener('click', unlockAudio);
                console.log('Audio has been unlocked by user interaction.');
            }
        }
    };
    document.body.addEventListener('click', unlockAudio);
	
    // Navigation Listeners
    const navButtons = ['nav-canned-responses', 'nav-fedex-tracker', 'nav-helpful-links', 'nav-my-stats', 'nav-settings'];
    navButtons.forEach(id => {
        const btn = document.getElementById(id);
        if(btn) btn.addEventListener('click', () => {
            currentPage = id.replace('nav-', '');
            localStorage.setItem('lastVisitedPage', currentPage);
            renderContent();
            closeSidebar();
            logUserEvent('visit_page', { page: currentPage });
        });
    });

    // Sidebar Listeners
    const hamburgerBtn = document.getElementById('hamburger-menu-btn');
    if(hamburgerBtn) hamburgerBtn.addEventListener('click', () => { document.getElementById('sidebar').classList.toggle('open'); });
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    if(closeSidebarBtn) closeSidebarBtn.addEventListener('click', closeSidebar);
    
    // Achievement Listeners
    const achievementsContainer = document.getElementById('achievements-container');
    if(achievementsContainer) {
        achievementsContainer.addEventListener('click', (e) => {
            const card = e.target.closest('.achievement-card-redesign');
            if (card && card.dataset.unlocked === 'true') {
                const modal = document.getElementById('achievement-details-modal');
                const modalIcon = document.getElementById('modal-achievement-icon');
                const modalTitle = document.getElementById('modal-achievement-title');
                const modalDesc = document.getElementById('modal-achievement-desc');
                const modalDateEl = document.getElementById('modal-achievement-date');
                
                const { name, desc, icon, color, unlockedDate } = card.dataset;
                
                modalIcon.className = `text-6xl mb-4 ${color}`;
                modalIcon.innerHTML = `<i class="fas ${icon}"></i>`;
                modalTitle.textContent = name;
                modalDesc.textContent = desc;
                
                if (unlockedDate) {
                    const date = new Date(unlockedDate);
                    modalDateEl.textContent = `Unlocked on: ${date.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })}`;
                } else {
                    modalDateEl.textContent = 'Unlocked!';
                }

                modal.classList.remove('hidden');
            }
        });
    }

    const closeAchievementModalBtn = document.getElementById('close-achievement-modal-btn');
    if(closeAchievementModalBtn) {
        closeAchievementModalBtn.addEventListener('click', () => {
            document.getElementById('achievement-details-modal').classList.add('hidden');
        });
    }
    
    setupAchievementFiltering();
    
    // --- All Other Event Listeners ---
    document.getElementById('add-link-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isSubmittingLink) { console.warn("Preventing duplicate form submission."); return; }
        if (!db || !userId || isAnonymous) { showLinksStatus('Please sign in to manage your links.', 'text-yellow-400'); return; }
        const title = document.getElementById('link-title').value;
        const url = document.getElementById('link-url').value;
        const description = document.getElementById('link-description').value;
        if (!title || !url) { showLinksStatus('Please fill out all required fields.', 'text-red-400'); return; }
        isSubmittingLink = true;
        try {
            if (editingLinkDocId) {
                showLinksStatus('Updating link...', 'text-yellow-400');
                const docRef = doc(db, 'artifacts', safeAppId, 'users', userId, 'helpful_links_data', editingLinkDocId);
                await updateDoc(docRef, { title, url, description });
                showLinksStatus('Link updated successfully!', 'text-green-400');
            } else {
                showLinksStatus('Adding link...', 'text-yellow-400');
                const linksCollectionRef = getUserHelpfulLinksCollectionRef(userId);
                await addDoc(linksCollectionRef, { title, url, description, createdAt: new Date() });
                showLinksStatus('Link added successfully!', 'text-green-400');
				logUserEvent('add_link');
            }
            resetLinksForm();
        } catch (error) {
            console.error("Error during link operation:", error);
            showLinksStatus(`Failed to save link: ${error.message}`, 'text-red-400');
        } finally {
            isSubmittingLink = false;
        }
    });

    document.getElementById('links-search-input').addEventListener('input', (e) => {
        const query = e.target.value;
        renderLinks(query);
    });

    document.getElementById('cancel-button').addEventListener('click', () => { resetLinksForm(); });
    
    document.getElementById('user-links-list').addEventListener('click', (event) => {
        if (isAnonymous) return;
        const button = event.target.closest('.meatballs-button');
        const editBtn = event.target.closest('.edit-link-btn');
        const deleteBtn = event.target.closest('.delete-link-btn');
        if (button) {
            event.stopPropagation();
            const parentDiv = button.closest('[data-doc-id]');
            const menu = parentDiv.querySelector('.meatballs-menu');
            if (menu) {
                const isHidden = menu.classList.contains('hidden');
                document.querySelectorAll('.meatballs-menu').forEach(m => m.classList.add('hidden'));
                if (isHidden) { menu.classList.remove('hidden'); openMenuId = parentDiv.dataset.docId; } else { openMenuId = null; }
            }
        } else if (editBtn) {
            event.stopPropagation();
            const parentDiv = editBtn.closest('[data-doc-id]');
            if (parentDiv) {
                const { docId, title, url, description } = parentDiv.dataset;
                editLink(docId, title, url, description);
                const menu = parentDiv.querySelector('.meatballs-menu');
                if (menu) menu.classList.add('hidden');
                openMenuId = null;
            }
        } else if (deleteBtn) {
            event.stopPropagation();
            const parentDiv = deleteBtn.closest('[data-doc-id]');
            if (parentDiv) {
                deleteLink(parentDiv.dataset.docId);
                const menu = parentDiv.querySelector('.meatballs-menu');
                if (menu) menu.classList.add('hidden');
                openMenuId = null;
            }
        }
    });

    document.addEventListener('click', (event) => {
        const categoryActionsMenu = document.getElementById('category-actions-menu');
        const categoryActionsBtn = document.getElementById('category-actions-btn');
        const isClickInsideCategoryActions = categoryActionsBtn && (categoryActionsBtn.contains(event.target) || categoryActionsMenu.contains(event.target));
        const isClickInsideMeatballsMenu = event.target.closest('.meatballs-menu') || event.target.closest('.meatballs-button');

        if (!isClickInsideCategoryActions && categoryActionsMenu) {
            categoryActionsMenu.classList.add('hidden', 'scale-95', 'opacity-0');
            if(categoryActionsBtn) categoryActionsBtn.classList.remove('active');
        }
        if (!isClickInsideMeatballsMenu) {
            document.querySelectorAll('.meatballs-menu').forEach(m => m.classList.add('hidden'));
            openMenuId = null;
        }
    });
}
    document.addEventListener('click', (event) => {
        const isClickInsideCategoryActions = event.target.closest('#category-actions-menu') || event.target.closest('#category-actions-btn');
        const isClickInsideMeatballsMenu = event.target.closest('.meatballs-menu') || event.target.closest('.meatballs-button');
        const categoryActionsMenu = document.getElementById('category-actions-menu');
        const categoryActionsBtn = document.getElementById('category-actions-btn');
        if (!categoryActionsMenu.contains(event.target) && !categoryActionsBtn.contains(event.target)) {
            categoryActionsMenu.classList.add('hidden', 'scale-95', 'opacity-0');
            categoryActionsBtn.classList.remove('active');
        }
        if (!isClickInsideMeatballsMenu) {
            document.querySelectorAll('.meatballs-menu').forEach(m => m.classList.add('hidden'));
            openMenuId = null;
        }
    });

    document.getElementById('close-login-popup-btn').addEventListener('click', async () => {
        document.getElementById('login-popup-modal').classList.remove('show');
        document.getElementById('login-popup-modal').classList.add('hidden');
        if (userId) {
            const userDocRef = getUserRootDocRef(userId);
            try { await setDoc(userDocRef, { hasSeenLoginPrompt: true }, { merge: true }); } catch (error) { console.error("Error setting hasSeenLoginPrompt flag:", error); }
        }
    });
    document.getElementById('login-popup-btn').addEventListener('click', async () => {
        document.getElementById('login-popup-modal').classList.remove('show');
        document.getElementById('login-popup-modal').classList.add('hidden');
        if (userId) {
            const userDocRef = getUserRootDocRef(userId);
            try { await setDoc(userDocRef, { hasSeenLoginPrompt: true }, { merge: true }); } catch (error) { console.error("Error setting hasSeenLoginPrompt flag:", error); }
        }
        try { const provider = new GoogleAuthProvider(); await signInWithPopup(auth, provider); showMessage("Signed in with Google!"); } catch (error) { console.error("Google sign-in failed", error); showMessage("Google sign-in failed. Please try again.", 'error'); }
    });

    document.getElementById('close-copy-success-btn').addEventListener('click', () => {
        document.getElementById('copy-success-modal').classList.add('hidden');
    });

    // --- Tutorial Listeners (Corrected) ---
    document.getElementById('tutorial-next-btn').addEventListener('click', () => {
        if (currentTutorialStep < tutorialSteps.length - 1) {
            currentTutorialStep++;
            showTutorialStep(currentTutorialStep);
        }
    });

    document.getElementById('tutorial-back-btn').addEventListener('click', () => {
        if (currentTutorialStep > 0) {
            currentTutorialStep--;
            showTutorialStep(currentTutorialStep);
        }
    });

    document.getElementById('tutorial-finish-btn').addEventListener('click', async () => {
        isTutorialActive = false;
        // Clear all highlights before hiding the modal
        clearTutorialHighlights();

        document.getElementById('tutorial-modal').classList.add('hidden');
        document.getElementById('tutorial-overlay').classList.add('hidden');

        if (userId) {
            const userDocRef = getUserRootDocRef(userId);
            try {
                await setDoc(userDocRef, { tutorialSeen: true }, { merge: true });
            } catch (error) {
                console.error("Error setting tutorialSeen flag:", error);
            }
        }
    });

    document.getElementById('show-tutorial-btn').addEventListener('click', async () => {
        if (userId && !isAnonymous) {
            const userDocRef = getUserRootDocRef(userId);
            try {
                await setDoc(userDocRef, { tutorialSeen: false }, { merge: true });
                showTutorialStep(0); // This function call will now handle displaying the modal
            } catch (error) {
                console.error("Error resetting tutorialSeen flag:", error);
                showMessage("Error showing tutorial. Please try again.", 'error');
            }
        } else {
            showMessage("Please sign in to view the tutorial.", 'error');
        }
    });

    document.getElementById('theme-toggle-btn-settings').addEventListener('click', () => {
        document.body.classList.toggle('light-mode');
        localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        const icon = document.getElementById('theme-toggle-btn-settings').querySelector('i');
        icon.className = document.body.classList.contains('light-mode') ? 'fas fa-sun mr-2' : 'fas fa-moon mr-2';
		updateDarkModeStreak();
		if (currentPage === 'my-stats') {
            renderAdvancedStats();
        }
    });
    document.getElementById('category-list').addEventListener('click', (e) => {
        const button = e.target.closest('.category-item');
        if (button) {
            const newCategory = button.dataset.category;
            if (newCategory !== activeCategory) {
                activeCategory = newCategory;
                renderCategories();
            }
        }
    });
    document.getElementById('responses-list').addEventListener('click', (e) => {
        const copyBtn = e.target.closest('.copy-btn');
        const editBtn = e.target.closest('.edit-btn');
        const deleteBtn = e.target.closest('.delete-btn');
        const pinBtn = e.target.closest('.pin-btn');
        if (copyBtn) {
            const responseItem = copyBtn.closest('.response-item');
            const textToCopy = responseItem.querySelector('.response-text-display').textContent;
			const responseId = responseItem.dataset.id;
		    const categoryName = responseItem.dataset.category;
		    processAndCopy(textToCopy, responseId, categoryName);
		
		}
        if (editBtn) {
            const responseItem = editBtn.closest('.response-item');
            const id = responseItem.dataset.id;
            const category = responseItem.dataset.category;
            const responseData = categories[category].responses.find(r => r.id === id);
            if (responseData) {
                document.getElementById('edit-response-label').value = responseData.label || '';
                document.getElementById('edit-response-text').value = responseData.text;
                document.getElementById('edit-response-modal').dataset.originalId = responseData.id;
                document.getElementById('edit-response-modal').dataset.originalCategory = category;
                const editCategorySelect = document.getElementById('edit-category-select');
                editCategorySelect.innerHTML = '';
                const categoryNames = Object.keys(categories);
                categoryNames.forEach(catName => {
                    const option = document.createElement('option');
                    option.value = catName;
                    option.textContent = catName;
                    if (catName === category) option.selected = true;
                    editCategorySelect.appendChild(option);
                });
                document.getElementById('edit-response-modal').classList.remove('hidden');
            }
        }
        if (deleteBtn) {
            const responseItem = deleteBtn.closest('.response-item');
            responseToDeleteId = responseItem.dataset.id;
            const category = responseItem.dataset.category;
            document.getElementById('delete-modal').dataset.category = category;
            document.getElementById('delete-modal').classList.remove('hidden');
        }
        if (pinBtn) {
            const responseItem = pinBtn.closest('.response-item');
            const id = responseItem.dataset.id;
            const category = responseItem.dataset.category;
            const responseData = categories[category].responses.find(r => r.id === id);
            if (responseData) {
                responseData.isPinned = !responseData.isPinned;
		        if (responseData.isPinned) {
		            logUserEvent('pin_response', { responseId: id }, firstSignIn); // <-- ADD THIS LINE
		        }
                saveToFirestore(categories);
            }
        }
    });
    document.getElementById('open-add-response-modal-btn').addEventListener('click', () => {
        document.getElementById('new-response-modal').classList.remove('hidden');
        document.getElementById('new-response-label').value = '';
        document.getElementById('new-response-text').value = '';
        const newResponseCategorySelect = document.getElementById('new-response-category');
        newResponseCategorySelect.innerHTML = '';
        const categoryNames = Object.keys(categories);
        categoryNames.forEach(catName => {
            const option = document.createElement('option');
            option.value = catName;
            option.textContent = catName;
            if (catName === activeCategory) option.selected = true;
            newResponseCategorySelect.appendChild(option);
        });
    });
    document.getElementById('cancel-new-response-btn').addEventListener('click', () => { document.getElementById('new-response-modal').classList.add('hidden'); });
    document.getElementById('save-new-response-btn').addEventListener('click', () => {
        const label = document.getElementById('new-response-label').value;
        const text = document.getElementById('new-response-text').value;
        const category = document.getElementById('new-response-category').value;
        if (text.trim() !== '') { addResponse(text, label, category); document.getElementById('new-response-modal').classList.add('hidden');logUserEvent('create_response'); awardXP(XP_VALUES.CREATE_RESPONSE); } else { showMessage("Response text cannot be empty.", 'error'); }
    });
    document.getElementById('cancel-edit-btn').addEventListener('click', () => { document.getElementById('edit-response-modal').classList.add('hidden'); currentEditingId = null; });
    document.getElementById('save-edit-btn').addEventListener('click', () => {
        const id = document.getElementById('edit-response-modal').dataset.originalId;
        const oldCategory = document.getElementById('edit-response-modal').dataset.originalCategory;
        const newLabel = document.getElementById('edit-response-label').value;
        const newText = document.getElementById('edit-response-text').value;
        const newCategory = document.getElementById('edit-category-select').value;
        if (newText.trim() !== '') { updateResponse(id, newText, newLabel, newCategory, oldCategory); document.getElementById('edit-response-modal').classList.add('hidden'); currentEditingId = null;logUserEvent('edit_response', {}, firstSignIn); } else { showMessage("Response text cannot be empty.", 'error'); }
    });
    document.getElementById('delete-confirm-btn').addEventListener('click', () => {
        const category = document.getElementById('delete-modal').dataset.category;
        deleteResponse(responseToDeleteId, category);
        document.getElementById('delete-modal').classList.add('hidden');
		logUserEvent('delete_response', {}, firstSignIn);
    });
    document.getElementById('delete-cancel-btn').addEventListener('click', () => { document.getElementById('delete-modal').classList.add('hidden'); responseToDeleteId = null; });
    document.getElementById('search-input').addEventListener('input', () => { renderResponses(document.getElementById('search-input').value); });
    document.getElementById('add-category-btn').addEventListener('click', () => { document.getElementById('add-category-modal').classList.remove('hidden'); document.getElementById('add-category-input').focus(); });
    document.getElementById('cancel-add-category-btn').addEventListener('click', () => { document.getElementById('add-category-modal').classList.add('hidden'); document.getElementById('add-category-input').value = ''; });
    document.getElementById('confirm-add-category-btn').addEventListener('click', async () => {
        const newCategoryName = document.getElementById('add-category-input').value.trim();
        if (newCategoryName && !categories[newCategoryName]) {
            const updatedCategories = JSON.parse(JSON.stringify(categories));
            updatedCategories[newCategoryName] = { color: '#60a5fa', responses: [] };
            saveToFirestore(updatedCategories);
            activeCategory = newCategoryName;
            document.getElementById('add-category-modal').classList.add('hidden');
            document.getElementById('add-category-input').value = '';
            showMessage("Category created successfully!");
			logUserEvent('create_category', {}, firstSignIn);
			awardXP(XP_VALUES.CREATE_CATEGORY);
        } else if (categories[newCategoryName]) {
            showMessage("Category already exists.", 'error');
        }
    });
    document.getElementById('category-actions-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        const categoryActionsMenu = document.getElementById('category-actions-menu');
        categoryActionsMenu.classList.toggle('hidden');
        categoryActionsMenu.classList.toggle('scale-95');
        categoryActionsMenu.classList.toggle('opacity-0');
        document.getElementById('category-actions-btn').classList.toggle('active');
    });
    document.getElementById('rename-category-btn').addEventListener('click', () => {
        const editCategoryModal = document.getElementById('edit-category-modal');
        const editCategoryInput = document.getElementById('edit-category-input');
        const categoryActionsMenu = document.getElementById('category-actions-menu');
        editCategoryModal.classList.remove('hidden');
        editCategoryInput.value = activeCategory;
        categoryToEdit = activeCategory;
        categoryActionsMenu.classList.add('hidden');
    });
    document.getElementById('cancel-edit-category-btn').addEventListener('click', () => { document.getElementById('edit-category-modal').classList.add('hidden'); });
    document.getElementById('confirm-edit-category-btn').addEventListener('click', () => {
        const newName = document.getElementById('edit-category-input').value.trim();
        if (newName && newName !== categoryToEdit) {
            const updatedCategories = JSON.parse(JSON.stringify(categories));
            if (updatedCategories[newName]) { showMessage("A category with that name already exists.", 'error'); return; }
            const oldCategoryData = updatedCategories[categoryToEdit];
            delete updatedCategories[categoryToEdit];
            updatedCategories[newName] = oldCategoryData;
            saveToFirestore(updatedCategories);
            activeCategory = newName;
            document.getElementById('edit-category-modal').classList.add('hidden');
            showMessage("Category renamed successfully!");
        } else { document.getElementById('edit-category-modal').classList.add('hidden'); }
    });
    document.getElementById('delete-category-btn').addEventListener('click', () => { document.getElementById('delete-category-modal').classList.remove('hidden'); document.getElementById('category-actions-menu').classList.add('hidden'); });
    document.getElementById('cancel-delete-category-btn').addEventListener('click', () => { document.getElementById('delete-category-modal').classList.add('hidden'); });
    document.getElementById('confirm-delete-category-btn').addEventListener('click', () => {
        const updatedCategories = JSON.parse(JSON.stringify(categories));
        delete updatedCategories[activeCategory];
        const categoryNames = Object.keys(updatedCategories);
        activeCategory = categoryNames.length > 0 ? categoryNames[0] : '';
        saveToFirestore(updatedCategories);
        document.getElementById('delete-category-modal').classList.add('hidden');
        showMessage("Category deleted successfully!");
    });
    document.getElementById('change-color-btn').addEventListener('click', () => {
        const colorPickerModal = document.getElementById('color-picker-modal');
        const colorInput = document.getElementById('color-input');
        colorPickerModal.classList.remove('hidden');
        const currentColor = categories[activeCategory]?.color || '#60a5fa';
        colorInput.value = currentColor;
        document.getElementById('category-actions-menu').classList.add('hidden');
    });
    document.getElementById('close-color-picker-btn').addEventListener('click', () => { document.getElementById('color-picker-modal').classList.add('hidden'); });
    document.getElementById('save-color-btn').addEventListener('click', () => {
        const newColor = document.getElementById('color-input').value;
        const updatedCategories = JSON.parse(JSON.stringify(categories));
        if (updatedCategories[activeCategory]) {
            updatedCategories[activeCategory].color = newColor;
            saveToFirestore(updatedCategories);
            document.getElementById('color-picker-modal').classList.add('hidden');
            showMessage("Color updated successfully!");
			logUserEvent('change_color', {}, firstSignIn);
        }
    });
    document.getElementById('input-text-fedex').addEventListener('input', extractAndDisplayNumbers);
    document.getElementById('clear-button-fedex').addEventListener('click', () => {
        document.getElementById('input-text-fedex').value = '';
        extractAndDisplayNumbers();
        showMessage('Input cleared!', 'success');
    });
document.getElementById('copy-button-fedex').addEventListener('click', async () => {
    const text = document.getElementById('input-text-fedex').value;
    const fedexRegex = /(?:78\d{10}|79\d{10}|80\d{10}|81\d{10}|82\d{10}|(?:96\d{20}|96\d{32}|\d{15}|\d{12}))/g;
    const matches = text.match(fedexRegex) || [];
    if (matches.length > 0) {
        const uniqueNumbers = [...new Set(matches)];
        
        await logUserEvent('extract_tracking', { count: uniqueNumbers.length });
        const numbersToCopy = uniqueNumbers.join('\t');
        copyToClipboard(numbersToCopy);
		await awardXP(XP_VALUES.FEDEX_TRACKING);

        const numbersForUrl = uniqueNumbers.join(',');
        const encodedNumbers = encodeURIComponent(numbersForUrl);
        const fedexUrl = `https://www.fedex.com/en-us/tracking.html?tracknumbers=${encodedNumbers}`;
        window.open(fedexUrl, '_blank');
    } else {
        showMessage('No tracking numbers to copy.', 'error');
    }
});
    document.getElementById('import-export-btn-settings').addEventListener('click', () => { document.getElementById('import-export-modal').classList.remove('hidden'); });
    document.getElementById('close-import-export-modal-btn').addEventListener('click', () => { document.getElementById('import-export-modal').classList.add('hidden'); });
    document.getElementById('export-btn').addEventListener('click', () => { exportData(); });
    document.getElementById('import-file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) importData(file);
    });

document.getElementById('confirm-placeholder-btn').addEventListener('click', () => {
    const inputs = document.getElementById('placeholder-inputs').querySelectorAll('input, textarea');
    const userValues = {};
    inputs.forEach(input => {
        const key = input.dataset.placeholder;
        userValues[key] = input.value;
    });

    const finalContent = replacePlaceholders(currentTextToCopy, userValues);
    // Pass the stored ID and category to the final copy function
    copyToClipboard(finalContent, currentResponseToCopyId, currentResponseToCopyCategory);

    document.getElementById('placeholder-modal').classList.add('hidden');
    document.getElementById('copied-text-display').textContent = finalContent;

    if (isTutorialActive) {
        document.getElementById('copy-success-modal').classList.remove('hidden');
        currentTutorialStep++;
        showTutorialStep(currentTutorialStep);
    } else {
        document.getElementById('copy-success-modal').classList.remove('hidden');
    }
});

// The cancel button logic is correct and doesn't need to be changed.
document.getElementById('cancel-placeholder-btn').addEventListener('click', () => {
    document.getElementById('placeholder-modal').classList.add('hidden');
    
    if (isTutorialActive) {
        document.getElementById('tutorial-modal').classList.remove('hidden');
        document.getElementById('tutorial-overlay').classList.remove('hidden');
        showTutorialStep(currentTutorialStep);
    } 
});

// The showPlaceholderDemo logic should be updated slightly.
document.getElementById('show-placeholder-example-btn').addEventListener('click', () => {
    isTutorialActive = true; 
    const highlightedResponse = document.querySelector('.response-item.highlight-target');
    if (highlightedResponse) {
        const textToCopy = highlightedResponse.querySelector('.response-text-display').textContent;
        processAndCopy(textToCopy);
    } else {
        console.error("No highlighted response found for the tutorial demo.");
        const fallbackText = "Hello [Customer's Name], this is a default message.";
        processAndCopy(fallbackText);
    }
    
    // Hide the tutorial modal and overlay so the placeholder modal is the main focus.
    // This is correct.
    document.getElementById('tutorial-modal').classList.add('hidden');
    document.getElementById('tutorial-overlay').classList.add('hidden');
});

// Add a check to the showPlaceholderDemo function as well to set the flag
document.getElementById('show-placeholder-example-btn').addEventListener('click', () => {
    isTutorialActive = true; // Set the flag to true when starting the demo
    const highlightedResponse = document.querySelector('.response-item.highlight-target');
    if (highlightedResponse) {
        const textToCopy = highlightedResponse.querySelector('.response-text-display').textContent;
        processAndCopy(textToCopy);
    } else {
        console.error("No highlighted response found for the tutorial demo.");
        const fallbackText = "Hello [Customer's Name], this is a default message.";
        processAndCopy(fallbackText);
    }
    // The placeholder modal is shown inside processAndCopy, so we don't do it here.
    document.getElementById('tutorial-modal').classList.add('hidden');
    document.getElementById('tutorial-overlay').classList.add('hidden');
});

	
    document.getElementById('sign-in-btn-settings').addEventListener('click', async () => {
        try { const provider = new GoogleAuthProvider(); await signInWithPopup(auth, provider); showMessage("Signed in with Google!"); } catch (error) { console.error("Google sign-in failed", error); showMessage("Google sign-in failed. Please try again.", 'error'); }
    });
    document.getElementById('sign-out-btn-settings').addEventListener('click', async () => {
        try { await signOut(auth); showMessage("Signed out successfully!"); await signInAnonymously(auth); } catch (error) { console.error("Sign out failed", error); showMessage("Sign out failed. Please try again.", 'error'); }
    });
document.getElementById('check-updates-btn-settings').addEventListener('click', async () => {
    if (isAnonymous) {
        showMessage("Please sign in to check for updates.", "error");
        return;
    }

    const updateModal = document.getElementById('update-modal');
    const updateModalTitle = document.getElementById('update-modal-title');
    const updateModalMessage = document.getElementById('update-modal-message');
    const updateModalButtons = document.getElementById('update-modal-buttons');

    // Show the modal immediately
    updateModal.classList.remove('hidden');
    updateModalTitle.textContent = "Checking for Updates...";
    updateModalMessage.textContent = "Comparing your data with the latest blueprint...";
    updateModalButtons.classList.add('hidden');

    try {
        // 1. Get the latest blueprint from your code
        const blueprint = await getCannedResponsesBlueprint();
        
        // 2. Make a deep copy of the user's current data to modify it safely
        const updatedCategories = JSON.parse(JSON.stringify(categories));
        
        let changesMade = false;
        let updatedResponsesCount = 0;
        let newResponsesCount = 0;
        let newCategoryCount = 0;

        // 3. Loop through every category and response in the blueprint
        for (const blueprintCategoryName in blueprint) {
            const blueprintCategory = blueprint[blueprintCategoryName];

            // Check if the category exists for the user; if not, add it
            if (!updatedCategories[blueprintCategoryName]) {
                updatedCategories[blueprintCategoryName] = {
                    color: blueprintCategory.color,
                    responses: [] // Start with an empty array
                };
                newCategoryCount++;
                changesMade = true;
            }

            for (const blueprintResponse of blueprintCategory.responses) {
                // Find the user's version of this response
                const userResponse = updatedCategories[blueprintCategoryName].responses.find(r => r.id === blueprintResponse.id);

                if (userResponse) {
                    // Response exists, check its version
                    // (Use 0 as a default if the user's response doesn't have a version yet)
                    const userVersion = userResponse.version || 0;
                    if (blueprintResponse.version > userVersion) {
                        // Blueprint is newer! Overwrite the user's response text and update their version.
                        userResponse.text = blueprintResponse.text;
                        userResponse.label = blueprintResponse.label;
                        userResponse.version = blueprintResponse.version; // Crucial!
                        updatedResponsesCount++;
                        changesMade = true;
                    }
                } else {
                    // Response does not exist for the user, so add it
                    updatedCategories[blueprintCategoryName].responses.push(blueprintResponse);
                    newResponsesCount++;
                    changesMade = true;
                }
            }
        }
        
        // 4. If any changes were made, save the updated data to Firestore
        if (changesMade) {
            await saveToFirestore(updatedCategories);
			const userDocRef = getUserRootDocRef(userId);
            await setDoc(userDocRef, { syncedBlueprintVersion: masterBlueprintVersion }, { merge: true });
            showUpdateNotification(false);
            updateModalTitle.textContent = "Updates Applied! ✅";
            updateModalMessage.innerHTML = `
                <p>Your data has been successfully updated.</p>
                <ul class="list-disc list-inside mt-2 text-left">
                    ${newCategoryCount > 0 ? `<li>${newCategoryCount} new categories added.</li>` : ''}
                    ${newResponsesCount > 0 ? `<li>${newResponsesCount} new responses added.</li>` : ''}
                    ${updatedResponsesCount > 0 ? `<li>${updatedResponsesCount} existing responses updated.</li>` : ''}
                </ul>
            `;
        } else {
			const userDocRef = getUserRootDocRef(userId);
            await setDoc(userDocRef, { syncedBlueprintVersion: masterBlueprintVersion }, { merge: true });
            showUpdateNotification(false);
            updateModalTitle.textContent = "You're Up to Date! 👍";
            updateModalMessage.textContent = "No new updates were found.";
        }

    } catch (error) {
        console.error("Error checking for updates:", error);
        updateModalTitle.textContent = "Update Failed ❌";
        updateModalMessage.textContent = "An error occurred. Please try again later.";
    } finally {
        // Always show the close button at the end
        updateModalButtons.classList.remove('hidden');
    }
});
    document.getElementById('close-update-btn').addEventListener('click', () => { document.getElementById('update-modal').classList.add('hidden'); });
    document.getElementById('show-placeholder-example-btn').addEventListener('click', showPlaceholderDemo);



// --- Core Application Logic (Auth and Data Sync) ---
onAuthStateChanged(auth, async (user) => {
    if (cannedResponsesUnsubscribe) { cannedResponsesUnsubscribe(); cannedResponsesUnsubscribe = null; }
    if (helpfulLinksUnsubscribe) { helpfulLinksUnsubscribe(); helpfulLinksUnsubscribe = null; }
    if (user) {
        userId = user.uid;
        isAnonymous = user.isAnonymous;
        const displayName = user.displayName || user.email || 'User';
        userName = displayName.split(' ')[0].split('@')[0];
        const linksUserInfo = document.getElementById('links-user-info');
        if (linksUserInfo) linksUserInfo.textContent = `User ID: ${userId}`;
        defaultLinks = await getHelpfulLinksBlueprint();
        renderStaticLinks();
        if (!isAnonymous) {
            const linksCollectionRef = getUserHelpfulLinksCollectionRef(userId);
            helpfulLinksUnsubscribe = onSnapshot(linksCollectionRef, (querySnapshot) => {
                userLinks = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUserLinks();
            }, (error) => {
                console.error("Error listening for user links:", error);
                showMessage("Error loading your links. Please check your Firebase permissions.", 'error');
            });
        }
        if (isAnonymous) {
            const userDocRef = getUserRootDocRef(userId);
            try {
                const userDoc = await getDoc(userDocRef);
                const hasSeenPrompt = userDoc.exists() && userDoc.data().hasSeenLoginPrompt;
                if (!hasSeenPrompt) { document.getElementById('login-popup-modal').classList.remove('hidden'); setTimeout(() => { document.getElementById('login-popup-modal').classList.add('show'); }, 10); } else { document.getElementById('login-popup-modal').classList.add('hidden'); }
            } catch (error) {
                console.error("Error fetching user data for login prompt:", error);
                document.getElementById('login-popup-modal').classList.remove('hidden');
                setTimeout(() => { document.getElementById('login-popup-modal').classList.add('show'); }, 10);
            }
            categories = await getCannedResponsesBlueprint();
            if (Object.keys(categories).length > 0) {
                const existingCategoryNames = Object.keys(categories);
                if (!existingCategoryNames.includes(activeCategory)) { activeCategory = existingCategoryNames[0]; }
            }
            renderContent();
        } else {
            document.getElementById('login-popup-modal').classList.add('hidden');
            const userDocRef = getUserRootDocRef(userId);
			await migrateExistingUsersToLeaderboard();
            const userDoc = await getDoc(userDocRef);
			const userData = userDoc.exists() ? userDoc.data() : {};
            firstSignIn = userDoc.exists() && userDoc.data().firstSignIn ? userDoc.data().firstSignIn.toDate() : null;
            
            if (!userData.firstSignIn) {
                const creationTime = user.metadata.creationTime; 
                firstSignIn = new Date(creationTime);
                await setDoc(userDocRef, { firstSignIn: firstSignIn, xp: 0 }, { merge: true });
                console.log(`Initialized 'firstSignIn' and 'xp' for user ${userId}`);
            } else {
                firstSignIn = userData.firstSignIn.toDate();
            }

            // --- NEW: One-Time XP Backfilling Script ---
            if (userData && userData.achievementsData && !userData.xpMigrated) {
                const unlockedAchievementsCount = Object.keys(userData.achievementsData).length;
                if (unlockedAchievementsCount > 0) {
                    const earnedXp = unlockedAchievementsCount * XP_VALUES.UNLOCK_ACHIEVEMENT;
                    const currentXp = userData.xp || 0;
                    const newTotalXp = currentXp + earnedXp;

                    await setDoc(userDocRef, {
                        xp: newTotalXp,
                        xpMigrated: true // Set the flag to prevent this from running again
                    }, { merge: true });
                    
                    console.log(`Migrated ${earnedXp} XP for ${unlockedAchievementsCount} past achievements for user ${userId}.`);
                    showMessage("Your past achievements have been credited with XP!", "success");
                } else {
                     await setDoc(userDocRef, { xpMigrated: true }, { merge: true });
                }
            }
            // --- END of New Script ---

            const tutorialSeen = userDoc.exists() && userDoc.data().tutorialSeen;
            if (!tutorialSeen) {
                document.getElementById('tutorial-modal').classList.remove('hidden');
                showTutorialStep(0);
            } else {
                document.getElementById('tutorial-modal').classList.add('hidden');
            }
			await checkForUpdatesOnLoad();
            const userCannedResponsesDocRef = getUserCannedResponsesDocRef(userId);
            cannedResponsesUnsubscribe = onSnapshot(userCannedResponsesDocRef, async (doc) => {
                if (doc.exists()) { categories = doc.data().categories || {}; } else { try { const blueprint = await getCannedResponsesBlueprint(); categories = JSON.parse(JSON.stringify(blueprint)); await setDoc(userCannedResponsesDocRef, { categories: categories }); console.log("Migrated default data to Firestore for new user."); } catch (error) { console.error("Error migrating data for new user:", error); } }
                for (const key in categories) { if (!categories[key].responses) { categories[key].responses = []; } }
                if (Object.keys(categories).length > 0) {
                    const existingCategoryNames = Object.keys(categories);
                    if (!existingCategoryNames.includes(activeCategory)) { activeCategory = existingCategoryNames[0]; }
                }
                renderContent();
				updateDarkModeStreak();
				checkAndNotifyAchievements(firstSignIn); 
            }, (error) => {
                console.error("Error with onSnapshot listener:", error);
                showMessage("Error loading your data. Please check your Firebase permissions.", 'error');
            });
        }
    } else {
        try { await signInAnonymously(auth); } catch (error) { console.error("Anonymous sign-in failed", error); }
    }
    const loader = document.getElementById('full-page-loader');
    if (loader) {
        loader.classList.add('hidden');
    }	
});

attachEventListeners();
</script>
</body>
</html>
