<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tools For Work</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Alexandria:wght@400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;600&display=swap');
        
        /* Base Dark Mode Styles */
        body {
            font-family: 'Alexandria', sans-serif;
            background-color: #111827;
            color: #e5e7eb;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        h1, h2 {
            font-family: 'Poppins', sans-serif;
        }
        .container-bg {
            background-color: #0d1117;
            background-image: radial-gradient(at 0% 0%, hsla(215,90%,55%,0.15) 0, transparent 50%),
                              radial-gradient(at 100% 100%, hsla(280,90%,70%,0.15) 0, transparent 50%);
        }
        .link-card, .card-style, .form-container, .floating-card, .main-card, .sidebar, .modal-content {
            background-color: rgba(22, 27, 34, 0.8);
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
        }
        .link-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .link-title {
            background-image: linear-gradient(to right, #80e8ff, #62b3ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .pulse-effect:hover {
            animation: pulse-border 1s infinite;
        }
        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(100, 160, 255, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(100, 160, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(100, 160, 255, 0);
            }
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            color: white;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .message-box.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }
        .modal-content {
            background-color: #1f2937;
            color: #e5e7eb;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5-px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
            width: 90%;
            max-width: 450px;
            transform: scale(0.95);
            transition: transform 0.3s ease-out;
        }
        .modal.show .modal-content {
            transform: scale(1);
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background-color: #1f2937;
            padding: 2.5rem 1.5rem;
            box-shadow: 4px 0 15px rgba(0,0,0,0.5);
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2000;
        }
        .sidebar.open {
            left: 0;
        }
        .pb-extra {
            padding-bottom: 2rem;
        }
        .scrollable-box {
            max-height: 250px;
            overflow-y: auto;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            background-color: #1f2937;
            box-shadow: 0 10px 15px -3-px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.5);
        }
        .tracking-numbers-container {
            background-color: #111827;
            border-color: #4a5568;
        }
        .tracking-tab {
            background-color: #2d3748;
            border-color: #4a5568;
        }
        .text-placeholder::placeholder {
            color: #a0aec0;
        }
        .main-card {
            background-color: rgba(22, 27, 34, 0.8);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            padding: 2rem;
            transition: all 0.3s ease;
        }
        .main-card:hover {
            transform: translateY(-5px);
        }
        .floating-card {
            background-color: rgba(22, 27, 34, 0.8);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .highlight {
            background-color: rgba(255, 255, 0, 0.3);
            color: #000;
            padding: 2px 4px;
            border-radius: 4px;
        }

        /* Light Mode Styles */
        body.light-mode {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .light-mode .container-bg {
            background-color: #f9fafb;
            background-image: radial-gradient(at 0% 0%, hsla(215,90%,55%,0.15) 0, transparent 50%),
                              radial-gradient(at 100% 100%, hsla(280,90%,70%,0.15) 0, transparent 50%);
        }
        .light-mode .link-card, .light-mode .card-style, .light-mode .form-container, .light-mode .floating-card, .light-mode .main-card, .light-mode .sidebar, .light-mode .modal-content {
            background-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .light-mode .link-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .light-mode h1, .light-mode h2, .light-mode h3 {
            color: #1f2937;
        }
        .light-mode .link-title {
            background-image: none;
            -webkit-background-clip: unset;
            -webkit-text-fill-color: inherit;
            color: #1f2937;
        }
        .light-mode .text-placeholder::placeholder {
            color: #6b7280;
        }
        .light-mode #auth-status, .light-mode .text-gray-400 {
            color: #4b5563;
        }
        .light-mode .bg-gray-800 { background-color: #e5e7eb; }
        .light-mode .bg-gray-700 { background-color: #d1d5db; }
        .light-mode .bg-gray-600 { background-color: #9ca3af; }
        .light-mode .text-gray-100 { color: #1f2937; }
        .light-mode .text-gray-200 { color: #374151; }
        .light-mode .border-gray-600 { border-color: #9ca3af; }
        .light-mode .hover\:bg-gray-700:hover { background-color: #d1d5db; }
        .light-mode .hover\:text-white:hover { color: #1f2937; }
        .light-mode .tracking-numbers-container { background-color: #f3f4f6; }
        .light-mode .tracking-tab { background-color: #e5e7eb; }
        
        .kebab-button.active svg {
            transform: rotate(90deg);
            transition: transform 0.2s ease-in-out;
        }

        .kebab-button svg {
            transition: transform 0.2s ease-in-out;
        }
    </style>
    
    <!-- Favicon links for all browsers and devices -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

    <!-- Legacy favicon link for older browsers -->
    <link rel="shortcut icon" href="favicon.ico">

    <!-- Apple touch icon for iOS devices -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

    <!-- Manifest for Progressive Web Apps (PWAs) -->
    <link rel="manifest" href="/site.webmanifest">
</head>
<body class="flex flex-col min-h-screen bg-gray-900 relative">

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar flex flex-col">
        <h2 class="text-3xl font-extrabold text-gray-100 mb-8">Tools </h2>
        <nav class="flex flex-col space-y-3">
            <button id="nav-canned-responses" class="w-full text-left px-5 py-3 rounded-xl hover:bg-gray-700 transition duration-300 text-gray-200 font-semibold text-lg">
                <i class="fas fa-comment-dots mr-3"></i> Canned Responses
            </button>
            <button id="nav-fedex-tracker" class="w-full text-left px-5 py-3 rounded-xl hover:bg-gray-700 transition duration-300 text-gray-200 font-semibold text-lg">
                <i class="fas fa-box-open mr-3"></i> FedEx Tracker
            </button>
            <button id="nav-helpful-links" class="w-full text-left px-5 py-3 rounded-xl hover:bg-gray-700 transition duration-300 text-gray-200 font-semibold text-lg">
                <i class="fas fa-link mr-3"></i> Helpful Links
            </button>
        </nav>
        <div class="mt-auto pt-8 flex flex-col items-center space-y-3">
            <div id="auth-status" class="text-center text-gray-400 font-medium">Not signed in.</div>
            <button id="sign-in-btn" class="w-full text-center px-5 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 transition duration-300 shadow-lg hidden">Sign In with Google</button>
            <button id="sign-out-btn" class="w-full text-center px-5 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 transition duration-300 shadow-lg hidden">Sign Out</button>
            
            <!-- Theme Toggle Button -->
            <button id="theme-toggle-btn" class="w-full text-center px-5 py-3 rounded-xl bg-gray-700 text-white font-bold hover:bg-gray-600 transition duration-300 shadow-lg">
                <i id="theme-icon" class="fas fa-moon mr-2"></i> Toggle Theme
            </button>
        </div>
        <button id="close-sidebar-btn" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-700 transition duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="flex-1 p-6 sm:p-10 flex flex-col items-center transition-all duration-300 ease-in-out">
        <header class="w-full mb-8">
            <div class="flex items-center justify-between">
                <button id="hamburger-menu-btn" class="p-2 rounded-full hover:bg-gray-700 transition duration-300" aria-label="Open Menu">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <div class="flex items-center space-x-4">
                    <h1 id="main-title" class="text-3xl sm:text-5xl font-extrabold text-gray-100 transition-colors duration-300">Canned Responses</h1>
                    <div id="category-menu-container" class="relative">
                        <!-- New Category Actions Button -->
                        <button id="category-actions-btn" class="kebab-button p-2 rounded-full hover:bg-gray-700 transition duration-300 relative hidden" aria-expanded="true" aria-haspopup="true">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                            </svg>
                        </button>
                        <!-- New centralized Category Actions menu -->
                        <div id="category-actions-menu" class="hidden absolute top-full right-0 mt-3 w-56 bg-gray-700 rounded-xl shadow-2xl z-50 transform scale-95 opacity-0 transition-all duration-300 origin-top-right">
                            <button id="rename-category-btn" class="w-full text-left px-5 py-3 hover:bg-gray-600 rounded-t-xl transition duration-200"><i class="fas fa-pencil-alt mr-2"></i>Rename Category</button>
                            <button id="delete-category-btn" class="w-full text-left px-5 py-3 hover:bg-gray-600 text-red-400 transition duration-200"><i class="fas fa-trash-alt mr-2"></i>Delete Category</button>
                            <button id="change-color-btn" class="w-full text-left px-5 py-3 hover:bg-gray-600 rounded-b-xl transition duration-200"><i class="fas fa-palette mr-2"></i>Change Color</button>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="import-export-btn" class="p-2 text-gray-400 hover:text-blue-400 transition duration-300" aria-label="Import/Export Data">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Floating Category Bar at the top -->
            <div id="category-bar" class="mt-6 p-4 bg-gray-800 shadow-2xl flex items-center justify-between rounded-2xl">
                <div class="flex-grow overflow-x-auto whitespace-nowrap scrollbar-hide">
                    <div id="category-list" class="flex gap-4">
                        <!-- Category buttons will be dynamically added here -->
                    </div>
                </div>
                <button id="add-category-btn" class="flex-shrink-0 ml-4 bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-blue-700 transition duration-300">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </header>

        <!-- Message box for user feedback -->
        <div id="message-box" class="message-box"></div>

        <!-- Canned Responses App Content -->
        <div id="canned-responses-app" class="w-full container-bg rounded-2xl p-6 sm:p-10 text-gray-100 min-h-screen flex items-start justify-center py-12 hidden">
            <div class="w-full max-w-7xl mx-auto flex flex-col md:flex-row gap-8">
                <!-- Left Column: Search & Add Response -->
                <div class="w-full md:w-1/3 flex flex-col">
                    <!-- Search Bar -->
                    <div id="search-bar-container" class="floating-card mb-8 relative p-6 sm:p-8">
                        <div class="absolute inset-y-0 left-0 pl-11 flex items-center pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input
                            type="text"
                            id="search-input"
                            class="w-full border-2 border-gray-600 rounded-xl p-4 pl-12 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg text-placeholder"
                            placeholder="Search responses..."
                        />
                    </div>
                    
                    <!-- Add Response Section -->
                    <div id="add-response-section" class="floating-card mb-8 p-6 sm:p-8 flex-grow">
                        <label for="response-input" class="block text-gray-400 font-semibold text-lg mb-4">Add New Response</label>
                        <div class="flex flex-col sm:flex-row gap-6 mb-6">
                            <textarea
                                id="response-input"
                                class="flex-grow w-full border-2 border-gray-600 rounded-xl p-4 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg text-placeholder"
                                rows="5"
                                placeholder="Type your new canned response here..."
                            ></textarea>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 items-center justify-center">
                            <button id="add-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-blue-700 transition duration-300">
                                <i class="fas fa-plus mr-2"></i> Add Response
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Responses List -->
                <div class="w-full md:w-2/3">
                    <div id="responses-container" class="w-full floating-card p-6 sm:p-8">
                        <h2 id="responses-heading" class="text-3xl font-bold text-gray-200 mb-6 hidden"></h2>
                        
                        <div id="responses-list" class="space-y-6">
                            <!-- Responses will be dynamically added here, grouped by label -->
                        </div>
                        <div id="empty-state" class="text-center text-gray-400 mt-8 hidden">
                            <p class="text-lg">No canned responses in this category. Add one above!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FedEx Tracker Content -->
        <div id="fedex-tracker-app" class="w-full container-bg rounded-2xl p-6 sm:p-10 text-gray-100 min-h-screen flex items-center justify-center py-12 hidden">
            <div class="main-card p-8 w-full max-w-2xl mx-auto">
                <h1 class="text-4xl font-bold text-center text-gray-100 mb-4">FedEx Tracking</h1>
                <p class="text-center text-gray-400 mb-8 text-lg">Extract and manage your FedEx tracking numbers easily.</p>
        
                <!-- Input Section -->
                <div class="mb-6">
                    <label for="input-text" class="block text-sm font-medium text-gray-300 mb-2">Paste or type your text here:</label>
                    <textarea id="input-text-fedex" rows="8" class="text-placeholder w-full p-4 border-2 border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-800 text-gray-100 transition duration-300 text-lg" placeholder="e.g., 'Your package with tracking number 794829370821 has been shipped.'"></textarea>
                </div>
        
                <!-- Extracted Numbers Section -->
                <div class="mb-6">
                    <h2 class="text-2xl font-semibold text-gray-200 mb-4">Extracted Tracking Numbers</h2>
                    <div id="tracking-numbers-container" class="tracking-numbers-container border-2 border-dashed border-gray-700 rounded-xl p-4 scrollable-box shadow-inner">
                        <p id="no-numbers-message" class="text-center text-gray-500 text-base">No tracking numbers found yet.</p>
                        <!-- Loading indicator -->
                        <div id="loading-indicator" class="hidden flex justify-center items-center">
                            <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-base text-gray-400">Processing...</span>
                        </div>
                    </div>
                </div>
        
                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <button id="clear-button-fedex" class="w-full sm:w-auto bg-gray-700 text-gray-200 font-semibold py-3 px-8 rounded-xl shadow-md hover:bg-gray-600 transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-400 disabled:opacity-50">
                        Clear
                    </button>
                    <button id="copy-button-fedex" class="w-full sm:w-auto bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 disabled:bg-indigo-300">
                        <svg class="h-5 w-5 inline-block -mt-1 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2H6z" />
                        </svg>
                        Copy All & Open FedEx
                    </button>
                </div>
            </div>
        </div>

        <!-- Helpful Links Content -->
        <div id="helpful-links-app" class="w-full hidden container-bg rounded-2xl p-6 sm:p-10 text-gray-100 min-h-screen flex items-center justify-center py-12">
            <div class="container mx-auto px-4">
                <header class="text-center mb-16 animate-fade-in">
                    <p class="mt-4 text-xl text-gray-300 max-w-2xl mx-auto">
                        A carefully curated selection of resources, tools, and documentation.
                    </p>
                    <div id="links-user-info" class="mt-4 text-sm text-gray-500"></div>
                </header>

                <!-- Main links container -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    
                    <!-- Category: Static Resources (Your pre-defined links) -->
                    <section class="col-span-1 md:col-span-2 lg:col-span-3">
                        <h2 class="text-3xl font-bold text-center mb-8 link-title">
                            Static Resources
                        </h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="link-card rounded-xl p-6 shadow-2xl pulse-effect">
                                <a href="https://supportcenter.corp.google.com/corpengkb/category/bltc1355050242a3f3d?e=ServicedeskCommonGuidedSupport::Launch" target="_blank" rel="noopener noreferrer" class="block">
                                    <h3 class="font-bold text-xl text-white hover:text-sky-300 transition-colors mb-2">Astreya KB</h3>
                                    <p class="text-sm text-gray-400">A knowledge base for support and resources.</p>
                                </a>
                            </div>
                            <div class="link-card rounded-xl p-6 shadow-2xl pulse-effect">
                                <a href="https://ui-web-dot-emt-inspecto-dev.uc.r.appspot.com/app/" target="_blank" rel="noopener noreferrer" class="block">
                                    <h3 class="font-bold text-xl text-white hover:text-sky-300 transition-colors mb-2">Astreya Audits</h3>
                                    <p class="text-sm text-gray-400">An internal tool for audits.</p>
                                </a>
                            </div>
                            <div class="link-card rounded-xl p-6 shadow-2xl pulse-effect">
                                <a href="https://ipdb.corp.google.com/ipdb/corp-list/?ip_address=&netmask=&description=&vlan=&address_type=all&region_name=&country_name=US&city_name=&building_name=&network_name=&tag=ACL-CORP-MNP" target="_blank" rel="noopener noreferrer" class="block">
                                    <h3 class="font-bold text-xl text-white hover:text-sky-300 transition-colors mb-2">Find Net blocks</h3>
                                    <p class="text-sm text-gray-400">A tool for searching corporate network information.</p>
                                </a>
                            </div>
                            <div class="link-card rounded-xl p-6 shadow-2xl pulse-effect">
                                <a href="https://docs.google.com/spreadsheets/d/1urmopWJvKXdXqAsPf1TBW2W97h5wbkFkNs9CKcBdwsE/edit?gid=0#gid=0" target="_blank" rel="noopener noreferrer" class="block">
                                    <h3 class="font-bold text-xl text-white hover:text-sky-300 transition-colors mb-2">Bronco Plant Codes </h3>
                                    <p class="text-sm text-gray-400">A spreadsheet containing plant codes.</p>
                                </a>
                            </div>
                            <div class="link-card rounded-xl p-6 shadow-2xl pulse-effect">
                                <a href="https://docs.google.com/spreadsheets/d/1zYSxHSdwIwrEvWAcpVyhbx6b5R2raWq322pM3EGexy0/edit?resourcekey=0-ghk2iWDZcH3sFEZ_NA-uyQ&gid=421127237#gid=421127237" target="_blank" rel="noopener noreferrer" class="block">
                                    <h3 class="font-bold text-xl text-white hover:text-sky-300 transition-colors mb-2">GUTS CTI</h3>
                                    <p class="text-sm text-gray-400">A spreadsheet for CTI tracking.</p>
                                </a>
                            </div>
                            <div class="link-card rounded-xl p-6 shadow-2xl pulse-effect">
                                <a href="https://lookerstudio.google.com/c/u/0/reporting/462c770f-51f7-42e4-811d-b3fb3daf09eb/page/p_6a7jcz4nsd" target="_blank" rel="noopener noreferrer" class="block">
                                    <h3 class="font-bold text-xl text-white hover:text-sky-300 transition-colors mb-2">Technician Workload Management</h3>
                                    <p class="text-sm text-gray-400">A tool for monitoring and managing technician workload.</p>
                                </a>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Category: User-Added Links -->
                    <section class="col-span-1 md:col-span-2 lg:col-span-3 mt-12">
                        <h2 class="text-3xl font-bold text-center mb-8 link-title">
                            Your Links
                        </h2>
                        <div id="user-links-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <p class="text-center text-gray-400 col-span-full">Loading your links...</p>
                        </div>
                    </section>

                    <!-- Form to add new links -->
                    <section class="col-span-1 md:col-span-2 lg:col-span-3 flex justify-center">
                        <div class="floating-card rounded-2xl p-8 max-w-lg w-full">
                            <h2 id="form-title" class="text-2xl font-bold text-blue-400 mb-4">Add a New Link</h2>
                            <form id="add-link-form" class="space-y-4">
                                <div>
                                    <label for="link-title" class="block text-sm font-medium text-gray-400">Title</label>
                                    <input type="text" id="link-title" required class="mt-1 block w-full bg-gray-700 text-white border-2 border-gray-600 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg p-3 transition duration-300">
                                </div>
                                <div>
                                    <label for="link-url" class="block text-sm font-medium text-gray-400">URL</label>
                                    <input type="url" id="link-url" required class="mt-1 block w-full bg-gray-700 text-white border-2 border-gray-600 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg p-3 transition duration-300">
                                </div>
                                <div class="flex space-x-4">
                                    <button type="submit" id="submit-button" class="w-full inline-flex justify-center py-3 px-6 border border-transparent shadow-lg text-lg font-bold rounded-xl text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">
                                        Add Link
                                    </button>
                                    <button type="button" id="cancel-button" class="w-full inline-flex justify-center py-3 px-6 border border-gray-600 shadow-md text-lg font-bold rounded-xl text-gray-300 bg-gray-700 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-300 hidden">
                                        Cancel
                                    </button>
                                </div>
                                <div id="status-message" class="text-center mt-2 text-sm text-gray-400"></div>
                            </form>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <!-- Universal Placeholder Modal -->
    <div id="placeholder-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Customize Response</h3>
            <p class="text-gray-400 text-base mb-4">Please fill in the details for the placeholders below.</p>
            <div id="placeholder-inputs" class="space-y-4">
                <!-- Dynamic input fields will be added here -->
            </div>
            <div class="flex justify-end mt-6 space-x-4">
                <button id="cancel-placeholder-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="confirm-placeholder-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Copy Response
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Response Modal -->
    <div id="edit-response-modal" class="modal hidden">
        <div class="modal-content w-full max-w-3xl">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Edit Response</h3>
            <p class="text-gray-400 text-base mb-4">Modify the response, its label, or category below.</p>
            <div id="edit-form" class="space-y-4">
                <div>
                    <label for="edit-response-label" class="block text-sm font-medium text-gray-400">Label</label>
                    <input type="text" id="edit-response-label" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg" />
                </div>
                <div>
                    <label for="edit-response-text" class="block text-sm font-medium text-gray-400">Response Text</label>
                    <textarea id="edit-response-text" rows="15" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg"></textarea>
                </div>
                <div>
                    <label for="edit-category-select" class="block text-sm font-medium text-gray-400">Category</label>
                    <select id="edit-category-select" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg"></select>
                </div>
            </div>
            <div class="flex justify-end mt-6 space-x-4">
                <button id="cancel-edit-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="save-edit-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Save Changes
                </button>
            </div>
        </div>
    </div>


    <!-- Import/Export Modal -->
    <div id="import-export-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Import or Export Data</h3>
            <div class="flex flex-col space-y-4">
                <div>
                    <h4 class="font-semibold text-gray-400 text-lg">Export All Data</h4>
                    <p class="text-gray-400 text-base mb-2">Download a JSON file containing all your categories and responses.</p>
                    <button id="export-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition duration-300 shadow-lg">
                        Export to File
                    </button>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-400 text-lg">Import Data</h4>
                    <p class="text-gray-400 text-base mb-2">Upload a JSON file to restore your categories and responses. This will overwrite your current data.</p>
                    <input type="file" id="import-file-input" accept="application/json" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 transition duration-300">
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button id="close-import-export-modal-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="add-category-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Add a New Category</h3>
            <p class="text-gray-400 text-base mb-4">Give your new category a name.</p>
            <input
                type="text"
                id="add-category-input"
                class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 mb-4 text-lg"
                placeholder="Enter category name (e.g., 'Customer Support')"
            />
            <div class="flex justify-end space-x-4">
                <button id="cancel-add-category-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="confirm-add-category-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Create Category
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div id="edit-category-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Edit Category</h3>
            <p class="text-gray-400 text-base mb-4">Enter a new name for the category.</p>
            <input
                type="text"
                id="edit-category-input"
                class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 mb-4 text-lg"
                placeholder="Enter new name"
            />
            <div class="flex justify-end space-x-4">
                <button id="cancel-edit-category-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="confirm-edit-category-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Save Name
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Category Modal -->
    <div id="delete-category-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Confirm Category Deletion</h3>
            <p class="text-gray-400 text-base mb-4">Are you sure you want to delete this category? All responses inside it will be permanently deleted.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-category-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="confirm-delete-category-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-red-700 transition duration-300 shadow-md">
                    Yes, Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Color Picker Modal -->
    <div id="color-picker-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Change Category Color</h3>
            <p class="text-gray-400 text-base mb-4">Select a new color for the active category.</p>
            <div class="flex justify-center mb-4">
                <input type="color" id="color-input" class="w-16 h-16 rounded-lg cursor-pointer border-2 border-gray-600">
            </div>
            <div class="flex justify-end mt-6 space-x-4">
                <button id="close-color-picker-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Close
                </button>
                <button id="save-color-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- Label Modal -->
    <div id="label-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Add a Label</h3>
            <p class="text-gray-400 text-base mb-4">Give your new response a label to help keep things organized.</p>
            <input
                type="text"
                id="modal-label-input"
                class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 mb-4 text-lg"
                placeholder="Enter a label (e.g., 'Customer Support')"
            />
            <div class="flex justify-end space-x-4">
                <button id="cancel-label-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="save-label-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Save Label
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Confirm Deletion</h3>
            <p class="text-gray-400 text-base mb-4">Are you sure you want to delete this response?</p>
            <div class="flex justify-end space-x-4">
                <button id="delete-cancel-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="delete-confirm-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-red-700 transition duration-300 shadow-md">
                    Yes, Delete
                </button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Initialization and Auth ---
        const firebaseConfig = {
            apiKey: "AIzaSyCCsU4YY_Rwqo-F9KJjeOOSD4NpUGLNq8s",
            authDomain: "tools-a180f.firebaseapp.com",
            projectId: "tools-a180f",
            storageBucket: "tools-a180f.firebasestorage.app",
            messagingSenderId: "195275159442",
            appId: "1:195275159442:web:20031fd5ccf0428162334b",
            measurementId: "G-TP0VKGV0EE"
        };
        const appId = firebaseConfig.appId;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let categories = {};
        let activeCategory = '';
        let userId = null;
        let newResponseId = null;
        let responseToDeleteId = null;
        let categoryToEdit = null;
        let currentPage = 'canned-responses';
        let userName = '';
        let currentTextToCopy = '';
        let currentEditingId = null;
        let openCategoryMenu = null;
        let editingLinkDocId = null;
        let openMenuId = null;
        
        const defaultCannedResponses = {
            'BRONCO': {
                color: '#0284c7',
                responses: [
                    { id: 'bronco-1', label: 'NON ACTIONABLE ORDER', text: 'Hello [Customer\'s Name],\n\nI am writing to inform you that the item you ordered, [Device Model], is currently out of stock. We expect to have it back in stock within 2-4 weeks. I apologize for the inconvenience.\n\nOnce it is back in stock, we will deliver it to you as soon as possible. We appreciate your patience and understanding during this time.\n\nIf you have any other questions or concerns, please do not hesitate to contact me.\n\nSincerely,\n\n[Name]', createdAt: new Date().toISOString() },
                    { id: 'bronco-2', label: 'ACTIONABLE ITEM RESPONSE', text: 'Hello [Customer\'s Name],\n\nThank you for your order!\n\nOur target is to have them either shipped or delivered to you in 1-3 business days time. We will let you know when your order is on its way.\n\nThank you\n\n[Name]', createdAt: new Date().toISOString() },
                    { id: 'bronco-3', label: 'OUT FOR DELIVERY RESPONSE', text: 'Hello [Customer\'s Name],\n\nYour order will ship today or the next business day, depending on FedEx\'s pickup schedule. You can track your shipment with FedEx Tracking [TrackingNumber].\n\nPlease make sure to check your local Mail room once this order is marked delivered.\n\nPlease note that once the order is delivered, we are unable to see and respond to updates in the order.\n\nIf you need further help, please submit a request through go/stuff by selecting “Have questions about your order?”, or by opening a ticket at go/emt-request.\n\nThank you,\n\n[Name]', createdAt: new Date().toISOString() },
                    { id: 'bronco-4', label: 'ITEM DELIVERED', text: 'Hello [Customer\'s Name],\n\nI have delivered the [Device Model] to your desk [Desk Location] this morning [Date].\n\nPlease note that once the order is delivered, we are unable to see and respond to updates in the order.\n\nIf you need further help, please submit a request through go/stuff by selecting “Have questions about your order?”, or by opening a ticket at go/emt-request.\n\nThank you,\n\n[Name]', createdAt: new Date().toISOString() },
                    { id: 'bronco-5', label: 'SECURITY KEY DELIVERED', text: 'Hello [Customer\'s Name],\n\nYour security key order has been delivered to [Desk Location]. Please be sure to follow the Techstop security key setup instructions at go/setup-sk.\n\nPlease note that once the order is delivered, we are unable to see and respond to updates in the order.\n\nIf you need further help, please submit a request through go/stuff by selecting “Have questions about your order?”, or by opening a ticket at go/emt-request.\n\nThank you,\n\n[Name]', createdAt: new Date().toISOString() },
                    { id: 'bronco-6', label: 'PIKTIME', text: 'Hello [Customer\'s Name],\n\nThank you for your request.\n\nWe\'ve prepared your order and it will be ready for you to pick up at your confirmed appointment time.\n\nPick-up Location: https://floorscope.googleplex.com/US-LAX-BIN2-1#US-LAX-BIN2-1-100 (Please knock on our door when you arrive to pick up your order.)\n\nKind regards,\n\n[Name]', createdAt: new Date().toISOString() },
                    { id: 'bronco-7', label: 'PIKTIME DELIVERED', text: 'Hello [Customer\'s Name],\n\nYour order for a [Device Model] was successfully picked up on [Date]. Thanks for stopping by!\n\nWe will now mark this order delivered.\n\nKind regards,\n\n[Name]', createdAt: new Date().toISOString() },
                    { id: 'bronco-8', label: 'PIKTIME CANCELLED', text: 'Hello [Customer\'s Name],\n\nThis is to inform you that your order has been canceled. This is due to the failure to pick up the order at the confirmed date and time of your appointment.\n\nKind regards,\n\n[Name]', createdAt: new Date().toISOString() }
                ]
            },
            'PAR': {
                color: '#ef4444',
                responses: [
                    { id: 'par-1', label: 'PAR REMOTE ORDER', text: 'Hello [Customer\'s Name],\n\nYour shipping materials have been sent for your return order\n\nFedEx Tracking: [TrackingNumber]\nReturn Tracking: [ReturnTrackingNumber]\n\nKind regards,\n\n[Name]', createdAt: new Date().toISOString() },
                    { id: 'par-2', label: 'PAR SHIPPING MATERIALS DELIVERED', text: 'Hello [Customer\'s Name],\n\nAccording to the FedEx tracking number, the shipping Materials were delivered on [Date].\n\nScreenshot:\n\nAs a reminder, per Google’s device return policy, you have 10 business days to complete your return. If you still have your device after the return window, this device will lose corporate access and your cost center will be charged back after 40 days.\n\nBest regards,\n\n[Name]', createdAt: new Date().toISOString() },
                    { id: 'par-3', label: 'PAR STUFF LOCKER', text: 'Hello [Customer\'s Name],\n\nThank you for submitting your return request.\n\nWe\'ll retrieve your asset from the Stuff Station return locker as soon as it\'s dropped off.\n\nJust a friendly reminder: you have 10 business days from the creation date of this order to place your asset in the return locker. If it\'s not dropped off within this time frame, your return order will be automatically canceled.\n\nKind regards,\n\n[Name]', createdAt: new Date().toISOString() },
                    { id: 'par-4', label: 'CANCEL RETURN LOCKER ORDER', text: 'Hello [Customer\'s Name],\n\nPlease be advised that this return order will be canceled. This is due to the failure to pick up the item from the designated return lockers.', createdAt: new Date().toISOString() }
                ]
            },
            'GUTS': {
                color: '#059669',
                responses: [
                    { id: 'guts-1', label: 'GNG LOCKERS PROACTIVE TICKET', text: 'Hello [Customer\'s Name],\n\nThe GNG lockers contain [Number] loaners and [Number2] empty slots.\n\nScreenshot:\n\nThis ticket will be marked resolved.\n\nKind regards,\n\n[Name]', createdAt: new Date().toISOString() },
                    { id: 'guts-2', label: 'GUTS STUFF STATION VENDING', text: 'Hello [Customer\'s Name],\n\nThe stuff station vending machine has been replenished .\n\nScreenshot:\n\nThis ticket will now be resolved.\n\nKind regards,\n\n[Name]', createdAt: new Date().toISOString() },
                    { id: 'guts-3', label: 'Remote Return Shipment Information', text: 'Hello [Customer\'s Name],\n\nYour request has been prepped and ready to ship. Feel free to reach out to us if you need more assistance. (1 Box Sent)\n\nFedEx Tracking:[TrackingNumber]\nReturn Tracking:[ReturnTrackingNumber]\n\nAs a reminder, per Google’s device return policy, you have 14 days (10 business days) to complete your return. If you still have your device after the return window, this device will lose corporate access and your cost center will be charged.\n\nWe will send a reminder in 3 business days if we haven\'t received your return by then.\n\nI’ll set this ticket to Pending Hardware Return while we wait for delivery.\n\nKind regards,\n\n[Name]', createdAt: new Date().toISOString() },
                    { id: 'guts-4', label: 'Resolution For Lost Device', text: 'Hello [Customer\'s Name],\n\nAfter conducting a search for [Asset Number] - [Device Model], I have concluded that this device is lost and I updated our records to reflect this.\n\nThe following actions were taken to search for this device:\n1:\n2:\n3:\n\nSince no further actions are needed, I will resolve this ticket now. Please feel free to reach out if you have any further questions regarding this request.\n\nKind regards,\n\n[Name]', createdAt: new Date().toISOString() },
                    { id: 'guts-5', label: 'Exit Onsite Collection Information', text: 'Hello [Customer\'s Name],\n\nThank you for confirming that your [Device Model] - [Asset Number] is ready for pickup on [Date].\n\nI will set this ticket to Pending Date of Event until the collection date, and I will update the ticket again when the collection is in progress.\n\nIn the meantime, please let me know if you have any further questions regarding this request.\n\nKind regards,\n\n[Name]', createdAt: new Date().toISOString() },
                    { id: 'guts-6', label: 'Onsite Collection That Was Not Found/Not Ready for Pick Up', text: 'Hello [Customer\'s Name],\n\nI just want to follow up because we visited [Desk Location] and your [Device Model] Asset Number [Asset Number] was not ready for collection.\n\nCan you please confirm a new collection date and the correct pick up location site code?\n\nAs a reminder, you have [Number] business days remaining to complete your return. If you do not complete your return in [Number] business days this request will be closed, and your device will lose corporate access.\n\nIn the meantime, I’ll set this ticket back to Pending Customer Action while we wait for your reply.\n\nKind regards,\n\n[Name]', createdAt: new Date().toISOString() },
                    { id: 'guts-7', label: 'Remote Return Shipment That Has Not Been Received', text: 'Hello [Customer\'s Name],\n\nI just want to follow up because we have not received your return.\n\nAs a reminder, you have 5 business days remaining to complete your return.\n\nIf you do not complete your return in 5 business days this request will be closed, and your device will lose corporate access.\n\nIn the meantime, I’ll set this ticket back to Pending Hardware Return while we wait for your return to be delivered.\n\nKind regards,\n\n[Name]', createdAt: new Date().toISOString() },
                    { id: 'guts-8', label: 'Successful Return', text: 'Hello [Customer\'s Name],\n\nThe following devices have been returned to inventory, so I’ll resolve this ticket now:\n\nAsset Number [Asset Number] - [Device Model]\n\nPlease feel free to reach out if you have any further questions regarding this return.\nKind regards,\n\n[Name]', createdAt: new Date().toISOString() }
                ]
            }
        };
        
        // A placeholder for the user's saved data
        let savedCategories = {};
        
        const mergeData = (defaultData, userData) => {
            const merged = { ...defaultData };
            for (const category in userData) {
                if (merged[category]) {
                    const defaultResponses = merged[category].responses;
                    const userResponses = userData[category].responses;
                    
                    const userResponseMap = new Map(userResponses.map(r => [r.id, r]));
                    
                    for (const defaultResponse of defaultResponses) {
                        if (!userResponseMap.has(defaultResponse.id)) {
                            userResponseMap.set(defaultResponse.id, defaultResponse);
                        }
                    }
                    merged[category].responses = Array.from(userResponseMap.values());
                } else {
                    merged[category] = userData[category];
                }
            }
            return merged;
        };

        const getUserDocRef = (uid) => {
            const docPath = `artifacts/${appId}/users/${uid}/data/canned-responses`;
            return doc(db, docPath);
        };
        
        const getLinksCollectionRef = (uid) => {
            const collectionPath = `artifacts/${appId}/users/${uid}/user_links`;
            return collection(db, collectionPath);
        }

        const saveToFirestore = async () => {
            if (!userId) {
                console.error("User not authenticated.");
                return;
            }
            const userDocRef = getUserDocRef(userId);
            try {
                // Perform a deep copy and cleanup to prevent undefined values
                const cleanedSavedCategories = JSON.parse(JSON.stringify(savedCategories));
                for (const key in cleanedSavedCategories) {
                    if (!cleanedSavedCategories[key].responses) {
                        cleanedSavedCategories[key].responses = [];
                    }
                }
                await setDoc(userDocRef, { categories: cleanedSavedCategories });
            } catch (error) {
                console.error("Error saving to Firestore:", error);
                showMessage("Error saving data.", 'error');
            }
        };

        const renderContent = () => {
            const cannedResponsesApp = document.getElementById('canned-responses-app');
            const fedexTrackerApp = document.getElementById('fedex-tracker-app');
            const helpfulLinksApp = document.getElementById('helpful-links-app');
            const categoryBar = document.getElementById('category-bar');
            const categoryActionsBtn = document.getElementById('category-actions-btn');
            
            const mainTitle = document.getElementById('main-title');
            
            if (cannedResponsesApp) cannedResponsesApp.classList.add('hidden');
            if (fedexTrackerApp) fedexTrackerApp.classList.add('hidden');
            if (helpfulLinksApp) helpfulLinksApp.classList.add('hidden');
            if (categoryBar) categoryBar.classList.add('hidden');
            if (categoryActionsBtn) categoryActionsBtn.classList.add('hidden');
            
            if (currentPage === 'canned-responses') {
                if (cannedResponsesApp) cannedResponsesApp.classList.remove('hidden');
                if (categoryBar) categoryBar.classList.remove('hidden');
                if (mainTitle) mainTitle.textContent = 'Canned Responses';
                if (Object.keys(categories).length > 0) {
                    categoryActionsBtn.classList.remove('hidden');
                }
                renderCategories();
            } else if (currentPage === 'fedex-tracker') {
                if (fedexTrackerApp) fedexTrackerApp.classList.remove('hidden');
                if (mainTitle) mainTitle.textContent = 'FedEx Tracker';
                extractAndDisplayNumbers();
            } else if (currentPage === 'helpful-links') {
                if (helpfulLinksApp) helpfulLinksApp.classList.remove('hidden');
                if (mainTitle) mainTitle.textContent = 'Helpful Links';
                listenForUserLinks();
            }
        };

        const responseInput = document.getElementById('response-input');
        const addBtn = document.getElementById('add-btn');
        const responsesList = document.getElementById('responses-list');
        const emptyState = document.getElementById('empty-state');
        const messageBox = document.getElementById('message-box');
        const labelModal = document.getElementById('label-modal');
        const modalLabelInput = document.getElementById('modal-label-input');
        const saveLabelBtn = document.getElementById('save-label-btn');
        const cancelLabelBtn = document.getElementById('cancel-label-btn');
        const deleteModal = document.getElementById('delete-modal');
        const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
        const deleteCancelBtn = document.getElementById('delete-cancel-btn');
        const categoryList = document.getElementById('category-list');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const addCategoryModal = document.getElementById('add-category-modal');
        const addCategoryInput = document.getElementById('add-category-input');
        const confirmAddCategoryBtn = document.getElementById('confirm-add-category-btn');
        const cancelAddCategoryBtn = document.getElementById('cancel-add-category-btn');
        const addResponseSection = document.getElementById('add-response-section');
        const responsesHeading = document.getElementById('responses-heading');
        
        const importExportBtn = document.getElementById('import-export-btn');
        const importExportModal = document.getElementById('import-export-modal');
        const exportBtn = document.getElementById('export-btn');
        const importFileInput = document.getElementById('import-file-input');
        const closeImportExportModalBtn = document.getElementById('close-import-export-modal-btn');
        
        const searchInput = document.getElementById('search-input');
        const searchBarContainer = document.getElementById('search-bar-container');

        const editCategoryModal = document.getElementById('edit-category-modal');
        const editCategoryInput = document.getElementById('edit-category-input');
        const confirmEditCategoryBtn = document.getElementById('confirm-edit-category-btn');
        const cancelEditCategoryBtn = document.getElementById('cancel-edit-category-btn');
        const deleteCategoryModal = document.getElementById('delete-category-modal');
        const confirmDeleteCategoryBtn = document.getElementById('confirm-delete-category-btn');
        const cancelDeleteCategoryBtn = document.getElementById('cancel-delete-category-btn');

        const colorPickerModal = document.getElementById('color-picker-modal');
        const colorInput = document.getElementById('color-input');
        const closeColorPickerBtn = document.getElementById('close-color-picker-btn');
        const saveColorBtn = document.getElementById('save-color-btn');
        
        const categoryActionsBtn = document.getElementById('category-actions-btn');
        const categoryActionsMenu = document.getElementById('category-actions-menu');
        const renameCategoryBtn = document.getElementById('rename-category-btn');
        const deleteCategoryBtn = document.getElementById('delete-category-btn');
        const changeColorBtn = document.getElementById('change-color-btn');

        const hamburgerMenuBtn = document.getElementById('hamburger-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const navCannedResponses = document.getElementById('nav-canned-responses');
        const navFedexTracker = document.getElementById('nav-fedex-tracker');
        const navHelpfulLinks = document.getElementById('nav-helpful-links');
        const signInBtn = document.getElementById('sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');

        const placeholderModal = document.getElementById('placeholder-modal');
        const placeholderInputsContainer = document.getElementById('placeholder-inputs');
        const confirmPlaceholderBtn = document.getElementById('confirm-placeholder-btn');
        const cancelPlaceholderBtn = document.getElementById('cancel-placeholder-btn');

        const editResponseModal = document.getElementById('edit-response-modal');
        const editResponseLabelInput = document.getElementById('edit-response-label');
        const editResponseTextInput = document.getElementById('edit-response-text');
        const editCategorySelect = document.getElementById('edit-category-select');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeIcon = document.getElementById('theme-icon');

        themeToggleBtn.addEventListener('click', () => {
            if (document.body.classList.contains('light-mode')) {
                document.body.classList.remove('light-mode');
                themeIcon.className = 'fas fa-moon mr-2';
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.add('light-mode');
                themeIcon.className = 'fas fa-sun mr-2';
                localStorage.setItem('theme', 'light');
            }
        });

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
            themeIcon.className = 'fas fa-sun mr-2';
        } else {
            document.body.classList.remove('light-mode');
            themeIcon.className = 'fas fa-moon mr-2';
        }

        const fedexRegex = /(?:78\d{10}|79\d{10}|80\d{10}|81\d{10}|82\d{10}|(?:96\d{20}|96\d{32}|\d{15}|\d{12}))/g;
        const inputTextareaFedex = document.getElementById('input-text-fedex');
        const trackingNumbersContainer = document.getElementById('tracking-numbers-container');
        const copyButtonFedex = document.getElementById('copy-button-fedex');
        const clearButtonFedex = document.getElementById('clear-button-fedex');
        const noNumbersMessage = document.getElementById('no-numbers-message');
        const loadingIndicator = document.getElementById('loading-indicator');

        const linksForm = document.getElementById('add-link-form');
        const linkTitleInput = document.getElementById('link-title');
        const linkUrlInput = document.getElementById('link-url');
        const linksSubmitButton = document.getElementById('submit-button');
        const linksCancelButton = document.getElementById('cancel-button');
        const linksFormTitle = document.getElementById('form-title');
        const linksStatusMessage = document.getElementById('status-message');
        const userLinksList = document.getElementById('user-links-list');
        const linksUserInfo = document.getElementById('links-user-info');
        
        const showMessage = (text, type = 'success') => {
            messageBox.textContent = text;
            messageBox.className = 'message-box show';
            if (type === 'success') {
                messageBox.style.backgroundColor = '#10B981';
            } else if (type === 'error') {
                messageBox.style.backgroundColor = '#EF4444';
            }
            setTimeout(() => {
                messageBox.className = 'message-box';
            }, 3000);
        };
        
        const renderCategories = () => {
            categoryList.innerHTML = '';
            const categoryNames = Object.keys(categories);
            
            if (categoryNames.length > 0) {
                categoryActionsBtn.classList.remove('hidden');
            } else {
                categoryActionsBtn.classList.add('hidden');
                categoryActionsMenu.classList.add('hidden');
            }

            if (categoryNames.length === 0) {
                activeCategory = '';
                addResponseSection.classList.add('hidden');
                searchBarContainer.classList.add('hidden');
                responsesHeading.classList.add('hidden');
                emptyState.classList.remove('hidden');
                responsesList.innerHTML = '';
                return;
            }

            addResponseSection.classList.remove('hidden');
            searchBarContainer.classList.remove('hidden');
            
            categoryNames.forEach(name => {
                const button = document.createElement('button');
                button.className = `category-item font-bold py-2 px-4 rounded-lg shadow-md text-white transition-colors
                    ${name === activeCategory ? 'border-2 border-white' : ''}
                    hover:scale-105 active:scale-95 transition-all duration-300`;
                const categoryColor = categories[name].color || '#60a5fa';
                button.style.backgroundColor = categoryColor;
                button.textContent = name;
                button.dataset.category = name;
                
                categoryList.appendChild(button);
            });
            
            if (!categories[activeCategory]) {
                activeCategory = categoryNames[0];
            }
            renderResponses();
        };

        const renderResponses = (searchQuery = '') => {
            responsesList.innerHTML = '';
            
            let responsesToRender = [];
            let headingText = '';
            const query = searchQuery.toLowerCase();

            if (query) {
                let allResponses = [];
                for (const categoryName in categories) {
                    allResponses = allResponses.concat(categories[categoryName].responses.map(r => ({...r, category: categoryName})));
                }
                
                let labelMatches = [];
                let textMatches = [];

                allResponses.forEach(r => {
                    const labelMatch = r.label && r.label.toLowerCase().includes(query);
                    const textMatch = r.text && r.text.toLowerCase().includes(query);
                    
                    if (labelMatch) {
                        labelMatches.push(r);
                    } else if (textMatch) {
                        textMatches.push(r);
                    }
                });
                
                responsesToRender = [...new Set([...labelMatches, ...textMatches])];
                headingText = 'Search Results';
            } else {
                if (categories[activeCategory]) {
                    responsesToRender = categories[activeCategory].responses.map(r => ({...r, category: activeCategory}));
                    headingText = `Responses in: ${activeCategory}`;
                } else {
                    responsesToRender = [];
                    headingText = 'No Active Category';
                }
            }
            
            document.title = (query ? 'Search Results' : `${activeCategory} - Canned Responses`);
            document.getElementById('main-title').textContent = (query ? 'Search Results' : 'Canned Responses');

            responsesHeading.textContent = headingText;
            responsesHeading.classList.remove('hidden');
            
            if (responsesToRender.length > 0) {
                emptyState.classList.add('hidden');
                const groupedResponses = responsesToRender.reduce((acc, response) => {
                    const label = response.label || 'Unlabeled';
                    if (!acc[label]) {
                        acc[label] = [];
                    }
                    acc[label].push(response);
                    return acc;
                }, {});

                for (const label in groupedResponses) {
                    const labelSection = document.createElement('div');
                    labelSection.className = 'mb-6';
                    let highlightedLabel = label;
                    if(query) {
                        const regex = new RegExp(query, 'gi');
                        highlightedLabel = label.replace(regex, `<span class="highlight">$&</span>`);
                    }

                    labelSection.innerHTML = `
                        <h3 class="text-xl font-bold text-gray-400 mb-2">${highlightedLabel}</h3>
                        <div class="space-y-4"></div>
                    `;
                    const responsesInSection = labelSection.querySelector('div');

                    groupedResponses[label].forEach(response => {
                        let displayText = response.text;
                        if (query) {
                            const regex = new RegExp(query, 'gi');
                            displayText = displayText.replace(regex, `<span class="highlight">$&</span>`);
                        }
                        
                        const responseEl = document.createElement('div');
                        responseEl.className = 'response-item flex flex-col sm:flex-row items-start sm:items-center justify-between bg-gray-700 p-4 rounded-lg border border-gray-600';
                        responseEl.dataset.id = response.id;
                        responseEl.dataset.category = response.category;
                        responseEl.innerHTML = `
                            <div class="flex-grow display-mode space-y-2 w-full">
                                <h4 class="response-label-display text-sm font-semibold text-gray-400">${response.label || 'Unlabeled'}</h4>
                                <p class="response-text-display text-gray-200 whitespace-pre-wrap">${displayText}</p>
                                <div class="flex-shrink-0 flex space-x-2 mt-2 sm:mt-0">
                                    <button class="copy-btn bg-green-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-700 hover:scale-105 hover:shadow-md active:scale-95 transition-all duration-300">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="edit-btn bg-yellow-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-yellow-600 hover:scale-105 hover:shadow-md active:scale-95 transition-all duration-300" data-id="${response.id}">
                                        <i class="fas fa-pencil-alt"></i>
                                    </button>
                                    <button class="delete-btn bg-red-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-700 hover:scale-105 hover:shadow-md active:scale-95 transition-all duration-300">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        responsesInSection.appendChild(responseEl);
                    });
                    responsesList.appendChild(labelSection);
                }
            } else {
                emptyState.classList.add('hidden');
            }
        };

        const addResponse = (text) => {
            if (!text.trim()) {
                showMessage("Please enter a response to save.", 'error');
                return;
            }

            if (!activeCategory || !categories[activeCategory]) {
                showMessage("Please create or select a category first.", 'error');
                return;
            }

            // A more robust check to ensure the responses array exists before pushing.
            if (!categories[activeCategory].responses) {
                categories[activeCategory].responses = [];
            }
            if (!savedCategories[activeCategory]) {
                savedCategories[activeCategory] = { color: categories[activeCategory].color, responses: [] };
            }
            if (!savedCategories[activeCategory].responses) {
                savedCategories[activeCategory].responses = [];
            }

            const newId = Date.now().toString();
            const newResponse = { id: newId, text: text, label: '', createdAt: new Date().toISOString() };
            categories[activeCategory].responses.push(newResponse);
            savedCategories[activeCategory].responses.push(newResponse);
            
            saveToFirestore();
            responseInput.value = '';
            newResponseId = newId;
            labelModal.classList.remove('hidden');
            modalLabelInput.focus();
        };

        const updateResponse = (id, newText, newLabel, newCategory) => {
            const oldCategory = activeCategory;

            if (newCategory && newCategory !== oldCategory) {
                const oldResponsesList = categories[oldCategory]?.responses || [];
                const oldSavedResponsesList = savedCategories[oldCategory]?.responses || [];
                const responseIndex = oldResponsesList.findIndex(r => r.id === id);
                
                if (responseIndex > -1) {
                    const [responseToMove] = oldResponsesList.splice(responseIndex, 1);
                    
                    const savedResponseIndex = oldSavedResponsesList.findIndex(r => r.id === id);
                    if (savedResponseIndex > -1) {
                        oldSavedResponsesList.splice(savedResponseIndex, 1);
                    }
                    
                    responseToMove.text = newText;
                    responseToMove.label = newLabel || '';

                    if (!categories[newCategory]) {
                        categories[newCategory] = { color: '#60a5fa', responses: [] };
                    }
                    if (!savedCategories[newCategory]) {
                        savedCategories[newCategory] = { color: '#60a5fa', responses: [] };
                    }

                    categories[newCategory].responses.push(responseToMove);
                    savedCategories[newCategory].responses.push(responseToMove);
                    
                    activeCategory = newCategory;
                }
            } else {
                const responsesInActiveCategory = categories[activeCategory]?.responses || [];
                const savedResponsesInActiveCategory = savedCategories[activeCategory]?.responses || [];

                const responseIndex = responsesInActiveCategory.findIndex(r => r.id === id);
                const savedResponseIndex = savedResponsesInActiveCategory.findIndex(r => r.id === id);
                
                if (responseIndex > -1) {
                    responsesInActiveCategory[responseIndex].text = newText;
                    responsesInActiveCategory[responseIndex].label = newLabel || '';
                    if (savedResponseIndex > -1) {
                        savedResponsesInActiveCategory[savedResponseIndex].text = newText;
                        savedResponsesInActiveCategory[savedResponseIndex].label = newLabel || '';
                    }
                }
            }
            
            saveToFirestore();
            showMessage("Response updated successfully!");
            renderCategories();
            renderResponses();
        };

        const deleteResponse = (id, categoryName) => {
            if (!categoryName || !categories[categoryName] || !categories[categoryName].responses) return;

            categories[categoryName].responses = categories[categoryName].responses.filter(r => r.id !== id);
            if (savedCategories[categoryName]) {
                savedCategories[categoryName].responses = savedCategories[categoryName].responses.filter(r => r.id !== id);
            }
            saveToFirestore();
            renderResponses();
            showMessage("Response deleted successfully!");
        };

        const copyToClipboard = (text) => {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showMessage("Copied to clipboard!");
        };

        const exportData = () => {
            const dataStr = JSON.stringify(categories, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'canned_responses.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage("Data exported successfully!");
        };

        const importData = (file) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (typeof importedData === 'object' && importedData !== null) {
                        categories = importedData;
                        savedCategories = importedData;
                        const categoryNames = Object.keys(categories);
                        if (categoryNames.length > 0) {
                            activeCategory = categoryNames[0];
                        } else {
                            activeCategory = '';
                        }
                        saveToFirestore();
                        renderCategories();
                        showMessage("Data imported successfully!");
                        importExportModal.classList.add('hidden');
                    } else {
                        throw new Error('Invalid JSON format.');
                    }
                } catch (error) {
                    showMessage(`Error importing file: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        };
        
        const placeholderRegex = /\[([^\]]+)\]/g;
        
        const processAndCopy = (text) => {
            currentTextToCopy = text;
            const matches = text.match(placeholderRegex);
            const placeholders = matches ? [...new Set(matches.map(m => m.slice(1, -1)))] : [];
            
            if (placeholders.length > 0 && !(placeholders.length === 1 && placeholders[0] === 'Name')) {
                placeholderInputsContainer.innerHTML = '';
                const today = new Date().toISOString().split('T')[0];
                placeholders.forEach(placeholder => {
                    if (placeholder !== 'Name') {
                        const inputGroup = document.createElement('div');
                        inputGroup.className = 'flex flex-col';
                        const label = document.createElement('label');
                        label.className = 'block text-sm font-medium text-gray-400 mb-1';
                        label.textContent = placeholder;
                        let input;
                        if (placeholder.toLowerCase().includes('date')) {
                            input = document.createElement('input');
                            input.type = 'date';
                            input.value = today;
                        } else {
                            input = document.createElement('input');
                            input.type = 'text';
                        }
                        input.id = `placeholder-${placeholder.replace(/\s/g, '-')}`;
                        input.className = 'w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg';
                        inputGroup.appendChild(label);
                        inputGroup.appendChild(input);
                        placeholderInputsContainer.appendChild(inputGroup);
                    }
                });
                placeholderModal.classList.remove('hidden');
                document.querySelector('#placeholder-inputs input')?.focus();
            } else {
                const finalContent = replacePlaceholders(currentTextToCopy, {});
                copyToClipboard(finalContent);
            }
        };

        const replacePlaceholders = (text, userValues) => {
            let result = text;
            result = result.replace(/\[Name\]/g, userName);
            for (const key in userValues) {
                const regex = new RegExp(`\\[${key}\\]`, 'g');
                result = result.replace(regex, userValues[key]);
            }
            return result;
        };
        
        // --- Event Listeners ---
        hamburgerMenuBtn.addEventListener('click', () => {
            sidebar.classList.add('open');
        });

        closeSidebarBtn.addEventListener('click', () => {
            sidebar.classList.remove('open');
        });

        navCannedResponses.addEventListener('click', () => {
            currentPage = 'canned-responses';
            renderContent();
            sidebar.classList.remove('open');
        });

        navFedexTracker.addEventListener('click', () => {
            currentPage = 'fedex-tracker';
            renderContent();
            sidebar.classList.remove('open');
        });
        
        navHelpfulLinks.addEventListener('click', () => {
            currentPage = 'helpful-links';
            renderContent();
            sidebar.classList.remove('open');
        });

        signInBtn.addEventListener('click', async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                showMessage("Signed in with Google!");
            } catch (error) {
                console.error("Google sign-in failed", error);
                showMessage("Google sign-in failed. Please try again.", 'error');
            }
        });

        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessage("Signed out successfully!");
            } catch (error) {
                console.error("Sign out failed", error);
                showMessage("Sign out failed. Please try again.", 'error');
            }
        });

        importExportBtn.addEventListener('click', () => {
            importExportModal.classList.remove('hidden');
        });
        closeImportExportModalBtn.addEventListener('click', () => {
            importExportModal.classList.add('hidden');
        });
        exportBtn.addEventListener('click', exportData);
        importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                importData(file);
            }
        });

        addCategoryBtn.addEventListener('click', () => {
            addCategoryModal.classList.remove('hidden');
            addCategoryInput.focus();
        });

        confirmAddCategoryBtn.addEventListener('click', () => {
            const categoryName = addCategoryInput.value.trim();
            if (!categoryName) {
                showMessage("Please enter a category name.", 'error');
                return;
            }
            if (categories[categoryName]) {
                showMessage("A category with this name already exists.", 'error');
                return;
            }
            
            categories[categoryName] = { color: '#60a5fa', responses: [] };
            savedCategories[categoryName] = { color: '#60a5fa', responses: [] };
            activeCategory = categoryName;
            addCategoryModal.classList.add('hidden');
            saveToFirestore();
            renderCategories();
            showMessage(`Category '${categoryName}' created successfully!`);
        });

        cancelAddCategoryBtn.addEventListener('click', () => {
            addCategoryInput.value = '';
            addCategoryModal.classList.add('hidden');
        });
        
        // Handle clicking on category buttons to set the active category
        categoryList.addEventListener('click', (event) => {
            const target = event.target;
            const itemBtn = target.closest('.category-item');
            if (itemBtn) {
                const categoryName = itemBtn.dataset.category;
                if (categoryName !== activeCategory) {
                    activeCategory = categoryName;
                    categoryActionsBtn.classList.remove('hidden');
                    categoryActionsMenu.classList.add('hidden');
                    renderCategories();
                    renderResponses();
                }
            }
        });
        
        // Handle the new single "Category Actions" button
        categoryActionsBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            categoryActionsMenu.classList.toggle('hidden');
            categoryActionsBtn.classList.toggle('active');
            
            if (!categoryActionsMenu.classList.contains('hidden')) {
                categoryActionsMenu.classList.remove('scale-95', 'opacity-0');
                categoryActionsMenu.classList.add('scale-100', 'opacity-100');
            } else {
                categoryActionsMenu.classList.add('scale-95', 'opacity-0');
                categoryActionsMenu.classList.remove('scale-100', 'opacity-100');
            }
        });

        // Handle the actions from the new central menu
        renameCategoryBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            categoryToEdit = activeCategory;
            if (!activeCategory || !categories[activeCategory]) {
                showMessage("Please select a valid category to rename.", 'error');
                categoryActionsMenu.classList.add('hidden');
                categoryActionsBtn.classList.remove('active');
                return;
            }
            editCategoryInput.value = categoryToEdit;
            editCategoryModal.classList.remove('hidden');
            categoryActionsMenu.classList.add('hidden');
            categoryActionsBtn.classList.remove('active');
        });
        
        deleteCategoryBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            categoryToEdit = activeCategory;
            if (!activeCategory || !categories[activeCategory]) {
                showMessage("Please select a valid category to delete.", 'error');
                categoryActionsMenu.classList.add('hidden');
                categoryActionsBtn.classList.remove('active');
                return;
            }
            deleteCategoryModal.classList.remove('hidden');
            categoryActionsMenu.classList.add('hidden');
            categoryActionsBtn.classList.remove('active');
        });
        
        changeColorBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            categoryToEdit = activeCategory;
            if (!activeCategory || !categories[activeCategory]) {
              showMessage("Please select a valid category to change color.", 'error');
              categoryActionsMenu.classList.add('hidden');
              categoryActionsBtn.classList.remove('active');
              return;
            }
            if (categories[categoryToEdit]) {
              const currentColor = categories[categoryToEdit].color || '#60a5fa';
              colorInput.value = currentColor;
            }
            colorPickerModal.classList.remove('hidden');
            categoryActionsMenu.classList.add('hidden');
            categoryActionsBtn.classList.remove('active');
        });
        

        // Universal click handler to close menus when clicking outside
        document.addEventListener('click', (event) => {
            const isClickInsideCategoryActions = event.target.closest('#category-actions-menu') || event.target.closest('#category-actions-btn');
            if (!isClickInsideCategoryActions) {
                categoryActionsMenu.classList.add('hidden', 'scale-95', 'opacity-0');
                categoryActionsBtn.classList.remove('active');
            }
            
            const isClickInsideLinkMenu = event.target.closest('.meatballs-menu') || event.target.closest('.meatballs-button');
            if (!isClickInsideLinkMenu) {
                const allLinkMenus = document.querySelectorAll('.meatballs-menu');
                allLinkMenus.forEach(m => m.classList.add('hidden'));
            }
        });


        confirmEditCategoryBtn.addEventListener('click', () => {
            const newName = editCategoryInput.value.trim();
            if (!newName) {
                showMessage("Category name cannot be empty.", 'error');
                return;
            }
            if (categories[newName] && newName !== categoryToEdit) {
                showMessage("A category with this name already exists.", 'error');
                return;
            }
            
            if (newName !== categoryToEdit) {
                if (categories[categoryToEdit]) { // Check if old category still exists
                    categories[newName] = categories[categoryToEdit];
                    savedCategories[newName] = savedCategories[categoryToEdit];
                    delete categories[categoryToEdit];
                    delete savedCategories[categoryToEdit];
                    if (activeCategory === categoryToEdit) {
                        activeCategory = newName;
                    }
                }
            }

            categoryToEdit = null;
            saveToFirestore();
            editCategoryModal.classList.add('hidden');
            renderCategories();
            showMessage("Category renamed successfully!");
        });

        cancelEditCategoryBtn.addEventListener('click', () => {
            categoryToEdit = null;
            editCategoryModal.classList.add('hidden');
        });

        confirmDeleteCategoryBtn.addEventListener('click', () => {
            if (categoryToEdit && categories[categoryToEdit]) {
                delete categories[categoryToEdit];
                delete savedCategories[categoryToEdit];
                if (activeCategory === categoryToEdit) {
                    const categoryNames = Object.keys(categories);
                    activeCategory = categoryNames.length > 0 ? categoryNames[0] : '';
                }
                categoryToEdit = null;
                saveToFirestore();
                deleteCategoryModal.classList.add('hidden');
                renderCategories();
                showMessage("Category deleted successfully!");
            } else {
                 showMessage("Error: The category no longer exists.", 'error');
                 deleteCategoryModal.classList.add('hidden');
            }
        });

        cancelDeleteCategoryBtn.addEventListener('click', () => {
            categoryToEdit = null;
            deleteCategoryModal.classList.add('hidden');
        });

        saveColorBtn.addEventListener('click', () => {
            const newColor = colorInput.value;
            if (categoryToEdit && categories[categoryToEdit]) {
                categories[categoryToEdit].color = newColor;
                if (savedCategories[categoryToEdit]) {
                    savedCategories[categoryToEdit].color = newColor;
                }
                saveToFirestore();
                renderCategories();
                showMessage(`Color for '${categoryToEdit}' changed successfully!`);
            } else {
                showMessage("Error: No valid category selected to change color.", 'error');
            }
            colorPickerModal.classList.add('hidden');
            categoryToEdit = null;
        });

        closeColorPickerBtn.addEventListener('click', () => {
            colorPickerModal.classList.add('hidden');
            categoryToEdit = null;
        });

        addBtn.addEventListener('click', () => {
            addResponse(responseInput.value);
        });

        responsesList.addEventListener('click', (event) => {
            const target = event.target;
            const parentEl = target.closest('.response-item');
            if (!parentEl) return;
            const id = parentEl.dataset.id;
            const categoryName = parentEl.dataset.category;
            
            if (target.closest('.copy-btn')) {
                if (!categoryName || !categories[categoryName] || !categories[categoryName].responses) {
                    showMessage("Error: No active category found.", 'error');
                    return;
                }
                const responses = categories[categoryName].responses;
                const text = responses.find(r => r.id === id).text;
                processAndCopy(text);
            } else if (target.closest('.edit-btn')) {
                if (!categoryName || !categories[categoryName] || !categories[categoryName].responses) {
                    showMessage("Error: No active category found.", 'error');
                    return;
                }
                const responseToEdit = categories[categoryName].responses.find(r => r.id === id);
                if (responseToEdit) {
                    currentEditingId = id;
                    editResponseLabelInput.value = responseToEdit.label || '';
                    editResponseTextInput.value = responseToEdit.text;

                    const categoryOptions = Object.keys(categories).map(cat => `<option value="${cat}" ${cat === categoryName ? 'selected' : ''}>${cat}</option>`).join('');
                    editCategorySelect.innerHTML = categoryOptions;

                    editResponseModal.classList.remove('hidden');
                }
            } else if (target.closest('.delete-btn')) {
                responseToDeleteId = id;
                deleteModal.classList.remove('hidden');
            }
        });

        saveEditBtn.addEventListener('click', () => {
            const newText = editResponseTextInput.value;
            const newLabel = editResponseLabelInput.value;
            const newCategory = editCategorySelect.value;
            const oldCategory = activeCategory;
            
            // Re-fetch the response since activeCategory might have changed
            let responseToUpdate = null;
            if (categories[oldCategory] && categories[oldCategory].responses) {
                responseToUpdate = categories[oldCategory].responses.find(r => r.id === currentEditingId);
            }
            if (!responseToUpdate) {
                showMessage("Error: The response no longer exists in its original category.", 'error');
                editResponseModal.classList.add('hidden');
                currentEditingId = null;
                return;
            }

            if (newCategory && newCategory !== oldCategory) {
                // Move the response to a new category
                const oldResponsesList = categories[oldCategory].responses;
                const index = oldResponsesList.indexOf(responseToUpdate);
                if (index > -1) {
                    oldResponsesList.splice(index, 1);
                }
                
                if (!categories[newCategory]) {
                    categories[newCategory] = { color: '#60a5fa', responses: [] };
                }
                responseToUpdate.text = newText;
                responseToUpdate.label = newLabel || '';
                categories[newCategory].responses.push(responseToUpdate);

                // Update saved categories
                const oldSavedResponsesList = savedCategories[oldCategory]?.responses || [];
                const savedIndex = oldSavedResponsesList.indexOf(responseToUpdate);
                if (savedIndex > -1) {
                    oldSavedResponsesList.splice(savedIndex, 1);
                }
                if (!savedCategories[newCategory]) {
                    savedCategories[newCategory] = { color: '#60a5fa', responses: [] };
                }
                savedCategories[newCategory].responses.push(responseToUpdate);
                activeCategory = newCategory;

            } else {
                // Update the response within the same category
                responseToUpdate.text = newText;
                responseToUpdate.label = newLabel || '';
            }

            saveToFirestore();
            showMessage("Response updated successfully!");
            editResponseModal.classList.add('hidden');
            currentEditingId = null;
            renderCategories();
            renderResponses();
        });

        cancelEditBtn.addEventListener('click', () => {
            editResponseModal.classList.add('hidden');
            currentEditingId = null;
        });

        confirmPlaceholderBtn.addEventListener('click', () => {
            const inputs = placeholderInputsContainer.querySelectorAll('input');
            const userValues = {};
            inputs.forEach(input => {
                const placeholder = input.id.replace('placeholder-', '').replace(/-/g, ' ');
                if (input.type === 'date') {
                    const [year, month, day] = input.value.split('-');
                    const date = new Date(year, month - 1, day);
                    userValues[placeholder] = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                } else {
                    userValues[placeholder] = input.value.trim() || `[${placeholder}]`;
                }
            });
            const finalContent = replacePlaceholders(currentTextToCopy, userValues);
            copyToClipboard(finalContent);
            placeholderModal.classList.add('hidden');
        });

        cancelPlaceholderBtn.addEventListener('click', () => {
            placeholderModal.classList.add('hidden');
            showMessage("Copy cancelled.", 'error');
        });

        searchInput.addEventListener('input', (e) => {
            renderResponses(e.target.value);
        });

        saveLabelBtn.addEventListener('click', () => {
            if (newResponseId) {
                if (!categories[activeCategory] || !categories[activeCategory].responses) {
                    showMessage("Error: No active category found.", 'error');
                    labelModal.classList.add('hidden');
                    return;
                }
                const responses = categories[activeCategory].responses;
                const responseIndex = responses.findIndex(r => r.id === newResponseId);
                if (responseIndex > -1) {
                    responses[responseIndex].label = modalLabelInput.value || '';
                    if (savedCategories[activeCategory]) {
                        const savedResponseIndex = savedCategories[activeCategory].responses.findIndex(r => r.id === newResponseId);
                        if (savedResponseIndex > -1) {
                            savedCategories[activeCategory].responses[savedResponseIndex].label = modalLabelInput.value || '';
                        }
                    }
                    saveToFirestore();
                }
                newResponseId = null;
                modalLabelInput.value = '';
                labelModal.classList.add('hidden');
                renderResponses();
            }
        });

        cancelLabelBtn.addEventListener('click', () => {
            if (newResponseId) {
                deleteResponse(newResponseId, activeCategory);
                newResponseId = null;
            }
            modalLabelInput.value = '';
            labelModal.classList.add('hidden');
        });

        deleteConfirmBtn.addEventListener('click', () => {
            if (responseToDeleteId) {
                const parentEl = document.querySelector(`.response-item[data-id="${responseToDeleteId}"]`);
                const categoryName = parentEl ? parentEl.dataset.category : null;
                deleteResponse(responseToDeleteId, categoryName);
                responseToDeleteId = null;
                deleteModal.classList.add('hidden');
            }
        });

        deleteCancelBtn.addEventListener('click', () => {
            responseToDeleteId = null;
            deleteModal.classList.add('hidden');
        });

        const extractAndDisplayNumbers = () => {
            loadingIndicator.classList.remove('hidden');
            noNumbersMessage.classList.add('hidden');
            trackingNumbersContainer.innerHTML = '';
            
            setTimeout(() => {
                const text = inputTextareaFedex.value;
                const matches = text.match(fedexRegex);

                loadingIndicator.classList.add('hidden');

                if (matches && matches.length > 0) {
                    const uniqueNumbers = [...new Set(matches)];

                    uniqueNumbers.forEach(number => {
                        const trackingNumberLink = document.createElement('a');
                        trackingNumberLink.href = `https://www.fedex.com/fedextrack/?tracknumbers=${number}`;
                        trackingNumberLink.target = "_blank";
                        trackingNumberLink.classList.add(
                            'tracking-tab', 'flex', 'items-center', 'justify-between', 'p-3', 'rounded-lg',
                            'border', 'border-gray-600', 'shadow-sm', 'mb-2',
                            'hover:scale-105', 'hover:shadow-md', 'transition-all', 'duration-300', 'animate-fade-in'
                        );

                        const numberText = document.createElement('span');
                        numberText.textContent = number;
                        numberText.classList.add('font-mono', 'text-sm', 'md:text-base', 'text-gray-200');

                        const copyBtn = document.createElement('button');
                        copyBtn.classList.add(
                            'ml-4', 'p-2', 'rounded-full', 'hover:bg-gray-700', 'transition-colors',
                            'duration-200', 'text-gray-400'
                        );
                        copyBtn.title = "Copy to clipboard";
                        copyBtn.innerHTML = `<svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2H6z" /></svg>`;
                        copyBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            const tempInput = document.createElement('input');
                            tempInput.value = number;
                            document.body.appendChild(tempInput);
                            tempInput.select();
                            document.execCommand('copy');
                            document.body.removeChild(tempInput);
                            showMessage('Tracking number copied!');
                        });

                        trackingNumberLink.appendChild(numberText);
                        trackingNumberLink.appendChild(copyBtn);
                        trackingNumbersContainer.appendChild(trackingNumberLink);
                    });

                    copyButtonFedex.disabled = false;
                } else {
                    noNumbersMessage.classList.remove('hidden');
                    trackingNumbersContainer.appendChild(noNumbersMessage);
                    copyButtonFedex.disabled = true;
                }

                if (text.length > 0) {
                    clearButtonFedex.disabled = false;
                } else {
                    clearButtonFedex.disabled = true;
                }
            }, 300);
        };

        inputTextareaFedex.addEventListener('input', extractAndDisplayNumbers);
        clearButtonFedex.addEventListener('click', () => {
            inputTextareaFedex.value = '';
            extractAndDisplayNumbers();
            showMessage('Text area cleared!');
        });

        copyButtonFedex.addEventListener('click', () => {
            const trackingNumberElements = trackingNumbersContainer.querySelectorAll('span');
            let allNumbersText = '';
            trackingNumberElements.forEach(el => {
                allNumbersText += el.textContent + '\n';
            });

            if (allNumbersText.trim().length > 0) {
                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = allNumbersText.trim();
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextarea);

                window.open('https://www.fedex.com/en-us/tracking.html', '_blank');

                showMessage('Tracking numbers copied to clipboard. Paste them on the FedEx page to track.');
            }
        });

        // Helpful Links Functions
        function showLinksStatus(message, color = 'text-gray-400') {
            linksStatusMessage.textContent = message;
            linksStatusMessage.className = `text-center mt-2 text-sm ${color}`;
        }
        
        async function deleteLink(docId) {
            if (!db || !userId) {
                showLinksStatus('Authentication in progress, please wait.', 'text-yellow-400');
                return;
            }
            try {
                showLinksStatus('Removing link...', 'text-yellow-400');
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'user_links', docId);
                await deleteDoc(docRef);
                showLinksStatus('Link removed successfully!', 'text-green-400');
            } catch (error) {
                console.error("Error removing document:", error);
                showLinksStatus(`Failed to remove link: ${error.message}`, 'text-red-400');
            }
        }

        function editLink(docId, title, url) {
            editingLinkDocId = docId;
            linkTitleInput.value = title;
            linkUrlInput.value = url;
            linksSubmitButton.textContent = 'Update Link';
            linksFormTitle.textContent = 'Edit Link';
            linksCancelButton.classList.remove('hidden');
        }

        function resetLinksForm() {
            editingLinkDocId = null;
            linkTitleInput.value = '';
            linkUrlInput.value = '';
            linksSubmitButton.textContent = 'Add Link';
            linksFormTitle.textContent = 'Add a New Link';
            linksCancelButton.classList.add('hidden');
            showLinksStatus('');
        }
        
        function listenForUserLinks() {
            if (!db || !userId) {
                console.error("Firestore or User ID not available.");
                return;
            }

            const linksCollectionRef = getLinksCollectionRef(userId);
            const q = query(linksCollectionRef);

            onSnapshot(q, (querySnapshot) => {
                userLinksList.innerHTML = '';
                if (querySnapshot.empty) {
                    userLinksList.innerHTML = '<p class="text-center text-gray-400 col-span-full">No links added yet. Add one above!</p>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const linkData = doc.data();
                        const card = document.createElement('div');
                        
                        // Sanitize data for HTML attributes to prevent XSS
                        const titleForHtml = linkData.title.replace(/'/g, "\\'");
                        const urlForHtml = linkData.url.replace(/'/g, "\\'");
                        
                        card.className = 'link-card rounded-xl p-6 shadow-2xl flex items-center justify-between relative';
                        card.innerHTML = `
                            <a href="${linkData.url}" target="_blank" rel="noopener noreferrer" class="flex-grow">
                                <h3 class="font-bold text-xl text-white hover:text-sky-300 transition-colors mb-2">${linkData.title}</h3>
                                <p class="text-sm text-gray-400">${linkData.url}</p>
                            </a>
                            <div class="relative inline-block text-left" data-doc-id="${doc.id}" data-title="${titleForHtml}" data-url="${urlForHtml}">
                                <button type="button" class="meatballs-button p-2 text-gray-400 hover:text-white transition-colors" aria-expanded="true" aria-haspopup="true">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 pointer-events-none">
                                      <path d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM11.5 15a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z" />
                                    </svg>
                                </button>
                                <div class="meatballs-menu hidden absolute right-0 mt-2 w-48 origin-top-right rounded-md bg-gray-700 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-10">
                                    <div class="py-1">
                                        <button class="edit-link-btn text-gray-200 block w-full text-left px-4 py-2 text-sm hover:bg-gray-600">Edit</button>
                                        <button class="delete-link-btn text-red-400 block w-full text-left px-4 py-2 text-sm hover:bg-gray-600">Delete</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        userLinksList.appendChild(card);
                    });
                }
            }, (error) => {
                console.error("Error listening for documents:", error);
                showLinksStatus('Failed to load links. Please try again.', 'text-red-400');
            });
        }
        
        linksForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !userId) {
                showLinksStatus('Authentication in progress, please wait.', 'text-yellow-400');
                return;
            }

            const title = linkTitleInput.value;
            const url = linkUrlInput.value;

            if (!title || !url) {
                showLinksStatus('Please fill out both fields.', 'text-red-400');
                return;
            }

            try {
                if (editingLinkDocId) {
                    showLinksStatus('Updating link...', 'text-yellow-400');
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'user_links', editingLinkDocId);
                    await updateDoc(docRef, {
                        title: title,
                        url: url,
                    });
                    showLinksStatus('Link updated successfully!', 'text-green-400');
                } else {
                    showLinksStatus('Adding link...', 'text-yellow-400');
                    const linksCollectionRef = getLinksCollectionRef(userId);
                    await addDoc(linksCollectionRef, {
                        title: title,
                        url: url,
                        createdAt: new Date()
                    });
                    showLinksStatus('Link added successfully!', 'text-green-400');
                }
                resetLinksForm();

            } catch (error) {
                console.error("Error during link operation:", error);
                showLinksStatus(`Failed to save link: ${error.message}`, 'text-red-400');
            }
        });

        linksCancelButton.addEventListener('click', () => {
            resetLinksForm();
        });

        userLinksList.addEventListener('click', (event) => {
            const button = event.target.closest('.meatballs-button');
            const editBtn = event.target.closest('.edit-link-btn');
            const deleteBtn = event.target.closest('.delete-link-btn');

            if (button) {
                event.stopPropagation();
                const parentDiv = button.closest('[data-doc-id]');
                const menu = parentDiv.querySelector('.meatballs-menu');
                if (menu) {
                    const isHidden = menu.classList.contains('hidden');
                    // Close all other menus before opening the clicked one
                    const allMenus = document.querySelectorAll('.meatballs-menu');
                    allMenus.forEach(m => m.classList.add('hidden'));

                    if (isHidden) {
                        menu.classList.remove('hidden');
                        openMenuId = parentDiv.dataset.docId;
                    } else {
                        openMenuId = null;
                    }
                }
            } else if (editBtn) {
                event.stopPropagation();
                const parentDiv = editBtn.closest('[data-doc-id]');
                if (parentDiv) {
                    const docId = parentDiv.dataset.docId;
                    const title = parentDiv.dataset.title;
                    const url = parentDiv.dataset.url;
                    editLink(docId, title, url);
                    const menu = parentDiv.querySelector('.meatballs-menu');
                    if (menu) menu.classList.add('hidden');
                    openMenuId = null;
                }
            } else if (deleteBtn) {
                event.stopPropagation();
                const parentDiv = deleteBtn.closest('[data-doc-id]');
                if (parentDiv) {
                    const docId = parentDiv.dataset.docId;
                    deleteLink(docId);
                    const menu = parentDiv.querySelector('.meatballs-menu');
                    if (menu) menu.classList.add('hidden');
                    openMenuId = null;
                }
            }
        });

        // Universal click handler to close menus when clicking outside
        document.addEventListener('click', (event) => {
            const isClickInsideCategoryActions = event.target.closest('#category-actions-menu') || event.target.closest('#category-actions-btn');
            if (!isClickInsideCategoryActions) {
                categoryActionsMenu.classList.add('hidden', 'scale-95', 'opacity-0');
                categoryActionsBtn.classList.remove('active');
            }
            
            const isClickInsideLinkMenu = event.target.closest('.meatballs-menu') || event.target.closest('.meatballs-button');
            if (!isClickInsideLinkMenu) {
                const allLinkMenus = document.querySelectorAll('.meatballs-menu');
                allLinkMenus.forEach(m => m.classList.add('hidden'));
            }
        });
        
        // Initial render
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                const displayName = user.displayName || user.email || 'User';
                const firstName = displayName.split(' ')[0].split('@')[0];
                userName = firstName;
                document.getElementById('auth-status').textContent = `Signed in as: ${displayName}`;
                document.getElementById('auth-status').title = user.email;
                if (user.isAnonymous) {
                    signInBtn.classList.remove('hidden');
                    signOutBtn.classList.add('hidden');
                } else {
                    signInBtn.classList.add('hidden');
                    signOutBtn.classList.remove('hidden');
                }
                const userDocRef = getUserDocRef(userId);
                
                onSnapshot(userDocRef, (doc) => {
                    if (doc.exists()) {
                        savedCategories = doc.data().categories || {};
                        categories = mergeData(defaultCannedResponses, savedCategories);
                    } else {
                        savedCategories = {};
                        categories = defaultCannedResponses;
                        saveToFirestore();
                    }
                    if (Object.keys(categories).length > 0) {
                        activeCategory = Object.keys(categories)[0];
                    }
                    renderContent();
                });
                
                listenForUserLinks();
            } else {
                try {
                     await signInAnonymously(auth);
                } catch (error) {
                    console.error("Authentication failed", error);
                }
                signInBtn.classList.remove('hidden');
                signOutBtn.classList.add('hidden');
            }
        });
        
    </script>
</body>
</html>
```
