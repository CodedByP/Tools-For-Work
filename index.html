<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tools For Work</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Alexandria:wght@400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;600&display=swap');
        
        /* Base Dark Mode Styles */
        body {
            font-family: 'Alexandria', sans-serif;
            background-color: #111827;
            color: #e5e7eb;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        h1, h2 {
            font-family: 'Poppins', sans-serif;
        }
        .container-bg {
            background-color: #0d1117;
            background-image: radial-gradient(at 0% 0%, hsla(215,90%,55%,0.15) 0, transparent 50%),
                                 radial-gradient(at 100% 100%, hsla(280,90%,70%,0.15) 0, transparent 50%);
        }
        .link-card, .card-style, .form-container, .floating-card, .main-card, .sidebar, .modal-content {
            background-color: rgba(22, 27, 34, 0.8);
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
        }
        .link-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .link-title {
            background-image: linear-gradient(to right, #80e8ff, #62b3ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .pulse-effect:hover {
            animation: pulse-border 1s infinite;
        }
        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(100, 160, 255, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(100, 160, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(100, 160, 255, 0);
            }
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1-px rgba(0, 0, 0, 0.1), 0 2px 4px -1-px rgba(0, 0, 0, 0.06);
            color: white;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .message-box.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
/* Update the main modal container to be a full-screen overlay */
/* Refined modal container for full-screen overlay */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.25);
    z-index: 1001;
    display: flex; /* We want it to be a flex container when it's visible */
    justify-content: center;
    align-items: center;
}

/* This rule ensures that adding the 'hidden' class hides the modal completely */
.modal.hidden {
    display: none;
}

/* Base modal content styling, without positioning */
.modal-content {
    background-color: #1f2937;
    color: #e5e7eb;
    padding: 2.5rem;
    border-radius: 1rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
    width: 90%;
    max-width: 450px;
    position: absolute;
    transition: all 0.5s ease-in-out;
}

/* Tutorial Pop-up specific positioning */
#tutorial-modal .modal-content {
    opacity: 0;
    transform: scale(0.95);
}

#tutorial-modal.show-modal .modal-content {
    opacity: 1;
    transform: scale(1);
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

#tutorial-modal.top-right .modal-content {
    /* Refactored to use top and left for positioning and a transform for a smooth animation */
    opacity: 1;
    top: 200px;
    left: calc(100% - 400px - 800px); /* Adjusting left to match your right: 800px value */
    transform: translate(0, 0) scale(1);
    max-width: 400px;
}
		
#tutorial-modal.top-left .modal-content {
    /* Refactored to use top and left for positioning and a transform for a smooth animation */
    opacity: 1;
    top: 100px;
    left: calc(60% - 400px - 800px); /* Adjusting left to match your right: 800px value */
    transform: translate(0, 0) scale(1);
    max-width: 400px;
}		

#tutorial-modal.bottom-left .modal-content {
    /* Refactored to use top and left for positioning and a transform for a smooth animation */
    opacity: 1;
    top: calc(100% - 380px - 400px); /* Adjusting top to match your bottom: 380px value */
    left: 40%;
    transform: translate(0, 0) scale(1);
    max-width: 400px;
}

#tutorial-modal.on-response .modal-content {
    /* Refactored to use top and left for positioning and a transform for a smooth animation */
    opacity: 1;
    top: calc(100% - 300px - 400px); /* Adjusting top to match your bottom: 380px value */
    left: 48.2%;
    transform: translate(0, 0) scale(1);
    max-width: 400px;
}

#tutorial-modal.on-tracker-page .modal-content {
    opacity: 1;
    top: 25%;
    right: 10%;
    transform: translate(0, 0) scale(1);
    max-width: 400px;
}		
		
#tutorial-modal.upper-right .modal-content {
    /* Refactored to use top and left for positioning and a transform for a smooth animation */
    opacity: 1;
    top: calc(85% - 400px - 400px); /* Adjusting top to match your bottom: 380px value */
    left: 60%;
    transform: translate(0, 0) scale(1);
    max-width: 400px;
}
 #tutorial-modal.left-response .modal-content {
    /* Refactored to use top and left for positioning and a transform for a smooth animation */
    opacity: 1;
    top: calc(85% - 300px - 400px); /* Adjusting top to match your bottom: 380px value */
    left: 15%;
    transform: translate(0, 0) scale(1);
    max-width: 500px;
}		 	


        /* Add these rules to ensure proper z-indexing for highlighting */
#add-response-section,
#category-bar {
    position: relative;
}


@keyframes pulse-highlight {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(100, 160, 255, 0.4); }
    50% { transform: scale(1.01); box-shadow: 0 0 0 10px rgba(100, 160, 255, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(100, 160, 255, 0.4); }
}
		
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background-color: #1f2937;
            padding: 2.5rem 1.5rem;
            box-shadow: 4px 0 15px rgba(0,0,0,0.5);
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2000;
        }
        .sidebar.open {
            left: 0;
        }
        .pb-extra {
            padding-bottom: 2rem;
        }
        .scrollable-box {
            max-height: 250px;
            overflow-y: auto;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            background-color: #1f2937;
            box-shadow: 0 10px 15px -3-px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.5);
        }
        .tracking-numbers-container {
            background-color: #111827;
            border-color: #4a5568;
        }
        .tracking-tab {
            background-color: #2d3748;
            border-color: #4a5568;
        }
        .text-placeholder::placeholder {
            color: #a0aec0;
        }
        .main-card {
            background-color: rgba(22, 27, 34, 0.8);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            padding: 2rem;
            transition: all 0.3s ease;
        }
        .main-card:hover {
            transform: translateY(-5px);
        }
        .floating-card {
            background-color: rgba(22, 27, 34, 0.8);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .highlight {
            background-color: rgba(255, 255, 0, 0.3);
            color: #000;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .highlight-placeholder {
            color: #80e8ff; /* A color that stands out from the prose */
            font-weight: 700;
            background-color: rgba(128, 232, 255, 0.1);
            padding: 2px 4px;
            border-radius: 4px;
        }

        .highlight-target {
            position: relative; /* This is crucial for z-index to work */
            z-index: 1000;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            border-radius: 1rem; /* Adjust this to match your modal's border radius */
            animation: pulse-highlight 1.5s infinite;

            /* ADD THIS LINE to give the element a permanent, bright glow */
            border: 3px solid white; /* Adds a solid, white border for more visibility */
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.8)); /* Adds a soft glow effect */		
        }

		/* Light Mode Highlighting Effect */
body.light-mode .highlight-target {
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.2);
    border: 3px solid #1f2937;
    filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.8));
    animation: pulse-highlight-light 1.5s infinite;
}

@keyframes pulse-highlight-light {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(100, 160, 255, 0.4); }
    50% { transform: scale(1.01); box-shadow: 0 0 0 10px rgba(100, 160, 255, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(100, 160, 255, 0.4); }
}

        /* Light Mode Styles */
        body.light-mode {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .light-mode .container-bg {
            background-color: #f9fafb;
            background-image: radial-gradient(at 0% 0%, hsla(215,90%,55%,0.15) 0, transparent 50%),
                                 radial-gradient(at 100% 100%, hsla(280,90%,70%,0.15) 0, transparent 50%);
        }
        .light-mode .link-card, .light-mode .card-style, .light-mode .form-container, .light-mode .floating-card, .light-mode .main-card, .light-mode .sidebar, .light-mode .modal-content {
            background-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .light-mode .link-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .light-mode h1, .light-mode h2, .light-mode h3 {
            color: #1f2937;
        }
        .light-mode .link-title {
            background-image: none;
            -webkit-background-clip: unset;
            -webkit-text-fill-color: inherit;
            color: #1f2937;
        }
        .light-mode .text-placeholder::placeholder {
            color: #6b7280;
        }
        .light-mode #auth-status, .light-mode .text-gray-400 {
            color: #4b5563;
        }
        .light-mode .bg-gray-800 { background-color: #e5e7eb; }
        .light-mode .bg-gray-700 { background-color: #d1d5db; }
        .light-mode .bg-gray-600 { background-color: #9ca3af; }
        .light-mode .text-gray-100 { color: #1f2937; }
        .light-mode .text-gray-200 { color: #374151; }
        .light-mode .border-gray-600 { border-color: #9ca3af; }
        .light-mode .hover\:bg-gray-700:hover { background-color: #d1d5db; }
        .light-mode .hover\:text-white:hover { color: #1f2937; }
        .light-mode .tracking-numbers-container { background-color: #f3f4f6; }
        .light-mode .tracking-tab { background-color: #e5e7eb; }
		
        .kebab-button.active svg {
            transform: rotate(90deg);
            transition: transform 0.2s ease-in-out;
        }

        .kebab-button svg {
            transition: transform 0.2s ease-in-out;
        }

        /* Login Modal and Popup Styles */
        #login-popup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        #login-popup-modal.show {
            display: flex;
        }

        .login-popup {
            background-color: #1f2937;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            padding: 1.5rem;
            width: 90%;
            max-width: 350px;
            animation: fadeInModal 0.3s ease-in-out;
            z-index: 3001;
        }

        .light-mode .login-popup {
            background-color: rgba(255, 255, 255, 0.9);
            color: #111827;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        @keyframes fadeInModal {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

		/* Light Mode Styles for Tutorial Modal */
body.light-mode #tutorial-modal .modal-content {
    background-color: rgba(243, 244, 246, 0.9); /* Lighter background */
    color: #111827; /* Dark text */
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

body.light-mode #tutorial-modal h3,
body.light-mode #tutorial-modal h4 {
    color: #3b82f6; /* A contrasting blue for headings */
}

body.light-mode #tutorial-modal p,
body.light-mode #tutorial-modal ul {
    color: #4b5563; /* Darker text for readability */
}

body.light-mode #tutorial-modal .bg-gray-800 {
    background-color: #e5e7eb; /* Adjusting the info box color */
    border-color: #d1d5db;
}
/* Inside your style block */
/* Buttons in dark mode (default) */
#tutorial-back-btn { background-color: #4b5563; color: #e5e7eb; }
#tutorial-next-btn { background-color: #2563eb; color: #ffffff; }
#tutorial-finish-btn { background-color: #16a34a; color: #ffffff; }

/* Buttons in light mode */
body.light-mode #tutorial-back-btn { background-color: #d1d5db; color: #1f2937; }
body.light-mode #tutorial-next-btn { background-color: #3b82f6; color: #ffffff; }
body.light-mode #tutorial-finish-btn { background-color: #22c55e; color: #ffffff; }

/* Button hover effects */
#tutorial-back-btn:hover { background-color: #6b7280; }
body.light-mode #tutorial-back-btn:hover { background-color: #9ca3af; }
#tutorial-next-btn:hover { background-color: #3b82f6; }
body.light-mode #tutorial-next-btn:hover { background-color: #3b82f6; }
#tutorial-finish-btn:hover { background-color: #22c55e; }
body.light-mode #tutorial-finish-btn:hover { background-color: #4ade80; }

    </style>
		
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">

    <link rel="shortcut icon" href="favicon.ico">

    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">

    <link rel="manifest" href="site.webmanifest">
</head>
<body class="flex flex-col min-h-screen bg-gray-900 relative">

    <div id="tutorial-overlay" class="fixed inset-0 bg-black bg-opacity-75 hidden z-[999]"></div>

    <div id="sidebar" class="sidebar flex flex-col">
        <h2 class="text-3xl font-extrabold text-gray-100 mb-8">Tools </h2>
        <nav class="flex flex-col space-y-3">
            <button id="nav-canned-responses" class="w-full text-left px-5 py-3 rounded-xl hover:bg-gray-700 transition duration-300 text-gray-200 font-semibold text-lg">
                <i class="fas fa-comment-dots mr-3"></i> Canned Responses
            </button>
            <button id="nav-fedex-tracker" class="w-full text-left px-5 py-3 rounded-xl hover:bg-gray-700 transition duration-300 text-gray-200 font-semibold text-lg">
                <i class="fas fa-box-open mr-3"></i> FedEx Tracker
            </button>
            <button id="nav-helpful-links" class="w-full text-left px-5 py-3 rounded-xl hover:bg-gray-700 transition duration-300 text-gray-200 font-semibold text-lg">
                <i class="fas fa-link mr-3"></i> Helpful Links
            </button>
            <button id="nav-settings" class="w-full text-left px-5 py-3 rounded-xl hover:bg-gray-700 transition duration-300 text-gray-200 font-semibold text-lg">
                <i class="fas fa-cog mr-3"></i> Settings
            </button>
        </nav>
        <button id="close-sidebar-btn" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-700 transition duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>

    <div id="main-content" class="flex-1 p-6 sm:p-10 flex flex-col items-center transition-all duration-300 ease-in-out">
        <header class="w-full mb-8">
            <div class="flex items-center justify-between relative">
                <button id="hamburger-menu-btn" class="p-2 rounded-full hover:bg-gray-700 transition duration-300 relative z-1000" aria-label="Open Menu">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <div class="flex items-center space-x-4">
                    <h1 id="main-title" class="text-3xl sm:text-5xl font-extrabold text-gray-100 transition-colors duration-300">Canned Responses</h1>
                    <div id="category-menu-container" class="relative">
                        <button id="category-actions-btn" class="kebab-button p-2 rounded-full hover:bg-gray-700 transition duration-300 relative hidden" aria-expanded="true" aria-haspopup="true">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                            </svg>
                        </button>
                        <div id="category-actions-menu" class="hidden absolute top-full right-0 mt-3 w-56 bg-gray-700 rounded-xl shadow-2xl z-50 transform scale-95 opacity-0 transition-all duration-300 origin-top-right">
                            <button id="rename-category-btn" class="w-full text-left px-5 py-3 hover:bg-gray-600 rounded-t-xl transition duration-200"><i class="fas fa-pencil-alt mr-2"></i>Rename Category</button>
                            <button id="delete-category-btn" class="w-full text-left px-5 py-3 hover:bg-gray-600 text-red-400 transition duration-200"><i class="fas fa-trash-alt mr-2"></i>Delete Category</button>
                            <button id="change-color-btn" class="w-full text-left px-5 py-3 hover:bg-gray-600 rounded-b-xl transition duration-200"><i class="fas fa-palette mr-2"></i>Change Color</button>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="import-export-btn-placeholder" class="p-2 text-gray-400 hover:text-blue-400 transition duration-300 hidden" aria-label="Import/Export Data">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div id="category-bar" class="mt-6 p-4 bg-gray-800 shadow-2xl flex items-center justify-between rounded-2xl">
                <div class="flex-grow overflow-x-auto whitespace-nowrap scrollbar-hide">
                    <div id="category-list" class="flex gap-4">
                        </div>
                </div>
                <button id="add-category-btn" class="flex-shrink-0 ml-4 bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-blue-700 transition duration-300">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </header>

        <div id="message-box" class="message-box"></div>

        <div id="canned-responses-app" class="w-full container-bg rounded-2xl p-6 sm:p-10 text-gray-100 min-h-screen flex items-start justify-center py-12 hidden">
            <div class="w-full max-w-7xl mx-auto flex flex-col md:flex-row gap-8">
                <div class="w-full md:w-1/3 flex flex-col">
                    <div id="search-bar-container" class="floating-card mb-8 relative p-6 sm:p-8">
                        <div class="absolute inset-y-0 left-0 pl-11 flex items-center pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input
                            type="text"
                            id="search-input"
                            class="w-full border-2 border-gray-600 rounded-xl p-4 pl-12 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg text-placeholder"
                            placeholder="Search responses..."
                        />
                    </div>
                    
                    <div id="add-response-section" class="floating-card mb-8 p-6 sm:p-8 flex justify-center items-start">
                        <button id="open-add-response-modal-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-blue-700 transition duration-300">
                            <i class="fas fa-plus mr-2"></i> Add New Response
                        </button>
                    </div>
                </div>

                <div class="w-full md:w-2/3">
                    <div id="responses-container" class="w-full floating-card p-6 sm:p-8">
                        <h2 id="responses-heading" class="text-3xl font-bold text-gray-200 mb-6 hidden"></h2>
                        
                        <div id="responses-list" class="space-y-6">
                            </div>
                        <div id="empty-state" class="text-center text-gray-400 mt-8 hidden">
                            <p class="text-lg">No canned responses in this category. Add one above!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="fedex-tracker-app" class="w-full container-bg rounded-2xl p-6 sm:p-10 text-gray-100 min-h-screen flex items-center justify-center py-12 hidden">
            <div class="main-card p-8 w-full max-w-2xl mx-auto">
                <h1 class="text-4xl font-bold text-center text-gray-100 mb-4">FedEx Tracking</h1>
                <p class="text-center text-gray-400 mb-8 text-lg">Extract and manage your FedEx tracking numbers easily.</p>
		
                <div class="mb-6">
                    <label for="input-text" class="block text-sm font-medium text-gray-300 mb-2">Paste or type your text here:</label>
                    <textarea id="input-text-fedex" rows="8" class="text-placeholder w-full p-4 border-2 border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-800 text-gray-100 transition duration-300 text-lg" placeholder="e.g., 'Your package with tracking number 794829370821 has been shipped.'"></textarea>
                </div>
		
                <div class="mb-6">
                    <h2 class="text-2xl font-semibold text-gray-200 mb-4">Extracted Tracking Numbers</h2>
                    <div id="tracking-numbers-container" class="tracking-numbers-container border-2 border-dashed border-gray-700 rounded-xl p-4 scrollable-box shadow-inner">
                        <p id="no-numbers-message" class="text-center text-gray-500 text-base">No tracking numbers found yet.</p>
                        <div id="loading-indicator" class="hidden flex justify-center items-center">
                            <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-base text-gray-400">Processing...</span>
                        </div>
                    </div>
                </div>
		
                <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <button id="clear-button-fedex" class="w-full sm:w-auto bg-gray-700 text-gray-200 font-semibold py-3 px-8 rounded-xl shadow-md hover:bg-gray-600 transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-400 disabled:opacity-50">
                        Clear
                    </button>
                    <button id="copy-button-fedex" class="w-full sm:w-auto bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 disabled:bg-indigo-300">
                        <svg class="h-5 w-5 inline-block -mt-1 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2H6z" />
                        </svg>
                        Copy All & Open FedEx
                    </button>
                </div>
            </div>
        </div>

        <div id="helpful-links-app" class="w-full hidden container-bg rounded-2xl p-6 sm:p-10 text-gray-100 min-h-screen flex items-center justify-center py-12">
            <div class="container mx-auto px-4">
                <header class="text-center mb-16 animate-fade-in">
                    <p class="mt-4 text-xl text-gray-300 max-w-2xl mx-auto">
                        A carefully curated selection of resources, tools, and documentation.
                    </p>
                    <div id="links-user-info" class="mt-4 text-sm text-gray-500"></div>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    
                    <section class="col-span-1 md:col-span-2 lg:col-span-3">
                        <h2 class="text-3xl font-bold text-center mb-8 link-title">
                            Static Resources
                        </h2>
                        <div id="static-links-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <p class="text-center text-gray-400 col-span-full">Loading static links...</p>
                        </div>
                    </section>
                    
                    <section id="user-links-section" class="col-span-1 md:col-span-2 lg:col-span-3 mt-12">
                        <h2 class="text-3xl font-bold text-center mb-8 link-title">
                            Your Links
                        </h2>
                        <div id="user-links-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <p class="text-center text-gray-400 col-span-full">No links added yet. Add one above!</p>
                        </div>
                    </section>

                    <section id="add-link-section" class="col-span-1 md:col-span-2 lg:col-span-3 flex justify-center">
                        <div class="floating-card rounded-2xl p-8 max-w-lg w-full">
                            <h2 id="form-title" class="text-2xl font-bold text-blue-400 mb-4">Add a New Link</h2>
                            <form id="add-link-form" class="space-y-4">
                                <div>
                                    <label for="link-title" class="block text-sm font-medium text-gray-400">Title</label>
                                    <input type="text" id="link-title" required class="mt-1 block w-full bg-gray-700 text-white border-2 border-gray-600 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg p-3 transition duration-300">
                                </div>
                                <div>
                                    <label for="link-url" class="block text-sm font-medium text-gray-400">URL</label>
                                    <input type="url" id="link-url" required class="mt-1 block w-full bg-gray-700 text-white border-2 border-gray-600 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg p-3 transition duration-300">
                                </div>
                                <div>
                                    <label for="link-description" class="block text-sm font-medium text-gray-400">Description (Optional)</label>
                                    <input type="text" id="link-description" class="mt-1 block w-full bg-gray-700 text-white border-2 border-gray-600 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg p-3 transition duration-300">
                                </div>
                                <div class="flex space-x-4">
                                    <button type="submit" id="submit-button" class="w-full inline-flex justify-center py-3 px-6 border border-transparent shadow-lg text-lg font-bold rounded-xl text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">
                                        Add Link
                                    </button>
                                    <button type="button" id="cancel-button" class="w-full inline-flex justify-center py-3 px-6 border border-gray-600 shadow-md text-lg font-bold rounded-xl text-gray-300 bg-gray-700 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-300 hidden">
                                        Cancel
                                    </button>
                                </div>
                                <div id="status-message" class="text-center mt-2 text-sm text-gray-400"></div>
                            </form>
                        </div>
                    </section>
                </div>
            </div>
        </div>
		
        <div id="settings-page" class="w-full container-bg rounded-2xl p-6 sm:p-10 text-gray-100 min-h-screen flex items-start justify-center py-12 hidden">
            <div class="w-full max-w-7xl mx-auto space-y-8 md:flex md:flex-wrap md:gap-8">
                
                <div class="floating-card p-6 sm:p-8 flex flex-col items-center flex-1 md:w-1/2 min-h-full">
                    <h2 class="text-2xl font-bold text-gray-200 mb-4 flex items-center">
                        <i class="fas fa-user-circle mr-3 text-3xl text-blue-400"></i> Account
                    </h2>
                    <div id="auth-status-settings" class="text-center text-gray-400 font-medium mb-4">Not signed in.</div>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 w-full justify-center">
                        <button id="sign-in-btn-settings" class="w-full sm:w-auto text-center px-5 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 transition duration-300 shadow-lg hidden">
                            <i class="fas fa-sign-in-alt mr-2"></i> Sign In with Google
                        </button>
                        <button id="sign-out-btn-settings" class="w-full sm:w-auto text-center px-5 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 transition duration-300 shadow-lg hidden">
                            <i class="fas fa-sign-out-alt mr-2"></i> Sign Out
                        </button>
                    </div>
                </div>

                <div class="floating-card p-6 sm:p-8 flex-1 md:w-1/2 min-h-full space-y-6">
                    <h2 class="text-2xl font-bold text-gray-200 mb-4 flex items-center">
                        <i class="fas fa-paint-brush mr-3 text-3xl text-purple-400"></i> Appearance
                    </h2>
                    <div class="flex items-center justify-between border-t border-gray-600 pt-6">
                        <span class="text-lg text-gray-300">Dark / Light Mode</span>
                        <button id="theme-toggle-btn-settings" class="px-5 py-3 rounded-xl bg-gray-700 text-white font-bold hover:bg-gray-600 transition duration-300 shadow-lg">
                            <i id="theme-icon-settings" class="fas fa-moon mr-2"></i> Toggle Theme
                        </button>
                    </div>
                    <div class="flex items-center justify-between border-t border-gray-600 pt-6">
                        <span class="text-lg text-gray-300">Check for New Content</span>
                        <button id="check-updates-btn-settings" class="px-5 py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition duration-300 shadow-lg">
                            <i class="fas fa-sync-alt mr-2"></i> Check for Updates
                        </button>
                    </div>
                </div>

                <div class="floating-card p-6 sm:p-8 flex flex-col items-center md:w-full">
                    <h2 class="text-2xl font-bold text-gray-200 mb-4 flex items-center">
                        <i class="fas fa-database mr-3 text-3xl text-green-400"></i> Data Management
                    </h2>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 w-full justify-center">
                        <button id="import-export-btn-settings" class="w-full sm:w-auto text-center px-5 py-3 rounded-xl bg-gray-700 text-white font-bold hover:bg-gray-600 transition duration-300 shadow-lg">
                            <i class="fas fa-exchange-alt mr-2"></i> Import / Export
                        </button>
                    </div>
                    <div id="tutorial-reset-section" class="flex items-center justify-between border-t border-gray-600 pt-6 mt-6 w-full hidden">
                        <span class="text-lg text-gray-300">Tutorial</span>
                        <button id="show-tutorial-btn" class="px-5 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 transition duration-300 shadow-lg">
                            <i class="fas fa-book mr-2"></i> Show Me Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="placeholder-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Customize Response</h3>
            <p class="text-gray-400 text-base mb-4">Please fill in the details for the placeholders below.</p>
            <div id="placeholder-inputs" class="space-y-4">
                </div>
            <div class="flex justify-end mt-6 space-x-4">
                <button id="cancel-placeholder-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="confirm-placeholder-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Copy Response
                </button>
            </div>
        </div>
    </div>

    <div id="edit-response-modal" class="modal hidden">
        <div class="modal-content w-full max-w-3xl" data-original-category="">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Edit Response</h3>
            <p class="text-gray-400 text-base mb-4">Modify the response, its label, or category below.</p>
            <div id="edit-form" class="space-y-4">
                <div>
                    <label for="edit-response-label" class="block text-sm font-medium text-gray-400">Label</label>
                    <input type="text" id="edit-response-label" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg" />
                </div>
                <div>
                    <label for="edit-response-text" class="block text-sm font-medium text-gray-400">Response Text</label>
                    <textarea id="edit-response-text" rows="15" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg"></textarea>
                </div>
                <div>
                    <label for="edit-category-select" class="block text-sm font-medium text-gray-400">Category</label>
                    <select id="edit-category-select" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg"></select>
                </div>
            </div>
            <div class="flex justify-end mt-6 space-x-4">
                <button id="cancel-edit-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="save-edit-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Save Changes
                </button>
            </div>
        </div>
    </div>


    <div id="import-export-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Import or Export Data</h3>
            <div class="flex flex-col space-y-4">
                <div>
                    <h4 class="font-semibold text-gray-400 text-lg">Export All Data</h4>
                    <p class="text-gray-400 text-base mb-2">Download a JSON file containing all your categories and responses.</p>
                    <button id="export-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition duration-300 shadow-lg">
                        <i class="fas fa-download mr-2"></i> Export to File
                    </button>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-400 text-lg">Import Data</h4>
                    <p class="text-gray-400 text-base mb-2">Upload a JSON file to restore your categories and responses. This will overwrite your current data.</p>
                    <input type="file" id="import-file-input" accept="application/json" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 transition duration-300">
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button id="close-import-export-modal-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Close
                </button>
            </div>
        </div>
    </div>

    <div id="new-response-modal" class="modal hidden">
        <div class="modal-content w-full max-w-3xl">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Create New Response</h3>
            <div id="add-response-form" class="space-y-4">
                <div>
                    <label for="new-response-label" class="block text-sm font-medium text-gray-400">Label (Optional)</label>
                    <input type="text" id="new-response-label" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg" placeholder="Enter a label (e.g., 'Customer Support')" />
                </div>
                <div>
                    <label for="new-response-text" class="block text-sm font-medium text-gray-400">Response Text</label>
                    <textarea id="new-response-text" rows="15" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg" placeholder="Type your new canned response here..."></textarea>
                </div>
                <div>
                    <label for="new-response-category" class="block text-sm font-medium text-gray-400">Category</label>
                    <select id="new-response-category" class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg"></select>
                </div>
            </div>
            <div class="flex justify-end mt-6 space-x-4">
                <button id="cancel-new-response-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="save-new-response-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Save Response
                </button>
            </div>
        </div>
    </div>


    <div id="add-category-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Add a New Category</h3>
            <p class="text-gray-400 text-base mb-4">Give your new category a name.</p>
            <input
                type="text"
                id="add-category-input"
                class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 mb-4 text-lg"
                placeholder="Enter category name (e.g., 'Customer Support')"
            />
            <div class="flex justify-end space-x-4">
                <button id="cancel-add-category-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="confirm-add-category-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Create Category
                </button>
            </div>
        </div>
    </div>

    <div id="edit-category-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Edit Category</h3>
            <p class="text-gray-400 text-base mb-4">Enter a new name for the category.</p>
            <input
                type="text"
                id="edit-category-input"
                class="w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 mb-4 text-lg"
                placeholder="Enter new name"
            />
            <div class="flex justify-end space-x-4">
                <button id="cancel-edit-category-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="confirm-edit-category-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Save Name
                </button>
            </div>
        </div>
    </div>

    <div id="delete-category-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Confirm Category Deletion</h3>
            <p class="text-gray-400 text-base mb-4">Are you sure you want to delete this category? All responses inside it will be permanently deleted.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-category-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="confirm-delete-category-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-red-700 transition duration-300 shadow-md">
                    Yes, Delete
                </button>
            </div>
        </div>
    </div>

    <div id="color-picker-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Change Category Color</h3>
            <p class="text-gray-400 text-base mb-4">Select a new color for the active category.</p>
            <div class="flex justify-center mb-4">
                <input type="color" id="color-input" class="w-16 h-16 rounded-lg cursor-pointer border-2 border-gray-600">
            </div>
            <div class="flex justify-end mt-6 space-x-4">
                <button id="close-color-picker-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Close
                </button>
                <button id="save-color-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                    Save
                </button>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Confirm Deletion</h3>
            <p class="text-gray-400 text-base mb-4">Are you sure you want to delete this response?</p>
            <div class="flex justify-end space-x-4">
                <button id="delete-cancel-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Cancel
                </button>
                <button id="delete-confirm-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-red-700 transition duration-300 shadow-md">
                    Yes, Delete
                </button>
            </div>
        </div>
    </div>

    <div id="update-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="update-modal-title" class="text-2xl font-bold text-gray-200 mb-4">Checking for Updates...</h3>
            <p id="update-modal-message" class="text-gray-400 text-base mb-4">Please wait while we check for new content.</p>
            <div id="update-modal-buttons" class="flex justify-end space-x-4 hidden">
                <button id="close-update-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-gray-700 transition duration-300 shadow-md">
                    Close
                </button>
            </div>
        </div>
    </div>
		
    <div id="login-popup-modal" class="modal hidden">
        <div class="login-popup flex flex-col space-y-3">
            <div class="flex items-center justify-between">
                <span class="text-sm font-semibold text-gray-200">Sign In for more!</span>
                <button id="close-login-popup-btn" class="p-1 rounded-full hover:bg-gray-600 transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <p class="text-xs text-gray-400">Sign in to save your canned responses and helpful links across all your devices.</p>
            <button id="login-popup-btn" class="w-full text-center px-4 py-2 rounded-xl bg-blue-600 text-white text-sm font-bold hover:bg-blue-700 transition duration-300">
                Sign In with Google
            </button>
        </div>
    </div>

    <div id="tutorial-modal" class="modal hidden">
        <div class="modal-content w-full max-w-lg">
            <div id="tutorial-step-1" class="tutorial-step space-y-6">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Welcome! 👋</h3>
                <p class="text-lg text-gray-300 text-center">Thanks for signing in! Here's a quick tour to show you how to get the most out of this site.</p>
            </div>

            <div id="tutorial-step-2" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Add New Responses</h3>
                <p class="text-lg text-gray-300">This button is where you can create new canned responses. You can give it a label and assign it to a category.</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-plus-circle text-purple-400 mr-3"></i> Tips
                    </h4>
                    <p class="text-gray-400">Add responses for your most common requests to save time!</p>
                </div>
            </div>
            <div id="tutorial-step-3" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Search Your Responses</h3>
                <p class="text-lg text-gray-300">Quickly find any response by using the search box at the top of the left column.</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-search text-yellow-400 mr-3"></i> How it Works
                    </h4>
                    <p class="text-gray-400">Type any keyword into the search bar, and the list below will instantly filter to show you matching responses.</p>
                </div>
            </div>

            <div id="tutorial-step-4" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Categories</h3>
                <p class="text-lg text-gray-300">Organize your responses with custom categories. You can create new categories with the **<i class="fas fa-plus"></i>** button.</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-ellipsis-v text-pink-400 mr-3"></i> Manage Categories
                    </h4>
                    <p class="text-gray-400">Click the vertical ellipsis (<i class="fas fa-ellipsis-v"></i>) next to a category to **rename** it, **change its color**, or **delete** it. </p>
                </div>
            </div>
            
            <div id="tutorial-step-5" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Manage Categories</h3>
                <p class="text-lg text-gray-300">Once you have a category selected, click on the **kebab menu button** to edit, rename, or delete it.</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-lightbulb text-yellow-400 mr-3"></i> Tip
                    </h4>
                    <p class="text-gray-400">You can also **change a category's color** here to make it stand out!</p>
                </div>
            </div>
            
            <div id="tutorial-step-6" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Manage Responses</h3>
                <p class="text-lg text-gray-300">Each canned response has buttons to **Copy**, **Edit**, or **Delete** it. Use them to manage your content!</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-copy text-green-400 mr-3"></i> Quick Actions
                    </h4>
                    <p class="text-gray-400">The **Copy** button instantly copies the text. The other buttons allow you to easily edit or delete the entry from your list.</p>
                </div>
            </div>

            <div id="tutorial-step-7" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Pin Your Favorites</h3>
                <p class="text-lg text-gray-300">The **pin button** allows you to pin your most-used responses to the top of the list for quick access.</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-thumbtack text-white mr-3"></i> Pinning Tips
                    </h4>
                    <p class="text-gray-400">Click the pin icon again to unpin a response, and it will return to its alphabetical position.</p>
                </div>
            </div>
            
            <div id="tutorial-step-8" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Dynamic Placeholders</h3>
                <p class="text-lg text-gray-300">Some responses use special placeholders like [TrackingNumber], [Customer's Name], [Asset Number], that you can quickly fill in.</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-magic text-purple-400 mr-3"></i> Try it out!
                    </h4>
                    <p class="text-gray-400 mt-2">Notice the highlighted response on the right. Click the button below to see how to fill in its placeholders!</p>
                </div>
                <div class="flex justify-center mt-6">
                    <button id="show-placeholder-example-btn" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-purple-700 transition duration-300">
                        Fill it Out
                    </button>
                </div>
            </div>

            <div id="tutorial-step-9" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">You're All Set! 🎉</h3>
                <p class="text-lg text-gray-300">You've successfully copied a response with placeholders filled in. Now you can paste it anywhere you need!</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-paste text-green-400 mr-3"></i> Try it out
                    </h4>
                    <p class="text-gray-400">Paste the text into a document or email to see the final result. All your responses are now ready to be used with a single click.</p>
                </div>
            </div>

			<div id="tutorial-step-10" class="tutorial-step space-y-6 hidden">
   				 <h3 class="text-3xl font-extrabold text-blue-400 text-center">Navigate to Other Pages 🗺️</h3>
   				 <p class="text-lg text-gray-300">
       				 You can access other tools, like the **FedEx Tracker** and **Helpful Links**, by opening the main menu.
   				 </p>
   				 <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
       				 <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
            			<i class="fas fa-bars text-gray-400 mr-3"></i> How it Works
        				</h4>
       				 <p class="text-gray-400">
           			 Click the hamburger icon on the top left to reveal the sidebar menu and switch between pages.
        			</p>
    			</div>
			</div>

            <div id="tutorial-step-11" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">FedEx Tracker Page 📦</h3>
                <p class="text-lg text-gray-300">This page allows you to quickly extract FedEx tracking numbers from any block of text you paste in.</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-clipboard-check text-green-400 mr-3"></i> Try it out!
                    </h4>
                    <p class="text-gray-400">Paste an email or text containing one or more FedEx tracking numbers into the box on the left, and watch them appear on the right.</p>
                </div>
            </div>	

            <div id="tutorial-step-12" class="tutorial-step space-y-6 hidden">
                <h3 class="text-3xl font-extrabold text-blue-400 text-center">Copy & Open FedEx 🔗</h3>
                <p class="text-lg text-gray-300">After the numbers are extracted, this button copies all of them and automatically opens a new FedEx tracking tab for you.</p>
                <div class="p-4 rounded-xl bg-gray-800 shadow-lg border border-gray-700">
                    <h4 class="text-xl font-bold text-gray-200 flex items-center mb-2">
                        <i class="fas fa-truck text-red-400 mr-3"></i> Why it's useful
                    </h4>
                    <p class="text-gray-400">This saves you from copying each number one by one and pasting them into the FedEx website, streamlining your workflow.</p>
                </div>
            </div>		

            <div id="copy-success-modal" class="modal hidden">
                <div class="modal-content">
                    <h3 class="text-2xl font-bold text-gray-200 mb-4">Text Copied! ✅</h3>
                    <p class="text-gray-400 text-base mb-2">Here is the final response you just copied:</p>
                    <div class="bg-gray-700 p-4 rounded-xl border border-gray-600 mb-4 overflow-auto max-h-60">
                        <pre id="copied-text-display" class="whitespace-pre-wrap text-gray-200"></pre>
                    </div>
                    <p class="text-sm text-gray-500 mb-4">Feel free to paste this into your application.</p>
                    <div class="flex justify-end">
                        <button id="close-copy-success-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition duration-300">
                            Got it!
                        </button>
                    </div>
                </div>
            </div>

			<div class="flex justify-between items-center mt-8">
   				 <button id="tutorial-back-btn" class="py-3 px-6 rounded-xl shadow-md hidden 
       			 dark:bg-gray-600 dark:text-white dark:hover:bg-gray-700
        			light-mode:bg-gray-300 light-mode:text-gray-800 light-mode:hover:bg-gray-400
        			transition duration-300">
       			 <i class="fas fa-arrow-left mr-2"></i> Back
   			 </button>
   			 <button id="tutorial-next-btn" class="py-3 px-6 rounded-xl shadow-lg
        			dark:bg-blue-600 dark:text-white dark:hover:bg-blue-700
        			light-mode:bg-blue-600 light-mode:text-white light-mode:hover:bg-blue-700
        			transition duration-300">
        			Next <i class="fas fa-arrow-right ml-2"></i>
   			 </button>
    			<button id="tutorial-finish-btn" class="py-3 px-6 rounded-xl shadow-lg hidden
       			 dark:bg-green-600 dark:text-white dark:hover:bg-green-700
       			 light-mode:bg-green-600 light-mode:text-white light-mode:hover:bg-green-700
       			 transition duration-300">
       			 Finish <i class="fas fa-check ml-2"></i>
    			</button>
			</div>
        </div>
    </div>
		
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, query, deleteDoc, updateDoc, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Initialization and Auth ---
        const firebaseConfig = {
          apiKey: "AIzaSyCCsU4YY_Rwqo-F9KJjeOOSD4NpUGLNq8s",
          authDomain: "tools-a180f.firebaseapp.com",
          projectId: "tools-a180f",
          storageBucket: "tools-a180f.firebasestorage.app",
          messagingSenderId: "195275159442",
          appId: "1:195275159442:web:20031fd5ccf0428162334b",
          measurementId: "G-TP0VKGV0EE"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-tools-app';
        const safeAppId = appId.replace(/[:\/]/g, '-');

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug');
        
        // --- Global State Variables ---
let currentTutorialStep = 0;
let categories = {};
let activeCategory = '';
let userId = null;
let isAnonymous = true;
let responseToDeleteId = null;
let categoryToEdit = null;
let currentPage = 'canned-responses';
let userName = '';
let currentTextToCopy = '';
let currentEditingId = null;
let openCategoryMenu = null;
let editingLinkDocId = null;
let openMenuId = null;
let defaultLinks = [];
let cannedResponsesUnsubscribe = null;
let helpfulLinksUnsubscribe = null;
let userLinks = [];
let renderedStaticLinks = false;
let isSubmittingLink = false;
let isTutorialActive = false;	

const storedTheme = localStorage.getItem('theme');
if (storedTheme === 'light') {
    document.body.classList.add('light-mode');
}

// Function to darken a color for light mode backgrounds
function lightenColor(hexColor) {
    // Remove the '#' if it exists
    const hex = hexColor.replace('#', '');
    
    // Convert hex to R, G, B
    const r = parseInt(hex.substring(0, 2), 16);
    const g = parseInt(hex.substring(2, 4), 16);
    const b = parseInt(hex.substring(4, 6), 16);
    
    // Find the max and min RGB values
    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    
    // Convert RGB to HSL
    let h, s, l = (max + min) / 255 / 2;
    
    if (max === min) {
        h = s = 0; // Achromatic
    } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        
        switch(max) {
            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
            case g: h = (b - r) / d + 2; break;
            case b: h = (r - g) / d + 4; break;
        }
        
        h /= 6;
    }
    
    // Increase lightness for light mode (e.g., to 90% or 95%)
    let newL = Math.min(l + 0.5, 0.95); // Ensure it's not too light
    
    // Convert back to RGB
    let newR, newG, newB;
    if (s === 0) {
        newR = newG = newB = newL; // Achromatic
    } else {
        const hue2rgb = (p, q, t) => {
            if (t < 0) t += 1;
            if (t > 1) t -= 1;
            if (t < 1/6) return p + (q - p) * 6 * t;
            if (t < 1/2) return q;
            if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
            return p;
        };
        const q = newL < 0.5 ? newL * (1 + s) : newL + s - newL * s;
        const p = 2 * newL - q;
        newR = hue2rgb(p, q, h + 1/3);
        newG = hue2rgb(p, q, h);
        newB = hue2rgb(p, q, h - 1/3);
    }
    
    // Convert RGB back to hex
    const toHex = (c) => {
        const hex = Math.round(c * 255).toString(16);
        return hex.length === 1 ? '0' + hex : hex;
    };
    
    return `#${toHex(newR)}${toHex(newG)}${toHex(newB)}`;
}


const tutorialSteps = [
    document.getElementById('tutorial-step-1'),
    document.getElementById('tutorial-step-2'),
    document.getElementById('tutorial-step-3'),
    document.getElementById('tutorial-step-4'),
    document.getElementById('tutorial-step-5'), 
    document.getElementById('tutorial-step-6'), 
    document.getElementById('tutorial-step-7'),
    document.getElementById('tutorial-step-8'),
    document.getElementById('tutorial-step-9'),
    document.getElementById('tutorial-step-10'),
    document.getElementById('tutorial-step-11'),
    document.getElementById('tutorial-step-12'),   	
];

const highlightedElements = [
    null, // Step 1
    document.getElementById('add-response-section'), // Step 2: Add New Response
    document.getElementById('search-bar-container'), // Step 3: Search Bar
    document.getElementById('category-bar'), // Step 4: Categories
    document.getElementById('category-menu-container'), // Step 5: Kebab menu
    null, // Step 6: Copy, Edit, Delete buttons (highlighting handled dynamically)
    null, // Step 7: Pin button (highlighting handled dynamically)
    null, // Step 8: Dynamic Placeholders
    null, // Step 9:This will be handled dynamically inside the function
	document.getElementById('hamburger-menu-btn'), // New Step 10: Highlights the hamburger icon
    document.getElementById('input-text-fedex'), // Step 11
    document.getElementById('copy-button-fedex'), // Step 12: New highlight
];
 
const tutorialPages = [
    'canned-responses', // Step 1: Welcome screen
    'canned-responses', // Step 2: Add a response
    'canned-responses', // Step 3: Search
    'canned-responses', // Step 4: Categories
    'canned-responses', // Step 5: Manage Categories
    'canned-responses', // Step 6: Manage Responses (new)
    'canned-responses', // Step 7: Pinning (new)
    'canned-responses', // Step 8: Dynamic placeholders
    'canned-responses', //step 9
	'canned-responses', //step 10
    'fedex-tracker', // Step 11: Change page to FedEx tracker
    'fedex-tracker', // Step 12: Change page to FedEx tracker   
];

// An array to map each step to the modal's target position
const modalPositions = [
    'show-modal', // Step 1: Centered modal
    'top-right',  // Step 2: Position for add response section
    'top-right',  // Step 3: Position for the search bar
    'bottom-left', // Step 4: Position for category bar
    'upper-right', //Step 5: Position for Kebab menu
    'on-response', // Step 6: Response buttons (new)
    'on-response',  // Step 7: Pin button (new)
    'left-response', // Step 8: Dynamic placeholders
    'show-modal', //Step 9
	'top-left',
    'left-response', // Step 10: New position
    'on-tracker-page' // Step 11: Position on the tracker page   
];

// --- Master Blueprint Data for Initialization ---
const defaultCannedResponsesBlueprint = {
    'BRONCO': {
        color: '#32789C',
        responses: [
            { id: 'bronco-1', label: 'NON ACTIONABLE ORDER', text: 'Hello [Customer\'s Name],\n\nI am writing to inform you that the item you ordered, [Device Model], is currently out of stock. We expect to have it back in stock within 2-4 weeks. I apologize for the inconvenience.\n\nOnce it is back in stock, we will deliver it to you as soon as possible. We appreciate your patience and understanding during this time.\n\nIf you have any other questions or concerns, please do not hesitate to contact me.\n\nSincerely,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() },
            { id: 'bronco-2', label: 'ACTIONABLE ITEM RESPONSE', text: 'Hello [Customer\'s Name],\n\nThank you for your order!\n\nOur target is to have them either shipped or delivered to you in 1-3 business days time. We will let you know when your order is on its way.\n\nThank you\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() },
            { id: 'bronco-3', label: 'OUT FOR DELIVERY RESPONSE', text: 'Hello [Customer\'s Name],\n\nYour order will ship today or the next business day, depending on FedEx\'s pickup schedule. You can track your shipment with FedEx Tracking [TrackingNumber].\n\nPlease make sure to check your local Mail room once this order is marked delivered.\n\nPlease note that once the order is delivered, we are unable to see and respond to updates in the order.\n\nIf you need further help, please submit a request through go/stuff by selecting “Have questions about your order?”, or by opening a ticket at go/emt-request.\n\nThank you,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() },
            { id: 'bronco-4', label: 'ITEM DELIVERED', text: 'Hello [Customer\'s Name],\n\nI have delivered the [Device Model] to your desk [Desk Location] this morning [Date].\n\nPlease note that once the order is delivered, we are unable to see and respond to updates in the order.\n\nIf you need further help, please submit a request through go/stuff by selecting “Have questions about your order?”, or by opening a ticket at go/emt-request.\n\nThank you,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() },
            { id: 'bronco-5', label: 'SECURITY KEY DELIVERED', text: 'Hello [Customer\'s Name],\n\nYour security key order has been delivered to [Desk Location]. Please be sure to follow the Techstop security key setup instructions at go/setup-sk.\n\nPlease note that once the order is delivered, we are unable to see and respond to updates in the order.\n\nIf you need further help, please submit a request through go/stuff by selecting “Have questions about your order?”, or by opening a ticket at go/emt-request.\n\nThank you,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() },
            { id: 'bronco-6', label: 'PIKTIME', text: 'Hello [Customer\'s Name],\n\nThank you for your request.\n\nWe\'ve prepared your order and it will be ready for you to pick up at your confirmed appointment time.\n\nPick-up Location: https://floorscope.googleplex.com/US-LAX-BIN2-1#US-LAX-BIN2-1-100 (Please knock on our door when you arrive to pick up your order.)\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() },
            { id: 'bronco-7', label: 'PIKTIME DELIVERED', text: 'Hello [Customer\'s Name],\n\nYour order for a [Device Model] was successfully picked up on [Date]. Thanks for stopping by!\n\nWe will now mark this order delivered.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() },
            { id: 'bronco-8', label: 'PIKTIME CANCELLED', text: 'Hello [Customer\'s Name],\n\nThis is to inform you that your order has been canceled. This is due to the failure to pick up the order at the confirmed date and time of your appointment.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() }
        ]
    },
    'PAR': {
        color: '#242020',
        responses: [
            { id: 'par-1', label: 'PAR REMOTE ORDER', text: 'Hello [Customer\'s Name],\n\nYour shipping materials have been sent for your return order\n\nFedEx Tracking: [TrackingNumber]\nReturn Tracking: [ReturnTrackingNumber]\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() },
            { id: 'par-2', label: 'PAR SHIPPING MATERIALS DELIVERED', text: 'Hello [Customer\'s Name],\n\nAccording to the FedEx tracking number, the shipping Materials were delivered on [Date].\n\nScreenshot:\n\nAs a reminder, per Google’s device return policy, you have 10 business days to complete your return. If you still have your device after the return window, this device will lose corporate access and your cost center will be charged back after 40 days.\n\nBest regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() },
            { id: 'par-3', label: 'PAR STUFF LOCKER', text: 'Hello [Customer\'s Name],\n\nThank you for submitting your return request.\n\nWe\'ll retrieve your asset from the Stuff Station return locker as soon as it\'s dropped off.\n\nJust a friendly reminder: you have 10 business days from the creation date of this order to place your asset in the return locker. If it\'s not dropped off within this time frame, your return order will be automatically canceled.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() },
            { id: 'par-4', label: 'CANCEL RETURN LOCKER ORDER', text: 'Hello [Customer\'s Name],\n\nPlease be advised that this return order will be canceled. This is due to the failure to pick up the item from the designated return lockers.', isPinned: false, createdAt: new Date().toISOString() }
        ]
    },
    'GUTS': {
        color: '#014B34',
        responses: [
            { id: 'guts-1', label: 'GNG LOCKERS PROACTIVE TICKET', text: 'The GNG lockers contain [Number] loaners and [Number2] empty slots.\n\nScreenshot:\n\nThis ticket will be marked resolved.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() },
            { id: 'guts-2', label: 'GUTS STUFF STATION VENDING', text: 'The stuff station vending machine has been replenished .\n\nScreenshot:\n\nThis ticket will now be resolved.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() },
            { id: 'guts-3', label: 'Remote Return Shipment Information', text: 'Your request has been prepped and ready to ship. Feel free to reach out to us if you need more assistance. (1 Box Sent)\n\nFedEx Tracking:[TrackingNumber]\nReturn Tracking:[ReturnTrackingNumber]\n\nAs a reminder, per Google’s device return policy, you have 14 days (10 business days) to complete your return. If you still have your device after the return window, this device will lose corporate access and your cost center will be charged.\n\nWe will send a reminder in 3 business days if we haven\'t received your return by then.\n\nI’ll set this ticket to Pending Hardware Return while we wait for delivery.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() },
            { id: 'guts-4', label: 'Resolution For Lost Device', text: 'After conducting a search for [Asset Number] - [Device Model], I have concluded that this device is lost and I updated our records to reflect this.\n\nThe following actions were taken to search for this device:\n1:\n2:\n3:\n\nSince no further actions are needed, I will resolve this ticket now. Please feel free to reach out if you have any further questions regarding this request.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() },
            { id: 'guts-5', label: 'Exit Onsite Collection Information', text: 'Thank you for confirming that your [Asset Number] - [Device Model] is ready for pickup on [Date].\n\nI will set this ticket to Pending Date of Event until the collection date, and I will update the ticket again when the collection is in progress.\n\nIn the meantime, please let me know if you have any further questions regarding this request.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() },
            { id: 'guts-6', label: 'Onsite Collection That Was Not Found/Not Ready for Pick Up', text: 'I just want to follow up because we visited [Desk Location] and your [Device Model] Asset Number [Asset Number] was not ready for collection.\n\nCan you please confirm a new collection date and the correct pick up location site code?\n\nAs a reminder, you have [Number] business days remaining to complete your return. If you do not complete your return in [Number] business days this request will be closed, and your device will lose corporate access.\n\nIn the meantime, I’ll set this ticket back to Pending Customer Action while we wait for your reply.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() },
            { id: 'guts-7', label: 'Remote Return Shipment That Has Not Been Received', text: 'I just want to follow up because we have not received your return.\n\nAs a reminder, you have 5 business days remaining to complete your return.\n\nIf you do not complete your return in 5 business days this request will be closed, and your device will lose corporate access.\n\nIn the meantime, I’ll set this ticket back to Pending Hardware Return while we wait for your return to be delivered.\n\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() },
            { id: 'guts-8', label: 'Successful Return', text: 'The following devices have been returned to inventory, so I’ll resolve this ticket now:\n\n [Asset Number] - [Device Model]\n\nPlease feel free to reach out if you have any further questions regarding this return.\nKind regards,\n\n[Name]', isPinned: false, createdAt: new Date().toISOString() }
        ]
    }
};

const defaultHelpfulLinksBlueprint = [
    { id: 'default-1', title: 'Astreya KB', description: 'Access the Astreya knowledge base for support.', url: 'https://supportcenter.corp.google.com/corpengkb/category/bltc1355050242a3f3d?e=ServicedeskCommonGuidedSupport::Launch' },
    { id: 'default-2', title: 'Astreya Audits', description: 'Review and manage Astreya audit reports.', url: 'https://ui-web-dot-emt-inspecto-dev.uc.r.appspot.com/app/' },
    { id: 'default-3', title: 'Find Net blocks', description: 'Search for network blocks and IP information.', url: 'https://ipdb.corp.google.com/ipdb/corp-list/?ip_address=&netmask=&description=&vlan=&address_type=all&region_name=&country_name=&city_name=&building_name=&network_name=&tag=ACL-CORP-MNP' },
    { id: 'default-4', title: 'Bronco Plant Codes', description: 'A spreadsheet of plant codes for the Bronco project.', url: 'https://docs.google.com/spreadsheets/d/1urmopWJvKXdXqAsPf1TBW2W97h5wbkFkNs9CKcBdwsE/edit?gid=0#gid=0' },
    { id: 'default-5', title: 'GUTS CTI', description: 'Check the GUTS CTI spreadsheet for contact info.', url: 'https://docs.google.com/spreadsheets/d/1zYSxHSdwIwrEvWAcpVyhbx6b5R2raWq322pM3EGexy0/edit?resourcekey=0-ghk2iWDZcH3sFEZ_NA-uyQ&gid=421127237#gid=421127237' },
    { id: 'default-6', title: 'Technician Workload Management', description: 'View and manage technician workload.', url: 'https://lookerstudio.google.com/c/u/0/reporting/462c770f-51f7-42e4-811d-b3fb3daf09eb/page/p_6a7jcz4nsd' },
    { id: 'default-7', title: 'GUTS Ticket Checklist', description: 'A checklist for resolving GUTS tickets.', url: 'https://docs.google.com/spreadsheets/d/1VeKBxej95gIGqB2RhER9cRu-8DvD4kNcbL2PDIPMtp0/edit?gid=0#gid=0' }
];

// --- Helper Functions ---
const showMessage = (text, type = 'success') => {
    const messageBox = document.getElementById('message-box');
    messageBox.textContent = text;
    messageBox.className = 'message-box show';
    if (type === 'success') {
        messageBox.style.backgroundColor = '#10B981';
    } else if (type === 'error') {
        messageBox.style.backgroundColor = '#EF4444';
    }
    setTimeout(() => {
        messageBox.className = 'message-box';
    }, 3000);
};

   const clearTutorialHighlights = () => {
    document.querySelectorAll('.highlight-target').forEach(el => {
        el.classList.remove('highlight-target');
    });
};		

// This is the new, combined function that handles all tutorial logic
const showTutorialStep = async (stepIndex) => {
	    isTutorialActive = true;
    // Define the elements and their positions for each step
    const highlightedElements = [
        null, // Step 0 (Welcome)
        document.getElementById('add-response-section'), // Step 1: Add New Response
        document.getElementById('search-bar-container'), // Step 2: Search Bar
        document.getElementById('category-bar'), // Step 3: Categories
        document.getElementById('category-menu-container'), // Step 4: Kebab menu
        null, // Step 5: Will find dynamically below
        null, // Step 6: Will find dynamically below
        null, // Step 7: Dynamic Placeholders
        null, // Step 8: Placeholder Demo
		document.getElementById('hamburger-menu-btn'), // New Step 10: Highlights the hamburger icon
        document.getElementById('input-text-fedex'), // Step 11: FedEx Tracker
        document.getElementById('copy-button-fedex'), // Step 12: New highlight
    ];
    
    const positionClasses = [
        'show-modal', // Step 0: Centered modal
        'top-right',  // Step 1: Add response section
        'top-right',  // Step 2: Search bar
        'bottom-left', // Step 3: Category bar
        'upper-right', // Step 4: Kebab menu
        'on-response', // Step 5: Manage Responses (new)
        'on-response', // Step 6: Pin button (new)
        'left-response', // Step 7: Dynamic placeholders
        'show-modal', // Step 8: Placeholder demo
		'top-left',
        'on-tracker-page', // Step 10: New position
        'on-tracker-page' // Step 11: Position on the tracker page
    ];

    const tutorialModal = document.getElementById('tutorial-modal');
    const tutorialOverlay = document.getElementById('tutorial-overlay');

    tutorialSteps.forEach((step, index) => {
        if (index !== stepIndex) {
            step.classList.add('hidden');
        } else {
            step.classList.remove('hidden');
        }
    });
    // Determine the target page based on the tutorial step
    const targetPage = tutorialPages[stepIndex];

    // Check if a page change is required
    if (currentPage !== targetPage) {
        currentPage = targetPage;
        
        // Use a promise to wait for the page to render.
        // This is the crucial change to fix the race condition.
        await new Promise(resolve => {
            renderContent();
            requestAnimationFrame(() => {
                requestAnimationFrame(resolve);
            });
        });
    }
	
    // We now clear the highlights and hide the modal AFTER the page content is rendered.
    clearTutorialHighlights();
    tutorialModal.classList.remove(...positionClasses);

    const currentStepElement = tutorialSteps[stepIndex];
    if (currentStepElement) {
        currentStepElement.classList.remove('hidden');

        // Dynamically set highlights based on stepIndex
        if (stepIndex === 5) {
            const firstResponse = document.querySelector('.response-item');
            if (firstResponse) {
                const buttons = firstResponse.querySelectorAll('.copy-btn, .edit-btn, .delete-btn');
                buttons.forEach(button => button.classList.add('highlight-target'));
            }
        } else if (stepIndex === 6) {
            const firstResponse = document.querySelector('.response-item');
            if (firstResponse) {
                const pinButton = firstResponse.querySelector('.pin-btn');
                if (pinButton) pinButton.classList.add('highlight-target');
            }
        } else if (stepIndex === 7) {
            const responsesWithPlaceholders = [];
            if (categories[activeCategory]) {
                categories[activeCategory].responses.forEach(response => {
                    if (response.text.match(/\[([^\]]+)\]/g)) {
                        responsesWithPlaceholders.push(document.querySelector(`.response-item[data-id="${response.id}"]`));
                    }
                });
            }
            if (responsesWithPlaceholders.length === 0) {
                for (const category in categories) {
                    categories[category].responses.forEach(response => {
                        if (response.text.match(/\[([^\]]+)\]/g)) {
                            const foundResponse = document.querySelector(`.response-item[data-id="${response.id}"]`);
                            if (foundResponse) {
                                responsesWithPlaceholders.push(foundResponse);
                            }
                        }
                    });
                }
            }
            const responseToHighlight = responsesWithPlaceholders[0];
            if (responseToHighlight) {
                responseToHighlight.classList.add('highlight-target');
                if (responseToHighlight.dataset.category !== activeCategory) {
                    activeCategory = responseToHighlight.dataset.category;
                    renderCategories();
                    const newHighlight = document.querySelector(`.response-item[data-id="${responseToHighlight.dataset.id}"]`);
                    if (newHighlight) {
                        newHighlight.classList.add('highlight-target');
                        newHighlight.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                } else {
                    responseToHighlight.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            } else {
                console.warn("No canned response with dynamic placeholders found for the tutorial.");
            }
		} else if (stepIndex === 9) { // New logic for the hamburger icon
		const hamburgerBtn = document.getElementById('hamburger-menu-btn');
        hamburgerBtn.classList.add('highlight-target', 'bg-gray-700');	
			hamburgerBtn.scrollIntoView({
            		behavior: 'smooth',
            		block: 'start' // This positions the element at the top of the viewport
        });
        } else if (stepIndex === 10) {
            document.getElementById('input-text-fedex').classList.add('highlight-target');
            document.getElementById('input-text-fedex').scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        } else if (stepIndex === 11) {
            document.getElementById('copy-button-fedex').classList.add('highlight-target');
            document.getElementById('copy-button-fedex').scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        } else {
            const targetElement = highlightedElements[stepIndex];
            if (targetElement) {
                if (Array.isArray(targetElement)) {
                    targetElement.forEach(el => {
                        el.classList.add('highlight-target');
                    });
                } else {
                    targetElement.classList.add('highlight-target');
                }
            }
        }
    }

    // Now, show the modal with the correct positioning
    tutorialModal.classList.remove('hidden');
    tutorialOverlay.classList.remove('hidden');
    tutorialModal.classList.add('modal', positionClasses[stepIndex]);

    // Update button visibility
    const tutorialBackBtn = document.getElementById('tutorial-back-btn');
    const tutorialNextBtn = document.getElementById('tutorial-next-btn');
    const tutorialFinishBtn = document.getElementById('tutorial-finish-btn');
    tutorialBackBtn.classList.toggle('hidden', stepIndex === 0);
    tutorialNextBtn.classList.toggle('hidden', stepIndex === tutorialSteps.length - 1);
    tutorialFinishBtn.classList.toggle('hidden', stepIndex !== tutorialSteps.length - 1);

    currentTutorialStep = stepIndex;
};

const getCannedResponsesBlueprint = async () => { return defaultCannedResponsesBlueprint; };
const getHelpfulLinksBlueprint = async () => { return defaultHelpfulLinksBlueprint; };
const getUserCannedResponsesDocRef = (uid) => { return doc(db, 'artifacts', safeAppId, 'users', uid, 'canned_responses_data', 'app_data'); };
const getUserHelpfulLinksCollectionRef = (uid) => { return collection(db, 'artifacts', safeAppId, 'users', uid, 'helpful_links_data'); };
const getUserRootDocRef = (uid) => { return doc(db, 'artifacts', safeAppId, 'users', uid); }

const saveToFirestore = async (dataToSave) => {
    if (!userId || isAnonymous) {
        console.error("User not authenticated or is anonymous. Cannot save data.");
        showMessage("Please sign in to save your data.", 'error');
        return;
    }
    const userDocRef = getUserCannedResponsesDocRef(userId);
    try {
        const cleanedData = JSON.parse(JSON.stringify(dataToSave));
        for (const key in cleanedData) {
            if (!cleanedData[key].responses) {
                cleanedData[key].responses = [];
            }
        }
        await setDoc(userDocRef, { categories: cleanedData });
    } catch (error) {
        console.error("Error saving to Firestore:", error);
        showMessage("Error saving data. Check your permissions.", 'error');
    }
};

// --- Rendering Functions ---
const renderContent = () => {
    const cannedResponsesApp = document.getElementById('canned-responses-app');
    const fedexTrackerApp = document.getElementById('fedex-tracker-app');
    const helpfulLinksApp = document.getElementById('helpful-links-app');
    const settingsPage = document.getElementById('settings-page');
    const categoryBar = document.getElementById('category-bar');
    const mainTitle = document.getElementById('main-title');
    const categoryActionsBtn = document.getElementById('category-actions-btn');
    const categoryActionsMenu = document.getElementById('category-actions-menu');
    const addCategoryBtn = document.getElementById('add-category-btn');
    const addResponseSection = document.getElementById('add-response-section');
    const userLinksSection = document.getElementById('user-links-section');
    const addLinkSection = document.getElementById('add-link-section');
    const importExportBtnSettings = document.getElementById('import-export-btn-settings');
    const checkUpdatesBtnSettings = document.getElementById('check-updates-btn-settings');

    categoryActionsBtn.classList.add('hidden');
    categoryActionsMenu.classList.add('hidden');
    
    if (cannedResponsesApp) cannedResponsesApp.classList.add('hidden');
    if (fedexTrackerApp) fedexTrackerApp.classList.add('hidden');
    if (helpfulLinksApp) helpfulLinksApp.classList.add('hidden');
    if (settingsPage) settingsPage.classList.add('hidden');
    if (categoryBar) categoryBar.classList.add('hidden');
    
    if (currentPage === 'canned-responses') {
        cannedResponsesApp.classList.remove('hidden');
        categoryBar.classList.remove('hidden');
        mainTitle.textContent = 'Canned Responses';
        renderCategories();
        
        if (!isAnonymous) {
            addCategoryBtn.classList.remove('hidden');
            addResponseSection.classList.remove('hidden');
            if (Object.keys(categories).length > 0) {
                categoryActionsBtn.classList.remove('hidden');
            }
        } else {
            addCategoryBtn.classList.add('hidden');
            addResponseSection.classList.add('hidden');
            categoryActionsBtn.classList.add('hidden'); // Ensure it is hidden for anonymous users

        }
    } else if (currentPage === 'fedex-tracker') {
        fedexTrackerApp.classList.remove('hidden');
        mainTitle.textContent = 'FedEx Tracker';
        extractAndDisplayNumbers();
    } else if (currentPage === 'helpful-links') {
        helpfulLinksApp.classList.remove('hidden');
        mainTitle.textContent = 'Helpful Links';
        
        if (!renderedStaticLinks) {
            renderStaticLinks();
        }

        if (isAnonymous) {
            userLinksSection.classList.add('hidden');
            addLinkSection.classList.add('hidden');
        } else {
            userLinksSection.classList.remove('hidden');
            addLinkSection.classList.remove('hidden');
            renderUserLinks();
        }
    } else if (currentPage === 'settings') {
        settingsPage.classList.remove('hidden');
        mainTitle.textContent = 'Settings';
        renderSettingsPage();
        if (isAnonymous) {
            importExportBtnSettings.classList.add('hidden');
            checkUpdatesBtnSettings.classList.add('hidden');
        } else {
            importExportBtnSettings.classList.remove('hidden');
            checkUpdatesBtnSettings.classList.remove('hidden');
        }
    }
};

const renderCategories = () => {
    const categoryList = document.getElementById('category-list');
    const addResponseSection = document.getElementById('add-response-section');
    const searchBarContainer = document.getElementById('search-bar-container');
    const categoryActionsBtn = document.getElementById('category-actions-btn');
    const categoryActionsMenu = document.getElementById('category-actions-menu');

    categoryList.innerHTML = '';
    const categoryNames = Object.keys(categories);
    
if (!isAnonymous && categoryNames.length > 0) {
    if (categoryActionsBtn) categoryActionsBtn.classList.remove('hidden');
} else {
    if (categoryActionsBtn) {
        categoryActionsBtn.classList.add('hidden');
        categoryActionsMenu.classList.add('hidden');
    }
}

    if (!isAnonymous) {
        addResponseSection.classList.remove('hidden');
        searchBarContainer.classList.remove('hidden');
    }
    
    categoryNames.forEach(name => {
        const button = document.createElement('button');
		
         // Determine the border color based on the theme
        const activeClass = name === activeCategory ? 
            (document.body.classList.contains('light-mode') ? 'border-2 border-gray-900' : 'border-2 border-white') : 
            '';

        button.className = `category-item font-bold py-2 px-4 rounded-lg shadow-md text-white transition-colors
            ${activeClass}
            hover:scale-105 active:scale-95 transition-all duration-300`;
        // Get the original color from the categories object
        let categoryColor = categories[name].color || '#60a5fa';

        // Add this conditional logic to check for light mode
        if (document.body.classList.contains('light-mode')) {
            categoryColor = lightenColor(categoryColor);
        }

    // Apply the potentially modified color to the button background
    button.style.backgroundColor = categoryColor;

    // Corrected logic for setting the border color
    if (name === activeCategory) {
        button.style.borderColor = document.body.classList.contains('light-mode') ? '#111827' : '#FFFFFF';
    } else {
        // Set the border color to match the button background color when not active
        button.style.borderColor = categoryColor;
    }
    
    button.textContent = name;
    button.dataset.category = name;

    categoryList.appendChild(button);
    });
    
    if (!categories[activeCategory]) {
        activeCategory = categoryNames[0];
    }
    renderResponses();
};

const renderResponses = (searchQuery = '') => {
    const responsesList = document.getElementById('responses-list');
    const emptyState = document.getElementById('empty-state');
    const responsesHeading = document.getElementById('responses-heading');

    responsesList.innerHTML = '';
    
    let responsesToRender = [];
    let headingText = '';
    const query = searchQuery.toLowerCase();

    if (query) {
        let allResponses = [];
        for (const categoryName in categories) {
            allResponses = allResponses.concat(categories[categoryName].responses.map(r => ({...r, category: categoryName})));
        }
        
        let labelMatches = [];
        let textMatches = [];

        allResponses.forEach(r => {
            const labelMatch = r.label && r.label.toLowerCase().includes(query);
            const textMatch = r.text && r.text.toLowerCase().includes(query);
            
            if (labelMatch) {
                labelMatches.push(r);
            } else if (textMatch) {
                textMatches.push(r);
            }
        });
        
        responsesToRender = [...new Set([...labelMatches, ...textMatches])];
        headingText = 'Search Results';
    } else {
        if (categories[activeCategory]) {
            const allResponses = categories[activeCategory].responses.map(r => ({...r, category: activeCategory}));
            const pinnedResponses = allResponses.filter(r => r.isPinned);
            const unpinnedResponses = allResponses.filter(r => !r.isPinned);
            
            unpinnedResponses.sort((a, b) => (a.label || '').localeCompare(b.label || ''));
            responsesToRender = [...pinnedResponses, ...unpinnedResponses];
            headingText = `Responses in: ${activeCategory}`;
        } else {
            responsesToRender = [];
            headingText = 'No Active Category';
        }
    }
    
    document.title = (query ? 'Search Results' : `${activeCategory} - Canned Responses`);
    document.getElementById('main-title').textContent = (query ? 'Search Results' : 'Canned Responses');

    responsesHeading.textContent = headingText;
    responsesHeading.classList.remove('hidden');
    
    if (responsesToRender.length > 0) {
        emptyState.classList.add('hidden');
        const groupedResponses = responsesToRender.reduce((acc, response) => {
            const label = response.label || 'Unlabeled';
            if (!acc[label]) {
                acc[label] = [];
            }
            acc[label].push(response);
            return acc;
        }, {});

        for (const label in groupedResponses) {
            const labelSection = document.createElement('div');
            labelSection.className = 'mb-6';
            let highlightedLabel = label;
            if(query) {
                const regex = new RegExp(query, 'gi');
                highlightedLabel = label.replace(regex, `<span class="highlight">$&</span>`);
            }

            labelSection.innerHTML = `
                <h3 class="text-xl font-bold text-gray-400 mb-2">${highlightedLabel}</h3>
                <div class="space-y-4"></div>
            `;
            const responsesInSection = labelSection.querySelector('div');

            groupedResponses[label].forEach(response => {
                let displayText = response.text;
                if (query) {
                    const regex = new RegExp(query, 'gi');
                    displayText = displayText.replace(regex, `<span class="highlight">$&</span>`);
                }
                
                const responseEl = document.createElement('div');
				let categoryColor = categories[response.category].color || '#60a5fa';

                // Check the current theme and adjust the color
                if (document.body.classList.contains('light-mode')) {
                    categoryColor = lightenColor(categoryColor);
                }

                responseEl.className = 'response-item flex flex-col p-4 rounded-lg border relative';
                responseEl.style.backgroundColor = categoryColor;
                responseEl.style.borderColor = categoryColor;
                responseEl.dataset.id = response.id;
                responseEl.dataset.category = response.category;
                responseEl.innerHTML = `
                    <button class="pin-btn absolute top-3 right-3 p-2 rounded-full hover:bg-gray-600 transition-colors duration-200" title="Pin/Unpin" ${isAnonymous ? 'hidden' : ''}>
                        <i class="fas fa-thumbtack ${response.isPinned ? 'text-white' : 'text-gray-400'}"></i>
                    </button>
                    <div class="flex-grow display-mode space-y-2 w-full pt-8 sm:pt-0">
                        <p class="response-text-display text-gray-200 whitespace-pre-wrap">${displayText}</p>
                    </div>
                    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-600">
                        <button class="copy-btn bg-green-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-700 hover:scale-105 hover:shadow-md active:scale-95 transition-all duration-300">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <div class="flex space-x-2 ${isAnonymous ? 'hidden' : ''}">
                            <button class="edit-btn bg-yellow-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-yellow-600 hover:scale-105 hover:shadow-md active:scale-95 transition-all duration-300" data-id="${response.id}">
                                <i class="fas fa-pencil-alt"></i> Edit
                            </button>
                            <button class="delete-btn bg-red-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-700 hover:scale-105 hover:shadow-md active:scale-95 transition-all duration-300">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
                responsesInSection.appendChild(responseEl);
            });
            responsesList.appendChild(labelSection);
        }
        if (currentTutorialStep === 5 || currentTutorialStep === 6) {
            const firstResponse = document.querySelector('.response-item');
            if (firstResponse) {
                if (currentTutorialStep === 5) {
                    // Highlight the copy, edit, and delete buttons
                    const buttons = firstResponse.querySelectorAll('.copy-btn, .edit-btn, .delete-btn');
                    buttons.forEach(button => button.classList.add('highlight-target'));
                } else if (currentTutorialStep === 6) {
                    // Highlight the pin button
                    const pinButton = firstResponse.querySelector('.pin-btn');
                    if (pinButton) pinButton.classList.add('highlight-target');
                }
            }
        }		
    } else {
        emptyState.classList.add('hidden');
    }
};

const addResponse = async (text, label, category) => {
    if (isAnonymous) {
        showMessage("Please sign in to add responses.", 'error');
        return;
    }
    const newId = Date.now().toString();
    const newResponse = { id: newId, text: text, label: label || '', isPinned: false, createdAt: new Date().toISOString() };
    const updatedCategories = JSON.parse(JSON.stringify(categories));
    if (!updatedCategories[category]) {
        updatedCategories[category] = { color: categories[category]?.color || '#60a5fa', responses: [] };
    }
    if (!updatedCategories[category].responses) {
        updatedCategories[category].responses = [];
    }
    updatedCategories[category].responses.push(newResponse);
    saveToFirestore(updatedCategories);
    showMessage("Response added successfully!");
};
const updateResponse = (id, newText, newLabel, newCategory, oldCategory) => {
    if (isAnonymous) {
        showMessage("Please sign in to edit responses.", 'error');
        return;
    }
    const updatedCategories = JSON.parse(JSON.stringify(categories));
    const oldResponsesList = updatedCategories[oldCategory]?.responses || [];
    const responseToUpdate = oldResponsesList.find(r => r.id === id);
    if (!responseToUpdate) {
        showMessage("Error: The response no longer exists in its original category.", 'error');
        return;
    }
    if (newCategory && newCategory !== oldCategory) {
        const index = oldResponsesList.findIndex(r => r.id === id);
        if (index > -1) {
            oldResponsesList.splice(index, 1);
        }
        if (!updatedCategories[newCategory]) {
            updatedCategories[newCategory] = { color: updatedCategories[newCategory]?.color || '#60a5fa', responses: [] };
        }
        if (!updatedCategories[newCategory].responses) {
            updatedCategories[newCategory].responses = [];
        }
        responseToUpdate.text = newText;
        responseToUpdate.label = newLabel || '';
        updatedCategories[newCategory].responses.push(responseToUpdate);
        activeCategory = newCategory;
    } else {
        responseToUpdate.text = newText;
        responseToUpdate.label = newLabel || '';
    }
    saveToFirestore(updatedCategories);
    showMessage("Response updated successfully!");
};
const deleteResponse = (id, categoryName) => {
    if (isAnonymous) {
        showMessage("Please sign in to delete responses.", 'error');
        return;
    }
    if (!categoryName || !categories[categoryName] || !categories[categoryName].responses) return;
    const updatedCategories = JSON.parse(JSON.stringify(categories));
    updatedCategories[categoryName].responses = updatedCategories[categoryName].responses.filter(r => r.id !== id);
    saveToFirestore(updatedCategories);
    showMessage("Response deleted successfully!");
};
const copyToClipboard = (text) => {
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    showMessage("Copied to clipboard!");
};
const exportData = () => {
    if (isAnonymous) {
        showMessage("Please sign in to export data.", 'error');
        return;
    }
    const dataStr = JSON.stringify(categories, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'canned_responses.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showMessage("Data exported successfully!");
};
const importData = (file) => {
    if (isAnonymous) {
        showMessage("Please sign in to import data.", 'error');
        return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const importedData = JSON.parse(e.target.result);
            if (typeof importedData === 'object' && importedData !== null) {
                categories = importedData;
                const categoryNames = Object.keys(categories);
                if (categoryNames.length > 0) {
                    activeCategory = categoryNames[0];
                } else {
                    activeCategory = '';
                }
                saveToFirestore(categories);
                showMessage("Data imported successfully!");
                importExportModal.classList.add('hidden');
            } else {
                throw new Error('Invalid JSON format.');
            }
        } catch (error) {
            showMessage(`Error importing file: ${error.message}`, 'error');
        }
    };
    reader.readAsText(file);
};
const placeholderRegex = /\[([^\]]+)\]/g;
const processAndCopy = (text) => {
    const placeholderInputsContainer = document.getElementById('placeholder-inputs');
    const placeholderModal = document.getElementById('placeholder-modal');
    currentTextToCopy = text;
    const matches = text.match(placeholderRegex);
    const placeholders = matches ? [...new Set(matches.map(m => m.slice(1, -1)))] : [];
    if (placeholders.length > 0 && !(placeholders.length === 1 && placeholders[0] === 'Name')) {
        placeholderInputsContainer.innerHTML = '';
        const today = new Date().toISOString().split('T')[0];
        placeholders.forEach(placeholder => {
            if (placeholder !== 'Name') {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'flex flex-col';
                const label = document.createElement('label');
                label.className = 'block text-sm font-medium text-gray-400 mb-1';
                label.textContent = placeholder;
                let input;
                if (placeholder.toLowerCase().includes('date')) {
                    input = document.createElement('input');
                    input.type = 'date';
                    input.value = today;
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                }
                input.dataset.placeholder = placeholder;
                input.id = `placeholder-${placeholder.replace(/\s/g, '-')}`;
                input.className = 'w-full border-2 border-gray-600 rounded-xl p-3 bg-gray-700 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-lg';
                inputGroup.appendChild(label);
                inputGroup.appendChild(input);
                placeholderInputsContainer.appendChild(inputGroup);
            }
        });
        placeholderModal.classList.remove('hidden');
        document.querySelector('#placeholder-inputs input')?.focus();
    } else {
        const finalContent = replacePlaceholders(currentTextToCopy, {});
        copyToClipboard(finalContent);
    }
};
const replacePlaceholders = (text, userValues) => {
    let result = text;
    result = result.replace(/\[Name\]/g, userName);
    for (const key in userValues) {
        const regex = new RegExp(`\\[${key}\\]`, 'g');
        result = result.replace(regex, userValues[key]);
    }
    return result;
};
const renderStaticLinks = () => {
    const staticLinksList = document.getElementById('static-links-list');
    if (renderedStaticLinks) return;
    staticLinksList.innerHTML = '';
    if (defaultLinks.length > 0) {
        defaultLinks.forEach(link => {
            const card = document.createElement('div');
            card.className = 'link-card rounded-xl p-6 shadow-2xl pulse-effect';
            const descriptionText = link.description || 'No description available.';
            card.innerHTML = `
                <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="block">
                    <h3 class="font-bold text-xl text-white hover:text-sky-300 transition-colors mb-2">${link.title}</h3>
                    <p class="text-sm text-gray-400">${descriptionText}</p>
                </a>
            `;
            staticLinksList.appendChild(card);
        });
    } else {
        staticLinksList.innerHTML = '<p class="text-center text-gray-400 col-span-full">No static links found.</p>';
    }
    renderedStaticLinks = true;
}
const renderUserLinks = () => {
    const userLinksList = document.getElementById('user-links-list');
    userLinksList.innerHTML = '';
    if (userLinks && userLinks.length > 0) {
        userLinks.forEach(link => {
            const card = document.createElement('div');
            card.className = 'link-card rounded-xl p-6 shadow-2xl pulse-effect flex items-center justify-between relative';
            card.innerHTML = `
                <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="flex-grow">
                    <h3 class="font-bold text-xl text-white hover:text-sky-300 transition-colors mb-2">${link.title}</h3>
                    <p class="text-sm text-gray-400">${link.description || 'No description available.'}</p>
                </a>
                <div class="relative inline-block text-left" data-doc-id="${link.id}" data-title="${link.title}" data-url="${link.url}" data-description="${link.description || ''}">
                    <button type="button" class="meatballs-button p-2 text-gray-400 hover:text-white transition-colors" aria-expanded="true" aria-haspopup="true">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 pointer-events-none">
                            <path d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM11.5 15a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z" />
                        </svg>
                    </button>
                    <div class="meatballs-menu hidden absolute right-0 mt-2 w-48 origin-top-right rounded-md bg-gray-700 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-10">
                        <div class="py-1">
                            <button class="edit-link-btn text-gray-200 block w-full text-left px-4 py-2 text-sm hover:bg-gray-600">Edit</button>
                            <button class="delete-link-btn text-red-400 block w-full text-left px-4 py-2 text-sm hover:bg-gray-600">Delete</button>
                        </div>
                    </div>
                </div>
            `;
            userLinksList.appendChild(card);
        });
    } else {
        userLinksList.innerHTML = '<p class="text-center text-gray-400 col-span-full">No links added yet. Add one above!</p>';
    }
};
const renderHelpfulLinks = () => {
    const userLinksSection = document.getElementById('user-links-section');
    const addLinkSection = document.getElementById('add-link-section');
    if (!renderedStaticLinks) {
        renderStaticLinks();
    }
    if (isAnonymous) {
        userLinksSection.classList.add('hidden');
        addLinkSection.classList.add('hidden');
    } else {
        userLinksSection.classList.remove('hidden');
        addLinkSection.classList.remove('hidden');
        renderUserLinks();
    }
};
const showLinksStatus = (message, colorClass) => {
    const linksStatusMessage = document.getElementById('status-message');
    linksStatusMessage.textContent = message;
    linksStatusMessage.className = `text-center mt-2 text-sm font-semibold ${colorClass}`;
    setTimeout(() => {
        linksStatusMessage.textContent = '';
        linksStatusMessage.className = 'text-center mt-2 text-sm text-gray-400';
    }, 3000);
};
const resetLinksForm = () => {
    const linksFormTitle = document.getElementById('form-title');
    const linkTitleInput = document.getElementById('link-title');
    const linkUrlInput = document.getElementById('link-url');
    const linkDescriptionInput = document.getElementById('link-description');
    const linksSubmitButton = document.getElementById('submit-button');
    const linksCancelButton = document.getElementById('cancel-button');
    linksFormTitle.textContent = "Add a New Link";
    linkTitleInput.value = '';
    linkUrlInput.value = '';
    linkDescriptionInput.value = '';
    linksSubmitButton.textContent = 'Add Link';
    linksCancelButton.classList.add('hidden');
    editingLinkDocId = null;
};
const editLink = (docId, title, url, description) => {
    const linksFormTitle = document.getElementById('form-title');
    const linkTitleInput = document.getElementById('link-title');
    const linkUrlInput = document.getElementById('link-url');
    const linkDescriptionInput = document.getElementById('link-description');
    const linksSubmitButton = document.getElementById('submit-button');
    const linksCancelButton = document.getElementById('cancel-button');
    const addLinkSection = document.getElementById('add-link-section');
    linksFormTitle.textContent = "Edit Link";
    linkTitleInput.value = title;
    linkUrlInput.value = url;
    linkDescriptionInput.value = description;
    linksSubmitButton.textContent = 'Save Changes';
    linksCancelButton.classList.remove('hidden');
    editingLinkDocId = docId;
    addLinkSection.scrollIntoView({ behavior: 'smooth' });
};
const deleteLink = async (docId) => {
    if (!db || !userId || isAnonymous) {
        showLinksStatus('Please sign in to delete links.', 'text-red-400');
        return;
    }
    const docRef = doc(db, 'artifacts', safeAppId, 'users', userId, 'helpful_links_data', docId);
    try {
        await deleteDoc(docRef);
        showLinksStatus('Link deleted successfully!', 'text-green-400');
    } catch (error) {
        console.error("Error deleting link:", error);
        showLinksStatus(`Failed to delete link: ${error.message}`, 'text-red-400');
    }
};
const extractAndDisplayNumbers = () => {
    const fedexRegex = /(?:78\d{10}|79\d{10}|80\d{10}|81\d{10}|82\d{10}|(?:96\d{20}|96\d{32}|\d{15}|\d{12}))/g;
    const inputTextareaFedex = document.getElementById('input-text-fedex');
    const trackingNumbersContainer = document.getElementById('tracking-numbers-container');
    const noNumbersMessage = document.getElementById('no-numbers-message');
    const text = inputTextareaFedex.value;
    const matches = text.match(fedexRegex) || [];
    const uniqueMatches = [...new Set(matches)];
    trackingNumbersContainer.innerHTML = '';
    if (uniqueMatches.length > 0) {
        noNumbersMessage.classList.add('hidden');
        uniqueMatches.forEach(num => {
            const div = document.createElement('div');
            div.className = 'tracking-tab flex items-center justify-between p-3 rounded-lg shadow-md mb-2';
            div.innerHTML = `
                <span class="text-sm font-semibold">${num}</span>
                <button class="copy-tracking-btn bg-indigo-500 text-white text-xs px-2 py-1 rounded-full hover:bg-indigo-400 transition-colors">
                    Copy
                </button>
            `;
            trackingNumbersContainer.appendChild(div);
        });
    } else {
        noNumbersMessage.classList.remove('hidden');
    }
    document.querySelectorAll('.copy-tracking-btn').forEach(button => {
        button.addEventListener('click', () => {
            const number = button.previousElementSibling.textContent;
            copyToClipboard(number);
        });
    });
};
const renderSettingsPage = () => {
    const themeIconSettings = document.getElementById('theme-icon-settings');
    const authStatusSettings = document.getElementById('auth-status-settings');
    const signInBtn = document.getElementById('sign-in-btn-settings');
    const signOutBtn = document.getElementById('sign-out-btn-settings');
    const tutorialResetSection = document.getElementById('tutorial-reset-section');
    const importExportBtnSettings = document.getElementById('import-export-btn-settings');
    const checkUpdatesBtnSettings = document.getElementById('check-updates-btn-settings');

    if (document.body.classList.contains('light-mode')) {
        themeIconSettings.className = 'fas fa-sun mr-2';
    } else {
        themeIconSettings.className = 'fas fa-moon mr-2';
    }
    if (auth.currentUser) {
        const displayName = auth.currentUser.displayName || auth.currentUser.email || 'User';
        authStatusSettings.textContent = `Signed in as: ${displayName}`;
        authStatusSettings.title = auth.currentUser.email;
        if (isAnonymous) {
            signInBtn.classList.remove('hidden');
            signOutBtn.classList.add('hidden');
            tutorialResetSection.classList.add('hidden');
        } else {
            signInBtn.classList.add('hidden');
            signOutBtn.classList.remove('hidden');
            tutorialResetSection.classList.remove('hidden');
        }
    } else {
        authStatusSettings.textContent = 'Not signed in.';
        signInBtn.classList.remove('hidden');
        signOutBtn.classList.add('hidden');
        tutorialResetSection.classList.add('hidden');
    }
    if (isAnonymous) {
        importExportBtnSettings.classList.add('hidden');
        checkUpdatesBtnSettings.classList.add('hidden');
    } else {
        importExportBtnSettings.classList.remove('hidden');
        checkUpdatesBtnSettings.classList.remove('hidden');
    }
};

const showPlaceholderDemo = () => {
    const tutorialModal = document.getElementById('tutorial-modal');
    const tutorialOverlay = document.getElementById('tutorial-overlay');

    // Get the element that is highlighted for the tutorial
    const highlightedResponse = document.querySelector('.response-item.highlight-target');

    // Check if the highlighted element exists and has the necessary text
    if (highlightedResponse) {
        const textToCopy = highlightedResponse.querySelector('.response-text-display').textContent;
        processAndCopy(textToCopy);
    } else {
        // Fallback or error handling if the highlighted item isn't found
        console.error("No highlighted response found for the tutorial demo.");
        const fallbackText = "Hello [Customer's Name], this is a default message. There was an issue loading the dynamic placeholder example.";
        processAndCopy(fallbackText);
    }

    // Hide the tutorial modal and overlay so the placeholder modal is the main focus
    tutorialModal.classList.add('hidden');
    tutorialOverlay.classList.add('hidden');
};


// --- All Event Listeners (Correctly placed to be attached only once) ---
function attachEventListeners() {
    // Navigation Listeners
    document.getElementById('hamburger-menu-btn').addEventListener('click', () => { document.getElementById('sidebar').classList.toggle('open'); });
    document.getElementById('close-sidebar-btn').addEventListener('click', () => { document.getElementById('sidebar').classList.remove('open'); });
    document.getElementById('nav-canned-responses').addEventListener('click', () => { currentPage = 'canned-responses'; renderContent(); document.getElementById('sidebar').classList.remove('open'); });
    document.getElementById('nav-fedex-tracker').addEventListener('click', () => { currentPage = 'fedex-tracker'; renderContent(); document.getElementById('sidebar').classList.remove('open'); });
    document.getElementById('nav-helpful-links').addEventListener('click', () => { currentPage = 'helpful-links'; renderContent(); document.getElementById('sidebar').classList.remove('open'); });
    document.getElementById('nav-settings').addEventListener('click', () => { currentPage = 'settings'; renderContent(); document.getElementById('sidebar').classList.remove('open'); });
    
    // Form Submission Listener (Attached only once)
    document.getElementById('add-link-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isSubmittingLink) { console.warn("Preventing duplicate form submission."); return; }
        if (!db || !userId || isAnonymous) { showLinksStatus('Please sign in to manage your links.', 'text-yellow-400'); return; }
        const title = document.getElementById('link-title').value;
        const url = document.getElementById('link-url').value;
        const description = document.getElementById('link-description').value;
        if (!title || !url) { showLinksStatus('Please fill out all required fields.', 'text-red-400'); return; }
        isSubmittingLink = true;
        try {
            if (editingLinkDocId) {
                showLinksStatus('Updating link...', 'text-yellow-400');
                const docRef = doc(db, 'artifacts', safeAppId, 'users', userId, 'helpful_links_data', editingLinkDocId);
                await updateDoc(docRef, { title, url, description });
                showLinksStatus('Link updated successfully!', 'text-green-400');
            } else {
                showLinksStatus('Adding link...', 'text-yellow-400');
                const linksCollectionRef = getUserHelpfulLinksCollectionRef(userId);
                await addDoc(linksCollectionRef, { title, url, description, createdAt: new Date() });
                showLinksStatus('Link added successfully!', 'text-green-400');
            }
            resetLinksForm();
        } catch (error) {
            console.error("Error during link operation:", error);
            showLinksStatus(`Failed to save link: ${error.message}`, 'text-red-400');
        } finally {
            isSubmittingLink = false;
        }
    });

    // Other one-time listeners
    document.getElementById('cancel-button').addEventListener('click', () => { resetLinksForm(); });
    document.getElementById('user-links-list').addEventListener('click', (event) => {
        if (isAnonymous) return;
        const button = event.target.closest('.meatballs-button');
        const editBtn = event.target.closest('.edit-link-btn');
        const deleteBtn = event.target.closest('.delete-link-btn');
        if (button) {
            event.stopPropagation();
            const parentDiv = button.closest('[data-doc-id]');
            const menu = parentDiv.querySelector('.meatballs-menu');
            if (menu) {
                const isHidden = menu.classList.contains('hidden');
                document.querySelectorAll('.meatballs-menu').forEach(m => m.classList.add('hidden'));
                if (isHidden) { menu.classList.remove('hidden'); openMenuId = parentDiv.dataset.docId; } else { openMenuId = null; }
            }
        } else if (editBtn) {
            event.stopPropagation();
            const parentDiv = editBtn.closest('[data-doc-id]');
            if (parentDiv) {
                const { docId, title, url, description } = parentDiv.dataset;
                editLink(docId, title, url, description);
                const menu = parentDiv.querySelector('.meatballs-menu');
                if (menu) menu.classList.add('hidden');
                openMenuId = null;
            }
        } else if (deleteBtn) {
            event.stopPropagation();
            const parentDiv = deleteBtn.closest('[data-doc-id]');
            if (parentDiv) {
                deleteLink(parentDiv.dataset.docId);
                const menu = parentDiv.querySelector('.meatballs-menu');
                if (menu) menu.classList.add('hidden');
                openMenuId = null;
            }
        }
    });
    
    document.addEventListener('click', (event) => {
        const isClickInsideCategoryActions = event.target.closest('#category-actions-menu') || event.target.closest('#category-actions-btn');
        const isClickInsideMeatballsMenu = event.target.closest('.meatballs-menu') || event.target.closest('.meatballs-button');
        const categoryActionsMenu = document.getElementById('category-actions-menu');
        const categoryActionsBtn = document.getElementById('category-actions-btn');
        if (!categoryActionsMenu.contains(event.target) && !categoryActionsBtn.contains(event.target)) {
            categoryActionsMenu.classList.add('hidden', 'scale-95', 'opacity-0');
            categoryActionsBtn.classList.remove('active');
        }
        if (!isClickInsideMeatballsMenu) {
            document.querySelectorAll('.meatballs-menu').forEach(m => m.classList.add('hidden'));
            openMenuId = null;
        }
    });
    
    document.getElementById('close-login-popup-btn').addEventListener('click', async () => {
        document.getElementById('login-popup-modal').classList.remove('show');
        document.getElementById('login-popup-modal').classList.add('hidden');
        if (userId) {
            const userDocRef = getUserRootDocRef(userId);
            try { await setDoc(userDocRef, { hasSeenLoginPrompt: true }, { merge: true }); } catch (error) { console.error("Error setting hasSeenLoginPrompt flag:", error); }
        }
    });
    document.getElementById('login-popup-btn').addEventListener('click', async () => {
        document.getElementById('login-popup-modal').classList.remove('show');
        document.getElementById('login-popup-modal').classList.add('hidden');
        if (userId) {
            const userDocRef = getUserRootDocRef(userId);
            try { await setDoc(userDocRef, { hasSeenLoginPrompt: true }, { merge: true }); } catch (error) { console.error("Error setting hasSeenLoginPrompt flag:", error); }
        }
        try { const provider = new GoogleAuthProvider(); await signInWithPopup(auth, provider); showMessage("Signed in with Google!"); } catch (error) { console.error("Google sign-in failed", error); showMessage("Google sign-in failed. Please try again.", 'error'); }
    });

    document.getElementById('close-copy-success-btn').addEventListener('click', () => {
        document.getElementById('copy-success-modal').classList.add('hidden');
    
    });
    
// --- Tutorial Listeners (Corrected) ---
    document.getElementById('tutorial-next-btn').addEventListener('click', () => {
        if (currentTutorialStep < tutorialSteps.length - 1) {
            currentTutorialStep++;
            showTutorialStep(currentTutorialStep);
        }
    });

    document.getElementById('tutorial-back-btn').addEventListener('click', () => {
        if (currentTutorialStep > 0) {
            currentTutorialStep--;
            showTutorialStep(currentTutorialStep);
        }
    });

    document.getElementById('tutorial-finish-btn').addEventListener('click', async () => {
		 isTutorialActive = false;
        // Clear all highlights before hiding the modal
        clearTutorialHighlights();
        
        document.getElementById('tutorial-modal').classList.add('hidden');
        document.getElementById('tutorial-overlay').classList.add('hidden'); 
        
        if (userId) {
            const userDocRef = getUserRootDocRef(userId);
            try {
                await setDoc(userDocRef, { tutorialSeen: true }, { merge: true });
            } catch (error) {
                console.error("Error setting tutorialSeen flag:", error);
            }
        }
    });

    document.getElementById('show-tutorial-btn').addEventListener('click', async () => {
    if (userId && !isAnonymous) {
        const userDocRef = getUserRootDocRef(userId);
        try {
            await setDoc(userDocRef, { tutorialSeen: false }, { merge: true });
            showTutorialStep(0); // This function call will now handle displaying the modal
        } catch (error) {
            console.error("Error resetting tutorialSeen flag:", error);
            showMessage("Error showing tutorial. Please try again.", 'error');
        }
    } else {
        showMessage("Please sign in to view the tutorial.", 'error');
    }
});

    document.getElementById('theme-toggle-btn-settings').addEventListener('click', () => {
        document.body.classList.toggle('light-mode');
        localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        const icon = document.getElementById('theme-toggle-btn-settings').querySelector('i');
        icon.className = document.body.classList.contains('light-mode') ? 'fas fa-sun mr-2' : 'fas fa-moon mr-2';
    });
    document.getElementById('category-list').addEventListener('click', (e) => {
        const button = e.target.closest('.category-item');
        if (button) {
            const newCategory = button.dataset.category;
            if (newCategory !== activeCategory) {
                activeCategory = newCategory;
                renderCategories();
            }
        }
    });
    document.getElementById('responses-list').addEventListener('click', (e) => {
        const copyBtn = e.target.closest('.copy-btn');
        const editBtn = e.target.closest('.edit-btn');
        const deleteBtn = e.target.closest('.delete-btn');
        const pinBtn = e.target.closest('.pin-btn');
        if (copyBtn) {
            const responseItem = copyBtn.closest('.response-item');
            const textToCopy = responseItem.querySelector('.response-text-display').textContent;
            processAndCopy(textToCopy);
        }
        if (editBtn) {
            const responseItem = editBtn.closest('.response-item');
            const id = responseItem.dataset.id;
            const category = responseItem.dataset.category;
            const responseData = categories[category].responses.find(r => r.id === id);
            if (responseData) {
                document.getElementById('edit-response-label').value = responseData.label || '';
                document.getElementById('edit-response-text').value = responseData.text;
                document.getElementById('edit-response-modal').dataset.originalId = responseData.id;
                document.getElementById('edit-response-modal').dataset.originalCategory = category;
                const editCategorySelect = document.getElementById('edit-category-select');
                editCategorySelect.innerHTML = '';
                const categoryNames = Object.keys(categories);
                categoryNames.forEach(catName => {
                    const option = document.createElement('option');
                    option.value = catName;
                    option.textContent = catName;
                    if (catName === category) option.selected = true;
                    editCategorySelect.appendChild(option);
                });
                document.getElementById('edit-response-modal').classList.remove('hidden');
            }
        }
        if (deleteBtn) {
            const responseItem = deleteBtn.closest('.response-item');
            responseToDeleteId = responseItem.dataset.id;
            const category = responseItem.dataset.category;
            document.getElementById('delete-modal').dataset.category = category;
            document.getElementById('delete-modal').classList.remove('hidden');
        }
        if (pinBtn) {
            const responseItem = pinBtn.closest('.response-item');
            const id = responseItem.dataset.id;
            const category = responseItem.dataset.category;
            const responseData = categories[category].responses.find(r => r.id === id);
            if (responseData) {
                responseData.isPinned = !responseData.isPinned;
                saveToFirestore(categories);
            }
        }
    });
    document.getElementById('open-add-response-modal-btn').addEventListener('click', () => {
        document.getElementById('new-response-modal').classList.remove('hidden');
        document.getElementById('new-response-label').value = '';
        document.getElementById('new-response-text').value = '';
        const newResponseCategorySelect = document.getElementById('new-response-category');
        newResponseCategorySelect.innerHTML = '';
        const categoryNames = Object.keys(categories);
        categoryNames.forEach(catName => {
            const option = document.createElement('option');
            option.value = catName;
            option.textContent = catName;
            if (catName === activeCategory) option.selected = true;
            newResponseCategorySelect.appendChild(option);
        });
    });
    document.getElementById('cancel-new-response-btn').addEventListener('click', () => { document.getElementById('new-response-modal').classList.add('hidden'); });
    document.getElementById('save-new-response-btn').addEventListener('click', () => {
        const label = document.getElementById('new-response-label').value;
        const text = document.getElementById('new-response-text').value;
        const category = document.getElementById('new-response-category').value;
        if (text.trim() !== '') { addResponse(text, label, category); document.getElementById('new-response-modal').classList.add('hidden'); } else { showMessage("Response text cannot be empty.", 'error'); }
    });
    document.getElementById('cancel-edit-btn').addEventListener('click', () => { document.getElementById('edit-response-modal').classList.add('hidden'); currentEditingId = null; });
    document.getElementById('save-edit-btn').addEventListener('click', () => {
        const id = document.getElementById('edit-response-modal').dataset.originalId;
        const oldCategory = document.getElementById('edit-response-modal').dataset.originalCategory;
        const newLabel = document.getElementById('edit-response-label').value;
        const newText = document.getElementById('edit-response-text').value;
        const newCategory = document.getElementById('edit-category-select').value;
        if (newText.trim() !== '') { updateResponse(id, newText, newLabel, newCategory, oldCategory); document.getElementById('edit-response-modal').classList.add('hidden'); currentEditingId = null; } else { showMessage("Response text cannot be empty.", 'error'); }
    });
    document.getElementById('delete-confirm-btn').addEventListener('click', () => {
        const category = document.getElementById('delete-modal').dataset.category;
        deleteResponse(responseToDeleteId, category);
        document.getElementById('delete-modal').classList.add('hidden');
    });
    document.getElementById('delete-cancel-btn').addEventListener('click', () => { document.getElementById('delete-modal').classList.add('hidden'); responseToDeleteId = null; });
    document.getElementById('search-input').addEventListener('input', () => { renderResponses(document.getElementById('search-input').value); });
    document.getElementById('add-category-btn').addEventListener('click', () => { document.getElementById('add-category-modal').classList.remove('hidden'); document.getElementById('add-category-input').focus(); });
    document.getElementById('cancel-add-category-btn').addEventListener('click', () => { document.getElementById('add-category-modal').classList.add('hidden'); document.getElementById('add-category-input').value = ''; });
    document.getElementById('confirm-add-category-btn').addEventListener('click', () => {
        const newCategoryName = document.getElementById('add-category-input').value.trim();
        if (newCategoryName && !categories[newCategoryName]) {
            const updatedCategories = JSON.parse(JSON.stringify(categories));
            updatedCategories[newCategoryName] = { color: '#60a5fa', responses: [] };
            saveToFirestore(updatedCategories);
            activeCategory = newCategoryName;
            document.getElementById('add-category-modal').classList.add('hidden');
            document.getElementById('add-category-input').value = '';
            showMessage("Category created successfully!");
        } else if (categories[newCategoryName]) {
            showMessage("Category already exists.", 'error');
        }
    });
    document.getElementById('category-actions-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        const categoryActionsMenu = document.getElementById('category-actions-menu');
        categoryActionsMenu.classList.toggle('hidden');
        categoryActionsMenu.classList.toggle('scale-95');
        categoryActionsMenu.classList.toggle('opacity-0');
        document.getElementById('category-actions-btn').classList.toggle('active');
    });
    document.getElementById('rename-category-btn').addEventListener('click', () => {
        const editCategoryModal = document.getElementById('edit-category-modal');
        const editCategoryInput = document.getElementById('edit-category-input');
        const categoryActionsMenu = document.getElementById('category-actions-menu');
        editCategoryModal.classList.remove('hidden');
        editCategoryInput.value = activeCategory;
        categoryToEdit = activeCategory;
        categoryActionsMenu.classList.add('hidden');
    });
    document.getElementById('cancel-edit-category-btn').addEventListener('click', () => { document.getElementById('edit-category-modal').classList.add('hidden'); });
    document.getElementById('confirm-edit-category-btn').addEventListener('click', () => {
        const newName = document.getElementById('edit-category-input').value.trim();
        if (newName && newName !== categoryToEdit) {
            const updatedCategories = JSON.parse(JSON.stringify(categories));
            if (updatedCategories[newName]) { showMessage("A category with that name already exists.", 'error'); return; }
            const oldCategoryData = updatedCategories[categoryToEdit];
            delete updatedCategories[categoryToEdit];
            updatedCategories[newName] = oldCategoryData;
            saveToFirestore(updatedCategories);
            activeCategory = newName;
            document.getElementById('edit-category-modal').classList.add('hidden');
            showMessage("Category renamed successfully!");
        } else { document.getElementById('edit-category-modal').classList.add('hidden'); }
    });
    document.getElementById('delete-category-btn').addEventListener('click', () => { document.getElementById('delete-category-modal').classList.remove('hidden'); document.getElementById('category-actions-menu').classList.add('hidden'); });
    document.getElementById('cancel-delete-category-btn').addEventListener('click', () => { document.getElementById('delete-category-modal').classList.add('hidden'); });
    document.getElementById('confirm-delete-category-btn').addEventListener('click', () => {
        const updatedCategories = JSON.parse(JSON.stringify(categories));
        delete updatedCategories[activeCategory];
        const categoryNames = Object.keys(updatedCategories);
        activeCategory = categoryNames.length > 0 ? categoryNames[0] : '';
        saveToFirestore(updatedCategories);
        document.getElementById('delete-category-modal').classList.add('hidden');
        showMessage("Category deleted successfully!");
    });
    document.getElementById('change-color-btn').addEventListener('click', () => {
        const colorPickerModal = document.getElementById('color-picker-modal');
        const colorInput = document.getElementById('color-input');
        colorPickerModal.classList.remove('hidden');
        const currentColor = categories[activeCategory]?.color || '#60a5fa';
        colorInput.value = currentColor;
        document.getElementById('category-actions-menu').classList.add('hidden');
    });
    document.getElementById('close-color-picker-btn').addEventListener('click', () => { document.getElementById('color-picker-modal').classList.add('hidden'); });
    document.getElementById('save-color-btn').addEventListener('click', () => {
        const newColor = document.getElementById('color-input').value;
        const updatedCategories = JSON.parse(JSON.stringify(categories));
        if (updatedCategories[activeCategory]) {
            updatedCategories[activeCategory].color = newColor;
            saveToFirestore(updatedCategories);
            document.getElementById('color-picker-modal').classList.add('hidden');
            showMessage("Color updated successfully!");
        }
    });
    document.getElementById('input-text-fedex').addEventListener('input', extractAndDisplayNumbers);
    document.getElementById('clear-button-fedex').addEventListener('click', () => {
        document.getElementById('input-text-fedex').value = '';
        extractAndDisplayNumbers();
        showMessage('Input cleared!', 'success');
    });
    document.getElementById('copy-button-fedex').addEventListener('click', () => {
        const text = document.getElementById('input-text-fedex').value;
        const fedexRegex = /(?:78\d{10}|79\d{10}|80\d{10}|81\d{10}|82\d{10}|(?:96\d{20}|96\d{32}|\d{15}|\d{12}))/g;
        const matches = text.match(fedexRegex) || [];
        if (matches.length > 0) {
            const uniqueNumbers = [...new Set(matches)];
            const numbersToCopy = uniqueNumbers.join('\t');
            copyToClipboard(numbersToCopy);
            const numbersForUrl = uniqueNumbers.join(',');
            const encodedNumbers = encodeURIComponent(numbersForUrl);
            const fedexUrl = `https://www.fedex.com/en-us/tracking.html?tracknumbers=${encodedNumbers}`;
            window.open(fedexUrl, '_blank');
        } else {
            showMessage('No tracking numbers to copy.', 'error');
        }
    });
    document.getElementById('import-export-btn-settings').addEventListener('click', () => { document.getElementById('import-export-modal').classList.remove('hidden'); });
    document.getElementById('close-import-export-modal-btn').addEventListener('click', () => { document.getElementById('import-export-modal').classList.add('hidden'); });
    document.getElementById('export-btn').addEventListener('click', () => { exportData(); });
    document.getElementById('import-file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) importData(file);
    });
    document.getElementById('confirm-placeholder-btn').addEventListener('click', () => {
        const inputs = document.getElementById('placeholder-inputs').querySelectorAll('input, textarea');
        const userValues = {};
        inputs.forEach(input => { const key = input.dataset.placeholder; userValues[key] = input.value; });
        const finalContent = replacePlaceholders(currentTextToCopy, userValues);
        copyToClipboard(finalContent);
        document.getElementById('placeholder-modal').classList.add('hidden');
        document.getElementById('copied-text-display').textContent = finalContent;
        document.getElementById('copy-success-modal').classList.remove('hidden');

        currentTutorialStep++;
        showTutorialStep(currentTutorialStep);
        
    });
    document.getElementById('cancel-placeholder-btn').addEventListener('click', () => {
        // Hide the placeholder modal
        document.getElementById('placeholder-modal').classList.add('hidden');
   		 // Conditionally show the tutorial based on the global flag
    	if (isTutorialActive) {
        	// This is the tutorial-specific logic
        	document.getElementById('tutorial-modal').classList.remove('hidden');
        	document.getElementById('tutorial-overlay').classList.remove('hidden');
        	showTutorialStep(currentTutorialStep);
    	} else {
        // This is the normal operation; just close the modal.
        // No need to show the tutorial or do anything else.
   		 }
	});
    document.getElementById('sign-in-btn-settings').addEventListener('click', async () => {
        try { const provider = new GoogleAuthProvider(); await signInWithPopup(auth, provider); showMessage("Signed in with Google!"); } catch (error) { console.error("Google sign-in failed", error); showMessage("Google sign-in failed. Please try again.", 'error'); }
    });
    document.getElementById('sign-out-btn-settings').addEventListener('click', async () => {
        try { await signOut(auth); showMessage("Signed out successfully!"); await signInAnonymously(auth); } catch (error) { console.error("Sign out failed", error); showMessage("Sign out failed. Please try again.", 'error'); }
    });
    document.getElementById('check-updates-btn-settings').addEventListener('click', async () => {
        if (isAnonymous) { showMessage("Please sign in to check for updates.", "error"); return; }
        const updateModal = document.getElementById('update-modal');
        const updateModalTitle = document.getElementById('update-modal-title');
        const updateModalMessage = document.getElementById('update-modal-message');
        const updateModalButtons = document.getElementById('update-modal-buttons');
        updateModal.classList.remove('hidden');
        updateModalTitle.textContent = "Checking for Updates...";
        updateModalMessage.textContent = "Please wait while we check for new content.";
        updateModalButtons.classList.add('hidden');
        try {
            const blueprint = await getCannedResponsesBlueprint();
            let changesMade = false;
            const updatedCategories = JSON.parse(JSON.stringify(categories));
            let newCategoryCount = 0;
            let newResponseCount = 0;
            for (const cat in blueprint) {
                if (!updatedCategories[cat]) { updatedCategories[cat] = blueprint[cat]; newCategoryCount++; changesMade = true; }
            }
            for (const cat in blueprint) {
                if (updatedCategories[cat]) {
                    const existingResponses = updatedCategories[cat].responses.map(r => r.id);
                    const newResponses = blueprint[cat].responses.filter(r => !existingResponses.includes(r.id));
                    if (newResponses.length > 0) {
                        updatedCategories[cat].responses.push(...newResponses);
                        newResponseCount += newResponses.length;
                        changesMade = true;
                    }
                }
            }
            if (changesMade) {
                await saveToFirestore(updatedCategories);
                updateModalTitle.textContent = "Updates Found!";
                updateModalMessage.innerHTML = `<p>${newCategoryCount} new categories and ${newResponseCount} new responses were added.</p><p class="mt-2">Your data has been updated with the new content.</p>`;
                updateModalButtons.classList.remove('hidden');
            } else {
                updateModalTitle.textContent = "No Updates Found";
                updateModalMessage.textContent = "Your content is already up to date.";
                updateModalButtons.classList.remove('hidden');
            }
        } catch (error) {
            console.error("Error checking for updates:", error);
            updateModalTitle.textContent = "Update Failed";
            updateModalMessage.textContent = "There was an error checking for updates. Please try again later.";
            updateModalButtons.classList.remove('hidden');
        }
    });
    document.getElementById('close-update-btn').addEventListener('click', () => { document.getElementById('update-modal').classList.add('hidden'); });
    document.getElementById('show-placeholder-example-btn').addEventListener('click', showPlaceholderDemo);

}

// --- Core Application Logic (Auth and Data Sync) ---
onAuthStateChanged(auth, async (user) => {
    if (cannedResponsesUnsubscribe) { cannedResponsesUnsubscribe(); cannedResponsesUnsubscribe = null; }
    if (helpfulLinksUnsubscribe) { helpfulLinksUnsubscribe(); helpfulLinksUnsubscribe = null; }
    if (user) {
        userId = user.uid;
        isAnonymous = user.isAnonymous;
        const displayName = user.displayName || user.email || 'User';
        userName = displayName.split(' ')[0].split('@')[0];
        const linksUserInfo = document.getElementById('links-user-info');
        if (linksUserInfo) linksUserInfo.textContent = `User ID: ${userId}`;
        defaultLinks = await getHelpfulLinksBlueprint();
        renderStaticLinks();
        if (!isAnonymous) {
            const linksCollectionRef = getUserHelpfulLinksCollectionRef(userId);
            helpfulLinksUnsubscribe = onSnapshot(linksCollectionRef, (querySnapshot) => {
                userLinks = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUserLinks();
            }, (error) => {
                console.error("Error listening for user links:", error);
                showMessage("Error loading your links. Please check your Firebase permissions.", 'error');
            });
        }
        if (isAnonymous) {
            const userDocRef = getUserRootDocRef(userId);
            try {
                const userDoc = await getDoc(userDocRef);
                const hasSeenPrompt = userDoc.exists() && userDoc.data().hasSeenLoginPrompt;
                if (!hasSeenPrompt) { document.getElementById('login-popup-modal').classList.remove('hidden'); setTimeout(() => { document.getElementById('login-popup-modal').classList.add('show'); }, 10); } else { document.getElementById('login-popup-modal').classList.add('hidden'); }
            } catch (error) {
                console.error("Error fetching user data for login prompt:", error);
                document.getElementById('login-popup-modal').classList.remove('hidden');
                setTimeout(() => { document.getElementById('login-popup-modal').classList.add('show'); }, 10);
            }
            categories = await getCannedResponsesBlueprint();
            if (Object.keys(categories).length > 0) {
                const existingCategoryNames = Object.keys(categories);
                if (!existingCategoryNames.includes(activeCategory)) { activeCategory = existingCategoryNames[0]; }
            }
            renderContent();
        } else {
            document.getElementById('login-popup-modal').classList.add('hidden');
            const userDocRef = getUserRootDocRef(userId);
            const userDoc = await getDoc(userDocRef);
            const tutorialSeen = userDoc.exists() && userDoc.data().tutorialSeen;
            if (!tutorialSeen) {
                document.getElementById('tutorial-modal').classList.remove('hidden');
                showTutorialStep(0); // Start the tutorial at the beginning
            } else {
                document.getElementById('tutorial-modal').classList.add('hidden');
            }
            const userCannedResponsesDocRef = getUserCannedResponsesDocRef(userId);
            cannedResponsesUnsubscribe = onSnapshot(userCannedResponsesDocRef, async (doc) => {
                if (doc.exists()) { categories = doc.data().categories || {}; } else { try { const blueprint = await getCannedResponsesBlueprint(); categories = JSON.parse(JSON.stringify(blueprint)); await setDoc(userCannedResponsesDocRef, { categories: categories }); console.log("Migrated default data to Firestore for new user."); } catch (error) { console.error("Error migrating data for new user:", error); } }
                for (const key in categories) { if (!categories[key].responses) { categories[key].responses = []; } }
                if (Object.keys(categories).length > 0) {
                    const existingCategoryNames = Object.keys(categories);
                    if (!existingCategoryNames.includes(activeCategory)) { activeCategory = existingCategoryNames[0]; }
                }
                renderContent();
            }, (error) => {
                console.error("Error with onSnapshot listener:", error);
                showMessage("Error loading your data. Please check your Firebase permissions.", 'error');
            });
        }
    } else {
        try { await signInAnonymously(auth); } catch (error) { console.error("Anonymous sign-in failed", error); }
    }
});

attachEventListeners();
</script>
</body>
</html>
